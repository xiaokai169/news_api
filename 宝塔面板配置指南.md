# å®å¡”é¢æ¿é…ç½®æŒ‡å— - å®˜æ–¹æ–°é—»ç½‘ç«™åç«¯ç³»ç»Ÿ

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº **Symfony 7.3** æ¡†æ¶æ„å»ºçš„å®˜æ–¹æ–°é—»ç½‘ç«™åç«¯ç³»ç»Ÿï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

-   **PHP ç‰ˆæœ¬è¦æ±‚**: >= 8.2
-   **æ•°æ®åº“**: MySQL 8.0+ (åŒæ•°æ®åº“é…ç½®)
-   **API ç³»ç»Ÿ**: è‡ªå®šä¹‰ API æ¥å£
-   **è®¤è¯æ–¹å¼**: JWT è®¤è¯
-   **æ¡†æ¶**: Symfony 7.3

## ğŸ”§ å®å¡”é¢æ¿ç¯å¢ƒé…ç½®

### 1. PHP ç¯å¢ƒè®¾ç½®

#### å¿…éœ€çš„ PHP æ‰©å±•

åœ¨å®å¡”é¢æ¿çš„ **PHP ç®¡ç†** ä¸­ç¡®ä¿å®‰è£…ä»¥ä¸‹æ‰©å±•ï¼š

```
âœ… PHP >= 8.2
âœ… ctype æ‰©å±•
âœ… iconv æ‰©å±•
âœ… pdo_mysql æ‰©å±•
âœ… mbstring æ‰©å±•
âœ… json æ‰©å±•
âœ… curl æ‰©å±•
âœ… openssl æ‰©å±•
âœ… tokenizer æ‰©å±•
âœ… xml æ‰©å±•
```

#### PHP é…ç½®ä¼˜åŒ–

åœ¨ **PHP è®¾ç½®** â†’ **é…ç½®æ–‡ä»¶** ä¸­è°ƒæ•´ï¼š

```ini
# å†…å­˜é™åˆ¶
memory_limit = 512M

# æ‰§è¡Œæ—¶é—´
max_execution_time = 300

# ä¸Šä¼ æ–‡ä»¶å¤§å°
upload_max_filesize = 50M
post_max_size = 50M

# å¼€å¯é”™è¯¯æ˜¾ç¤ºï¼ˆç”Ÿäº§ç¯å¢ƒå»ºè®®å…³é—­ï¼‰
display_errors = Off
log_errors = On
error_log = /www/wwwlogs/your_site_error.log

# æ—¶åŒºè®¾ç½®
date.timezone = Asia/Shanghai
```

### 2. ç«™ç‚¹åˆ›å»ºæ­¥éª¤

#### æ­¥éª¤ 1: åˆ›å»ºç«™ç‚¹

1. ç™»å½•å®å¡”é¢æ¿
2. ç‚¹å‡» **ç½‘ç«™** â†’ **æ·»åŠ ç«™ç‚¹**
3. å¡«å†™åŸŸåï¼š`your-domain.com`
4. é€‰æ‹© **PHP ç‰ˆæœ¬**: 8.2
5. æ•°æ®åº“é€‰æ‹©ï¼š**MySQL**ï¼Œè®¾ç½®æ•°æ®åº“åå’Œå¯†ç 
6. ç‚¹å‡» **æäº¤**

#### æ­¥éª¤ 2: ä¸Šä¼ é¡¹ç›®æ–‡ä»¶

1. å°†é¡¹ç›®æ–‡ä»¶ä¸Šä¼ åˆ°ç«™ç‚¹æ ¹ç›®å½•ï¼š`/www/wwwroot/your-domain.com/`
2. ç¡®ä¿ç›®å½•æƒé™æ­£ç¡®ï¼š
    ```bash
    # é€šè¿‡ SSH æˆ–å®å¡”ç»ˆç«¯æ‰§è¡Œ
    chown -R www:www /www/wwwroot/your-domain.com/
    chmod -R 755 /www/wwwroot/your-domain.com/
    chmod -R 777 /www/wwwroot/your-domain.com/var/
    ```

#### æ­¥éª¤ 3: é…ç½®ç½‘ç«™æ ¹ç›®å½•

åœ¨å®å¡”é¢æ¿ä¸­ï¼š

1. é€‰æ‹©ç«™ç‚¹ â†’ **è®¾ç½®**
2. **ç½‘ç«™ç›®å½•** â†’ **è¿è¡Œç›®å½•** è®¾ç½®ä¸º `/public`
3. **ä¼ªé™æ€** é€‰æ‹© **è‡ªå®šä¹‰** å¹¶å¡«å…¥ä»¥ä¸‹è§„åˆ™ï¼š

```apache
# Symfony ä¼ªé™æ€è§„åˆ™
location / {
    try_files $uri $uri/ /index.php?$query_string;
}

# API è·¯ç”±ç‰¹æ®Šå¤„ç†
location ~ ^/(api|official-api)/ {
    try_files $uri $uri/ /index.php?$query_string;
}

# é™æ€æ–‡ä»¶ç¼“å­˜
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}

# æ‹’ç»è®¿é—®æ•æ„Ÿæ–‡ä»¶
location ~ /\.(ht|git|svn) {
    deny all;
}
```

### 3. æ•°æ®åº“é…ç½®

#### åˆ›å»ºæ•°æ®åº“

1. åœ¨å®å¡”é¢æ¿ **æ•°æ®åº“** ä¸­åˆ›å»ºä¸¤ä¸ªæ•°æ®åº“ï¼š

    - `official_website` (ä¸»æ•°æ®åº“)
    - `official_website_user` (ç”¨æˆ·æ•°æ®åº“)

2. è®°å½•æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼Œæ›´æ–° `.env` æ–‡ä»¶ï¼š

```bash
# ç¼–è¾‘ç¯å¢ƒé…ç½®
cd /www/wwwroot/your-domain.com/
nano .env
```

æ›´æ–°ä»¥ä¸‹é…ç½®ï¼š

```env
# ç¯å¢ƒè®¾ç½®
APP_ENV=prod
APP_DEBUG=false
APP_SECRET=your_secret_key_here

# æ•°æ®åº“è¿æ¥
DATABASE_URL="mysql://db_user:db_password@127.0.0.1:3306/official_website?serverVersion=8.0&charset=utf8mb4"
USER_DATABASE_URL="mysql://db_user:db_password@127.0.0.1:3306/official_website_user?serverVersion=8.0&charset=utf8mb4"

# CORS è®¾ç½®
CORS_ALLOW_ORIGIN=*

# é»˜è®¤ URI
DEFAULT_URI=http://your-domain.com
```

### 4. é¡¹ç›®éƒ¨ç½²æ­¥éª¤

#### æ­¥éª¤ 1: å®‰è£… Composer ä¾èµ–

```bash
cd /www/wwwroot/your-domain.com/

# å®‰è£…ä¾èµ–ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
composer install --no-dev --optimize-autoloader --no-interaction

# è®¾ç½®æƒé™
chown -R www:www vendor/
chmod -R 755 vendor/
```

#### æ­¥éª¤ 2: æ•°æ®åº“è¿ç§»

```bash
# æ¸…é™¤ç¼“å­˜
php bin/console cache:clear --env=prod

# æ‰§è¡Œæ•°æ®åº“è¿ç§»
php bin/console doctrine:migrations:migrate --env=prod --no-interaction

# ç”¨æˆ·æ•°æ®åº“è¿ç§»
php bin/console doctrine:migrations:migrate --em=user --env=prod --no-interaction
```

#### æ­¥éª¤ 3: ç”Ÿæˆ JWT å¯†é’¥

```bash
# ç”Ÿæˆ JWT å¯†é’¥å¯¹
php bin/console lexik:jwt:generate-keypair --env=prod

# è®¾ç½®æƒé™
chmod 600 config/jwt/private.pem
chmod 644 config/jwt/public.pem
chown www:www config/jwt/*
```

#### æ­¥éª¤ 4: ä¼˜åŒ–ç”Ÿäº§ç¯å¢ƒ

```bash
# æ¸…é™¤å¹¶é¢„çƒ­ç¼“å­˜
php bin/console cache:clear --env=prod
php bin/console cache:warmup --env=prod

# å®‰è£…é™æ€èµ„æº
php bin/console assets:install --env=prod public
```

### 5. è®¿é—®åœ°å€é…ç½®

#### ä¸»è¦è®¿é—®è·¯å¾„

1. **API æ–‡æ¡£ï¼ˆSwaggerï¼‰**

    ```
    http://your-domain.com/api/doc
    ```

2. **æ–°é—»æ–‡ç«  API**

    ```
    # è·å–æ–‡ç« åˆ—è¡¨
    GET http://your-domain.com/official-api/news

    # åˆ›å»ºæ–‡ç« 
    POST http://your-domain.com/official-api/news

    # è·å–å•ä¸ªæ–‡ç« 
    GET http://your-domain.com/official-api/news/{id}

    # æ›´æ–°æ–‡ç« 
    PUT http://your-domain.com/official-api/news/{id}
    ```

3. **å¥åº·æ£€æŸ¥æ¥å£**

    ```
    http://your-domain.com/api/health
    http://your-domain.com/api/info
    ```

4. **ç³»ç»Ÿä¿¡æ¯æ¥å£**
    ```
    http://your-domain.com/api/test
    ```

### 6. SSL è¯ä¹¦é…ç½®

#### æ­¥éª¤ 1: ç”³è¯· SSL è¯ä¹¦

1. åœ¨å®å¡”é¢æ¿ä¸­é€‰æ‹©ç«™ç‚¹
2. **SSL** â†’ **Let's Encrypt**
3. å¡«å†™åŸŸåå’Œé‚®ç®±
4. ç‚¹å‡» **ç”³è¯·**

#### æ­¥éª¤ 2: å¼ºåˆ¶ HTTPS

1. åœ¨ SSL è®¾ç½®ä¸­å¼€å¯ **å¼ºåˆ¶ HTTPS**
2. æ›´æ–° `.env` æ–‡ä»¶ä¸­çš„ URLï¼š
    ```env
    DEFAULT_URI=https://your-domain.com
    ```

### 7. æ€§èƒ½ä¼˜åŒ–é…ç½®

#### PHP-FPM ä¼˜åŒ–

åœ¨ **PHP ç®¡ç†** â†’ **FPM é…ç½®** ä¸­è°ƒæ•´ï¼š

```ini
# è¿›ç¨‹ç®¡ç†
pm = dynamic
pm.max_children = 50
pm.start_servers = 5
pm.min_spare_servers = 5
pm.max_spare_servers = 35

# å†…å­˜é™åˆ¶
pm.max_requests = 500
```

#### MySQL ä¼˜åŒ–

åœ¨ **æ•°æ®åº“** â†’ **é…ç½®ä¿®æ”¹** ä¸­è°ƒæ•´ï¼š

```ini
# ç¼“å†²åŒºè®¾ç½®
innodb_buffer_pool_size = 256M
innodb_log_file_size = 64M
innodb_flush_log_at_trx_commit = 2

# æŸ¥è¯¢ç¼“å­˜
query_cache_type = 1
query_cache_size = 64M
```

### 8. ç›‘æ§å’Œæ—¥å¿—

#### æ—¥å¿—é…ç½®

1. **PHP é”™è¯¯æ—¥å¿—**: `/www/wwwlogs/your_site_error.log`
2. **Symfony æ—¥å¿—**: `/www/wwwroot/your-domain.com/var/log/prod.log`
3. **Nginx è®¿é—®æ—¥å¿—**: `/www/wwwlogs/your-domain.com.log`

#### ç›‘æ§è®¾ç½®

åœ¨å®å¡”é¢æ¿ä¸­ï¼š

1. **ç›‘æ§** â†’ **ç½‘ç«™ç›‘æ§**
2. è®¾ç½® CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡å‘Šè­¦
3. é…ç½® **ç½‘ç«™å“åº”æ—¶é—´** ç›‘æ§

### 9. å®‰å…¨é…ç½®

#### ç›®å½•æƒé™

```bash
# è®¾ç½®æ­£ç¡®çš„ç›®å½•æƒé™
find /www/wwwroot/your-domain.com/ -type d -exec chmod 755 {} \;
find /www/wwwroot/your-domain.com/ -type f -exec chmod 644 {} \;

# ç‰¹æ®Šç›®å½•æƒé™
chmod -R 777 /www/wwwroot/your-domain.com/var/
chmod -R 777 /www/wwwroot/your-domain.com/public/uploads/
```

#### é˜²ç«å¢™è®¾ç½®

1. åœ¨å®å¡”é¢æ¿ **å®‰å…¨** ä¸­é…ç½®é˜²ç«å¢™è§„åˆ™
2. åªå¼€æ”¾å¿…è¦ç«¯å£ï¼š80, 443, 22
3. ç¦æ­¢ä¸å¿…è¦çš„ç«¯å£è®¿é—®

### 10. å¸¸è§é—®é¢˜æ’æŸ¥

#### é—®é¢˜ 1: 500 é”™è¯¯

```bash
# æ£€æŸ¥ PHP é”™è¯¯æ—¥å¿—
tail -f /www/wwwlogs/your_site_error.log

# æ£€æŸ¥ Symfony æ—¥å¿—
tail -f /www/wwwroot/your-domain.com/var/log/prod.log

# æ£€æŸ¥æƒé™
ls -la /www/wwwroot/your-domain.com/
```

#### é—®é¢˜ 2: æ•°æ®åº“è¿æ¥å¤±è´¥

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
php bin/console doctrine:database:create --connection=default
php bin/console doctrine:database:create --connection=user
```

#### é—®é¢˜ 3: JWT è®¤è¯å¤±è´¥

```bash
# æ£€æŸ¥ JWT é…ç½®
php bin/console debug:config lexik_jwt_authentication

# é‡æ–°ç”Ÿæˆå¯†é’¥
php bin/console lexik:jwt:generate-keypair
```

### 11. å¤‡ä»½ç­–ç•¥

#### è‡ªåŠ¨å¤‡ä»½é…ç½®

1. **è®¡åˆ’ä»»åŠ¡** â†’ **æ·»åŠ ä»»åŠ¡**
2. é€‰æ‹© **å¤‡ä»½ç½‘ç«™**
3. è®¾ç½®å¤‡ä»½å‘¨æœŸï¼šæ¯å¤©å‡Œæ™¨ 2 ç‚¹
4. ä¿ç•™ä»½æ•°ï¼š7 ä»½

#### æ•°æ®åº“å¤‡ä»½

```bash
# æ‰‹åŠ¨å¤‡ä»½è„šæœ¬
mysqldump -u root -p official_website > backup_$(date +%Y%m%d).sql
mysqldump -u root -p official_website_user > backup_user_$(date +%Y%m%d).sql
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨é…ç½®è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. PHP ç‰ˆæœ¬å’Œæ‰©å±•æ˜¯å¦æ­£ç¡®
2. æ•°æ®åº“è¿æ¥ä¿¡æ¯æ˜¯å¦å‡†ç¡®
3. ç›®å½•æƒé™æ˜¯å¦æ­£ç¡®
4. é˜²ç«å¢™å’Œ SELinux è®¾ç½®

**é…ç½®å®Œæˆåè®¿é—®åœ°å€**ï¼š

-   ä¸»ç«™ç‚¹ï¼š`https://your-domain.com`
-   API æ–‡æ¡£ï¼š`https://your-domain.com/api/doc`
-   å¥åº·æ£€æŸ¥ï¼š`https://your-domain.com/api/health`
