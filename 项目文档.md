# å®˜æ–¹æ–°é—»ç½‘ç«™åç«¯ç³»ç»Ÿ - é¡¹ç›®æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº Symfony æ¡†æ¶æ„å»ºçš„å®˜æ–¹æ–°é—»ç½‘ç«™åç«¯ç³»ç»Ÿï¼Œä¸»è¦åŠŸèƒ½åŒ…æ‹¬æ–°é—»æ–‡ç« ç®¡ç†ã€å¾®ä¿¡æ–‡ç« åŒæ­¥ã€ç”¨æˆ·æƒé™ç®¡ç†ã€JWT è®¤è¯ç­‰ã€‚

### æŠ€æœ¯æ ˆ
- **æ¡†æ¶**: Symfony 7.3
- **æ•°æ®åº“**: MySQL (åŒæ•°æ®åº“é…ç½®)
- **API**: API Platform
- **è®¤è¯**: JWT (Lexik JWT Authentication Bundle)
- **æ–‡æ¡£**: Nelmio API Doc Bundle

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•°æ®åº“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸»æ•°æ®åº“        â”‚    â”‚  ç”¨æˆ·æ•°æ®åº“      â”‚
â”‚ (official_website)â”‚    â”‚     (app)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ sys_news_article â”‚    â”‚      user       â”‚
â”‚ sys_news_categoryâ”‚    â”‚                 â”‚
â”‚ ...             â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  åº”ç”¨å±‚      â”‚
              â”‚ (Symfony)   â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
1. **æ–°é—»æ–‡ç« ç®¡ç†** - å®Œæ•´çš„ CRUD æ“ä½œå’ŒçŠ¶æ€ç®¡ç†
2. **å¾®ä¿¡æ–‡ç« åŒæ­¥** - ä¸å¾®ä¿¡å…¬ä¼—å·å†…å®¹åŒæ­¥
3. **ç”¨æˆ·å…³è”ç³»ç»Ÿ** - JWT è®¤è¯å’Œç”¨æˆ·ä¿¡æ¯å…³è”
4. **å®šæ—¶å‘å¸ƒç³»ç»Ÿ** - é¢„çº¦å‘å¸ƒåŠŸèƒ½
5. **åˆ†å¸ƒå¼é”æœºåˆ¶** - é˜²æ­¢å¹¶å‘åŒæ­¥å†²çª

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### ä¸»è¦æ•°æ®è¡¨

#### sys_news_article (æ–°é—»æ–‡ç« è¡¨)
- `id` - ä¸»é”®
- `merchantId` - å•†æˆ·ID
- `userId` - ç”¨æˆ·ID
- `name` - æ–‡ç« æ ‡é¢˜
- `cover` - å°é¢å›¾ç‰‡
- `content` - æ–‡ç« å†…å®¹
- `releaseTime` - å‘å¸ƒæ—¶é—´
- `status` - çŠ¶æ€ (1:æ¿€æ´», 2:éæ¿€æ´», 3:å·²åˆ é™¤)
- `isRecommend` - æ˜¯å¦æ¨è
- `category_id` - åˆ†ç±»ID

#### sys_news_article_category (æ–‡ç« åˆ†ç±»è¡¨)
- `id` - ä¸»é”®
- `code` - åˆ†ç±»ç¼–ç 
- `name` - åˆ†ç±»åç§°

#### user (ç”¨æˆ·è¡¨ - åªè¯»)
- `id` - ä¸»é”®
- `username` - ç”¨æˆ·å
- `email` - é‚®ç®±
- `nickname` - æ˜µç§°
- `status` - çŠ¶æ€

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. æ–°é—»æ–‡ç« ç®¡ç†

#### ä¸»è¦ç‰¹æ€§
- **å®Œæ•´çš„ CRUD æ“ä½œ**
- **é¢„çº¦å‘å¸ƒåŠŸèƒ½** - æ”¯æŒå®šæ—¶å‘å¸ƒ
- **é€»è¾‘åˆ é™¤** - é¿å…æ•°æ®ä¸¢å¤±
- **å¤šæ¡ä»¶æŸ¥è¯¢** - æ”¯æŒå¤æ‚æœç´¢
- **åˆ†é¡µå’Œæ’åº** - é«˜æ€§èƒ½æ•°æ®å±•ç¤º

#### æ ¸å¿ƒ API æ¥å£

```http
# åˆ›å»ºæ–‡ç« 
POST /official-api/news

# è·å–æ–‡ç« åˆ—è¡¨
GET /official-api/news?page=1&limit=20&includeUser=true

# è·å–å•ä¸ªæ–‡ç« 
GET /official-api/news/{id}

# æ›´æ–°æ–‡ç« 
PUT /official-api/news/{id}

# åˆ é™¤æ–‡ç« 
DELETE /official-api/news/{id}

# è®¾ç½®çŠ¶æ€
PATCH /official-api/news/{id}/status

# æ¢å¤æ–‡ç« 
PATCH /official-api/news/{id}/restore
```

### 2. å¾®ä¿¡æ–‡ç« åŒæ­¥

#### åŒæ­¥æµç¨‹
1. **è·å–è®¿é—®ä»¤ç‰Œ** - é€šè¿‡å¾®ä¿¡ API è·å– access_token
2. **æ‰¹é‡è·å–æ–‡ç« ** - åˆ†é¡µè·å–å¾®ä¿¡ç´ æåº“æ–‡ç« 
3. **æ•°æ®è½¬æ¢** - å¾®ä¿¡æ ¼å¼è½¬æ¢ä¸ºç³»ç»Ÿæ ¼å¼
4. **ä¿å­˜åˆ°æ•°æ®åº“** - ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘

#### æ ¸å¿ƒæœåŠ¡
- `WechatApiService` - å¾®ä¿¡ API è°ƒç”¨æœåŠ¡
- `WechatArticleSyncService` - æ–‡ç« åŒæ­¥æœåŠ¡
- `DistributedLockService` - åˆ†å¸ƒå¼é”æœåŠ¡

### 3. JWT è®¤è¯ç³»ç»Ÿ

#### è®¤è¯æµç¨‹
1. **Token è§£æ** - ä»è¯·æ±‚å¤´è§£æ JWT token
2. **ç”¨æˆ·è¯†åˆ«** - ä» token ä¸­æå–ç”¨æˆ· ID
3. **æƒé™éªŒè¯** - éªŒè¯ç”¨æˆ·æƒé™
4. **æ•°æ®å…³è”** - å°†ç”¨æˆ·ä¿¡æ¯å…³è”åˆ°æ–‡ç« 

#### æ ¸å¿ƒç»„ä»¶
- `JwtService` - JWT æœåŠ¡
- `UserReadOnlyService` - ç”¨æˆ·åªè¯»æœåŠ¡
- `UserDatabaseReadonlyListener` - åªè¯»æƒé™ç›‘å¬å™¨

## ğŸ”’ å®‰å…¨æ¶æ„

### ç”¨æˆ·åªè¯»æƒé™è®¾è®¡

#### å®‰å…¨å±‚æ¬¡
1. **æ•°æ®åº“å±‚é¢** - åªè¯»ç”¨æˆ·æƒé™
2. **å®ä½“å±‚é¢** - æ—  setter æ–¹æ³•
3. **Repository å±‚é¢** - åªè¯»æŸ¥è¯¢æ–¹æ³•
4. **äº‹ä»¶ç›‘å¬å±‚é¢** - é˜»æ­¢å†™æ“ä½œ
5. **æœåŠ¡å±‚é¢** - åªè¯»æœåŠ¡æ¥å£

#### å®‰å…¨é…ç½®
```yaml
# doctrine.yaml
user:
    url: "%env(resolve:USER_DATABASE_URL)%"
    driver_options:
        1000: true # PDO::ATTR_EMULATE_PREPARES
        1002: "SET SESSION sql_mode = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION'"
```

## ğŸ“Š API æ¥å£æ–‡æ¡£

### æŸ¥è¯¢å‚æ•°æ”¯æŒ

| å‚æ•° | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| page | int | é¡µç  | page=1 |
| limit | int | æ¯é¡µæ•°é‡ | limit=20 |
| includeUser | boolean | åŒ…å«ç”¨æˆ·ä¿¡æ¯ | includeUser=true |
| userId | int | ç”¨æˆ·IDç­›é€‰ | userId=123 |
| userName | string | ç”¨æˆ·åæœç´¢ | userName=admin |
| merchantId | int | å•†æˆ·ID | merchantId=1 |
| status | int | çŠ¶æ€ç­›é€‰ | status=1 |
| categoryCode | string | åˆ†ç±»ç¼–ç  | categoryCode=GZH_001 |
| name | string | æ ‡é¢˜æœç´¢ | name=å…³é”®è¯ |

### å“åº”æ ¼å¼ç¤ºä¾‹

```json
{
    "success": true,
    "data": [
        {
            "id": 1,
            "name": "æ–‡ç« æ ‡é¢˜",
            "cover": "å°é¢URL",
            "content": "æ–‡ç« å†…å®¹",
            "userId": 123,
            "user": {
                "id": 123,
                "username": "admin",
                "nickname": "ç®¡ç†å‘˜",
                "email": "admin@example.com"
            },
            "createTime": "2025-11-20T03:00:00+00:00"
        }
    ],
    "meta": {
        "total": 1,
        "page": 1,
        "limit": 20,
        "pages": 1
    }
}
```

## ğŸš€ éƒ¨ç½²æŒ‡å—

### ç¯å¢ƒè¦æ±‚
- PHP >= 8.2
- MySQL >= 8.0
- Symfony 7.3

### å®‰è£…æ­¥éª¤

1. **å®‰è£…ä¾èµ–**
```bash
composer install --no-dev --optimize-autoloader
```

2. **é…ç½®ç¯å¢ƒå˜é‡**
```bash
cp .env .env.local
# ç¼–è¾‘ .env.local è®¾ç½®æ•°æ®åº“è¿æ¥
```

3. **æ•°æ®åº“è¿ç§»**
```bash
# åˆ›å»ºä¸»æ•°æ®åº“è¡¨
php bin/console doctrine:migrations:migrate

# åˆ›å»ºç”¨æˆ·æ•°æ®åº“è¡¨
php bin/console doctrine:migrations:migrate --em=user
```

4. **é…ç½® JWT å¯†é’¥**
```bash
# ç”Ÿæˆ JWT å¯†é’¥å¯¹
php bin/console lexik:jwt:generate-keypair
```

## ğŸ” æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. æ•°æ®åº“è¿æ¥é—®é¢˜
```bash
# æ£€æŸ¥æ•°æ®åº“è¿æ¥
php bin/console doctrine:database:create --connection=user
php bin/console doctrine:schema:validate --em=user
```

#### 2. JWT è®¤è¯é—®é¢˜
```bash
# æ£€æŸ¥ JWT é…ç½®
php bin/console debug:config lexik_jwt_authentication
```

#### 3. å¾®ä¿¡åŒæ­¥é—®é¢˜
```bash
# æµ‹è¯•å¾®ä¿¡ API è¿æ¥
php test_wechat_sync_api.php
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

### æ ¸å¿ƒæ–‡æ¡£
- `TECHNICAL_DOCUMENTATION.md` - è¯¦ç»†æŠ€æœ¯æ–‡æ¡£
- `NEWS_ARTICLE_SYSTEM_GUIDE.md` - æ–°é—»ç³»ç»ŸæŒ‡å—
- `WECHAT_API_GUIDE.md` - å¾®ä¿¡ API æŒ‡å—

### æµ‹è¯•æ–‡æ¡£
- `test_news_jwt_token.php` - JWT åŠŸèƒ½æµ‹è¯•
- `test_news_with_user.php` - ç”¨æˆ·å…³è”æµ‹è¯•
- `test_user_readonly.php` - åªè¯»æƒé™æµ‹è¯•

## ğŸ”„ å¼€å‘å·¥ä½œæµ

### ä»£ç è§„èŒƒ
- ä½¿ç”¨ PHP 8.2+ è¯­æ³•ç‰¹æ€§
- éµå¾ª PSR-12 ç¼–ç è§„èŒƒ
- ä½¿ç”¨ç±»å‹å£°æ˜å’Œä¸¥æ ¼ç±»å‹
- å®Œæ•´çš„ PHPDoc æ³¨é‡Š

### æµ‹è¯•ç­–ç•¥
- å•å…ƒæµ‹è¯•ï¼šæ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- é›†æˆæµ‹è¯•ï¼šAPI æ¥å£æµ‹è¯•
- åŠŸèƒ½æµ‹è¯•ï¼šå®Œæ•´ä¸šåŠ¡æµç¨‹

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–

### æŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨ JOIN é¿å… N+1 æŸ¥è¯¢
- åˆç†çš„ç´¢å¼•ç­–ç•¥
- åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥
- Doctrine æŸ¥è¯¢ç¼“å­˜
- ç»“æœç¼“å­˜é…ç½®
- Redis é›†æˆæ”¯æŒ

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### æ—¥å¿—æ–‡ä»¶
- `var/log/dev.log` - å¼€å‘ç¯å¢ƒæ—¥å¿—
- `var/log/prod.log` - ç”Ÿäº§ç¯å¢ƒæ—¥å¿—

### ç›‘æ§æŒ‡æ ‡
- API å“åº”æ—¶é—´
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- å†…å­˜ä½¿ç”¨æƒ…å†µ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-11-21  
**ç»´æŠ¤å›¢é˜Ÿ**: åç«¯å¼€å‘å›¢é˜Ÿ