# 微信 API IP 白名单解决方案

## 问题描述

在执行公众号文章同步命令时，出现错误：

```
[ERROR] 获取access_token失败
```

通过测试脚本发现具体错误：

```
错误代码: 40164
错误信息: invalid ip 117.39.59.7 ipv6 ::ffff:117.39.59.7, not in whitelist
```

## 问题原因

微信公众平台要求将调用 API 的服务器 IP 地址添加到白名单中。当前服务器 IP `117.39.59.7` 不在白名单中。

## 解决方案

### 步骤 1：登录微信公众平台

1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 使用公众号管理员账号登录
3. 进入公众号管理后台

### 步骤 2：配置 IP 白名单

1. 在左侧菜单中找到 **"设置与开发"** → **"基本配置"**
2. 在 **"公众号开发信息"** 部分找到 **"IP 白名单"**
3. 点击 **"配置"** 按钮
4. 在 IP 白名单输入框中添加服务器 IP 地址：
    ```
    117.39.59.7
    ```
5. 点击 **"确认修改"** 保存设置

### 步骤 3：验证配置

配置完成后，等待几分钟让设置生效，然后重新测试同步命令：

```bash
php bin/console app:wechat:sync gh_01119904cc650f0c --bypass-lock
```

## 注意事项

1. **IP 地址可能变化**：如果服务器使用动态 IP，IP 地址可能会变化。在这种情况下，需要：

    - 使用固定 IP 的服务器
    - 或者每次 IP 变化后重新配置白名单

2. **多个 IP 地址**：如果您的应用部署在多个服务器上，需要将所有服务器的公网 IP 都添加到白名单中。

3. **IPv6 支持**：错误信息中显示同时有 IPv4 和 IPv6 地址，确保白名单配置支持两种协议。

## 临时解决方案

如果无法立即配置白名单，可以考虑以下临时方案：

1. **使用代理服务器**：配置一个已加入白名单的代理服务器
2. **本地开发**：在已加入白名单的开发环境中进行测试

## 验证步骤

配置完成后，可以运行以下命令验证：

```bash
php test_access_token.php
```

如果配置成功，应该看到类似以下输出：

```
✅ 成功获取 access_token: 70_xxxxxxxxxxxxxxxxxxxx...
过期时间: 7200 秒
```

## 技术支持

如果问题仍然存在，请检查：

-   公众号的 AppID 和 AppSecret 是否正确
-   公众号是否已认证并开通相关 API 权限
-   网络连接是否正常
