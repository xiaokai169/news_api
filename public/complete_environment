<?php
/**
 * å¾®ä¿¡åŒæ­¥å®Œæ•´ç¯å¢ƒè¯Šæ–­è„šæœ¬
 * å…¨é¢æ£€æŸ¥å¯èƒ½å¯¼è‡´"åŒæ­¥å®Œæˆï¼Œä½†å­˜åœ¨é”™è¯¯"çš„æ‰€æœ‰é—®é¢˜æº
 */

echo "=== å¾®ä¿¡åŒæ­¥å®Œæ•´ç¯å¢ƒè¯Šæ–­ ===\n\n";

// æ‰‹åŠ¨åŠ è½½å¿…è¦æ–‡ä»¶
require_once __DIR__ . '/../vendor/autoload.php';

use App\Kernel;

try {
    echo "ğŸ” å¼€å§‹å…¨é¢ç¯å¢ƒè¯Šæ–­...\n\n";

    // 1. æ£€æŸ¥PHPç¯å¢ƒ
    echo "1. PHPç¯å¢ƒæ£€æŸ¥:\n";
    echo "   PHPç‰ˆæœ¬: " . PHP_VERSION . "\n";
    echo "   å†…å­˜é™åˆ¶: " . ini_get('memory_limit') . "\n";
    echo "   æ‰§è¡Œæ—¶é—´é™åˆ¶: " . ini_get('max_execution_time') . "ç§’\n";
    echo "   ä¸Šä¼ æ–‡ä»¶å¤§å°: " . ini_get('upload_max_filesize') . "\n";

    // æ£€æŸ¥å¿…éœ€æ‰©å±•
    $requiredExtensions = ['curl', 'pdo', 'pdo_mysql', 'json', 'mbstring'];
    foreach ($requiredExtensions as $ext) {
        $status = extension_loaded($ext) ? 'âœ…' : 'âŒ';
        echo "   æ‰©å±• {$ext}: {$status}\n";
    }

    // 2. æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿæƒé™
    echo "\n2. æ–‡ä»¶ç³»ç»Ÿæƒé™æ£€æŸ¥:\n";
    $directories = [
        'var/log' => 'æ—¥å¿—ç›®å½•',
        'var/cache' => 'ç¼“å­˜ç›®å½•',
        'public' => 'å…¬å…±ç›®å½•',
        'uploads' => 'ä¸Šä¼ ç›®å½•'
    ];

    foreach ($directories as $dir => $name) {
        $fullPath = __DIR__ . '/../' . $dir;
        if (is_dir($fullPath)) {
            $writable = is_writable($fullPath) ? 'âœ…' : 'âŒ';
            echo "   {$name} ({$dir}): {$writable}\n";
        } else {
            echo "   {$name} ({$dir}): âŒ ä¸å­˜åœ¨\n";
        }
    }

    // 3. å°è¯•å¯åŠ¨Symfonyå®¹å™¨
    echo "\n3. Symfonyå®¹å™¨æ£€æŸ¥:\n";
    try {
        $kernel = new Kernel($_ENV['APP_ENV'] ?? 'dev', (bool)($_ENV['APP_DEBUG'] ?? true));
        $kernel->boot();

        echo "   âœ… Symfonyå®¹å™¨å¯åŠ¨æˆåŠŸ\n";

        // 4. æ£€æŸ¥æ•°æ®åº“è¿æ¥
        echo "\n4. æ•°æ®åº“è¿æ¥æ£€æŸ¥:\n";
        $container = $kernel->getContainer();
        $entityManager = $container->get('doctrine.orm.default_entity_manager');

        try {
            $connection = $entityManager->getConnection();
            $connection->connect();

            echo "   âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ\n";

            // æ£€æŸ¥æ•°æ®åº“ç‰ˆæœ¬
            $version = $connection->fetchOne('SELECT VERSION()');
            echo "   MySQLç‰ˆæœ¬: {$version}\n";

            // æ£€æŸ¥å…³é”®è¡¨æ˜¯å¦å­˜åœ¨
            $requiredTables = ['official', 'wechat_public_account', 'distributed_locks'];
            foreach ($requiredTables as $table) {
                $exists = $connection->executeQuery("SHOW TABLES LIKE '{$table}'")->fetchOne();
                echo "   è¡¨ {$table}: " . ($exists ? 'âœ…' : 'âŒ') . "\n";
            }

            // æ£€æŸ¥æ•°æ®ç»Ÿè®¡
            $officialCount = $connection->fetchOne('SELECT COUNT(*) FROM official');
            $accountCount = $connection->fetchOne('SELECT COUNT(*) FROM wechat_public_account');
            echo "   officialè¡¨è®°å½•æ•°: {$officialCount}\n";
            echo "   wechat_public_accountè¡¨è®°å½•æ•°: {$accountCount}\n";

        } catch (Exception $e) {
            echo "   âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: " . $e->getMessage() . "\n";
        }

        // 5. æ£€æŸ¥æœåŠ¡å®¹å™¨
        echo "\n5. å…³é”®æœåŠ¡æ£€æŸ¥:\n";
        $services = [
            'App\Service\WechatApiService' => 'å¾®ä¿¡APIæœåŠ¡',
            'App\Service\WechatArticleSyncService' => 'å¾®ä¿¡æ–‡ç« åŒæ­¥æœåŠ¡',
            'App\Service\DistributedLockService' => 'åˆ†å¸ƒå¼é”æœåŠ¡',
            'App\Repository\WechatPublicAccountRepository' => 'å…¬ä¼—å·ä»“åº“',
            'App\Repository\OfficialRepository' => 'æ–‡ç« ä»“åº“'
        ];

        foreach ($services as $serviceId => $serviceName) {
            try {
                if ($container->has($serviceId)) {
                    $service = $container->get($serviceId);
                    echo "   {$serviceName}: âœ…\n";
                } else {
                    echo "   {$serviceName}: âŒ æœªæ³¨å†Œ\n";
                }
            } catch (Exception $e) {
                echo "   {$serviceName}: âŒ é”™è¯¯ - " . $e->getMessage() . "\n";
            }
        }

        // 6. æ£€æŸ¥å…¬ä¼—å·æ•°æ®
        echo "\n6. å…¬ä¼—å·æ•°æ®æ£€æŸ¥:\n";
        try {
            $accountRepository = $container->get('App\Repository\WechatPublicAccountRepository');
            $accounts = $accountRepository->findAll();

            echo "   æ‰¾åˆ°è´¦æˆ·æ•°é‡: " . count($accounts) . "\n";

            if (!empty($accounts)) {
                foreach ($accounts as $account) {
                    echo "   è´¦æˆ· ID: " . $account->getId() . "\n";
                    echo "   è´¦æˆ·åç§°: " . ($account->getName() ?: 'æœªè®¾ç½®') . "\n";
                    echo "   è´¦æˆ·çŠ¶æ€: " . ($account->isActive() ? 'æ¿€æ´»' : 'æœªæ¿€æ´»') . "\n";
                    echo "   AppId: " . ($account->getAppId() ? substr($account->getAppId(), 0, 8) . '...' : 'æœªè®¾ç½®') . "\n";
                    echo "   AppSecret: " . ($account->getAppSecret() ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®') . "\n";

                    // æ£€æŸ¥æ˜¯å¦æœ‰å®Œæ•´çš„é…ç½®
                    if ($account->getAppId() && $account->getAppSecret() && $account->isActive()) {
                        echo "   è´¦æˆ·é…ç½®: âœ… å®Œæ•´\n";
                    } else {
                        echo "   è´¦æˆ·é…ç½®: âŒ ä¸å®Œæ•´\n";
                        if (!$account->getAppId()) echo "      - ç¼ºå°‘AppId\n";
                        if (!$account->getAppSecret()) echo "      - ç¼ºå°‘AppSecret\n";
                        if (!$account->isActive()) echo "      - è´¦æˆ·æœªæ¿€æ´»\n";
                    }
                    echo "\n";
                }
            } else {
                echo "   âŒ æ²¡æœ‰æ‰¾åˆ°å…¬ä¼—å·è´¦æˆ·æ•°æ®\n";
            }
        } catch (Exception $e) {
            echo "   âŒ å…¬ä¼—å·æ•°æ®æ£€æŸ¥å¤±è´¥: " . $e->getMessage() . "\n";
        }

        // 7. å°è¯•æµ‹è¯•å¾®ä¿¡APIè¿æ¥
        echo "\n7. å¾®ä¿¡APIè¿æ¥æµ‹è¯•:\n";
        try {
            if (!empty($accounts)) {
                $testAccount = null;
                foreach ($accounts as $account) {
                    if ($account->isActive() && $account->getAppId() && $account->getAppSecret()) {
                        $testAccount = $account;
                        break;
                    }
                }

                if ($testAccount) {
                    echo "   ä½¿ç”¨è´¦æˆ·è¿›è¡ŒAPIæµ‹è¯•: " . $testAccount->getId() . "\n";

                    $wechatApiService = $container->get('App\Service\WechatApiService');
                    $accessToken = $wechatApiService->getAccessToken($testAccount);

                    if ($accessToken) {
                        echo "   âœ… è·å–access_tokenæˆåŠŸ\n";
                        echo "   Tokené•¿åº¦: " . strlen($accessToken) . "\n";

                        // æµ‹è¯•è·å–æ–‡ç« åˆ—è¡¨
                        echo "   æµ‹è¯•è·å–å·²å‘å¸ƒæ–‡ç« ...\n";
                        $articles = $wechatApiService->getAllPublishedArticles($accessToken, 1, 0);

                        if ($articles !== null) {
                            echo "   âœ… è·å–æ–‡ç« åˆ—è¡¨æˆåŠŸ\n";
                            echo "   æ–‡ç« æ•°é‡: " . count($articles) . "\n";
                        } else {
                            echo "   âš ï¸ è·å–æ–‡ç« åˆ—è¡¨å¤±è´¥æˆ–æ— æ•°æ®\n";
                        }

                    } else {
                        echo "   âŒ è·å–access_tokenå¤±è´¥\n";
                        echo "   å¯èƒ½åŸå› :\n";
                        echo "      - AppIdæˆ–AppSecreté”™è¯¯\n";
                        echo "      - ç½‘ç»œè¿æ¥é—®é¢˜\n";
                        echo "      - å…¬ä¼—å·æƒé™ä¸è¶³\n";
                        echo "      - APIè°ƒç”¨é™åˆ¶\n";
                    }
                } else {
                    echo "   âŒ æ²¡æœ‰æ‰¾åˆ°é…ç½®å®Œæ•´çš„å…¬ä¼—å·è´¦æˆ·\n";
                }
            } else {
                echo "   âŒ æ²¡æœ‰å…¬ä¼—å·è´¦æˆ·å¯æµ‹è¯•\n";
            }
        } catch (Exception $e) {
            echo "   âŒ å¾®ä¿¡APIæµ‹è¯•å¤±è´¥: " . $e->getMessage() . "\n";
        }

        // 8. æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
        echo "\n8. æ—¥å¿—æ–‡ä»¶æ£€æŸ¥:\n";
        $logFiles = [
            'var/log/prod.log' => 'ç”Ÿäº§æ—¥å¿—',
            'var/log/dev.log' => 'å¼€å‘æ—¥å¿—',
            'var/log/wechat.log' => 'å¾®ä¿¡æ—¥å¿—',
            'var/log/error.log' => 'é”™è¯¯æ—¥å¿—'
        ];

        foreach ($logFiles as $logFile => $logName) {
            $fullPath = __DIR__ . '/../' . $logFile;
            if (file_exists($fullPath)) {
                $size = filesize($fullPath);
                $modified = date('Y-m-d H:i:s', filemtime($fullPath));
                $writable = is_writable($fullPath) ? 'âœ…' : 'âŒ';
                echo "   {$logName}: {$writable}, å¤§å°: {$size} bytes, ä¿®æ”¹æ—¶é—´: {$modified}\n";

                // å¦‚æœæ˜¯é”™è¯¯æ—¥å¿—ï¼Œæ˜¾ç¤ºæœ€è¿‘çš„é”™è¯¯
                if (strpos($logFile, 'error') !== false && $size > 0) {
                    $lines = file($fullPath);
                    $recentErrors = array_slice($lines, -5); // æœ€è¿‘5è¡Œ
                    echo "   æœ€è¿‘é”™è¯¯:\n";
                    foreach ($recentErrors as $line) {
                        if (strpos($line, 'ERROR') !== false || strpos($line, 'Exception') !== false) {
                            echo "      " . trim($line) . "\n";
                        }
                    }
                }
            } else {
                echo "   {$logName}: âŒ ä¸å­˜åœ¨\n";
            }
        }

    } catch (Exception $e) {
        echo "   âŒ Symfonyå®¹å™¨å¯åŠ¨å¤±è´¥: " . $e->getMessage() . "\n";
        echo "   è¿™å¯èƒ½æ˜¯ç¯å¢ƒé…ç½®é—®é¢˜\n";
    }

    echo "\n=== è¯Šæ–­æ€»ç»“ ===\n";

    echo "å¦‚æœåŒæ­¥æ¥å£ä»æ˜¾ç¤º'åŒæ­¥å®Œæˆï¼Œä½†å­˜åœ¨é”™è¯¯'ï¼Œå¯èƒ½çš„åŸå› :\n\n";

    echo "ğŸ”´ é«˜ä¼˜å…ˆçº§é—®é¢˜:\n";
    echo "1. å¾®ä¿¡APIé…ç½®é—®é¢˜ (AppId/AppSecreté”™è¯¯æˆ–æƒé™ä¸è¶³)\n";
    echo "2. ç½‘ç»œè¿æ¥é—®é¢˜ (æ— æ³•è®¿é—®å¾®ä¿¡API)\n";
    echo "3. å…¬ä¼—å·æƒé™é—®é¢˜ (æœªè®¤è¯æˆ–APIæƒé™ä¸è¶³)\n\n";

    echo "ğŸŸ¡ ä¸­ä¼˜å…ˆçº§é—®é¢˜:\n";
    echo "4. æ•°æ®åº“æƒé™é—®é¢˜ (å†™å…¥æƒé™ä¸è¶³)\n";
    echo "5. åˆ†å¸ƒå¼é”é—®é¢˜ (é”è¡¨æŸåæˆ–é”å®šå¼‚å¸¸)\n";
    echo "6. å†…å­˜æˆ–æ—¶é—´é™åˆ¶é—®é¢˜\n\n";

    echo "ğŸŸ¢ ä½ä¼˜å…ˆçº§é—®é¢˜:\n";
    echo "7. æ—¥å¿—å†™å…¥æƒé™é—®é¢˜\n";
    echo "8. ç¼“å­˜ç›®å½•æƒé™é—®é¢˜\n\n";

    echo "ğŸ’¡ å»ºè®®çš„è§£å†³æ­¥éª¤:\n";
    echo "1. éªŒè¯å¾®ä¿¡å…¬ä¼—å¹³å°çš„AppIdå’ŒAppSecretæ˜¯å¦æ­£ç¡®\n";
    echo "2. ç¡®è®¤å…¬ä¼—å·å·²è®¤è¯å¹¶æœ‰ç´ æç®¡ç†æƒé™\n";
    echo "3. æ£€æŸ¥æœåŠ¡å™¨ç½‘ç»œæ˜¯å¦èƒ½è®¿é—®å¾®ä¿¡API\n";
    echo "4. æŸ¥çœ‹è¯¦ç»†çš„é”™è¯¯æ—¥å¿—æ–‡ä»¶\n";
    echo "5. æ£€æŸ¥æ•°æ®åº“ç”¨æˆ·çš„å†™å…¥æƒé™\n";

} catch (Exception $e) {
    echo "âŒ è¯Šæ–­è¿‡ç¨‹å‘ç”Ÿä¸¥é‡é”™è¯¯: " . $e->getMessage() . "\n";
    echo "å †æ ˆè·Ÿè¸ª:\n" . $e->getTraceAsString() . "\n";
}

echo "\n=== è¯Šæ–­å®Œæˆ ===\n";
