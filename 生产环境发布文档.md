# ç”Ÿäº§ç¯å¢ƒå‘å¸ƒæ–‡æ¡£ - Symfony 7.3 + PHP 8.2+ RESTful API

## æ–‡æ¡£ç›®å½•

### ç¬¬ 1 ç« ï¼šé¡¹ç›®æ¦‚è¿°

-   1.1 é¡¹ç›®èƒŒæ™¯ä¸ç›®æ ‡
-   1.2 æŠ€æœ¯æ¶æ„æ¦‚è§ˆ
-   1.3 ç¯å¢ƒè¦æ±‚è¯´æ˜
-   1.4 å‘å¸ƒç­–ç•¥æ¦‚è¿°

### ç¬¬ 2 ç« ï¼šç¯å¢ƒå‡†å¤‡

-   2.1 æœåŠ¡å™¨ç¯å¢ƒé…ç½®
-   2.2 æ•°æ®åº“ç¯å¢ƒæ­å»º
-   2.3 Web æœåŠ¡å™¨é…ç½®
-   2.4 ç¼“å­˜æœåŠ¡é…ç½®
-   2.5 å®‰å…¨é…ç½®

### ç¬¬ 3 ç« ï¼šä»£ç éƒ¨ç½²

-   3.1 ä»£ç è·å–ä¸æ„å»º
-   3.2 ä¾èµ–ç®¡ç†
-   3.3 é…ç½®æ–‡ä»¶ç®¡ç†
-   3.4 æ•°æ®åº“è¿ç§»
-   3.5 ç¼“å­˜é¢„çƒ­

### ç¬¬ 4 ç« ï¼šé…ç½®ç®¡ç†

-   4.1 ç¯å¢ƒå˜é‡é…ç½®
-   4.2 æ•°æ®åº“è¿æ¥é…ç½®
-   4.3 JWT è®¤è¯é…ç½®
-   4.4 CORS è·¨åŸŸé…ç½®
-   4.5 æ—¥å¿—é…ç½®

### ç¬¬ 5 ç« ï¼šå®‰å…¨é…ç½®

-   5.1 æ–‡ä»¶æƒé™è®¾ç½®
-   5.2 æ•°æ®åº“å®‰å…¨
-   5.3 JWT å¯†é’¥ç®¡ç†
-   5.4 HTTPS é…ç½®
-   5.5 é˜²ç«å¢™é…ç½®

### ç¬¬ 6 ç« ï¼šæ€§èƒ½ä¼˜åŒ–

-   6.1 PHP æ€§èƒ½ä¼˜åŒ–
-   6.2 æ•°æ®åº“ä¼˜åŒ–
-   6.3 ç¼“å­˜ç­–ç•¥
-   6.4 é™æ€èµ„æºä¼˜åŒ–
-   6.5 CDN é…ç½®

### ç¬¬ 7 ç« ï¼šç›‘æ§ä¸æ—¥å¿—

-   7.1 åº”ç”¨ç›‘æ§
-   7.2 æœåŠ¡å™¨ç›‘æ§
-   7.3 æ•°æ®åº“ç›‘æ§
-   7.4 æ—¥å¿—ç®¡ç†
-   7.5 å‘Šè­¦é…ç½®

### ç¬¬ 8 ç« ï¼šæ•…éšœæ’é™¤

-   8.1 å¸¸è§é—®é¢˜è¯Šæ–­
    -   8.1.1 åº”ç”¨å¯åŠ¨é—®é¢˜
    -   8.1.2 æ•°æ®åº“è¿æ¥é—®é¢˜
    -   8.1.3 API è®¿é—®é—®é¢˜
-   8.2 æ€§èƒ½é—®é¢˜æ’æŸ¥
    -   8.2.1 å“åº”æ—¶é—´æ…¢
    -   8.2.2 å†…å­˜æ³„æ¼
    -   8.2.3 CPU ä½¿ç”¨ç‡é«˜
-   8.3 å®‰å…¨äº‹ä»¶å¤„ç†
    -   8.3.1 å®‰å…¨æ¼æ´å“åº”
    -   8.3.2 å¼‚å¸¸è®¿é—®æ£€æµ‹
    -   8.3.3 æ•°æ®æ³„éœ²å¤„ç†
-   8.4 æ•…éšœæ¢å¤
    -   8.4.1 æœåŠ¡æ¢å¤æµç¨‹
    -   8.4.2 æ•°æ®ä¿®å¤
    -   8.4.3 ç³»ç»Ÿæ¢å¤éªŒè¯
-   8.5 æ•…éšœé¢„é˜²
    -   8.5.1 å¥åº·æ£€æŸ¥
    -   8.5.2 é¢„è­¦æœºåˆ¶
    -   8.5.3 å®šæœŸå·¡æ£€

### ç¬¬ 9 ç« ï¼šå¤‡ä»½ä¸æ¢å¤

-   9.1 æ•°æ®å¤‡ä»½ç­–ç•¥
-   9.2 ä»£ç å¤‡ä»½
-   9.3 é…ç½®å¤‡ä»½
-   9.4 æ¢å¤æµç¨‹
-   9.5 å¤‡ä»½éªŒè¯

### ç¬¬ 10 ç« ï¼šæ£€æŸ¥æ¸…å•

-   10.1 å‘å¸ƒå‰æ£€æŸ¥
    -   10.1.1 ä»£ç è´¨é‡æ£€æŸ¥
    -   10.1.2 ç¯å¢ƒå‡†å¤‡æ£€æŸ¥
-   10.2 å‘å¸ƒè¿‡ç¨‹æ£€æŸ¥
    -   10.2.1 éƒ¨ç½²æ­¥éª¤éªŒè¯
    -   10.2.2 åŠŸèƒ½ç¡®è®¤æ£€æŸ¥
-   10.3 å‘å¸ƒåæ£€æŸ¥
    -   10.3.1 æœåŠ¡çŠ¶æ€æ£€æŸ¥
    -   10.3.2 ç›‘æ§å‘Šè­¦æ£€æŸ¥
-   10.4 ç´§æ€¥å›æ»šæ£€æŸ¥
    -   10.4.1 å›æ»šæ¡ä»¶éªŒè¯
    -   10.4.2 å›æ»šæ­¥éª¤ç¡®è®¤
-   10.5 å®šæœŸç»´æŠ¤æ£€æŸ¥
    -   10.5.1 ç³»ç»Ÿæ›´æ–°æ£€æŸ¥
    -   10.5.2 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥

### ç¬¬ 11 ç« ï¼šé™„å½•

-   11.1 å¿«é€Ÿå‚è€ƒ
-   11.2 å¸¸ç”¨å‘½ä»¤
-   11.3 é…ç½®æ¨¡æ¿
-   11.4 è„šæœ¬é›†åˆ
-   11.5 è”ç³»æ–¹å¼

---

# ç”Ÿäº§ç¯å¢ƒå‘å¸ƒæ–‡æ¡£

## 1. æ–‡æ¡£æ¦‚è¿°

### 1.1 æ–‡æ¡£ç›®çš„

-   è§„èŒƒåŒ–ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æµç¨‹
-   ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§å’Œå®‰å…¨æ€§
-   æä¾›å®Œæ•´çš„éƒ¨ç½²å’Œè¿ç»´æŒ‡å—
-   é™ä½å‘å¸ƒé£é™©ï¼Œæé«˜å‘å¸ƒæ•ˆç‡

### 1.2 é€‚ç”¨èŒƒå›´

-   ç”Ÿäº§ç¯å¢ƒé¦–æ¬¡éƒ¨ç½²
-   ç”Ÿäº§ç¯å¢ƒç‰ˆæœ¬æ›´æ–°
-   ç´§æ€¥æ•…éšœä¿®å¤éƒ¨ç½²
-   ç³»ç»Ÿè¿ç§»å’Œæ‰©å®¹

### 1.3 ç‰ˆæœ¬ä¿¡æ¯

-   æ–‡æ¡£ç‰ˆæœ¬: v1.0.0
-   åˆ›å»ºæ—¥æœŸ: 2025-11-27
-   æœ€åæ›´æ–°: 2025-11-27
-   ç»´æŠ¤äººå‘˜: è¿ç»´å›¢é˜Ÿã€åç«¯å¼€å‘å›¢é˜Ÿ

### 1.4 è”ç³»ä¿¡æ¯

-   æŠ€æœ¯è´Ÿè´£äºº: [å¾…å¡«å†™]
-   è¿ç»´è´Ÿè´£äºº: [å¾…å¡«å†™]
-   ç´§æ€¥è”ç³»æ–¹å¼: [å¾…å¡«å†™]

---

## 2. å‘å¸ƒå‰å‡†å¤‡

### 2.1 ç¯å¢ƒè¦æ±‚æ£€æŸ¥

#### 2.1.1 æœåŠ¡å™¨ç¡¬ä»¶è¦æ±‚

-   **CPU**: æœ€ä½ 4 æ ¸ï¼Œæ¨è 8 æ ¸ä»¥ä¸Š
-   **å†…å­˜**: æœ€ä½ 8GBï¼Œæ¨è 16GB ä»¥ä¸Š
-   **å­˜å‚¨**: SSD ç¡¬ç›˜ï¼Œæœ€ä½ 100GB å¯ç”¨ç©ºé—´
-   **ç½‘ç»œ**: å¸¦å®½ä¸ä½äº 100Mbps

#### 2.1.2 è½¯ä»¶ç¯å¢ƒè¦æ±‚

-   **æ“ä½œç³»ç»Ÿ**: Ubuntu 20.04 LTS / CentOS 8 / RHEL 8
-   **PHP ç‰ˆæœ¬**: >= 8.2.0
-   **Web æœåŠ¡å™¨**: Nginx >= 1.18 / Apache >= 2.4
-   **æ•°æ®åº“**: MySQL >= 8.0 / MariaDB >= 10.5
-   **ç¼“å­˜**: Redis >= 6.0 (å¯é€‰)

#### 2.1.3 PHP æ‰©å±•æ£€æŸ¥

-   å¿…éœ€æ‰©å±•: ctype, iconv, pdo_mysql, curl, json, mbstring, openssl
-   æ¨èæ‰©å±•: apcu, opcache, redis, imagick, gd

### 2.2 ä¾èµ–æ£€æŸ¥æ¸…å•

#### 2.2.1 Composer ä¾èµ–éªŒè¯

-   ç”Ÿäº§ç¯å¢ƒä¾èµ–åŒ…å®Œæ•´æ€§æ£€æŸ¥
-   ç‰ˆæœ¬å…¼å®¹æ€§éªŒè¯
-   å®‰å…¨æ¼æ´æ‰«æ

#### 2.2.2 ç³»ç»ŸæœåŠ¡ä¾èµ–

-   æ•°æ®åº“æœåŠ¡çŠ¶æ€
-   ç¼“å­˜æœåŠ¡çŠ¶æ€
-   æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡çŠ¶æ€
-   æ—¥å¿—æœåŠ¡çŠ¶æ€

### 2.3 å®‰å…¨é…ç½®å‡†å¤‡

#### 2.3.1 SSL è¯ä¹¦é…ç½®

-   åŸŸå SSL è¯ä¹¦ç”³è¯·å’Œå®‰è£…
-   è¯ä¹¦æœ‰æ•ˆæœŸæ£€æŸ¥
-   HTTPS é…ç½®éªŒè¯

#### 2.3.2 é˜²ç«å¢™é…ç½®

-   ç«¯å£å¼€æ”¾ç­–ç•¥
-   IP ç™½åå•é…ç½®
-   DDoS é˜²æŠ¤è®¾ç½®

#### 2.3.3 JWT å¯†é’¥ç®¡ç†

-   JWT å¯†é’¥å¯¹ç”Ÿæˆ
-   å¯†é’¥å®‰å…¨å­˜å‚¨
-   å¯†é’¥è½®æ¢è®¡åˆ’

---

## 3. ç¯å¢ƒé…ç½®æŒ‡å—

### 3.1 ç”Ÿäº§ç¯å¢ƒå˜é‡é…ç½®

#### 3.1.1 .env.local ç”Ÿäº§ç¯å¢ƒé…ç½®

```bash
# åº”ç”¨ç¯å¢ƒé…ç½®
APP_ENV=prod
APP_SECRET=[è¯·ç”Ÿæˆ32ä½éšæœºå­—ç¬¦ä¸²ï¼Œä¾‹å¦‚ï¼ša1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6]
APP_DEBUG=false

# é»˜è®¤URIé…ç½®
DEFAULT_URI=https://yourdomain.com

# æ•°æ®åº“é…ç½® - ä¸»æ•°æ®åº“ï¼ˆè¯»å†™ï¼‰
DATABASE_URL="mysql://official_user:[å¼ºå¯†ç ]@127.0.0.1:3306/official_website?serverVersion=8.0.32&charset=utf8mb4"

# ç”¨æˆ·æ•°æ®åº“é…ç½® - åªè¯»è®¿é—®
USER_DATABASE_URL="mysql://readonly_user:[åªè¯»ç”¨æˆ·å¯†ç ]@127.0.0.1:3306/official_website_user?serverVersion=8.0.32&charset=utf8mb4"

# JWTè®¤è¯é…ç½®
JWT_SECRET_KEY="%kernel.project_dir%/config/jwt/private.pem"
JWT_PUBLIC_KEY="%kernel.project_dir%/config/jwt/public.pem"
JWT_PASSPHRASE=[è¯·ç”Ÿæˆ40ä½éšæœºå¯†ç ï¼Œä¾‹å¦‚ï¼šx9y8z7w6v5u4t3s2r1q0p9o8n7m6l5k4j3i2h1g]

# CORSå®‰å…¨é…ç½® - ç”Ÿäº§ç¯å¢ƒå¿…é¡»é™åˆ¶åŸŸå
CORS_ALLOW_ORIGIN=["https://yourdomain.com", "https://www.yourdomain.com"]

# å¾®ä¿¡APIé…ç½®ï¼ˆå¦‚æœä½¿ç”¨ï¼‰
WECHAT_APP_ID=[å¾®ä¿¡å…¬ä¼—å·AppID]
WECHAT_APP_SECRET=[å¾®ä¿¡å…¬ä¼—å·AppSecret]

# Redisç¼“å­˜é…ç½®
REDIS_URL="redis://127.0.0.1:6379"

# æ—¥å¿—çº§åˆ«é…ç½®
LOG_LEVEL=error

# ä¼šè¯é…ç½®
SESSION_HANDLER=redis
SESSION_SAVE_PATH="tcp://127.0.0.1:6379"
```

#### 3.1.2 ç”Ÿæˆç”Ÿäº§ç¯å¢ƒå¯†é’¥

```bash
# ç”ŸæˆAPP_SECRET
php -r "echo bin2hex(random_bytes(16)); echo PHP_EOL;"

# ç”ŸæˆJWT_PASSPHRASE
php -r "echo bin2hex(random_bytes(20)); echo PHP_EOL;"

# ç”ŸæˆJWTå¯†é’¥å¯¹
openssl genpkey -out config/jwt/private.pem -aes256 -algorithm RSA -pkeyopt rsa_keygen_bits:4096
openssl rsa -pubout -in config/jwt/private.pem -out config/jwt/public.pem
```

#### 3.1.3 æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–é…ç½®

```yaml
# config/packages/doctrine.yaml - ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
doctrine:
    dbal:
        default_connection: default
        connections:
            default:
                url: "%env(resolve:DATABASE_URL)%"
                driver_options:
                    # è¿æ¥æ± é…ç½®
                    1000: true # PDO::ATTR_EMULATE_PREPARES
                    1002: "SET SESSION sql_mode = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'"
                    3: 2 # PDO::ATTR_ERRMODE -> PDO::ERRMODE_EXCEPTION
                    # è¿æ¥è¶…æ—¶è®¾ç½®
                    20: 30 # PDO::ATTR_TIMEOUT -> 30ç§’
                    # æŒä¹…è¿æ¥é…ç½®
                    12: true # PDO::ATTR_PERSISTENT -> å¯ç”¨æŒä¹…è¿æ¥
            user:
                url: "%env(resolve:USER_DATABASE_URL)%"
                driver_options:
                    1000: true
                    1002: "SET SESSION sql_mode = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'"
                    3: 2
                    20: 30
                    12: true
```

### 3.2 Web æœåŠ¡å™¨é…ç½®

#### 3.2.1 Nginx ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹

```nginx
# /etc/nginx/sites-available/official_website
server {
    listen 80;
    server_name yourdomain.com www.yourdomain.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name yourdomain.com www.yourdomain.com;

    # SSLè¯ä¹¦é…ç½®
    ssl_certificate /etc/ssl/certs/yourdomain.com.crt;
    ssl_certificate_key /etc/ssl/private/yourdomain.com.key;
    ssl_trusted_certificate /etc/ssl/certs/yourdomain.com.ca.crt;

    # SSLå®‰å…¨é…ç½®
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_stapling on;
    ssl_stapling_verify on;

    # æ ¹ç›®å½•é…ç½®
    root /var/www/official_website_backend/public;
    index index.php index.html;

    # æ—¥å¿—é…ç½®
    access_log /var/log/nginx/official_website_access.log;
    error_log /var/log/nginx/official_website_error.log;

    # å®‰å…¨å¤´é…ç½®
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'none';" always;

    # ä¸»è¦è·¯ç”±é…ç½®
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # PHPæ–‡ä»¶å¤„ç†
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_read_timeout 300;
        fastcgi_send_timeout 300;
        fastcgi_connect_timeout 300;
        fastcgi_buffer_size 128k;
        fastcgi_buffers 256 16k;
        fastcgi_busy_buffers_size 256k;
        fastcgi_temp_file_write_size 256k;
    }

    # é™æ€æ–‡ä»¶ç¼“å­˜é…ç½®
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary Accept-Encoding;
        access_log off;
    }

    # APIæ¥å£ç‰¹æ®Šé…ç½®
    location ~ ^/(official-api|public-api)/ {
        try_files $uri $uri/ /index.php?$query_string;
        # APIæ¥å£ä¸ç¼“å­˜
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # ç¦æ­¢è®¿é—®æ•æ„Ÿæ–‡ä»¶
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~ /(config|src|var|vendor|tests|bin|console)/ {
        deny all;
        access_log off;
        log_not_found off;
    }

    # é™åˆ¶è¯·æ±‚å¤§å°
    client_max_body_size 20M;

    # é™åˆ¶è¯·æ±‚é¢‘ç‡
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
    location ~ ^/(official-api|public-api)/ {
        limit_req zone=api burst=20 nodelay;
    }
}
```

#### 3.2.2 Apache ç”Ÿäº§ç¯å¢ƒé…ç½®ç¤ºä¾‹

```apache
# /etc/apache2/sites-available/official_website.conf
<VirtualHost *:80>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com
    Redirect permanent / https://yourdomain.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName yourdomain.com
    ServerAlias www.yourdomain.com
    DocumentRoot /var/www/official_website_backend/public

    # SSLé…ç½®
    SSLEngine on
    SSLCertificateFile /etc/ssl/certs/yourdomain.com.crt
    SSLCertificateKeyFile /etc/ssl/private/yourdomain.com.key
    SSLCertificateChainFile /etc/ssl/certs/yourdomain.com.ca.crt

    # SSLå®‰å…¨é…ç½®
    SSLProtocol all -SSLv2 -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionCache shmcb:/var/run/apache2/ssl_scache(512000)
    SSLSessionCacheTimeout 300

    # å®‰å…¨å¤´é…ç½®
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'none';"

    # æ—¥å¿—é…ç½®
    ErrorLog ${APACHE_LOG_DIR}/official_website_error.log
    CustomLog ${APACHE_LOG_DIR}/official_website_access.log combined

    # ç›®å½•æƒé™é…ç½®
    <Directory /var/www/official_website_backend/public>
        Options -Indexes +FollowSymLinks +MultiViews
        AllowOverride All
        Require all granted

        # é™æ€æ–‡ä»¶ç¼“å­˜
        <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>

        # APIæ¥å£ä¸ç¼“å­˜
        <FilesMatch "index\.php$">
            <If "%{REQUEST_URI} =~ m#^/(official-api|public-api)/#">
                Header set Cache-Control "no-cache, no-store, must-revalidate"
                Header set Pragma "no-cache"
                Header set Expires "0"
            </If>
        </FilesMatch>
    </Directory>

    # ç¦æ­¢è®¿é—®æ•æ„Ÿç›®å½•
    <Directory /var/www/official_website_backend/(config|src|var|vendor|tests|bin)>
        Require all denied
    </Directory>

    # é™åˆ¶è¯·æ±‚å¤§å°
    LimitRequestBody 20971520

    # å¯ç”¨å‹ç¼©
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
    </IfModule>
</VirtualHost>
```

### 3.3 PHP-FPM é…ç½®ä¼˜åŒ–

#### 3.3.1 PHP-FPM ä¸»é…ç½®æ–‡ä»¶

```ini
# /etc/php/8.2/fpm/php.ini - ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–é…ç½®

# åŸºç¡€é…ç½®
max_execution_time = 300
max_input_time = 300
memory_limit = 512M
error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT
display_errors = Off
display_startup_errors = Off
log_errors = On
error_log = /var/log/php8.2-fpm.log

# æ–‡ä»¶ä¸Šä¼ é…ç½®
upload_max_filesize = 20M
post_max_size = 25M
max_file_uploads = 20

# ä¼šè¯é…ç½®
session.save_handler = redis
session.save_path = "tcp://127.0.0.1:6379"
session.gc_maxlifetime = 7200
session.cookie_httponly = On
session.cookie_secure = On
session.cookie_samesite = Strict

# OPcacheä¼˜åŒ–é…ç½®
opcache.enable = 1
opcache.enable_cli = 0
opcache.memory_consumption = 256
opcache.interned_strings_buffer = 8
opcache.max_accelerated_files = 10000
opcache.revalidate_freq = 60
opcache.validate_timestamps = 0  # ç”Ÿäº§ç¯å¢ƒå…³é—­æ—¶é—´æˆ³éªŒè¯ï¼Œé€šè¿‡éƒ¨ç½²è„šæœ¬æ¸…é™¤
opcache.save_comments = 1
opcache.load_comments = 1
opcache.fast_shutdown = 1
opcache.enable_file_override = 1
opcache.optimization_level = 0x7FFEBFFF
opcache.blacklist_filename = /etc/php/8.2/mods-available/opcache.blacklist

# å…¶ä»–ä¼˜åŒ–
realpath_cache_size = 4096K
realpath_cache_ttl = 600
```

#### 3.3.2 PHP-FPM Pool é…ç½®

```ini
# /etc/php/8.2/fpm/pool.d/www.conf - è¿›ç¨‹æ± ä¼˜åŒ–é…ç½®

[www]
user = www-data
group = www-data
listen = /var/run/php/php8.2-fpm.sock
listen.owner = www-data
listen.group = www-data
listen.mode = 0660

# è¿›ç¨‹ç®¡ç†é…ç½® - åŠ¨æ€æ¨¡å¼é€‚åˆä¸­ç­‰æµé‡
pm = dynamic
pm.max_children = 50          # æœ€å¤§å­è¿›ç¨‹æ•°
pm.start_servers = 10          # å¯åŠ¨æ—¶çš„å­è¿›ç¨‹æ•°
pm.min_spare_servers = 5       # æœ€å°ç©ºé—²è¿›ç¨‹æ•°
pm.max_spare_servers = 15      # æœ€å¤§ç©ºé—²è¿›ç¨‹æ•°
pm.max_requests = 500          # æ¯ä¸ªè¿›ç¨‹å¤„ç†çš„æœ€å¤§è¯·æ±‚æ•°åé‡å¯

# è¿›ç¨‹ä¼˜å…ˆçº§
process.priority = -5

# è¿›ç¨‹æ ‡é¢˜
pm.status_path = /status
ping.path = /ping
ping.response = pong

# æ…¢æ—¥å¿—é…ç½®
slowlog = /var/log/php8.2-fpm-slow.log
request_slowlog_timeout = 5s

# å®‰å…¨é…ç½®
security.limit_extensions = .php
rlimit_files = 65536
rlimit_core = 0

# ç¯å¢ƒå˜é‡
env[HOSTNAME] = $HOSTNAME
env[PATH] = /usr/local/bin:/usr/bin:/bin
env[TMP] = /tmp
env[TMPDIR] = /tmp
env[TEMP] = /tmp

# Symfonyä¸“ç”¨ç¯å¢ƒå˜é‡
env[APP_ENV] = prod
env[APP_DEBUG] = 0
```

### 3.4 ç¼“å­˜é…ç½®ä¼˜åŒ–

#### 3.4.1 Redis ç¼“å­˜é…ç½®

```yaml
# config/packages/cache.yaml - Redisç¼“å­˜é…ç½®
framework:
    cache:
        app: cache.adapter.redis
        default_redis_provider: redis://127.0.0.1:6379/1
        prefix_seed: official_website

        pools:
            # DoctrineæŸ¥è¯¢ç¼“å­˜
            doctrine.result_cache_pool:
                adapter: cache.adapter.redis
                provider: redis://127.0.0.1:6379/2
            doctrine.system_cache_pool:
                adapter: cache.adapter.redis
                provider: redis://127.0.0.1:6379/3

            # åº”ç”¨ç¼“å­˜æ± 
            app.cache:
                adapter: cache.adapter.redis
                provider: redis://127.0.0.1:6379/4
                default_lifetime: 3600 # 1å°æ—¶

            # ä¼šè¯ç¼“å­˜
            session.cache:
                adapter: cache.adapter.redis
                provider: redis://127.0.0.1:6379/5
                default_lifetime: 7200 # 2å°æ—¶

            # APIå“åº”ç¼“å­˜
            api.cache:
                adapter: cache.adapter.redis
                provider: redis://127.0.0.1:6379/6
                default_lifetime: 300 # 5åˆ†é’Ÿ
```

#### 3.4.2 Redis æœåŠ¡å™¨é…ç½®

```conf
# /etc/redis/redis.conf - ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–é…ç½®

# åŸºç¡€é…ç½®
port 6379
bind 127.0.0.1
timeout 300
tcp-keepalive 300

# å†…å­˜é…ç½®
maxmemory 2gb
maxmemory-policy allkeys-lru
maxmemory-samples 5

# æŒä¹…åŒ–é…ç½®
save 900 1      # 900ç§’å†…è‡³å°‘1ä¸ªkeyå˜åŒ–æ—¶ä¿å­˜
save 300 10     # 300ç§’å†…è‡³å°‘10ä¸ªkeyå˜åŒ–æ—¶ä¿å­˜
save 60 10000   # 60ç§’å†…è‡³å°‘10000ä¸ªkeyå˜åŒ–æ—¶ä¿å­˜
rdbcompression yes
rdbchecksum yes
dbfilename dump.rdb
dir /var/lib/redis

# AOFé…ç½®
appendonly yes
appendfilename "appendonly.aof"
appendfsync everysec
no-appendfsync-on-rewrite no
auto-aof-rewrite-percentage 100
auto-aof-rewrite-min-size 64mb

# æ—¥å¿—é…ç½®
loglevel notice
logfile /var/log/redis/redis-server.log

# å®‰å…¨é…ç½®
requirepass [å¼ºå¯†ç ]
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command DEBUG ""
rename-command CONFIG ""

# æ€§èƒ½ä¼˜åŒ–
tcp-backlog 511
databases 16
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
list-max-ziplist-size -2
list-compress-depth 0
set-max-intset-entries 512
zset-max-ziplist-entries 128
zset-max-ziplist-value 64
```

#### 3.4.3 APCu ç¼“å­˜é…ç½®ï¼ˆå¯é€‰ï¼‰

```ini
# /etc/php/8.2/mods-available/apcu.ini
extension=apcu.so
apc.enabled=1
apc.enable_cli=0
apc.shm_size=256M
apc.ttl=3600
apc.user_ttl=7200
apc.gc_ttl=3600
apc.num_files_hint=10000
apc.user_entries_hint=10000
apc.mmap_file_mask=/tmp/apc.XXXXXX
apc.slam_defense=100
apc.use_request_time=1
apc.coredump_unmap=0
apc.file_update_protection=2
apc.preload_path=/var/www/official_website_backend/var/cache/prod/apc.php
```

---

## 4. éƒ¨ç½²æµç¨‹

### 4.1 éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

#### 4.1.1 ä»£ç è´¨é‡æ£€æŸ¥

-   [ ] ä»£ç å·²é€šè¿‡æ‰€æœ‰å•å…ƒæµ‹è¯•ï¼ˆ100%é€šè¿‡ç‡ï¼‰
-   [ ] é›†æˆæµ‹è¯•é€šè¿‡
-   [ ] ä»£ç å®¡æŸ¥å®Œæˆï¼ˆè‡³å°‘ 2 äººå®¡æŸ¥ï¼‰
-   [ ] é™æ€ä»£ç åˆ†æé€šè¿‡ï¼ˆPHPStan çº§åˆ« 8+ï¼‰
-   [ ] å®‰å…¨æ‰«æé€šè¿‡ï¼ˆæ— é«˜å±æ¼æ´ï¼‰
-   [ ] ç‰ˆæœ¬æ ‡è®°æ­£ç¡®ï¼ˆè¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼‰
-   [ ] å˜æ›´æ—¥å¿—æ›´æ–°å®Œæˆ

#### 4.1.2 ç¯å¢ƒå‡†å¤‡æ£€æŸ¥

-   [ ] æœåŠ¡å™¨èµ„æºå……è¶³ï¼ˆCPU < 80%, å†…å­˜ < 80%, ç£ç›˜ > 20%ï¼‰
-   [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸ï¼ˆä¸»åº“å’Œç”¨æˆ·åº“ï¼‰
-   [ ] Redis ç¼“å­˜æœåŠ¡å¯ç”¨
-   [ ] SSL è¯ä¹¦æœ‰æ•ˆæœŸ > 30 å¤©
-   [ ] å¤‡ä»½å­˜å‚¨ç©ºé—´å……è¶³
-   [ ] ç›‘æ§ç³»ç»Ÿæ­£å¸¸è¿è¡Œ
-   [ ] æ—¥å¿—è½®è½¬é…ç½®æ­£ç¡®

#### 4.1.3 é…ç½®æ–‡ä»¶éªŒè¯

-   [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®ï¼ˆ.env.localï¼‰
-   [ ] JWT å¯†é’¥æ–‡ä»¶å­˜åœ¨ä¸”æƒé™æ­£ç¡®
-   [ ] æ•°æ®åº“è¿æ¥é…ç½®éªŒè¯é€šè¿‡
-   [ ] CORS é…ç½®ç¬¦åˆç”Ÿäº§ç¯å¢ƒè¦æ±‚
-   [ ] ç¼“å­˜é…ç½®æ­£ç¡®ï¼ˆRedis/APCuï¼‰
-   [ ] æ—¥å¿—çº§åˆ«è®¾ç½®ä¸º error
-   [ ] å®‰å…¨é…ç½®ï¼ˆsecurity.yamlï¼‰æ­£ç¡®

### 4.2 è¯¦ç»†éƒ¨ç½²æ­¥éª¤

#### 4.2.1 ç¬¬ä¸€æ­¥ï¼šå¤‡ä»½å½“å‰ç¯å¢ƒ

```bash
#!/bin/bash
# éƒ¨ç½²å‰å¤‡ä»½è„šæœ¬
set -e

BACKUP_DIR="/backup/$(date +%Y%m%d_%H%M%S)"
APP_DIR="/var/www/official_website_backend"

echo "å¼€å§‹å¤‡ä»½å½“å‰ç¯å¢ƒ..."

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½åº”ç”¨ä»£ç ï¼ˆæ’é™¤ä¸å¿…è¦çš„ç›®å½•ï¼‰
echo "å¤‡ä»½åº”ç”¨ä»£ç ..."
tar -czf $BACKUP_DIR/app_backup.tar.gz \
    --exclude=$APP_DIR/var/cache \
    --exclude=$APP_DIR/var/log \
    --exclude=$APP_DIR/vendor \
    --exclude=$APP_DIR/node_modules \
    -C $(dirname $APP_DIR) $(basename $APP_DIR)

# å¤‡ä»½æ•°æ®åº“
echo "å¤‡ä»½ä¸»æ•°æ®åº“..."
mysqldump --single-transaction --routines --triggers \
    -u root -p official_website | gzip > $BACKUP_DIR/main_db_backup.sql.gz

echo "å¤‡ä»½ç”¨æˆ·æ•°æ®åº“..."
mysqldump --single-transaction --routines --triggers \
    -u root -p official_website_user | gzip > $BACKUP_DIR/user_db_backup.sql.gz

# å¤‡ä»½é…ç½®æ–‡ä»¶
echo "å¤‡ä»½é…ç½®æ–‡ä»¶..."
cp $APP_DIR/.env.local $BACKUP_DIR/env_local.backup
cp -r $APP_DIR/config/jwt $BACKUP_DIR/jwt_keys.backup

# å¤‡ä»½å½“å‰ç‰ˆæœ¬ä¿¡æ¯
cd $APP_DIR
git rev-parse HEAD > $BACKUP_DIR/git_commit.hash
git log --oneline -5 > $BACKUP_DIR/git_history.log

echo "å¤‡ä»½å®Œæˆï¼š$BACKUP_DIR"
ls -la $BACKUP_DIR
```

#### 4.2.2 ç¬¬äºŒæ­¥ï¼šä»£ç éƒ¨ç½²

```bash
#!/bin/bash
# ä»£ç éƒ¨ç½²è„šæœ¬
set -e

APP_DIR="/var/www/official_website_backend"
TARGET_BRANCH=$1
TARGET_TAG=$2

if [ -z "$TARGET_BRANCH" ] && [ -z "$TARGET_TAG" ]; then
    echo "ç”¨æ³•: $0 <branch_name> [tag_name]"
    exit 1
fi

echo "å¼€å§‹ä»£ç éƒ¨ç½²..."
cd $APP_DIR

# æ£€æŸ¥å½“å‰çŠ¶æ€
echo "æ£€æŸ¥å½“å‰GitçŠ¶æ€..."
if [ -n "$(git status --porcelain)" ]; then
    echo "é”™è¯¯ï¼šå·¥ä½œç›®å½•æœ‰æœªæäº¤çš„æ›´æ”¹"
    exit 1
fi

# æ‹‰å–æœ€æ–°ä»£ç 
echo "æ‹‰å–æœ€æ–°ä»£ç ..."
git fetch origin --tags

if [ -n "$TARGET_TAG" ]; then
    echo "åˆ‡æ¢åˆ°æ ‡ç­¾: $TARGET_TAG"
    git checkout $TARGET_TAG
else
    echo "åˆ‡æ¢åˆ°åˆ†æ”¯: $TARGET_BRANCH"
    git checkout $TARGET_BRANCH
    git pull origin $TARGET_BRANCH
fi

# éªŒè¯ä»£ç ç‰ˆæœ¬
echo "éªŒè¯ä»£ç ç‰ˆæœ¬..."
git log --oneline -3
echo "å½“å‰æäº¤: $(git rev-parse --short HEAD)"

# æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§
echo "æ£€æŸ¥å…³é”®æ–‡ä»¶..."
REQUIRED_FILES=("composer.json" "symfony.lock" "public/index.php" "src/Kernel.php")
for file in "${REQUIRED_FILES[@]}"; do
    if [ ! -f "$file" ]; then
        echo "é”™è¯¯ï¼šç¼ºå°‘å¿…è¦æ–‡ä»¶ $file"
        exit 1
    fi
done

echo "ä»£ç éƒ¨ç½²å®Œæˆ"
```

#### 4.2.3 ç¬¬ä¸‰æ­¥ï¼šä¾èµ–å®‰è£…å’Œä¼˜åŒ–

```bash
#!/bin/bash
# ä¾èµ–å®‰è£…è„šæœ¬
set -e

APP_DIR="/var/www/official_website_backend"

echo "å¼€å§‹å®‰è£…ä¾èµ–..."
cd $APP_DIR

# æ¸…ç†æ—§çš„Composerç¼“å­˜
echo "æ¸…ç†Composerç¼“å­˜..."
composer clear-cache

# å®‰è£…ç”Ÿäº§ä¾èµ–
echo "å®‰è£…Composerç”Ÿäº§ä¾èµ–..."
COMPOSER_MEMORY_LIMIT=-1 composer install \
    --no-dev \
    --optimize-autoloader \
    --no-interaction \
    --no-progress \
    --prefer-dist

# éªŒè¯ä¾èµ–
echo "éªŒè¯ä¾èµ–å®Œæ•´æ€§..."
composer validate --no-check-all --strict

# æ£€æŸ¥å®‰å…¨æ¼æ´
echo "æ£€æŸ¥å®‰å…¨æ¼æ´..."
composer audit

# ä¼˜åŒ–Composerè‡ªåŠ¨åŠ è½½
echo "ä¼˜åŒ–è‡ªåŠ¨åŠ è½½..."
composer dump-autoload --optimize --classmap-authoritative

# æ¸…ç†å¼€å‘ä¾èµ–æ–‡ä»¶
echo "æ¸…ç†å¼€å‘æ–‡ä»¶..."
rm -rf var/cache/dev
rm -rf var/cache/test
rm -f phpunit.xml.dist
rm -f .phpunit.result.cache

echo "ä¾èµ–å®‰è£…å®Œæˆ"
```

#### 4.2.4 ç¬¬å››æ­¥ï¼šç¼“å­˜æ¸…ç†å’Œé¢„çƒ­

```bash
#!/bin/bash
# ç¼“å­˜ç®¡ç†è„šæœ¬
set -e

APP_DIR="/var/www/official_website_backend"

echo "å¼€å§‹ç¼“å­˜ç®¡ç†..."
cd $APP_DIR

# æ¸…é™¤æ‰€æœ‰ç¼“å­˜
echo "æ¸…é™¤Symfonyç¼“å­˜..."
php bin/console cache:clear --env=prod --no-warmup

# æ¸…é™¤Redisç¼“å­˜
echo "æ¸…é™¤Redisç¼“å­˜..."
redis-cli -n 1 FLUSHDB  # æ¸…é™¤åº”ç”¨ç¼“å­˜
redis-cli -n 2 FLUSHDB  # æ¸…é™¤Doctrineç»“æœç¼“å­˜
redis-cli -n 3 FLUSHDB  # æ¸…é™¤Doctrineç³»ç»Ÿç¼“å­˜
redis-cli -n 6 FLUSHDB  # æ¸…é™¤APIç¼“å­˜

# é‡ç½®OPcache
echo "é‡ç½®OPcache..."
if command -v php-fpm8.2 &> /dev/null; then
    # é€šè¿‡é‡å¯PHP-FPMé‡ç½®OPcache
    systemctl reload php8.2-fpm
else
    # é€šè¿‡CLIé‡ç½®OPcache
    php -r "if (function_exists('opcache_reset')) { opcache_reset(); echo 'OPcache reset successfully\n'; }"
fi

# é¢„çƒ­ç¼“å­˜
echo "é¢„çƒ­ç”Ÿäº§ç¼“å­˜..."
php bin/console cache:warmup --env=prod

# é¢„çƒ­è·¯ç”±ç¼“å­˜
echo "é¢„çƒ­è·¯ç”±ç¼“å­˜..."
php bin/console cache:pool:clear cache.app --env=prod
php bin/console router:match / --env=prod > /dev/null 2>&1

# é¢„çƒ­Doctrineç¼“å­˜
echo "é¢„çƒ­Doctrineç¼“å­˜..."
php bin/console doctrine:cache:clear-metadata --env=prod
php bin/console doctrine:cache:clear-query --env=prod
php bin/console doctrine:cache:clear-result --env=prod

# é¢„çƒ­ç”¨æˆ·æ•°æ®åº“ç¼“å­˜
echo "é¢„çƒ­ç”¨æˆ·æ•°æ®åº“ç¼“å­˜..."
php bin/console doctrine:cache:clear-metadata --env=prod --em=user
php bin/console doctrine:cache:clear-query --env=prod --em=user
php bin/console doctrine:cache:clear-result --env=prod --em=user

echo "ç¼“å­˜ç®¡ç†å®Œæˆ"
```

#### 4.2.5 ç¬¬äº”æ­¥ï¼šæ•°æ®åº“è¿ç§»

```bash
#!/bin/bash
# æ•°æ®åº“è¿ç§»è„šæœ¬
set -e

APP_DIR="/var/www/official_website_backend"

echo "å¼€å§‹æ•°æ®åº“è¿ç§»..."
cd $APP_DIR

# æ£€æŸ¥è¿ç§»çŠ¶æ€
echo "æ£€æŸ¥ä¸»æ•°æ®åº“è¿ç§»çŠ¶æ€..."
php bin/console doctrine:migrations:status --env=prod

echo "æ£€æŸ¥ç”¨æˆ·æ•°æ®åº“è¿ç§»çŠ¶æ€..."
php bin/console doctrine:migrations:status --env=prod --em=user

# æ‰§è¡Œä¸»æ•°æ®åº“è¿ç§»
echo "æ‰§è¡Œä¸»æ•°æ®åº“è¿ç§»..."
php bin/console doctrine:migrations:migrate --env=prod --no-interaction

# æ‰§è¡Œç”¨æˆ·æ•°æ®åº“è¿ç§»
echo "æ‰§è¡Œç”¨æˆ·æ•°æ®åº“è¿ç§»..."
php bin/console doctrine:migrations:migrate --env=prod --em=user --no-interaction

# éªŒè¯æ•°æ®åº“ç»“æ„
echo "éªŒè¯ä¸»æ•°æ®åº“ç»“æ„..."
php bin/console doctrine:schema:validate --env=prod

echo "éªŒè¯ç”¨æˆ·æ•°æ®åº“ç»“æ„..."
php bin/console doctrine:schema:validate --env=prod --em=user

# æ›´æ–°æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
echo "æ›´æ–°æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯..."
mysql -u root -p -e "ANALYZE TABLE official_website.*;" 2>/dev/null || true
mysql -u root -p -e "ANALYZE TABLE official_website_user.*;" 2>/dev/null || true

echo "æ•°æ®åº“è¿ç§»å®Œæˆ"
```

#### 4.2.6 ç¬¬å…­æ­¥ï¼šæƒé™å’Œå®‰å…¨è®¾ç½®

```bash
#!/bin/bash
# æƒé™è®¾ç½®è„šæœ¬
set -e

APP_DIR="/var/www/official_website_backend"
WEB_USER="www-data"

echo "å¼€å§‹è®¾ç½®æƒé™..."

# è®¾ç½®åŸºæœ¬ç›®å½•æƒé™
echo "è®¾ç½®åŸºæœ¬ç›®å½•æƒé™..."
chown -R $WEB_USER:$WEB_USER $APP_DIR
find $APP_DIR -type d -exec chmod 755 {} \;
find $APP_DIR -type f -exec chmod 644 {} \;

# è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶æƒé™
echo "è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶æƒé™..."
chmod +x $APP_DIR/bin/console
find $APP_DIR/bin -type f -exec chmod 755 {} \;

# è®¾ç½®ç¼“å­˜å’Œæ—¥å¿—ç›®å½•æƒé™
echo "è®¾ç½®ç¼“å­˜å’Œæ—¥å¿—ç›®å½•æƒé™..."
chmod -R 775 $APP_DIR/var/cache
chmod -R 775 $APP_DIR/var/log

# è®¾ç½®JWTå¯†é’¥æ–‡ä»¶æƒé™
echo "è®¾ç½®JWTå¯†é’¥æ–‡ä»¶æƒé™..."
if [ -d "$APP_DIR/config/jwt" ]; then
    chown -R $WEB_USER:$WEB_USER $APP_DIR/config/jwt
    chmod 600 $APP_DIR/config/jwt/private.pem
    chmod 644 $APP_DIR/config/jwt/public.pem
fi

# è®¾ç½®ä¸Šä¼ ç›®å½•æƒé™ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
if [ -d "$APP_DIR/public/uploads" ]; then
    chown -R $WEB_USER:$WEB_USER $APP_DIR/public/uploads
    chmod -R 775 $APP_DIR/public/uploads
fi

# æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶æƒé™
echo "æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶æƒé™..."
SENSITIVE_FILES=("$APP_DIR/.env.local" "$APP_DIR/config/jwt/private.pem")
for file in "${SENSITIVE_FILES[@]}"; do
    if [ -f "$file" ]; then
        chmod 600 "$file"
        chown $WEB_USER:$WEB_USER "$file"
    fi
done

# éªŒè¯æƒé™è®¾ç½®
echo "éªŒè¯æƒé™è®¾ç½®..."
if [ -w "$APP_DIR/var/cache" ] && [ -w "$APP_DIR/var/log" ]; then
    echo "æƒé™è®¾ç½®æˆåŠŸ"
else
    echo "è­¦å‘Šï¼šç¼“å­˜æˆ–æ—¥å¿—ç›®å½•æƒé™å¯èƒ½ä¸æ­£ç¡®"
fi

echo "æƒé™è®¾ç½®å®Œæˆ"
```

#### 4.2.7 ç¬¬ä¸ƒæ­¥ï¼šæœåŠ¡é‡å¯å’ŒéªŒè¯

```bash
#!/bin/bash
# æœåŠ¡é‡å¯è„šæœ¬
set -e

echo "å¼€å§‹é‡å¯æœåŠ¡..."

# é‡å¯PHP-FPM
echo "é‡å¯PHP-FPM..."
systemctl restart php8.2-fpm
if ! systemctl is-active --quiet php8.2-fpm; then
    echo "é”™è¯¯ï¼šPHP-FPMå¯åŠ¨å¤±è´¥"
    systemctl status php8.2-fpm
    exit 1
fi

# é‡å¯Redis
echo "é‡å¯Redis..."
systemctl restart redis-server
if ! systemctl is-active --quiet redis-server; then
    echo "é”™è¯¯ï¼šRediså¯åŠ¨å¤±è´¥"
    systemctl status redis-server
    exit 1
fi

# æµ‹è¯•Nginxé…ç½®
echo "æµ‹è¯•Nginxé…ç½®..."
nginx -t
if [ $? -eq 0 ]; then
    echo "é‡å¯Nginx..."
    systemctl reload nginx
    if ! systemctl is-active --quiet nginx; then
        echo "é”™è¯¯ï¼šNginxå¯åŠ¨å¤±è´¥"
        systemctl status nginx
        exit 1
    fi
else
    echo "é”™è¯¯ï¼šNginxé…ç½®æµ‹è¯•å¤±è´¥"
    exit 1
fi

# éªŒè¯æœåŠ¡çŠ¶æ€
echo "éªŒè¯æœåŠ¡çŠ¶æ€..."
systemctl is-active php8.2-fpm && echo "âœ“ PHP-FPM è¿è¡Œæ­£å¸¸"
systemctl is-active nginx && echo "âœ“ Nginx è¿è¡Œæ­£å¸¸"
systemctl is-active redis-server && echo "âœ“ Redis è¿è¡Œæ­£å¸¸"

# æµ‹è¯•PHP-FPMè¿æ¥
echo "æµ‹è¯•PHP-FPMè¿æ¥..."
SCRIPT_FILENAME=/var/www/official_website_backend/public/index.php
REQUEST_METHOD=GET
cgi-fcgi -bind -connect /var/run/php/php8.2-fpm.sock

echo "æœåŠ¡é‡å¯å®Œæˆ"
```

### 4.3 å®Œæ•´éƒ¨ç½²è„šæœ¬

```bash
#!/bin/bash
# å®Œæ•´éƒ¨ç½²è„šæœ¬ - deploy.sh
# ç”¨æ³•: ./deploy.sh <branch_name> [tag_name]

set -e

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# æ£€æŸ¥å‚æ•°
if [ $# -lt 1 ]; then
    log_error "ç”¨æ³•: $0 <branch_name> [tag_name]"
    exit 1
fi

BRANCH=$1
TAG=$2
APP_DIR="/var/www/official_website_backend"
BACKUP_DIR="/backup/$(date +%Y%m%d_%H%M%S)"
DEPLOY_START_TIME=$(date +%s)

log_info "å¼€å§‹éƒ¨ç½²æµç¨‹..."
log_info "ç›®æ ‡åˆ†æ”¯: $BRANCH"
if [ -n "$TAG" ]; then
    log_info "ç›®æ ‡æ ‡ç­¾: $TAG"
fi

# åˆ›å»ºå¤‡ä»½
log_info "åˆ›å»ºå¤‡ä»½..."
mkdir -p $BACKUP_DIR
cd $APP_DIR

# æ‰§è¡Œå„ä¸ªéƒ¨ç½²æ­¥éª¤
log_info "æ­¥éª¤ 1/7: å¤‡ä»½å½“å‰ç¯å¢ƒ"
./scripts/backup.sh

log_info "æ­¥éª¤ 2/7: éƒ¨ç½²ä»£ç "
./scripts/deploy_code.sh $BRANCH $TAG

log_info "æ­¥éª¤ 3/7: å®‰è£…ä¾èµ–"
./scripts/install_dependencies.sh

log_info "æ­¥éª¤ 4/7: ç®¡ç†ç¼“å­˜"
./scripts/manage_cache.sh

log_info "æ­¥éª¤ 5/7: æ•°æ®åº“è¿ç§»"
./scripts/migrate_database.sh

log_info "æ­¥éª¤ 6/7: è®¾ç½®æƒé™"
./scripts/set_permissions.sh

log_info "æ­¥éª¤ 7/7: é‡å¯æœåŠ¡"
./scripts/restart_services.sh

# éƒ¨ç½²åéªŒè¯
log_info "æ‰§è¡Œéƒ¨ç½²åéªŒè¯..."
./scripts/post_deploy_verification.sh

# è®¡ç®—éƒ¨ç½²æ—¶é—´
DEPLOY_END_TIME=$(date +%s)
DEPLOY_DURATION=$((DEPLOY_END_TIME - DEPLOY_START_TIME))

log_info "éƒ¨ç½²å®Œæˆï¼"
log_info "éƒ¨ç½²è€—æ—¶: ${DEPLOY_DURATION}ç§’"
log_info "å¤‡ä»½ä½ç½®: $BACKUP_DIR"

# å‘é€é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
if [ -f "./scripts/send_notification.sh" ]; then
    ./scripts/send_notification.sh "success" "åº”ç”¨éƒ¨ç½²æˆåŠŸå®Œæˆ"
fi
```

### 4.3 éƒ¨ç½²åéªŒè¯

#### 4.3.1 åŸºæœ¬åŠŸèƒ½éªŒè¯

-   [ ] é¦–é¡µè®¿é—®æ­£å¸¸ï¼ˆHTTP 200ï¼‰
-   [ ] API æ¥å£å“åº”æ­£å¸¸ï¼ˆ/official-api, /public-apiï¼‰
-   [ ] æ•°æ®åº“è¿æ¥æ­£å¸¸ï¼ˆä¸»åº“å’Œç”¨æˆ·åº“ï¼‰
-   [ ] JWT è®¤è¯åŠŸèƒ½æ­£å¸¸
-   [ ] é™æ€èµ„æºåŠ è½½æ­£å¸¸
-   [ ] SSL è¯ä¹¦é…ç½®æ­£ç¡®
-   [ ] å®‰å…¨å¤´é…ç½®ç”Ÿæ•ˆ

#### 4.3.2 æ€§èƒ½éªŒè¯

-   [ ] é¡µé¢åŠ è½½æ—¶é—´ < 2 ç§’
-   [ ] API å“åº”æ—¶é—´ < 500ms
-   [ ] æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½æ­£å¸¸
-   [ ] å†…å­˜ä½¿ç”¨ç‡ < 80%
-   [ ] CPU ä½¿ç”¨ç‡ < 70%
-   [ ] ç¼“å­˜å‘½ä¸­ç‡ > 90%

#### 4.3.3 éƒ¨ç½²åéªŒè¯è„šæœ¬

```bash
#!/bin/bash
# éƒ¨ç½²åéªŒè¯è„šæœ¬ - post_deploy_verification.sh
set -e

# é¢œè‰²è¾“å‡º
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# é…ç½®
APP_URL="https://yourdomain.com"
API_BASE_URL="$APP_URL/official-api"
PUBLIC_API_BASE_URL="$APP_URL/public-api"
LOG_FILE="/tmp/deploy_verification_$(date +%Y%m%d_%H%M%S).log"

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1" | tee -a $LOG_FILE
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1" | tee -a $LOG_FILE
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" | tee -a $LOG_FILE
}

# æ£€æŸ¥å‡½æ•°
check_http_status() {
    local url=$1
    local expected_status=${2:-200}
    local description=$3

    log_info "æ£€æŸ¥: $description ($url)"

    local status=$(curl -s -o /dev/null -w "%{http_code}" "$url" --max-time 10)

    if [ "$status" -eq "$expected_status" ]; then
        log_info "âœ“ $description - HTTP $status"
        return 0
    else
        log_error "âœ— $description - HTTP $status (æœŸæœ›: $expected_status)"
        return 1
    fi
}

# æ£€æŸ¥å“åº”æ—¶é—´
check_response_time() {
    local url=$1
    local max_time=$2
    local description=$3

    log_info "æ£€æŸ¥å“åº”æ—¶é—´: $description"

    local response_time=$(curl -s -o /dev/null -w "%{time_total}" "$url" --max-time 10)

    if (( $(echo "$response_time < $max_time" | bc -l) )); then
        log_info "âœ“ $description - ${response_time}s (< ${max_time}s)"
        return 0
    else
        log_error "âœ— $description - ${response_time}s (> ${max_time}s)"
        return 1
    fi
}

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
check_database_connection() {
    log_info "æ£€æŸ¥æ•°æ®åº“è¿æ¥..."

    # æ£€æŸ¥ä¸»æ•°æ®åº“
    if php bin/console doctrine:database:exists --env=prod > /dev/null 2>&1; then
        log_info "âœ“ ä¸»æ•°æ®åº“è¿æ¥æ­£å¸¸"
    else
        log_error "âœ— ä¸»æ•°æ®åº“è¿æ¥å¤±è´¥"
        return 1
    fi

    # æ£€æŸ¥ç”¨æˆ·æ•°æ®åº“
    if php bin/console doctrine:database:exists --env=prod --em=user > /dev/null 2>&1; then
        log_info "âœ“ ç”¨æˆ·æ•°æ®åº“è¿æ¥æ­£å¸¸"
    else
        log_error "âœ— ç”¨æˆ·æ•°æ®åº“è¿æ¥å¤±è´¥"
        return 1
    fi
}

# æ£€æŸ¥ç¼“å­˜çŠ¶æ€
check_cache_status() {
    log_info "æ£€æŸ¥ç¼“å­˜çŠ¶æ€..."

    # æ£€æŸ¥Redis
    if redis-cli ping > /dev/null 2>&1; then
        log_info "âœ“ Redis æœåŠ¡æ­£å¸¸"

        # æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
        local hits=$(redis-cli info stats | grep keyspace_hits | cut -d: -f2)
        local misses=$(redis-cli info stats | grep keyspace_misses | cut -d: -f2)

        if [ "$hits" -gt 0 ] || [ "$misses" -gt 0 ]; then
            local total=$((hits + misses))
            local hit_rate=$((hits * 100 / total))

            if [ "$hit_rate" -gt 90 ]; then
                log_info "âœ“ Redis ç¼“å­˜å‘½ä¸­ç‡: ${hit_rate}%"
            else
                log_warn "âš  Redis ç¼“å­˜å‘½ä¸­ç‡è¾ƒä½: ${hit_rate}%"
            fi
        fi
    else
        log_error "âœ— Redis æœåŠ¡å¼‚å¸¸"
        return 1
    fi
}

# æ£€æŸ¥ç³»ç»Ÿèµ„æº
check_system_resources() {
    log_info "æ£€æŸ¥ç³»ç»Ÿèµ„æº..."

    # æ£€æŸ¥å†…å­˜ä½¿ç”¨
    local memory_usage=$(free | grep Mem | awk '{printf("%.1f", $3/$2 * 100.0)}')
    if (( $(echo "$memory_usage < 80" | bc -l) )); then
        log_info "âœ“ å†…å­˜ä½¿ç”¨ç‡: ${memory_usage}%"
    else
        log_warn "âš  å†…å­˜ä½¿ç”¨ç‡è¾ƒé«˜: ${memory_usage}%"
    fi

    # æ£€æŸ¥CPUä½¿ç”¨
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d% -f1)
    if (( $(echo "$cpu_usage < 70" | bc -l) )); then
        log_info "âœ“ CPUä½¿ç”¨ç‡: ${cpu_usage}%"
    else
        log_warn "âš  CPUä½¿ç”¨ç‡è¾ƒé«˜: ${cpu_usage}%"
    fi

    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    local disk_usage=$(df /var/www/official_website_backend | tail -1 | awk '{print $5}' | cut -d% -f1)
    if [ "$disk_usage" -lt 80 ]; then
        log_info "âœ“ ç£ç›˜ä½¿ç”¨ç‡: ${disk_usage}%"
    else
        log_warn "âš  ç£ç›˜ä½¿ç”¨ç‡è¾ƒé«˜: ${disk_usage}%"
    fi
}

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_service_status() {
    log_info "æ£€æŸ¥æœåŠ¡çŠ¶æ€..."

    local services=("nginx" "php8.2-fpm" "redis-server")

    for service in "${services[@]}"; do
        if systemctl is-active --quiet "$service"; then
            log_info "âœ“ $service è¿è¡Œæ­£å¸¸"
        else
            log_error "âœ— $service æœåŠ¡å¼‚å¸¸"
            return 1
        fi
    done
}

# æ£€æŸ¥SSLè¯ä¹¦
check_ssl_certificate() {
    log_info "æ£€æŸ¥SSLè¯ä¹¦..."

    local cert_info=$(echo | openssl s_client -servername yourdomain.com -connect yourdomain.com:443 2>/dev/null | openssl x509 -noout -dates)
    local expiry_date=$(echo "$cert_info" | grep "notAfter" | cut -d= -f2)
    local expiry_timestamp=$(date -d "$expiry_date" +%s)
    local current_timestamp=$(date +%s)
    local days_until_expiry=$(( (expiry_timestamp - current_timestamp) / 86400 ))

    if [ "$days_until_expiry" -gt 30 ]; then
        log_info "âœ“ SSLè¯ä¹¦æœ‰æ•ˆï¼Œè¿˜æœ‰ ${days_until_expiry} å¤©è¿‡æœŸ"
    else
        log_warn "âš  SSLè¯ä¹¦å°†åœ¨ ${days_until_expiry} å¤©åè¿‡æœŸ"
    fi
}

# æ£€æŸ¥å®‰å…¨å¤´
check_security_headers() {
    log_info "æ£€æŸ¥å®‰å…¨å¤´..."

    local security_headers=$(curl -s -I "$APP_URL" | grep -E "(X-Frame-Options|X-Content-Type-Options|X-XSS-Protection|Strict-Transport-Security)")

    if echo "$security_headers" | grep -q "X-Frame-Options"; then
        log_info "âœ“ X-Frame-Options å¤´å­˜åœ¨"
    else
        log_warn "âš  X-Frame-Options å¤´ç¼ºå¤±"
    fi

    if echo "$security_headers" | grep -q "X-Content-Type-Options"; then
        log_info "âœ“ X-Content-Type-Options å¤´å­˜åœ¨"
    else
        log_warn "âš  X-Content-Type-Options å¤´ç¼ºå¤±"
    fi

    if echo "$security_headers" | grep -q "X-XSS-Protection"; then
        log_info "âœ“ X-XSS-Protection å¤´å­˜åœ¨"
    else
        log_warn "âš  X-XSS-Protection å¤´ç¼ºå¤±"
    fi

    if echo "$security_headers" | grep -q "Strict-Transport-Security"; then
        log_info "âœ“ Strict-Transport-Security å¤´å­˜åœ¨"
    else
        log_warn "âš  Strict-Transport-Security å¤´ç¼ºå¤±"
    fi
}

# ä¸»éªŒè¯æµç¨‹
main() {
    log_info "å¼€å§‹éƒ¨ç½²åéªŒè¯..."
    log_info "éªŒè¯æ—¶é—´: $(date)"
    log_info "åº”ç”¨URL: $APP_URL"

    local failed_checks=0

    # åŸºæœ¬åŠŸèƒ½æ£€æŸ¥
    check_http_status "$APP_URL" 200 "é¦–é¡µè®¿é—®" || ((failed_checks++))
    check_http_status "$API_BASE_URL/docs" 200 "APIæ–‡æ¡£" || ((failed_checks++))
    check_http_status "$PUBLIC_API_BASE_URL/news" 200 "å…¬å…±API" || ((failed_checks++))

    # æ€§èƒ½æ£€æŸ¥
    check_response_time "$APP_URL" 2 "é¦–é¡µå“åº”æ—¶é—´" || ((failed_checks++))
    check_response_time "$API_BASE_URL/docs" 1 "APIæ–‡æ¡£å“åº”æ—¶é—´" || ((failed_checks++))

    # ç³»ç»Ÿæ£€æŸ¥
    check_database_connection || ((failed_checks++))
    check_cache_status || ((failed_checks++))
    check_system_resources || ((failed_checks++))
    check_service_status || ((failed_checks++))

    # å®‰å…¨æ£€æŸ¥
    check_ssl_certificate || ((failed_checks++))
    check_security_headers || ((failed_checks++))

    # éªŒè¯ç»“æœ
    log_info "éªŒè¯å®Œæˆ"
    log_info "è¯¦ç»†æ—¥å¿—: $LOG_FILE"

    if [ "$failed_checks" -eq 0 ]; then
        log_info "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼éƒ¨ç½²éªŒè¯æˆåŠŸ"
        return 0
    else
        log_error "âŒ å‘ç° $failed_checks ä¸ªé—®é¢˜ï¼Œè¯·æ£€æŸ¥å¹¶ä¿®å¤"
        return 1
    fi
}

# æ‰§è¡ŒéªŒè¯
main "$@"
```

### 4.4 éƒ¨ç½²é€šçŸ¥è„šæœ¬

```bash
#!/bin/bash
# éƒ¨ç½²é€šçŸ¥è„šæœ¬ - send_notification.sh
# ç”¨æ³•: ./send_notification.sh <status> <message>

STATUS=$1
MESSAGE=$2
WEBHOOK_URL="[é’‰é’‰/Slack/ä¼ä¸šå¾®ä¿¡WebhookURL]"

# é¢œè‰²å®šä¹‰
if [ "$STATUS" = "success" ]; then
    COLOR="good"
    EMOJI="âœ…"
    TITLE="éƒ¨ç½²æˆåŠŸ"
elif [ "$STATUS" = "failure" ]; then
    COLOR="danger"
    EMOJI="âŒ"
    TITLE="éƒ¨ç½²å¤±è´¥"
elif [ "$STATUS" = "warning" ]; then
    COLOR="warning"
    EMOJI="âš ï¸"
    TITLE="éƒ¨ç½²è­¦å‘Š"
else
    COLOR="gray"
    EMOJI="â„¹ï¸"
    TITLE="éƒ¨ç½²é€šçŸ¥"
fi

# è·å–éƒ¨ç½²ä¿¡æ¯
DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S')
DEPLOY_USER=$(whoami)
DEPLOY_BRANCH=$(git rev-parse --abbrev-ref HEAD)
DEPLOY_COMMIT=$(git rev-parse --short HEAD)

# æ„å»ºé€šçŸ¥å†…å®¹
cat > /tmp/deploy_notification.json << EOF
{
    "attachments": [
        {
            "color": "$COLOR",
            "title": "$EMOJI $TITLE",
            "fields": [
                {
                    "title": "éƒ¨ç½²æ—¶é—´",
                    "value": "$DEPLOY_TIME",
                    "short": true
                },
                {
                    "title": "éƒ¨ç½²ç”¨æˆ·",
                    "value": "$DEPLOY_USER",
                    "short": true
                },
                {
                    "title": "éƒ¨ç½²åˆ†æ”¯",
                    "value": "$DEPLOY_BRANCH",
                    "short": true
                },
                {
                    "title": "æäº¤å“ˆå¸Œ",
                    "value": "$DEPLOY_COMMIT",
                    "short": true
                },
                {
                    "title": "è¯¦ç»†ä¿¡æ¯",
                    "value": "$MESSAGE",
                    "short": false
                }
            ],
            "footer": "Official Website Backend",
            "ts": $(date +%s)
        }
    ]
}
EOF

# å‘é€é€šçŸ¥
if [ -n "$WEBHOOK_URL" ] && [ "$WEBHOOK_URL" != "[é’‰é’‰/Slack/ä¼ä¸šå¾®ä¿¡WebhookURL]" ]; then
    curl -X POST -H 'Content-type: application/json' \
        --data @/tmp/deploy_notification.json \
        "$WEBHOOK_URL"

    if [ $? -eq 0 ]; then
        echo "é€šçŸ¥å‘é€æˆåŠŸ"
    else
        echo "é€šçŸ¥å‘é€å¤±è´¥"
    fi
else
    echo "Webhook URLæœªé…ç½®ï¼Œè·³è¿‡é€šçŸ¥å‘é€"
fi

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
rm -f /tmp/deploy_notification.json
```

### 4.5 è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ç›®å½•ç»“æ„

```
/var/www/official_website_backend/scripts/
â”œâ”€â”€ deploy.sh                    # ä¸»éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ backup.sh                    # å¤‡ä»½è„šæœ¬
â”œâ”€â”€ deploy_code.sh               # ä»£ç éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ install_dependencies.sh       # ä¾èµ–å®‰è£…è„šæœ¬
â”œâ”€â”€ manage_cache.sh              # ç¼“å­˜ç®¡ç†è„šæœ¬
â”œâ”€â”€ migrate_database.sh          # æ•°æ®åº“è¿ç§»è„šæœ¬
â”œâ”€â”€ set_permissions.sh           # æƒé™è®¾ç½®è„šæœ¬
â”œâ”€â”€ restart_services.sh          # æœåŠ¡é‡å¯è„šæœ¬
â”œâ”€â”€ post_deploy_verification.sh  # éƒ¨ç½²åéªŒè¯è„šæœ¬
â”œâ”€â”€ send_notification.sh        # é€šçŸ¥å‘é€è„šæœ¬
â””â”€â”€ health_check.sh             # å¥åº·æ£€æŸ¥è„šæœ¬

# ä½¿ç”¨æ–¹æ³•
# 1. ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™
chmod +x scripts/*.sh

# 2. æ‰§è¡Œéƒ¨ç½²
./scripts/deploy.sh main v1.2.3

# 3. æ‰§è¡Œå¥åº·æ£€æŸ¥
./scripts/health_check.sh

# 4. æ‰§è¡Œå›æ»š
./scripts/rollback.sh v1.2.2
```

---

## 5. æ•°æ®åº“ç®¡ç†

### 5.1 åŒæ•°æ®åº“æ¶æ„è¯´æ˜

#### 5.1.1 æ¶æ„è®¾è®¡æ¦‚è¿°

æœ¬é¡¹ç›®é‡‡ç”¨åŒæ•°æ®åº“æ¶æ„è®¾è®¡ï¼Œå®ç°ä¸šåŠ¡æ•°æ®ä¸ç”¨æˆ·æ•°æ®çš„åˆ†ç¦»ç®¡ç†ï¼Œæé«˜ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§ï¼š

**ä¸»æ•°æ®åº“ (official_website)**ï¼š

-   **ç”¨é€”**: å­˜å‚¨æ ¸å¿ƒä¸šåŠ¡æ•°æ®ï¼ŒåŒ…æ‹¬æ–‡ç« ã€æ–°é—»ã€é˜…è¯»æ—¥å¿—ã€ç»Ÿè®¡æ•°æ®ç­‰
-   **æƒé™**: è¯»å†™æƒé™ï¼Œæ”¯æŒå®Œæ•´çš„ CRUD æ“ä½œ
-   **è¿æ¥**: `default` è¿æ¥ï¼Œä½¿ç”¨ `official_user` è´¦æˆ·
-   **å­—ç¬¦é›†**: utf8mb4_unicode_ciï¼Œæ”¯æŒå®Œæ•´çš„ Unicode å­—ç¬¦é›†
-   **å­˜å‚¨å¼•æ“**: InnoDBï¼Œæ”¯æŒäº‹åŠ¡å’Œè¡Œçº§é”å®š

**ç”¨æˆ·æ•°æ®åº“ (official_website_user)**ï¼š

-   **ç”¨é€”**: å­˜å‚¨ç”¨æˆ·è®¤è¯ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”¨æˆ·è´¦æˆ·ã€æƒé™ã€è§’è‰²ç­‰
-   **æƒé™**: åªè¯»æƒé™ï¼Œé˜²æ­¢æ„å¤–ä¿®æ”¹ç”¨æˆ·æ•°æ®
-   **è¿æ¥**: `user` è¿æ¥ï¼Œä½¿ç”¨ `readonly_user` è´¦æˆ·
-   **å­—ç¬¦é›†**: utf8mb4_unicode_ciï¼Œä¿æŒä¸ä¸»æ•°æ®åº“ä¸€è‡´
-   **å®‰å…¨**: é€šè¿‡æ•°æ®åº“å±‚é¢æƒé™æ§åˆ¶ç¡®ä¿æ•°æ®å®‰å…¨

#### 5.1.2 æ•°æ®åº“è¿æ¥é…ç½®è¯¦è§£

```yaml
# config/packages/doctrine.yaml - ç”Ÿäº§ç¯å¢ƒé…ç½®
doctrine:
    dbal:
        default_connection: default
        connections:
            default:
                url: "%env(resolve:DATABASE_URL)%"
                # è¿æ¥æ± é…ç½®
                driver_options:
                    1000: true # PDO::ATTR_EMULATE_PREPARES - å¯ç”¨é¢„å¤„ç†æ¨¡æ‹Ÿ
                    1002: "SET SESSION sql_mode = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'"
                    3: 2 # PDO::ATTR_ERRMODE -> PDO::ERRMODE_EXCEPTION
                    20: 30 # PDO::ATTR_TIMEOUT -> 30ç§’è¿æ¥è¶…æ—¶
                    12: true # PDO::ATTR_PERSISTENT -> å¯ç”¨æŒä¹…è¿æ¥
                # è¿æ¥æ± è®¾ç½®
                wrapper_class: Doctrine\DBAL\Connections\MasterSlaveConnection
                slaves:
                    slave1:
                        url: "%env(resolve:DATABASE_SLAVE_URL)%"
                        # ä»åº“è¿æ¥é…ç½®
                        driver_options:
                            1000: true
                            1002: "SET SESSION sql_mode = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'"
                            3: 2
                            20: 30
                            12: true

            user:
                url: "%env(resolve:USER_DATABASE_URL)%"
                # åªè¯»è¿æ¥é…ç½®
                driver_options:
                    1000: true
                    1002: "SET SESSION sql_mode = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'"
                    3: 0 # PDO::ATTR_ERRMODE -> PDO::ERRMODE_SILENT (åªè¯»æ¨¡å¼)
                    20: 30 # è¿æ¥è¶…æ—¶
                    12: true # æŒä¹…è¿æ¥
```

#### 5.1.3 è¿æ¥æ± å’Œæ€§èƒ½ä¼˜åŒ–

**è¿æ¥æ± é…ç½®å‚æ•°**ï¼š

```yaml
# PHP-FPM æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
pdo:
    # æœ€å¤§è¿æ¥æ•°
    max_connections: 100
    # æœ€å°è¿æ¥æ•°
    min_connections: 10
    # è¿æ¥è¶…æ—¶æ—¶é—´
    connect_timeout: 30
    # æŸ¥è¯¢è¶…æ—¶æ—¶é—´
    query_timeout: 60
    # ç©ºé—²è¿æ¥å›æ”¶æ—¶é—´
    idle_timeout: 300
    # è¿æ¥ç”Ÿå‘½å‘¨æœŸ
    lifetime: 3600
```

**é‡è¯•æœºåˆ¶é…ç½®**ï¼š

```yaml
# æ•°æ®åº“è¿æ¥é‡è¯•ç­–ç•¥
retry:
    max_attempts: 3
    initial_delay: 1.0
    max_delay: 10.0
    multiplier: 2.0
    jitter: 0.1
```

### 5.2 æ•°æ®åº“è¿ç§»æµç¨‹

#### 5.2.1 è¿ç§»å‰å‡†å¤‡æ¸…å•

**ç¯å¢ƒæ£€æŸ¥**ï¼š

-   [ ] æ•°æ®åº“å¤‡ä»½å®Œæˆï¼ˆä¸»åº“å’Œç”¨æˆ·åº“ï¼‰
-   [ ] è¿ç§»è„šæœ¬ä»£ç å®¡æŸ¥é€šè¿‡
-   [ ] æµ‹è¯•ç¯å¢ƒè¿ç§»éªŒè¯æˆåŠŸ
-   [ ] å›æ»šè„šæœ¬å‡†å¤‡å°±ç»ª
-   [ ] ç»´æŠ¤çª—å£ç¡®è®¤å’Œç”¨æˆ·é€šçŸ¥
-   [ ] æ•°æ®åº“è¿æ¥çŠ¶æ€æ­£å¸¸
-   [ ] ç£ç›˜ç©ºé—´å……è¶³ï¼ˆè‡³å°‘æ˜¯æ•°æ®åº“å¤§å°çš„ 2 å€ï¼‰

**æƒé™éªŒè¯**ï¼š

-   [ ] è¿ç§»ç”¨æˆ·æƒé™å……è¶³
-   [ ] æ•°æ®åº“å†™å…¥æƒé™ç¡®è®¤
-   [ ] è¡¨ç»“æ„ä¿®æ”¹æƒé™ç¡®è®¤
-   [ ] ç´¢å¼•åˆ›å»ºæƒé™ç¡®è®¤

#### 5.2.2 è¿ç§»æ‰§è¡Œè¯¦ç»†æ­¥éª¤

**ç¬¬ä¸€æ­¥ï¼šè¿ç§»çŠ¶æ€æ£€æŸ¥**

```bash
#!/bin/bash
# è¿ç§»å‰çŠ¶æ€æ£€æŸ¥è„šæœ¬
set -e

echo "=== æ•°æ®åº“è¿ç§»å‰çŠ¶æ€æ£€æŸ¥ ==="

# æ£€æŸ¥ä¸»æ•°æ®åº“è¿ç§»çŠ¶æ€
echo "æ£€æŸ¥ä¸»æ•°æ®åº“è¿ç§»çŠ¶æ€..."
php bin/console doctrine:migrations:status --env=prod --show-versions

# æ£€æŸ¥ç”¨æˆ·æ•°æ®åº“è¿ç§»çŠ¶æ€
echo "æ£€æŸ¥ç”¨æˆ·æ•°æ®åº“è¿ç§»çŠ¶æ€..."
php bin/console doctrine:migrations:status --env=prod --em=user --show-versions

# éªŒè¯æ•°æ®åº“è¿æ¥
echo "éªŒè¯æ•°æ®åº“è¿æ¥..."
php bin/console doctrine:database:exists --env=prod
php bin/console doctrine:database:exists --env=prod --em=user

# æ£€æŸ¥å¾…æ‰§è¡Œçš„è¿ç§»
echo "å¾…æ‰§è¡Œçš„ä¸»æ•°æ®åº“è¿ç§»ï¼š"
php bin/console doctrine:migrations:latest --env=prod

echo "å¾…æ‰§è¡Œçš„ç”¨æˆ·æ•°æ®åº“è¿ç§»ï¼š"
php bin/console doctrine:migrations:latest --env=prod --em=user
```

**ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œè¿ç§»**

```bash
#!/bin/bash
# æ•°æ®åº“è¿ç§»æ‰§è¡Œè„šæœ¬
set -e

BACKUP_DIR="/backup/pre_migration_$(date +%Y%m%d_%H%M%S)"
LOG_FILE="/var/log/db_migration_$(date +%Y%m%d_%H%M%S).log"

echo "=== å¼€å§‹æ•°æ®åº“è¿ç§» ===" | tee $LOG_FILE

# åˆ›å»ºè¿ç§»å‰å¤‡ä»½
echo "åˆ›å»ºè¿ç§»å‰å¤‡ä»½..." | tee -a $LOG_FILE
mkdir -p $BACKUP_DIR

# å¤‡ä»½ä¸»æ•°æ®åº“
echo "å¤‡ä»½ä¸»æ•°æ®åº“..." | tee -a $LOG_FILE
mysqldump --single-transaction --routines --triggers --events \
    -u root -p official_website | gzip > $BACKUP_DIR/main_db_backup.sql.gz

# å¤‡ä»½ç”¨æˆ·æ•°æ®åº“
echo "å¤‡ä»½ç”¨æˆ·æ•°æ®åº“..." | tee -a $LOG_FILE
mysqldump --single-transaction --routines --triggers --events \
    -u root -p official_website_user | gzip > $BACKUP_DIR/user_db_backup.sql.gz

# æ‰§è¡Œä¸»æ•°æ®åº“è¿ç§»
echo "æ‰§è¡Œä¸»æ•°æ®åº“è¿ç§»..." | tee -a $LOG_FILE
php bin/console doctrine:migrations:migrate --env=prod --no-interaction --verbose 2>&1 | tee -a $LOG_FILE

# æ‰§è¡Œç”¨æˆ·æ•°æ®åº“è¿ç§»
echo "æ‰§è¡Œç”¨æˆ·æ•°æ®åº“è¿ç§»..." | tee -a $LOG_FILE
php bin/console doctrine:migrations:migrate --env=prod --em=user --no-interaction --verbose 2>&1 | tee -a $LOG_FILE

# æ›´æ–°æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯
echo "æ›´æ–°æ•°æ®åº“ç»Ÿè®¡ä¿¡æ¯..." | tee -a $LOG_FILE
mysql -u root -p -e "ANALYZE TABLE official_website.*;" 2>/dev/null || true
mysql -u root -p -e "ANALYZE TABLE official_website_user.*;" 2>/dev/null || true

echo "=== è¿ç§»å®Œæˆ ===" | tee -a $LOG_FILE
echo "å¤‡ä»½ä½ç½®: $BACKUP_DIR" | tee -a $LOG_FILE
echo "æ—¥å¿—æ–‡ä»¶: $LOG_FILE" | tee -a $LOG_FILE
```

**ç¬¬ä¸‰æ­¥ï¼šè¿ç§»åéªŒè¯**

```bash
#!/bin/bash
# è¿ç§»åéªŒè¯è„šæœ¬
set -e

echo "=== è¿ç§»åéªŒè¯ ==="

# éªŒè¯ä¸»æ•°æ®åº“ç»“æ„
echo "éªŒè¯ä¸»æ•°æ®åº“ç»“æ„..."
php bin/console doctrine:schema:validate --env=prod

# éªŒè¯ç”¨æˆ·æ•°æ®åº“ç»“æ„
echo "éªŒè¯ç”¨æˆ·æ•°æ®åº“ç»“æ„..."
php bin/console doctrine:schema:validate --env=prod --em=user

# æ£€æŸ¥è¿ç§»çŠ¶æ€
echo "æ£€æŸ¥è¿ç§»å®ŒæˆçŠ¶æ€..."
php bin/console doctrine:migrations:status --env=prod --show-versions
php bin/console doctrine:migrations:status --env=prod --em=user --show-versions

# æµ‹è¯•æ•°æ®åº“è¿æ¥
echo "æµ‹è¯•æ•°æ®åº“è¿æ¥..."
php bin/console doctrine:database:exists --env=prod
php bin/console doctrine:database:exists --env=prod --em=user

# éªŒè¯å…³é”®è¡¨å­˜åœ¨
echo "éªŒè¯å…³é”®è¡¨å­˜åœ¨..."
mysql -u root -p -e "SHOW TABLES FROM official_website;" | grep -E "(sys_news_article|article_read_logs)"
mysql -u root -p -e "SHOW TABLES FROM official_website_user;" | grep -E "(users|user_roles)"

echo "=== éªŒè¯å®Œæˆ ==="
```

#### 5.2.3 è¿ç§»å›æ»šç­–ç•¥

**å›æ»šè„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ•°æ®åº“è¿ç§»å›æ»šè„šæœ¬
set -e

BACKUP_FILE=$1
DB_NAME=$2

if [ -z "$BACKUP_FILE" ] || [ -z "$DB_NAME" ]; then
    echo "ç”¨æ³•: $0 <backup_file> <database_name>"
    echo "ç¤ºä¾‹: $0 /backup/pre_migration_20251127_120000/main_db_backup.sql.gz official_website"
    exit 1
fi

echo "=== å¼€å§‹æ•°æ®åº“å›æ»š ==="
echo "å¤‡ä»½æ–‡ä»¶: $BACKUP_FILE"
echo "ç›®æ ‡æ•°æ®åº“: $DB_NAME"

# åœæ­¢åº”ç”¨æœåŠ¡
echo "åœæ­¢åº”ç”¨æœåŠ¡..."
systemctl stop nginx php8.2-fpm

# è§£å‹å¹¶æ¢å¤æ•°æ®åº“
echo "æ¢å¤æ•°æ®åº“..."
gunzip -c "$BACKUP_FILE" | mysql -u root -p "$DB_NAME"

# éªŒè¯æ¢å¤ç»“æœ
echo "éªŒè¯æ¢å¤ç»“æœ..."
php bin/console doctrine:schema:validate --env=prod

# é‡å¯åº”ç”¨æœåŠ¡
echo "é‡å¯åº”ç”¨æœåŠ¡..."
systemctl start php8.2-fpm nginx

echo "=== å›æ»šå®Œæˆ ==="
```

### 5.3 æ•°æ®åº“å¤‡ä»½ç­–ç•¥

#### 5.3.1 å¤‡ä»½ç­–ç•¥æ¦‚è¿°

**å¤‡ä»½ç±»å‹å’Œé¢‘ç‡**ï¼š

1. **å…¨é‡å¤‡ä»½**ï¼š

    - **é¢‘ç‡**: æ¯æ—¥å‡Œæ™¨ 02:00 æ‰§è¡Œ
    - **ä¿ç•™**: 30 å¤©
    - **å†…å®¹**: å®Œæ•´æ•°æ®åº“ç»“æ„å’Œæ•°æ®
    - **å‹ç¼©**: ä½¿ç”¨ gzip å‹ç¼©

2. **å¢é‡å¤‡ä»½**ï¼š

    - **é¢‘ç‡**: æ¯å°æ—¶æ‰§è¡Œ
    - **ä¿ç•™**: 7 å¤©
    - **å†…å®¹**: åŸºäºäºŒè¿›åˆ¶æ—¥å¿—çš„å¢é‡æ•°æ®
    - **å­˜å‚¨**: ç‹¬ç«‹çš„å¢é‡å¤‡ä»½æ–‡ä»¶

3. **äºŒè¿›åˆ¶æ—¥å¿—å¤‡ä»½**ï¼š

    - **é¢‘ç‡**: å®æ—¶åŒæ­¥
    - **ä¿ç•™**: 3 å¤©
    - **å†…å®¹**: æ‰€æœ‰æ•°æ®å˜æ›´æ—¥å¿—
    - **ç”¨é€”**: ç‚¹å¯¹ç‚¹æ¢å¤

4. **è¿ç§»å‰å¤‡ä»½**ï¼š
    - **è§¦å‘**: æ•°æ®åº“è¿ç§»å‰è‡ªåŠ¨æ‰§è¡Œ
    - **ä¿ç•™**: æ°¸ä¹…ä¿å­˜ï¼ˆé‡è¦å¤‡ä»½ï¼‰
    - **å†…å®¹**: è¿ç§»å‰çš„å®Œæ•´çŠ¶æ€

#### 5.3.2 è‡ªåŠ¨åŒ–å¤‡ä»½è„šæœ¬

**ä¸»å¤‡ä»½è„šæœ¬**ï¼š

```bash
#!/bin/bash
# ä¸»æ•°æ®åº“å¤‡ä»½è„šæœ¬ - backup_database.sh
# ç”¨æ³•: ./backup_database.sh [full|incremental]

set -e

# é…ç½®å‚æ•°
BACKUP_TYPE=${1:-full}
BACKUP_DIR="/backup/database"
DATE=$(date +%Y%m%d_%H%M%S)
LOG_FILE="/var/log/database_backup_${DATE}.log"

# æ•°æ®åº“é…ç½®
MAIN_DB="official_website"
USER_DB="official_website_user"
MYSQL_USER="root"
MYSQL_PASSWORD=""  # ä»é…ç½®æ–‡ä»¶è¯»å–

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR/full"
mkdir -p "$BACKUP_DIR/incremental"
mkdir -p "$BACKUP_DIR/binlog"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# é”™è¯¯å¤„ç†
error_exit() {
    log "ERROR: $1"
    exit 1
}

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space() {
    local available_space=$(df -BG "$BACKUP_DIR" | awk 'NR==2 {print $4}' | sed 's/G//')
    local required_space=10  # è‡³å°‘éœ€è¦10GB

    if [ "$available_space" -lt "$required_space" ]; then
        error_exit "ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œå¯ç”¨: ${available_space}GBï¼Œéœ€è¦: ${required_space}GB"
    fi
}

# å…¨é‡å¤‡ä»½å‡½æ•°
full_backup() {
    log "å¼€å§‹å…¨é‡å¤‡ä»½..."

    # å¤‡ä»½ä¸»æ•°æ®åº“
    log "å¤‡ä»½ä¸»æ•°æ®åº“: $MAIN_DB"
    mysqldump --single-transaction --routines --triggers --events \
        --opt --hex-blob --default-character-set=utf8mb4 \
        -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" \
        "$MAIN_DB" | gzip > "$BACKUP_DIR/full/main_db_${DATE}.sql.gz" || error_exit "ä¸»æ•°æ®åº“å¤‡ä»½å¤±è´¥"

    # å¤‡ä»½ç”¨æˆ·æ•°æ®åº“
    log "å¤‡ä»½ç”¨æˆ·æ•°æ®åº“: $USER_DB"
    mysqldump --single-transaction --routines --triggers --events \
        --opt --hex-blob --default-character-set=utf8mb4 \
        -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" \
        "$USER_DB" | gzip > "$BACKUP_DIR/full/user_db_${DATE}.sql.gz" || error_exit "ç”¨æˆ·æ•°æ®åº“å¤‡ä»½å¤±è´¥"

    # å¤‡ä»½äºŒè¿›åˆ¶æ—¥å¿—
    log "å¤‡ä»½äºŒè¿›åˆ¶æ—¥å¿—..."
    mysqladmin -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" flush-logs
    find /var/lib/mysql -name "mysql-bin.*" -not -name "*.index" -mtime -1 -exec cp {} "$BACKUP_DIR/binlog/" \;

    # åˆ›å»ºå¤‡ä»½æ¸…å•
    cat > "$BACKUP_DIR/full/backup_manifest_${DATE}.txt" << EOF
å¤‡ä»½ç±»å‹: å…¨é‡å¤‡ä»½
å¤‡ä»½æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
ä¸»æ•°æ®åº“: main_db_${DATE}.sql.gz
ç”¨æˆ·æ•°æ®åº“: user_db_${DATE}.sql.gz
å¤‡ä»½å¤§å°: $(du -sh "$BACKUP_DIR/full"/*_${DATE}.sql.gz | cut -f1)
EOF

    log "å…¨é‡å¤‡ä»½å®Œæˆ"
}

# å¢é‡å¤‡ä»½å‡½æ•°
incremental_backup() {
    log "å¼€å§‹å¢é‡å¤‡ä»½..."

    # è·å–æœ€æ–°çš„äºŒè¿›åˆ¶æ—¥å¿—ä½ç½®
    local last_binlog=$(mysql -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" -e "SHOW MASTER STATUS\G" | grep "File:" | awk '{print $2}')
    local last_position=$(mysql -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" -e "SHOW MASTER STATUS\G" | grep "Position:" | awk '{print $2}')

    # å¤‡ä»½å¢é‡æ•°æ®
    mysqladmin -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" flush-logs

    # å¤åˆ¶æ–°çš„äºŒè¿›åˆ¶æ—¥å¿—
    find /var/lib/mysql -name "mysql-bin.*" -not -name "*.index" -newer "$BACKUP_DIR/incremental/last_backup.marker" -exec cp {} "$BACKUP_DIR/incremental/" \;

    # æ›´æ–°æ ‡è®°æ–‡ä»¶
    touch "$BACKUP_DIR/incremental/last_backup.marker"

    log "å¢é‡å¤‡ä»½å®Œæˆ"
}

# æ¸…ç†è¿‡æœŸå¤‡ä»½
cleanup_old_backups() {
    log "æ¸…ç†è¿‡æœŸå¤‡ä»½..."

    # æ¸…ç†30å¤©å‰çš„å…¨é‡å¤‡ä»½
    find "$BACKUP_DIR/full" -name "*.sql.gz" -mtime +30 -delete
    find "$BACKUP_DIR/full" -name "backup_manifest_*.txt" -mtime +30 -delete

    # æ¸…ç†7å¤©å‰çš„å¢é‡å¤‡ä»½
    find "$BACKUP_DIR/incremental" -name "mysql-bin.*" -mtime +7 -delete

    # æ¸…ç†3å¤©å‰çš„äºŒè¿›åˆ¶æ—¥å¿—å¤‡ä»½
    find "$BACKUP_DIR/binlog" -name "mysql-bin.*" -mtime +3 -delete

    log "è¿‡æœŸå¤‡ä»½æ¸…ç†å®Œæˆ"
}

# éªŒè¯å¤‡ä»½å®Œæ•´æ€§
verify_backup() {
    log "éªŒè¯å¤‡ä»½å®Œæ•´æ€§..."

    # éªŒè¯gzipæ–‡ä»¶å®Œæ•´æ€§
    for file in "$BACKUP_DIR/full"/*_${DATE}.sql.gz; do
        if gzip -t "$file" 2>/dev/null; then
            log "âœ“ $file éªŒè¯é€šè¿‡"
        else
            error_exit "âœ— $file éªŒè¯å¤±è´¥"
        fi
    done

    log "å¤‡ä»½éªŒè¯å®Œæˆ"
}

# ä¸»æ‰§è¡Œæµç¨‹
main() {
    log "å¼€å§‹æ•°æ®åº“å¤‡ä»½ - ç±»å‹: $BACKUP_TYPE"

    check_disk_space

    case "$BACKUP_TYPE" in
        "full")
            full_backup
            verify_backup
            ;;
        "incremental")
            incremental_backup
            ;;
        *)
            error_exit "ä¸æ”¯æŒçš„å¤‡ä»½ç±»å‹: $BACKUP_TYPE"
            ;;
    esac

    cleanup_old_backups

    log "æ•°æ®åº“å¤‡ä»½å®Œæˆ"
}

# æ‰§è¡Œå¤‡ä»½
main
```

**å¤‡ä»½éªŒè¯è„šæœ¬**ï¼š

```bash
#!/bin/bash
# å¤‡ä»½éªŒè¯è„šæœ¬ - verify_backup.sh
set -e

BACKUP_FILE=$1
DB_NAME=$2

if [ -z "$BACKUP_FILE" ] || [ -z "$DB_NAME" ]; then
    echo "ç”¨æ³•: $0 <backup_file> <database_name>"
    exit 1
fi

echo "éªŒè¯å¤‡ä»½æ–‡ä»¶: $BACKUP_FILE"
echo "ç›®æ ‡æ•°æ®åº“: $DB_NAME"

# åˆ›å»ºä¸´æ—¶æ•°æ®åº“
TEMP_DB="temp_verify_$(date +%s)"
mysql -u root -p -e "CREATE DATABASE $TEMP_DB;"

# æ¢å¤åˆ°ä¸´æ—¶æ•°æ®åº“
echo "æ¢å¤å¤‡ä»½åˆ°ä¸´æ—¶æ•°æ®åº“..."
gunzip -c "$BACKUP_FILE" | mysql -u root -p "$TEMP_DB"

# éªŒè¯è¡¨ç»“æ„
echo "éªŒè¯è¡¨ç»“æ„..."
php bin/console doctrine:schema:validate --env=prod --em=default 2>/dev/null || {
    echo "è¡¨ç»“æ„éªŒè¯å¤±è´¥"
    mysql -u root -p -e "DROP DATABASE $TEMP_DB;"
    exit 1
}

# éªŒè¯æ•°æ®å®Œæ•´æ€§
echo "éªŒè¯æ•°æ®å®Œæ•´æ€§..."
TABLE_COUNT=$(mysql -u root -p -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='$TEMP_DB';" | tail -1)
echo "è¡¨æ•°é‡: $TABLE_COUNT"

# æ¸…ç†ä¸´æ—¶æ•°æ®åº“
mysql -u root -p -e "DROP DATABASE $TEMP_DB;"

echo "å¤‡ä»½éªŒè¯é€šè¿‡"
```

#### 5.3.3 å¤‡ä»½å­˜å‚¨å’ŒåŒæ­¥

**æœ¬åœ°å­˜å‚¨é…ç½®**ï¼š

```bash
# åˆ›å»ºå¤‡ä»½ç›®å½•ç»“æ„
mkdir -p /backup/{database,config,logs}
mkdir -p /backup/database/{full,incremental,binlog}
chmod 750 /backup
chown -R root:backup /backup
```

**è¿œç¨‹åŒæ­¥è„šæœ¬**ï¼š

```bash
#!/bin/bash
# å¤‡ä»½è¿œç¨‹åŒæ­¥è„šæœ¬ - sync_backup.sh
set -e

LOCAL_BACKUP_DIR="/backup/database"
REMOTE_SERVER="backup.example.com"
REMOTE_USER="backup"
REMOTE_DIR="/remote/backup/official_website"
SSH_KEY="/home/backup/.ssh/id_rsa"

# åŒæ­¥å…¨é‡å¤‡ä»½
echo "åŒæ­¥å…¨é‡å¤‡ä»½åˆ°è¿œç¨‹æœåŠ¡å™¨..."
rsync -avz -e "ssh -i $SSH_KEY" \
    --delete \
    "$LOCAL_BACKUP_DIR/full/" \
    "$REMOTE_USER@$REMOTE_SERVER:$REMOTE_DIR/full/"

# åŒæ­¥å¢é‡å¤‡ä»½
echo "åŒæ­¥å¢é‡å¤‡ä»½åˆ°è¿œç¨‹æœåŠ¡å™¨..."
rsync -avz -e "ssh -i $SSH_KEY" \
    --delete \
    "$LOCAL_BACKUP_DIR/incremental/" \
    "$REMOTE_USER@$REMOTE_SERVER:$REMOTE_DIR/incremental/"

# åŒæ­¥äºŒè¿›åˆ¶æ—¥å¿—
echo "åŒæ­¥äºŒè¿›åˆ¶æ—¥å¿—åˆ°è¿œç¨‹æœåŠ¡å™¨..."
rsync -avz -e "ssh -i $SSH_KEY" \
    --delete \
    "$LOCAL_BACKUP_DIR/binlog/" \
    "$REMOTE_USER@$REMOTE_SERVER:$REMOTE_DIR/binlog/"

echo "è¿œç¨‹åŒæ­¥å®Œæˆ"
```

### 5.4 æ•°æ®åº“æ¢å¤æµç¨‹

#### 5.4.1 æ¢å¤ç­–ç•¥å’Œæµç¨‹

**æ¢å¤åœºæ™¯åˆ†ç±»**ï¼š

1. **å®Œæ•´æ¢å¤**ï¼š

    - **åœºæ™¯**: æ•°æ®åº“å®Œå…¨æŸåæˆ–ä¸¥é‡æ•°æ®æŸå
    - **æ—¶é—´**: 1-4 å°æ—¶
    - **æ•°æ®ä¸¢å¤±**: å¯èƒ½ä¸¢å¤±æœ€è¿‘ä¸€æ¬¡å¤‡ä»½åçš„æ•°æ®

2. **ç‚¹å¯¹ç‚¹æ¢å¤**ï¼š

    - **åœºæ™¯**: éœ€è¦æ¢å¤åˆ°ç‰¹å®šæ—¶é—´ç‚¹
    - **æ—¶é—´**: 2-6 å°æ—¶
    - **ç²¾åº¦**: å¯ç²¾ç¡®åˆ°ç§’çº§

3. **è¡¨çº§æ¢å¤**ï¼š

    - **åœºæ™¯**: å•ä¸ªè¡¨æ•°æ®æŸå
    - **æ—¶é—´**: 30 åˆ†é’Ÿ-2 å°æ—¶
    - **å½±å“**: æœ€å°åŒ–ä¸šåŠ¡å½±å“

4. **ç”¨æˆ·æ•°æ®æ¢å¤**ï¼š
    - **åœºæ™¯**: ç”¨æˆ·æ•°æ®åº“æŸå
    - **æ—¶é—´**: 30 åˆ†é’Ÿ-1 å°æ—¶
    - **å½±å“**: ä»…å½±å“ç”¨æˆ·è®¤è¯åŠŸèƒ½

#### 5.4.2 å®Œæ•´æ¢å¤è„šæœ¬

**ä¸»æ¢å¤è„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ•°æ®åº“å®Œæ•´æ¢å¤è„šæœ¬ - restore_database.sh
# ç”¨æ³•: ./restore_database.sh <backup_date> [target_time]

set -e

# å‚æ•°è§£æ
BACKUP_DATE=$1
TARGET_TIME=$2  # æ ¼å¼: "YYYY-MM-DD HH:MM:SS"

if [ -z "$BACKUP_DATE" ]; then
    echo "ç”¨æ³•: $0 <backup_date> [target_time]"
    echo "ç¤ºä¾‹: $0 20251127_120000"
    echo "ç¤ºä¾‹: $0 20251127_120000 '2025-11-27 14:30:00'"
    exit 1
fi

# é…ç½®å‚æ•°
BACKUP_DIR="/backup/database"
TEMP_DIR="/tmp/restore_$(date +%s)"
LOG_FILE="/var/log/database_restore_$(date +%Y%m%d_%H%M%S).log"

# æ•°æ®åº“é…ç½®
MAIN_DB="official_website"
USER_DB="official_website_user"
MYSQL_USER="root"
MYSQL_PASSWORD=""

# åˆ›å»ºä¸´æ—¶ç›®å½•
mkdir -p "$TEMP_DIR"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# é”™è¯¯å¤„ç†
error_exit() {
    log "ERROR: $1"
    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -rf "$TEMP_DIR"
    exit 1
}

# åœæ­¢åº”ç”¨æœåŠ¡
stop_services() {
    log "åœæ­¢åº”ç”¨æœåŠ¡..."
    systemctl stop nginx php8.2-fpm || true
    systemctl status nginx php8.2-fpm || true
}

# å¯åŠ¨åº”ç”¨æœåŠ¡
start_services() {
    log "å¯åŠ¨åº”ç”¨æœåŠ¡..."
    systemctl start php8.2-fpm nginx
    systemctl status nginx php8.2-fpm || true
}

# éªŒè¯å¤‡ä»½æ–‡ä»¶
verify_backup_files() {
    log "éªŒè¯å¤‡ä»½æ–‡ä»¶..."

    local main_backup="$BACKUP_DIR/full/main_db_${BACKUP_DATE}.sql.gz"
    local user_backup="$BACKUP_DIR/full/user_db_${BACKUP_DATE}.sql.gz"

    if [ ! -f "$main_backup" ]; then
        error_exit "ä¸»æ•°æ®åº“å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: $main_backup"
    fi

    if [ ! -f "$user_backup" ]; then
        error_exit "ç”¨æˆ·æ•°æ®åº“å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: $user_backup"
    fi

    # éªŒè¯æ–‡ä»¶å®Œæ•´æ€§
    gzip -t "$main_backup" || error_exit "ä¸»æ•°æ®åº“å¤‡ä»½æ–‡ä»¶æŸå"
    gzip -t "$user_backup" || error_exit "ç”¨æˆ·æ•°æ®åº“å¤‡ä»½æ–‡ä»¶æŸå"

    log "å¤‡ä»½æ–‡ä»¶éªŒè¯é€šè¿‡"
}

# æ¢å¤æ•°æ®åº“
restore_database() {
    local db_name=$1
    local backup_file=$2

    log "æ¢å¤æ•°æ®åº“: $db_name"

    # åˆ é™¤ç°æœ‰æ•°æ®åº“
    mysql -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" -e "DROP DATABASE IF EXISTS $db_name;" || error_exit "åˆ é™¤æ•°æ®åº“å¤±è´¥"

    # åˆ›å»ºæ–°æ•°æ®åº“
    mysql -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" -e "CREATE DATABASE $db_name CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;" || error_exit "åˆ›å»ºæ•°æ®åº“å¤±è´¥"

    # æ¢å¤æ•°æ®
    log "å¯¼å…¥æ•°æ®åˆ° $db_name..."
    gunzip -c "$backup_file" | mysql -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" "$db_name" || error_exit "æ•°æ®å¯¼å…¥å¤±è´¥"

    log "æ•°æ®åº“ $db_name æ¢å¤å®Œæˆ"
}

# ç‚¹å¯¹ç‚¹æ¢å¤ï¼ˆåŸºäºäºŒè¿›åˆ¶æ—¥å¿—ï¼‰
point_in_time_recovery() {
    if [ -z "$TARGET_TIME" ]; then
        log "æœªæŒ‡å®šç›®æ ‡æ—¶é—´ï¼Œè·³è¿‡ç‚¹å¯¹ç‚¹æ¢å¤"
        return
    fi

    log "å¼€å§‹ç‚¹å¯¹ç‚¹æ¢å¤åˆ°æ—¶é—´: $TARGET_TIME"

    # æ‰¾åˆ°æœ€æ¥è¿‘ç›®æ ‡æ—¶é—´çš„äºŒè¿›åˆ¶æ—¥å¿—
    local binlog_file=$(mysql -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" -e "SHOW MASTER LOGS;" | grep "mysql-bin" | tail -1 | awk '{print $1}')
    local binlog_path="$BACKUP_DIR/binlog/$binlog_file"

    if [ -f "$binlog_path" ]; then
        log "åº”ç”¨äºŒè¿›åˆ¶æ—¥å¿—: $binlog_file"
        mysqlbinlog --start-datetime="$TARGET_TIME" "$binlog_path" | mysql -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" || error_exit "äºŒè¿›åˆ¶æ—¥å¿—åº”ç”¨å¤±è´¥"
    else
        log "æœªæ‰¾åˆ°ç›¸åº”çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶"
    fi

    log "ç‚¹å¯¹ç‚¹æ¢å¤å®Œæˆ"
}

# éªŒè¯æ¢å¤ç»“æœ
verify_restore() {
    log "éªŒè¯æ¢å¤ç»“æœ..."

    # éªŒè¯æ•°æ®åº“ç»“æ„
    php bin/console doctrine:schema:validate --env=prod || error_exit "ä¸»æ•°æ®åº“ç»“æ„éªŒè¯å¤±è´¥"
    php bin/console doctrine:schema:validate --env=prod --em=user || error_exit "ç”¨æˆ·æ•°æ®åº“ç»“æ„éªŒè¯å¤±è´¥"

    # éªŒè¯è¡¨å­˜åœ¨
    local main_tables=$(mysql -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='$MAIN_DB';" | tail -1)
    local user_tables=$(mysql -u "$MYSQL_USER" -p"$MYSQL_PASSWORD" -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema='$USER_DB';" | tail -1)

    log "ä¸»æ•°æ®åº“è¡¨æ•°é‡: $main_tables"
    log "ç”¨æˆ·æ•°æ®åº“è¡¨æ•°é‡: $user_tables"

    if [ "$main_tables" -lt 1 ] || [ "$user_tables" -lt 1 ]; then
        error_exit "æ•°æ®åº“è¡¨æ•°é‡å¼‚å¸¸"
    fi

    log "æ¢å¤éªŒè¯é€šè¿‡"
}

# ä¸»æ¢å¤æµç¨‹
main() {
    log "å¼€å§‹æ•°æ®åº“æ¢å¤æµç¨‹"
    log "å¤‡ä»½æ—¥æœŸ: $BACKUP_DATE"
    if [ -n "$TARGET_TIME" ]; then
        log "ç›®æ ‡æ—¶é—´: $TARGET_TIME"
    fi

    # åœæ­¢æœåŠ¡
    stop_services

    # éªŒè¯å¤‡ä»½æ–‡ä»¶
    verify_backup_files

    # æ¢å¤ä¸»æ•°æ®åº“
    restore_database "$MAIN_DB" "$BACKUP_DIR/full/main_db_${BACKUP_DATE}.sql.gz"

    # æ¢å¤ç”¨æˆ·æ•°æ®åº“
    restore_database "$USER_DB" "$BACKUP_DIR/full/user_db_${BACKUP_DATE}.sql.gz"

    # ç‚¹å¯¹ç‚¹æ¢å¤ï¼ˆå¦‚æœæŒ‡å®šäº†ç›®æ ‡æ—¶é—´ï¼‰
    point_in_time_recovery

    # éªŒè¯æ¢å¤ç»“æœ
    verify_restore

    # å¯åŠ¨æœåŠ¡
    start_services

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -rf "$TEMP_DIR"

    log "æ•°æ®åº“æ¢å¤å®Œæˆ"
    log "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
}

# æ‰§è¡Œæ¢å¤
main
```

**è¡¨çº§æ¢å¤è„šæœ¬**ï¼š

```bash
#!/bin/bash
# è¡¨çº§æ¢å¤è„šæœ¬ - restore_table.sh
# ç”¨æ³•: ./restore_table.sh <database> <table> <backup_file>

set -e

DATABASE=$1
TABLE=$2
BACKUP_FILE=$3

if [ -z "$DATABASE" ] || [ -z "$TABLE" ] || [ -z "$BACKUP_FILE" ]; then
    echo "ç”¨æ³•: $0 <database> <table> <backup_file>"
    echo "ç¤ºä¾‹: $0 official_website sys_news_article /backup/full/main_db_20251127_120000.sql.gz"
    exit 1
fi

echo "æ¢å¤è¡¨: $DATABASE.$TABLE"
echo "å¤‡ä»½æ–‡ä»¶: $BACKUP_FILE"

# æå–è¡¨æ•°æ®
echo "æå–è¡¨æ•°æ®..."
gunzip -c "$BACKUP_FILE" | grep -A 100000 "Table structure for table \`$TABLE\`" | grep -B 100000 "Table structure for table" | head -n -1 > /tmp/table_restore.sql

# åˆ é™¤ç°æœ‰è¡¨
echo "åˆ é™¤ç°æœ‰è¡¨..."
mysql -u root -p -e "DROP TABLE IF EXISTS $DATABASE.$TABLE;"

# æ¢å¤è¡¨ç»“æ„
echo "æ¢å¤è¡¨ç»“æ„..."
mysql -u root -p "$DATABASE" < /tmp/table_restore.sql

echo "è¡¨æ¢å¤å®Œæˆ: $DATABASE.$TABLE"
```

### 5.5 æ•°æ®åº“ç›‘æ§

#### 5.5.1 æ€§èƒ½ç›‘æ§é…ç½®

**MySQL æ€§èƒ½ç›‘æ§è„šæœ¬**ï¼š

```bash
#!/bin/bash
# MySQLæ€§èƒ½ç›‘æ§è„šæœ¬ - mysql_monitor.sh
set -e

MONITOR_INTERVAL=60  # ç›‘æ§é—´éš”ï¼ˆç§’ï¼‰
LOG_FILE="/var/log/mysql_monitor_$(date +%Y%m%d).log"
ALERT_THRESHOLD=80   # å‘Šè­¦é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼‰

# è·å–MySQLè¿æ¥ä¿¡æ¯
get_mysql_status() {
    mysql -u root -p -e "SHOW GLOBAL STATUS LIKE '$1';" | tail -1 | awk '{print $2}'
}

# è·å–MySQLå˜é‡
get_mysql_variable() {
    mysql -u root -p -e "SHOW GLOBAL VARIABLES LIKE '$1';" | tail -1 | awk '{print $2}'
}

# ç›‘æ§è¿æ¥æ•°
monitor_connections() {
    local max_connections=$(get_mysql_variable "max_connections")
    local current_connections=$(get_mysql_status "Threads_connected")
    local usage_percentage=$((current_connections * 100 / max_connections))

    echo "[$(date)] è¿æ¥æ•°: $current_connections/$max_connections (${usage_percentage}%)" >> "$LOG_FILE"

    if [ "$usage_percentage" -gt "$ALERT_THRESHOLD" ]; then
        echo "WARNING: è¿æ¥æ•°ä½¿ç”¨ç‡è¶…è¿‡ ${ALERT_THRESHOLD}%"
        # å‘é€å‘Šè­¦é€šçŸ¥
        # ./send_alert.sh "MySQLè¿æ¥æ•°å‘Šè­¦" "å½“å‰è¿æ¥æ•°: $current_connections/$max_connections"
    fi
}

# ç›‘æ§æ…¢æŸ¥è¯¢
monitor_slow_queries() {
    local slow_queries=$(get_mysql_status "Slow_queries")
    echo "[$(date)] æ…¢æŸ¥è¯¢æ•°é‡: $slow_queries" >> "$LOG_FILE"
}

# ç›‘æ§æŸ¥è¯¢ç¼“å­˜
monitor_query_cache() {
    local qcache_hits=$(get_mysql_status "Qcache_hits")
    local qcache_inserts=$(get_mysql_status "Qcache_inserts")
    local qcache_not_cached=$(get_mysql_status "Qcache_not_cached")

    if [ "$((qcache_hits + qcache_inserts + qcache_not_cached))" -gt 0 ]; then
        local hit_rate=$((qcache_hits * 100 / (qcache_hits + qcache_inserts + qcache_not_cached)))
        echo "[$(date)] æŸ¥è¯¢ç¼“å­˜å‘½ä¸­ç‡: ${hit_rate}%" >> "$LOG_FILE"
    fi
}

# ç›‘æ§InnoDBçŠ¶æ€
monitor_innodb() {
    local innodb_buffer_pool_read_requests=$(get_mysql_status "Innodb_buffer_pool_read_requests")
    local innodb_buffer_pool_reads=$(get_mysql_status "Innodb_buffer_pool_reads")

    if [ "$innodb_buffer_pool_read_requests" -gt 0 ]; then
        local buffer_pool_hit_rate=$(((innodb_buffer_pool_read_requests - innodb_buffer_pool_reads) * 100 / innodb_buffer_pool_read_requests))
        echo "[$(date)] InnoDBç¼“å†²æ± å‘½ä¸­ç‡: ${buffer_pool_hit_rate}%" >> "$LOG_FILE"
    fi
}

# ä¸»ç›‘æ§å¾ªç¯
main() {
    echo "å¼€å§‹MySQLæ€§èƒ½ç›‘æ§..."
    echo "ç›‘æ§é—´éš”: ${MONITOR_INTERVAL}ç§’"
    echo "æ—¥å¿—æ–‡ä»¶: $LOG_FILE"

    while true; do
        monitor_connections
        monitor_slow_queries
        monitor_query_cache
        monitor_innodb

        sleep "$MONITOR_INTERVAL"
    done
}

# æ‰§è¡Œç›‘æ§
main
```

#### 5.5.2 æ…¢æŸ¥è¯¢åˆ†æ

**æ…¢æŸ¥è¯¢é…ç½®**ï¼š

```sql
-- MySQLæ…¢æŸ¥è¯¢é…ç½®
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL slow_query_log_file = '/var/log/mysql/mysql-slow.log';
SET GLOBAL long_query_time = 2;  -- è®°å½•æ‰§è¡Œæ—¶é—´è¶…è¿‡2ç§’çš„æŸ¥è¯¢
SET GLOBAL log_queries_not_using_indexes = 'ON';
```

**æ…¢æŸ¥è¯¢åˆ†æè„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ…¢æŸ¥è¯¢åˆ†æè„šæœ¬ - analyze_slow_queries.sh
set -e

SLOW_LOG_FILE="/var/log/mysql/mysql-slow.log"
ANALYSIS_REPORT="/var/log/slow_query_analysis_$(date +%Y%m%d).log"

echo "æ…¢æŸ¥è¯¢åˆ†ææŠ¥å‘Š - $(date)" > "$ANALYSIS_REPORT"
echo "=================================" >> "$ANALYSIS_REPORT"

# åˆ†ææœ€æ…¢çš„æŸ¥è¯¢
echo "" >> "$ANALYSIS_REPORT"
echo "Top 10 æœ€æ…¢æŸ¥è¯¢:" >> "$ANALYSIS_REPORT"
echo "----------------" >> "$ANALYSIS_REPORT"
mysqldumpslow -s t "$SLOW_LOG_FILE" | head -10 >> "$ANALYSIS_REPORT"

# åˆ†ææœ€é¢‘ç¹çš„æŸ¥è¯¢
echo "" >> "$ANALYSIS_REPORT"
echo "Top 10 æœ€é¢‘ç¹æŸ¥è¯¢:" >> "$ANALYSIS_REPORT"
echo "-------------------" >> "$ANALYSIS_REPORT"
mysqldumpslow -s c "$SLOW_LOG_FILE" | head -10 >> "$ANALYSIS_REPORT"

# åˆ†æé”å®šæ—¶é—´æœ€é•¿çš„æŸ¥è¯¢
echo "" >> "$ANALYSIS_REPORT"
echo "Top 10 é”å®šæ—¶é—´æœ€é•¿çš„æŸ¥è¯¢:" >> "$ANALYSIS_REPORT"
echo "-------------------------" >> "$ANALYSIS_REPORT"
mysqldumpslow -s l "$SLOW_LOG_FILE" | head -10 >> "$ANALYSIS_REPORT"

echo "æ…¢æŸ¥è¯¢åˆ†æå®Œæˆï¼ŒæŠ¥å‘Šä¿å­˜è‡³: $ANALYSIS_REPORT"
```

#### 5.5.3 æ•°æ®åº“å¥åº·æ£€æŸ¥

**å¥åº·æ£€æŸ¥è„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ•°æ®åº“å¥åº·æ£€æŸ¥è„šæœ¬ - db_health_check.sh
set -e

HEALTH_REPORT="/var/log/db_health_check_$(date +%Y%m%d_%H%M%S).log"

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
check_database_connection() {
    echo "æ£€æŸ¥æ•°æ®åº“è¿æ¥..." >> "$HEALTH_REPORT"

    if php bin/console doctrine:database:exists --env=prod >> "$HEALTH_REPORT" 2>&1; then
        echo "âœ“ ä¸»æ•°æ®åº“è¿æ¥æ­£å¸¸" >> "$HEALTH_REPORT"
    else
        echo "âœ— ä¸»æ•°æ®åº“è¿æ¥å¤±è´¥" >> "$HEALTH_REPORT"
    fi

    if php bin/console doctrine:database:exists --env=prod --em=user >> "$HEALTH_REPORT" 2>&1; then
        echo "âœ“ ç”¨æˆ·æ•°æ®åº“è¿æ¥æ­£å¸¸" >> "$HEALTH_REPORT"
    else
        echo "âœ— ç”¨æˆ·æ•°æ®åº“è¿æ¥å¤±è´¥" >> "$HEALTH_REPORT"
    fi
}

# æ£€æŸ¥æ•°æ®åº“å¤§å°
check_database_size() {
    echo "" >> "$HEALTH_REPORT"
    echo "æ•°æ®åº“å¤§å°æ£€æŸ¥:" >> "$HEALTH_REPORT"

    mysql -u root -p -e "
        SELECT
            table_schema as 'æ•°æ®åº“',
            ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'å¤§å°(MB)'
        FROM information_schema.tables
        GROUP BY table_schema;
    " >> "$HEALTH_REPORT"
}

# æ£€æŸ¥è¡¨ç¢ç‰‡
check_table_fragmentation() {
    echo "" >> "$HEALTH_REPORT"
    echo "è¡¨ç¢ç‰‡æ£€æŸ¥:" >> "$HEALTH_REPORT"

    mysql -u root -p -e "
        SELECT
            table_schema,
            table_name,
            ROUND(data_free/1024/1024, 2) AS 'ç¢ç‰‡(MB)'
        FROM information_schema.tables
        WHERE data_free > 0
        ORDER BY data_free DESC;
    " >> "$HEALTH_REPORT"
}

# æ£€æŸ¥ç´¢å¼•ä½¿ç”¨æƒ…å†µ
check_index_usage() {
    echo "" >> "$HEALTH_REPORT"
    echo "ç´¢å¼•ä½¿ç”¨æƒ…å†µ:" >> "$HEALTH_REPORT"

    mysql -u root -p -e "
        SELECT
            table_schema,
            table_name,
            index_name,
            cardinality
        FROM information_schema.statistics
        WHERE table_schema IN ('official_website', 'official_website_user')
        ORDER BY cardinality DESC;
    " >> "$HEALTH_REPORT"
}

# ä¸»æ£€æŸ¥æµç¨‹
main() {
    echo "æ•°æ®åº“å¥åº·æ£€æŸ¥æŠ¥å‘Š - $(date)" > "$HEALTH_REPORT"
    echo "=============================" >> "$HEALTH_REPORT"

    check_database_connection
    check_database_size
    check_table_fragmentation
    check_index_usage

    echo "å¥åº·æ£€æŸ¥å®Œæˆï¼ŒæŠ¥å‘Šä¿å­˜è‡³: $HEALTH_REPORT"
}

main
```

### 5.6 æ•°æ®å®‰å…¨

#### 5.6.1 ç”¨æˆ·æƒé™ç®¡ç†

**æ•°æ®åº“ç”¨æˆ·æƒé™é…ç½®**ï¼š

```sql
-- åˆ›å»ºæ•°æ®åº“ç”¨æˆ·å’Œæƒé™

-- 1. ä¸»æ•°æ®åº“åº”ç”¨ç”¨æˆ·
CREATE USER 'official_user'@'localhost' IDENTIFIED BY '[å¼ºå¯†ç ]';
GRANT SELECT, INSERT, UPDATE, DELETE ON official_website.* TO 'official_user'@'localhost';
GRANT EXECUTE ON official_website.* TO 'official_user'@'localhost';

-- 2. ç”¨æˆ·æ•°æ®åº“åªè¯»ç”¨æˆ·
CREATE USER 'readonly_user'@'localhost' IDENTIFIED BY '[å¼ºå¯†ç ]';
GRANT SELECT ON official_website_user.* TO 'readonly_user'@'localhost';

-- 3. è¿ç§»ä¸“ç”¨ç”¨æˆ·
CREATE USER 'migration_user'@'localhost' IDENTIFIED BY '[å¼ºå¯†ç ]';
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, ALTER, INDEX, DROP, REFERENCES, TRIGGER ON official_website.* TO 'migration_user'@'localhost';
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, ALTER, INDEX, DROP, REFERENCES, TRIGGER ON official_website_user.* TO 'migration_user'@'localhost';

-- 4. å¤‡ä»½ä¸“ç”¨ç”¨æˆ·
CREATE USER 'backup_user'@'localhost' IDENTIFIED BY '[å¼ºå¯†ç ]';
GRANT SELECT, LOCK TABLES, SHOW VIEW, EVENT, TRIGGER ON *.* TO 'backup_user'@'localhost';

-- 5. ç›‘æ§ç”¨æˆ·
CREATE USER 'monitor_user'@'localhost' IDENTIFIED BY '[å¼ºå¯†ç ]';
GRANT SELECT, REPLICATION CLIENT, SHOW DATABASES ON *.* TO 'monitor_user'@'localhost';

-- åˆ·æ–°æƒé™
FLUSH PRIVILEGES;
```

**æƒé™å®¡è®¡è„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ•°æ®åº“æƒé™å®¡è®¡è„šæœ¬ - audit_permissions.sh
set -e

AUDIT_REPORT="/var/log/db_permission_audit_$(date +%Y%m%d).log"

echo "æ•°æ®åº“æƒé™å®¡è®¡æŠ¥å‘Š - $(date)" > "$AUDIT_REPORT"
echo "=============================" >> "$AUDIT_REPORT"

# å®¡è®¡ç”¨æˆ·æƒé™
echo "" >> "$AUDIT_REPORT"
echo "ç”¨æˆ·æƒé™åˆ—è¡¨:" >> "$AUDIT_REPORT"
echo "-------------" >> "$AUDIT_REPORT"

mysql -u root -p -e "
    SELECT
        user,
        host,
        authentication_string,
        plugin
    FROM mysql.user;
" >> "$AUDIT_REPORT"

# å®¡è¯¢æ•°æ®åº“çº§æƒé™
echo "" >> "$AUDIT_REPORT"
echo "æ•°æ®åº“çº§æƒé™:" >> "$AUDIT_REPORT"
echo "-------------" >> "$AUDIT_REPORT"

mysql -u root -p -e "
    SELECT
        grantee,
        table_schema,
        privilege_type
    FROM information_schema.role_table_grants
    WHERE table_schema IN ('official_website', 'official_website_user')
    ORDER BY grantee, table_schema;
" >> "$AUDIT_REPORT"

echo "æƒé™å®¡è®¡å®Œæˆï¼ŒæŠ¥å‘Šä¿å­˜è‡³: $AUDIT_REPORT"
```

#### 5.6.2 æ•°æ®åŠ å¯†é…ç½®

**SSL è¿æ¥é…ç½®**ï¼š

```yaml
# config/packages/doctrine.yaml - SSLè¿æ¥é…ç½®
doctrine:
    dbal:
        connections:
            default:
                url: "%env(resolve:DATABASE_URL)%"
                driver_options:
                    # SSLé…ç½®
                    1014: 1 # PDO::MYSQL_ATTR_SSL_VERIFY_SERVER_CERT
                    1015: 1 # PDO::MYSQL_ATTR_SSL_USE_SYSTEM_CA
                    1016: "/etc/ssl/certs/mysql-ca.pem" # SSL CAè¯ä¹¦
                    1017: "/etc/ssl/certs/mysql-client-cert.pem" # å®¢æˆ·ç«¯è¯ä¹¦
                    1018: "/etc/ssl/private/mysql-client-key.pem" # å®¢æˆ·ç«¯ç§é’¥
            user:
                url: "%env(resolve:USER_DATABASE_URL)%"
                driver_options:
                    1014: 1
                    1015: 1
                    1016: "/etc/ssl/certs/mysql-ca.pem"
                    1017: "/etc/ssl/certs/mysql-client-cert.pem"
                    1018: "/etc/ssl/private/mysql-client-key.pem"
```

**MySQL æœåŠ¡å™¨ SSL é…ç½®**ï¼š

```ini
# /etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]
# SSLé…ç½®
ssl-ca=/etc/mysql/ssl/ca-cert.pem
ssl-cert=/etc/mysql/ssl/server-cert.pem
ssl-key=/etc/mysql/ssl/server-key.pem

# å¼ºåˆ¶SSLè¿æ¥
require_secure_transport=ON

# æ•°æ®åŠ å¯†é…ç½®
innodb_encrypt_tables=ON
innodb_encrypt_log=ON
innodb_encrypt_tmp=ON
```

#### 5.6.3 å®¡è®¡æ—¥å¿—é…ç½®

**MySQL å®¡è®¡æ’ä»¶é…ç½®**ï¼š

```sql
-- å¯ç”¨å®¡è®¡æ—¥å¿—
INSTALL PLUGIN audit_log SONAME 'audit_log.so';

-- é…ç½®å®¡è®¡å‚æ•°
SET GLOBAL audit_log_format = 'JSON';
SET GLOBAL audit_log_policy = 'ALL';
SET GLOBAL audit_log_file = '/var/log/mysql/audit.log';
SET GLOBAL audit_log_rotate_on_size = 1073741824;  -- 1GBè½®è½¬
SET GLOBAL audit_log_rotations = 10;
```

**å®¡è®¡æ—¥å¿—åˆ†æè„šæœ¬**ï¼š

```bash
#!/bin/bash
# å®¡è®¡æ—¥å¿—åˆ†æè„šæœ¬ - analyze_audit_log.sh
set -e

AUDIT_LOG="/var/log/mysql/audit.log"
ANALYSIS_REPORT="/var/log/audit_analysis_$(date +%Y%m%d).log"

echo "å®¡è®¡æ—¥å¿—åˆ†ææŠ¥å‘Š - $(date)" > "$ANALYSIS_REPORT"
echo "=========================" >> "$ANALYSIS_REPORT"

# åˆ†æç™»å½•å°è¯•
echo "" >> "$ANALYSIS_REPORT"
echo "ç™»å½•å°è¯•ç»Ÿè®¡:" >> "$ANALYSIS_REPORT"
echo "-------------" >> "$ANALYSIS_REPORT"
grep -o '"command":"Connect"' "$AUDIT_LOG" | wc -l >> "$ANALYSIS_REPORT"

# åˆ†æå¤±è´¥çš„ç™»å½•
echo "" >> "$ANALYSIS_REPORT"
echo "å¤±è´¥ç™»å½•ç»Ÿè®¡:" >> "$ANALYSIS_REPORT"
echo "-------------" >> "$ANALYSIS_REPORT"
grep -o '"status":"Command failed"' "$AUDIT_LOG" | wc -l >> "$ANALYSIS_REPORT"

# åˆ†æDMLæ“ä½œ
echo "" >> "$ANALYSIS_REPORT"
echo "DMLæ“ä½œç»Ÿè®¡:" >> "$ANALYSIS_REPORT"
echo "-------------" >> "$ANALYSIS_REPORT"
echo -e "INSERT: $(grep -o '"command":"Insert"' "$AUDIT_LOG" | wc -l)" >> "$ANALYSIS_REPORT"
echo -e "UPDATE: $(grep -o '"command":"Update"' "$AUDIT_LOG" | wc -l)" >> "$ANALYSIS_REPORT"
echo -e "DELETE: $(grep -o '"command":"Delete"' "$AUDIT_LOG" | wc -l)" >> "$ANALYSIS_REPORT"

echo "å®¡è®¡æ—¥å¿—åˆ†æå®Œæˆï¼ŒæŠ¥å‘Šä¿å­˜è‡³: $ANALYSIS_REPORT"
```

### 5.7 æ•°æ®åº“ä¼˜åŒ–é…ç½®

#### 5.7.1 MySQL æ€§èƒ½ä¼˜åŒ–

**ç”Ÿäº§ç¯å¢ƒ MySQL é…ç½®**ï¼š

```ini
# /etc/mysql/mysql.conf.d/mysqld.cnf
[mysqld]

# åŸºç¡€é…ç½®
port = 3306
bind-address = 127.0.0.1
socket = /var/run/mysqld/mysqld.sock
pid-file = /var/run/mysqld/mysqld.pid
user = mysql

# å­—ç¬¦é›†é…ç½®
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
init_connect = 'SET NAMES utf8mb4'

# å†…å­˜é…ç½®
innodb_buffer_pool_size = 2G          # è®¾ç½®ä¸ºå¯ç”¨å†…å­˜çš„70-80%
innodb_buffer_pool_instances = 4       # ç¼“å†²æ± å®ä¾‹æ•°
innodb_log_file_size = 256M            # æ—¥å¿—æ–‡ä»¶å¤§å°
innodb_log_buffer_size = 16M           # æ—¥å¿—ç¼“å†²åŒºå¤§å°
key_buffer_size = 32M                  # MyISAMé”®ç¼“å†²åŒº
sort_buffer_size = 2M                   # æ’åºç¼“å†²åŒº
read_buffer_size = 2M                   # è¯»å–ç¼“å†²åŒº
read_rnd_buffer_size = 8M              # éšæœºè¯»å–ç¼“å†²åŒº
tmp_table_size = 64M                   # ä¸´æ—¶è¡¨å¤§å°
max_heap_table_size = 64M              # æœ€å¤§å †è¡¨å¤§å°

# è¿æ¥é…ç½®
max_connections = 200                   # æœ€å¤§è¿æ¥æ•°
max_connect_errors = 10000             # æœ€å¤§è¿æ¥é”™è¯¯æ•°
connect_timeout = 10                   # è¿æ¥è¶…æ—¶
wait_timeout = 600                     # ç­‰å¾…è¶…æ—¶
interactive_timeout = 600              # äº¤äº’è¶…æ—¶

# æŸ¥è¯¢ç¼“å­˜
query_cache_type = 1                   # æŸ¥è¯¢ç¼“å­˜ç±»å‹
query_cache_size = 128M                # æŸ¥è¯¢ç¼“å­˜å¤§å°
query_cache_limit = 2M                 # å•ä¸ªæŸ¥è¯¢ç¼“å­˜é™åˆ¶

# InnoDBé…ç½®
innodb_file_per_table = 1              # ç‹¬ç«‹è¡¨ç©ºé—´
innodb_flush_log_at_trx_commit = 2      # äº‹åŠ¡æ—¥å¿—åˆ·æ–°ç­–ç•¥
innodb_flush_method = O_DIRECT         # åˆ·æ–°æ–¹æ³•
innodb_io_capacity = 2000              # I/Oå®¹é‡
innodb_io_capacity_max = 4000          # æœ€å¤§I/Oå®¹é‡
innodb_read_io_threads = 8             # è¯»çº¿ç¨‹æ•°
innodb_write_io_threads = 8             # å†™çº¿ç¨‹æ•°

# æ—¥å¿—é…ç½®
log_error = /var/log/mysql/error.log
slow_query_log = 1                     # å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2                     # æ…¢æŸ¥è¯¢é˜ˆå€¼
log_queries_not_using_indexes = 1      # è®°å½•æœªä½¿ç”¨ç´¢å¼•çš„æŸ¥è¯¢

# äºŒè¿›åˆ¶æ—¥å¿—
log_bin = /var/log/mysql/mysql-bin.log
binlog_format = ROW                     # è¡Œçº§å¤åˆ¶
expire_logs_days = 7                    # æ—¥å¿—ä¿ç•™å¤©æ•°
max_binlog_size = 100M                  # å•ä¸ªæ—¥å¿—æ–‡ä»¶å¤§å°

# å®‰å…¨é…ç½®
skip-name-resolve                       # è·³è¿‡åŸŸåè§£æ
local_infile = 0                        # ç¦ç”¨LOAD DATA LOCAL
```

#### 5.7.2 å®šæœŸç»´æŠ¤ä»»åŠ¡

**æ•°æ®åº“ç»´æŠ¤è„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ•°æ®åº“ç»´æŠ¤è„šæœ¬ - db_maintenance.sh
set -e

MAINTENANCE_LOG="/var/log/db_maintenance_$(date +%Y%m%d).log"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$MAINTENANCE_LOG"
}

# ä¼˜åŒ–è¡¨
optimize_tables() {
    log "å¼€å§‹ä¼˜åŒ–è¡¨..."

    # è·å–æ‰€æœ‰è¡¨
    local tables=$(mysql -u root -p -e "SELECT table_name FROM information_schema.tables WHERE table_schema='official_website' AND engine='InnoDB';" | grep -v "table_name")

    for table in $tables; do
        log "ä¼˜åŒ–è¡¨: $table"
        mysql -u root -p -e "OPTIMIZE TABLE official_website.$table;" >> "$MAINTENANCE_LOG" 2>&1
    done

    log "è¡¨ä¼˜åŒ–å®Œæˆ"
}

# åˆ†æè¡¨
analyze_tables() {
    log "å¼€å§‹åˆ†æè¡¨..."

    local tables=$(mysql -u root -p -e "SELECT table_name FROM information_schema.tables WHERE table_schema='official_website';" | grep -v "table_name")

    for table in $tables; do
        log "åˆ†æè¡¨: $table"
        mysql -u root -p -e "ANALYZE TABLE official_website.$table;" >> "$MAINTENANCE_LOG" 2>&1
    done

    log "è¡¨åˆ†æå®Œæˆ"
}

# æ£€æŸ¥è¡¨
check_tables() {
    log "å¼€å§‹æ£€æŸ¥è¡¨..."

    local tables=$(mysql -u root -p -e "SELECT table_name FROM information_schema.tables WHERE table_schema='official_website';" | grep -v "table_name")

    for table in $tables; do
        log "æ£€æŸ¥è¡¨: $table"
        mysql -u root -p -e "CHECK TABLE official_website.$table;" >> "$MAINTENANCE_LOG" 2>&1
    done

    log "è¡¨æ£€æŸ¥å®Œæˆ"
}

# ä¿®å¤è¡¨
repair_tables() {
    log "å¼€å§‹ä¿®å¤è¡¨..."

    local tables=$(mysql -u root -p -e "SELECT table_name FROM information_schema.tables WHERE table_schema='official_website' AND table_rows > 0;" | grep -v "table_name")

    for table in $tables; do
        log "ä¿®å¤è¡¨: $table"
        mysql -u root -p -e "REPAIR TABLE official_website.$table;" >> "$MAINTENANCE_LOG" 2>&1
    done

    log "è¡¨ä¿®å¤å®Œæˆ"
}

# æ¸…ç†äºŒè¿›åˆ¶æ—¥å¿—
cleanup_binlog() {
    log "æ¸…ç†äºŒè¿›åˆ¶æ—¥å¿—..."

    # ä¿ç•™æœ€è¿‘7å¤©çš„æ—¥å¿—
    mysql -u root -p -e "PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);" >> "$MAINTENANCE_LOG" 2>&1

    log "äºŒè¿›åˆ¶æ—¥å¿—æ¸…ç†å®Œæˆ"
}

# ä¸»ç»´æŠ¤æµç¨‹
main() {
    log "å¼€å§‹æ•°æ®åº“ç»´æŠ¤ä»»åŠ¡"

    case "$1" in
        "optimize")
            optimize_tables
            ;;
        "analyze")
            analyze_tables
            ;;
        "check")
            check_tables
            ;;
        "repair")
            repair_tables
            ;;
        "cleanup")
            cleanup_binlog
            ;;
        "all")
            check_tables
            analyze_tables
            optimize_tables
            cleanup_binlog
            ;;
        *)
            echo "ç”¨æ³•: $0 {optimize|analyze|check|repair|cleanup|all}"
            exit 1
            ;;
    esac

    log "æ•°æ®åº“ç»´æŠ¤ä»»åŠ¡å®Œæˆ"
}

main "$@"
```

#### 5.7.3 ç›‘æ§å’Œå‘Šè­¦

**æ•°æ®åº“ç›‘æ§é…ç½®**ï¼š

```bash
#!/bin/bash
# æ•°æ®åº“ç›‘æ§å‘Šè­¦è„šæœ¬ - db_alert.sh
set -e

ALERT_EMAIL="admin@example.com"
ALERT_THRESHOLD_CPU=80
ALERT_THRESHOLD_MEMORY=85
ALERT_THRESHOLD_CONNECTIONS=90
ALERT_THRESHOLD_DISK_SPACE=85

# å‘é€å‘Šè­¦é‚®ä»¶
send_alert() {
    local subject=$1
    local message=$2

    echo "$message" | mail -s "$subject" "$ALERT_EMAIL"
    echo "å‘Šè­¦é‚®ä»¶å·²å‘é€: $subject"
}

# æ£€æŸ¥CPUä½¿ç”¨ç‡
check_cpu_usage() {
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d% -f1)

    if (( $(echo "$cpu_usage > $ALERT_THRESHOLD_CPU" | bc -l) )); then
        send_alert "æ•°æ®åº“æœåŠ¡å™¨CPUå‘Šè­¦" "CPUä½¿ç”¨ç‡: ${cpu_usage}%ï¼Œè¶…è¿‡é˜ˆå€¼: ${ALERT_THRESHOLD_CPU}%"
    fi
}

# æ£€æŸ¥å†…å­˜ä½¿ç”¨ç‡
check_memory_usage() {
    local memory_usage=$(free | grep Mem | awk '{printf("%.1f", $3/$2 * 100.0)}')

    if (( $(echo "$memory_usage > $ALERT_THRESHOLD_MEMORY" | bc -l) )); then
        send_alert "æ•°æ®åº“æœåŠ¡å™¨å†…å­˜å‘Šè­¦" "å†…å­˜ä½¿ç”¨ç‡: ${memory_usage}%ï¼Œè¶…è¿‡é˜ˆå€¼: ${ALERT_THRESHOLD_MEMORY}%"
    fi
}

# æ£€æŸ¥æ•°æ®åº“è¿æ¥æ•°
check_db_connections() {
    local max_connections=$(mysql -u root -p -e "SHOW VARIABLES LIKE 'max_connections';" | tail -1 | awk '{print $2}')
    local current_connections=$(mysql -u root -p -e "SHOW STATUS LIKE 'Threads_connected';" | tail -1 | awk '{print $2}')
    local usage_percentage=$((current_connections * 100 / max_connections))

    if [ "$usage_percentage" -gt "$ALERT_THRESHOLD_CONNECTIONS" ]; then
        send_alert "æ•°æ®åº“è¿æ¥æ•°å‘Šè­¦" "è¿æ¥æ•°ä½¿ç”¨ç‡: ${usage_percentage}% (${current_connections}/${max_connections})"
    fi
}

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space() {
    local disk_usage=$(df /var/lib/mysql | tail -1 | awk '{print $5}' | cut -d% -f1)

    if [ "$disk_usage" -gt "$ALERT_THRESHOLD_DISK_SPACE" ]; then
        send_alert "æ•°æ®åº“æœåŠ¡å™¨ç£ç›˜ç©ºé—´å‘Šè­¦" "ç£ç›˜ä½¿ç”¨ç‡: ${disk_usage}%ï¼Œè¶…è¿‡é˜ˆå€¼: ${ALERT_THRESHOLD_DISK_SPACE}%"
    fi
}

# ä¸»ç›‘æ§å¾ªç¯
main() {
    while true; do
        check_cpu_usage
        check_memory_usage
        check_db_connections
        check_disk_space

        sleep 300  # æ¯5åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
    done
}

main
```

### 5.8 å®šæœŸä»»åŠ¡é…ç½®

#### 5.8.1 Cron ä»»åŠ¡é…ç½®

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹ä»»åŠ¡
# æ•°æ®åº“å¤‡ä»½ä»»åŠ¡
0 2 * * * /scripts/backup_database.sh full >> /var/log/cron_backup.log 2>&1
0 * * * * /scripts/backup_database.sh incremental >> /var/log/cron_backup.log 2>&1

# æ•°æ®åº“ç»´æŠ¤ä»»åŠ¡
0 3 * * 0 /scripts/db_maintenance.sh all >> /var/log/cron_maintenance.log 2>&1

# æ•°æ®åº“ç›‘æ§
*/5 * * * * /scripts/db_alert.sh >> /var/log/cron_monitor.log 2>&1

# æ—¥å¿—åˆ†æä»»åŠ¡
0 4 * * * /scripts/analyze_slow_queries.sh >> /var/log/cron_analysis.log 2>&1
0 5 * * * /scripts/db_health_check.sh >> /var/log/cron_health.log 2>&1

# å¤‡ä»½åŒæ­¥ä»»åŠ¡
0 6 * * * /scripts/sync_backup.sh >> /var/log/cron_sync.log 2>&1

# æƒé™å®¡è®¡ä»»åŠ¡
0 1 * * 1 /scripts/audit_permissions.sh >> /var/log/cron_audit.log 2>&1
```

#### 5.8.2 ä»»åŠ¡ç›‘æ§è„šæœ¬

```bash
#!/bin/bash
# Cronä»»åŠ¡ç›‘æ§è„šæœ¬ - monitor_cron.sh
set -e

MONITOR_LOG="/var/log/cron_monitor.log"

# æ£€æŸ¥CronæœåŠ¡çŠ¶æ€
check_cron_service() {
    if systemctl is-active --quiet cron; then
        echo "[$(date)] âœ“ CronæœåŠ¡è¿è¡Œæ­£å¸¸" >> "$MONITOR_LOG"
    else
        echo "[$(date)] âœ— CronæœåŠ¡å¼‚å¸¸ï¼Œå°è¯•é‡å¯" >> "$MONITOR_LOG"
        systemctl restart cron
    fi
}

# æ£€æŸ¥ä»»åŠ¡æ‰§è¡Œæƒ…å†µ
check_cron_jobs() {
    echo "[$(date)] æ£€æŸ¥Cronä»»åŠ¡æ‰§è¡Œæƒ…å†µ..." >> "$MONITOR_LOG"

    # æ£€æŸ¥å¤‡ä»½ä»»åŠ¡
    if [ $(find /backup/database/full -name "*.sql.gz" -mtime -1 | wc -l) -gt 0 ]; then
        echo "[$(date)] âœ“ å¤‡ä»½ä»»åŠ¡æ‰§è¡Œæ­£å¸¸" >> "$MONITOR_LOG"
    else
        echo "[$(date)] âœ— å¤‡ä»½ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸" >> "$MONITOR_LOG"
    fi

    # æ£€æŸ¥ç»´æŠ¤ä»»åŠ¡
    if [ $(find /var/log -name "db_maintenance_*.log" -mtime -1 | wc -l) -gt 0 ]; then
        echo "[$(date)] âœ“ ç»´æŠ¤ä»»åŠ¡æ‰§è¡Œæ­£å¸¸" >> "$MONITOR_LOG"
    else
        echo "[$(date)] âœ— ç»´æŠ¤ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸" >> "$MONITOR_LOG"
    fi
}

# ä¸»ç›‘æ§æµç¨‹
main() {
    check_cron_service
    check_cron_jobs
}

main
```

è‡³æ­¤ï¼Œç¬¬ 5 ç« "æ•°æ®åº“ç®¡ç†"çš„è¯¦ç»†å†…å®¹å·²ç»å¡«å……å®Œæˆï¼ŒåŒ…å«äº†åŒæ•°æ®åº“æ¶æ„è¯´æ˜ã€æ•°æ®åº“è¿ç§»æµç¨‹ã€å¤‡ä»½ç­–ç•¥ã€æ¢å¤æµç¨‹ã€æ•°æ®åº“ç›‘æ§ã€æ•°æ®å®‰å…¨ã€æ€§èƒ½ä¼˜åŒ–é…ç½®å’Œå®šæœŸä»»åŠ¡é…ç½®ç­‰æ‰€æœ‰è¦æ±‚çš„å†…å®¹ã€‚

---

## 6. å®‰å…¨é…ç½®

### 6.1 JWT è®¤è¯å®‰å…¨

#### 6.1.1 JWT å¯†é’¥ç®¡ç†

**å¯†é’¥ç”Ÿæˆå’Œå­˜å‚¨**ï¼š

-   ä½¿ç”¨ 4096 ä½ RSA å¯†é’¥å¯¹
-   ç§é’¥æ–‡ä»¶æƒé™è®¾ç½®ä¸º 600
-   å…¬é’¥æ–‡ä»¶æƒé™è®¾ç½®ä¸º 644
-   å¯†é’¥æ–‡ä»¶å­˜å‚¨åœ¨ `config/jwt/` ç›®å½•ä¸‹
-   å®šæœŸè½®æ¢å¯†é’¥ï¼ˆå»ºè®®æ¯ 6 ä¸ªæœˆï¼‰

**å¯†é’¥è½®æ¢ç­–ç•¥**ï¼š

-   åˆ¶å®šå¯†é’¥è½®æ¢è®¡åˆ’å’Œæ—¶é—´è¡¨
-   ä¿ç•™æ—§å¯†é’¥ç”¨äºç°æœ‰ Token éªŒè¯
-   åˆ†é˜¶æ®µéƒ¨ç½²æ–°å¯†é’¥
-   ç›‘æ§å¯†é’¥è½®æ¢æœŸé—´çš„è®¤è¯æƒ…å†µ

**å¯†é’¥æ³„éœ²åº”æ€¥å¤„ç†**ï¼š

1. ç«‹å³æ’¤é”€æ‰€æœ‰æœ‰æ•ˆ Token
2. ç”Ÿæˆæ–°çš„å¯†é’¥å¯¹
3. æ›´æ–°æ‰€æœ‰æœåŠ¡å™¨é…ç½®
4. å¼ºåˆ¶ç”¨æˆ·é‡æ–°ç™»å½•
5. å®¡æŸ¥è®¿é—®æ—¥å¿—æŸ¥æ‰¾å¼‚å¸¸

#### 6.1.2 JWT é…ç½®ä¼˜åŒ–

```yaml
# config/packages/lexik_jwt_authentication.yaml
lexik_jwt_authentication:
    secret_key: "%env(resolve:JWT_SECRET_KEY)%"
    public_key: "%env(resolve:JWT_PUBLIC_KEY)%"
    pass_phrase: "%env(JWT_PASSPHRASE)%"
    token_ttl: 3600 # Access Tokenæœ‰æ•ˆæœŸ1å°æ—¶
    refresh_token_ttl: 2592000 # Refresh Tokenæœ‰æ•ˆæœŸ30å¤©
    encoder:
        # ä½¿ç”¨æ›´å¼ºçš„ç­¾åç®—æ³•
        signature_algorithm: RS256
        # å¯ç”¨å¯†é’¥ID
        key_id: "%env(JWT_KEY_ID)%"
    # Tokenè½½è·é…ç½®
    user_identity_field: username
    # é˜²æ­¢Tokené‡æ”¾æ”»å‡»
    disable_csrf_protection: false
```

#### 6.1.3 Token å®‰å…¨ç­–ç•¥

**Token è¿‡æœŸæ—¶é—´è®¾ç½®**ï¼š

-   Access Token: 1 å°æ—¶ï¼ˆçŸ­æœ‰æ•ˆæœŸï¼Œé™ä½æ³„éœ²é£é™©ï¼‰
-   Refresh Token: 30 å¤©ï¼ˆè¾ƒé•¿æœ‰æ•ˆæœŸï¼Œæå‡ç”¨æˆ·ä½“éªŒï¼‰
-   ç»å¯¹è¿‡æœŸæ—¶é—´ï¼š7 å¤©ï¼ˆå¼ºåˆ¶é‡æ–°è®¤è¯ï¼‰

**åˆ·æ–° Token æœºåˆ¶**ï¼š

-   å®ç°å®‰å…¨çš„ Token åˆ·æ–°ç«¯ç‚¹
-   éªŒè¯ Refresh Token çš„æœ‰æ•ˆæ€§
-   é™åˆ¶åˆ·æ–°é¢‘ç‡ï¼ˆå¦‚ï¼šæ¯åˆ†é’Ÿæœ€å¤š 5 æ¬¡ï¼‰
-   è®°å½• Token åˆ·æ–°æ—¥å¿—

**Token é»‘åå•ç®¡ç†**ï¼š

```php
// ç¤ºä¾‹ï¼šTokené»‘åå•å®ç°
class TokenBlacklistService
{
    public function addToBlacklist(string $tokenId, \DateTimeInterface $expiresAt): void
    {
        // å°†Token IDæ·»åŠ åˆ°Redisé»‘åå•
        $this->redis->setex(
            "blacklist:{$tokenId}",
            $expiresAt->getTimestamp() - time(),
            '1'
        );
    }

    public function isBlacklisted(string $tokenId): bool
    {
        return $this->redis->exists("blacklist:{$tokenId}");
    }
}
```

#### 6.1.4 JWT å¯†é’¥ç”Ÿæˆè„šæœ¬

```bash
#!/bin/bash
# JWTå¯†é’¥ç”Ÿæˆå’Œè½®æ¢è„šæœ¬ - jwt_key_management.sh
set -e

JWT_DIR="/var/www/official_website_backend/config/jwt"
BACKUP_DIR="/backup/jwt_keys"
LOG_FILE="/var/log/jwt_key_management.log"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# ç”Ÿæˆæ–°çš„JWTå¯†é’¥å¯¹
generate_jwt_keys() {
    local key_id=$1
    if [ -z "$key_id" ]; then
        key_id="jwt_$(date +%Y%m%d_%H%M%S)"
    fi

    log "å¼€å§‹ç”ŸæˆJWTå¯†é’¥å¯¹ï¼ŒKey ID: $key_id"

    # åˆ›å»ºå¤‡ä»½ç›®å½•
    mkdir -p "$BACKUP_DIR"

    # å¤‡ä»½ç°æœ‰å¯†é’¥
    if [ -f "$JWT_DIR/private.pem" ]; then
        local backup_name="backup_$(date +%Y%m%d_%H%M%S)"
        mkdir -p "$BACKUP_DIR/$backup_name"
        cp "$JWT_DIR/"*.pem "$BACKUP_DIR/$backup_name/"
        log "ç°æœ‰å¯†é’¥å·²å¤‡ä»½åˆ°: $BACKUP_DIR/$backup_name"
    fi

    # ç¡®ä¿JWTç›®å½•å­˜åœ¨
    mkdir -p "$JWT_DIR"

    # ç”Ÿæˆæ–°çš„RSAå¯†é’¥å¯¹
    log "ç”Ÿæˆ4096ä½RSAå¯†é’¥å¯¹..."
    openssl genpkey -out "$JWT_DIR/private_new.pem" -aes256 -algorithm RSA -pkeyopt rsa_keygen_bits:4096 -pass pass:"$(openssl rand -hex 20)"

    # æå–å…¬é’¥
    openssl rsa -pubout -in "$JWT_DIR/private_new.pem" -out "$JWT_DIR/public_new.pem" -passin pass:"$(openssl rand -hex 20)"

    # è®¾ç½®æ­£ç¡®çš„æƒé™
    chmod 600 "$JWT_DIR/private_new.pem"
    chmod 644 "$JWT_DIR/public_new.pem"
    chown www-data:www-data "$JWT_DIR/"*.pem

    log "JWTå¯†é’¥å¯¹ç”Ÿæˆå®Œæˆ"
    log "ç§é’¥æ–‡ä»¶: $JWT_DIR/private_new.pem (æƒé™: 600)"
    log "å…¬é’¥æ–‡ä»¶: $JWT_DIR/public_new.pem (æƒé™: 644)"
    log "Key ID: $key_id"

    # æ›´æ–°ç¯å¢ƒå˜é‡é…ç½®
    update_env_file "$key_id"

    log "è¯·æ‰‹åŠ¨æ›´æ–° .env.local æ–‡ä»¶ä¸­çš„JWT_PASSPHRASE"
}

# æ›´æ–°ç¯å¢ƒå˜é‡æ–‡ä»¶
update_env_file() {
    local key_id=$1
    local env_file="/var/www/official_website_backend/.env.local"

    if [ -f "$env_file" ]; then
        # å¤‡ä»½ç¯å¢ƒæ–‡ä»¶
        cp "$env_file" "$env_file.backup.$(date +%Y%m%d_%H%M%S)"

        # æ›´æ–°Key ID
        if grep -q "JWT_KEY_ID=" "$env_file"; then
            sed -i "s/JWT_KEY_ID=.*/JWT_KEY_ID=$key_id/" "$env_file"
        else
            echo "JWT_KEY_ID=$key_id" >> "$env_file"
        fi

        log "ç¯å¢ƒæ–‡ä»¶å·²æ›´æ–°ï¼ŒKey ID: $key_id"
    fi
}

# éªŒè¯JWTé…ç½®
validate_jwt_config() {
    log "éªŒè¯JWTé…ç½®..."

    # æ£€æŸ¥å¯†é’¥æ–‡ä»¶
    if [ ! -f "$JWT_DIR/private.pem" ] || [ ! -f "$JWT_DIR/public.pem" ]; then
        log "é”™è¯¯: JWTå¯†é’¥æ–‡ä»¶ä¸å­˜åœ¨"
        return 1
    fi

    # æ£€æŸ¥æ–‡ä»¶æƒé™
    local private_perms=$(stat -c "%a" "$JWT_DIR/private.pem")
    local public_perms=$(stat -c "%a" "$JWT_DIR/public.pem")

    if [ "$private_perms" != "600" ]; then
        log "è­¦å‘Š: ç§é’¥æ–‡ä»¶æƒé™ä¸æ­£ç¡® (å½“å‰: $private_perms, æœŸæœ›: 600)"
    fi

    if [ "$public_perms" != "644" ]; then
        log "è­¦å‘Š: å…¬é’¥æ–‡ä»¶æƒé™ä¸æ­£ç¡® (å½“å‰: $public_perms, æœŸæœ›: 644)"
    fi

    # æµ‹è¯•å¯†é’¥å¯¹
    if openssl rsa -in "$JWT_DIR/private.pem" -pubout -check > /dev/null 2>&1; then
        log "âœ“ JWTå¯†é’¥å¯¹éªŒè¯é€šè¿‡"
    else
        log "âœ— JWTå¯†é’¥å¯¹éªŒè¯å¤±è´¥"
        return 1
    fi

    log "JWTé…ç½®éªŒè¯å®Œæˆ"
}

# æ¸…ç†è¿‡æœŸå¤‡ä»½
cleanup_old_backups() {
    log "æ¸…ç†30å¤©å‰çš„JWTå¯†é’¥å¤‡ä»½..."
    find "$BACKUP_DIR" -type d -mtime +30 -exec rm -rf {} \; 2>/dev/null || true
    log "å¤‡ä»½æ¸…ç†å®Œæˆ"
}

# ä¸»å‡½æ•°
main() {
    case "$1" in
        "generate")
            generate_jwt_keys "$2"
            ;;
        "validate")
            validate_jwt_config
            ;;
        "cleanup")
            cleanup_old_backups
            ;;
        *)
            echo "ç”¨æ³•: $0 {generate|validate|cleanup} [key_id]"
            echo "ç¤ºä¾‹:"
            echo "  $0 generate jwt_prod_20251201"
            echo "  $0 validate"
            echo "  $0 cleanup"
            exit 1
            ;;
    esac
}

main "$@"
```

### 6.2 HTTPS å®‰å…¨é…ç½®

#### 6.2.1 SSL è¯ä¹¦ç®¡ç†

**è¯ä¹¦ç”³è¯·å’Œå®‰è£…**ï¼š

```bash
# ä½¿ç”¨Let's Encryptç”³è¯·å…è´¹SSLè¯ä¹¦
certbot --nginx -d yourdomain.com -d www.yourdomain.com

# æˆ–è€…ä½¿ç”¨å•†ä¸šè¯ä¹¦
# 1. ç”ŸæˆCSR
openssl req -new -newkey rsa:4096 -keyout private.key -out certificate.csr

# 2. æäº¤CSRç»™è¯ä¹¦é¢å‘æœºæ„
# 3. ä¸‹è½½å¹¶å®‰è£…è¯ä¹¦æ–‡ä»¶
```

**è¯ä¹¦è‡ªåŠ¨ç»­æœŸ**ï¼š

```bash
# æ·»åŠ åˆ°crontabï¼Œæ¯å¤©æ£€æŸ¥ä¸€æ¬¡
0 2 * * * /usr/bin/certbot renew --quiet --post-hook "systemctl reload nginx"
```

**è¯ä¹¦å®‰å…¨å¼ºåº¦æ£€æŸ¥**ï¼š

```bash
# æ£€æŸ¥SSLé…ç½®å¼ºåº¦
openssl s_client -connect yourdomain.com:443 -tls1_2 < /dev/null 2>/dev/null | openssl x509 -text -noout

# åœ¨çº¿SSLæµ‹è¯•å·¥å…·
# https://www.ssllabs.com/ssltest/
```

#### 6.2.2 HTTPS é…ç½®ä¼˜åŒ–

```nginx
# SSLå®‰å…¨é…ç½®
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
ssl_prefer_server_ciphers off;
ssl_session_cache shared:SSL:10m;
ssl_session_timeout 10m;
ssl_session_tickets off;

# OCSPè£…è®¢
ssl_stapling on;
ssl_stapling_verify on;

# HSTSé…ç½®
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# å…¶ä»–å®‰å…¨å¤´
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
```

#### 6.2.3 SSL è¯ä¹¦ç®¡ç†è„šæœ¬

```bash
#!/bin/bash
# SSLè¯ä¹¦ç®¡ç†è„šæœ¬ - ssl_certificate_manager.sh
set -e

DOMAIN=$1
ACTION=$2
CERT_DIR="/etc/ssl/certs"
KEY_DIR="/etc/ssl/private"
LOG_FILE="/var/log/ssl_management.log"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# ç”Ÿæˆè‡ªç­¾åè¯ä¹¦ï¼ˆå¼€å‘ç¯å¢ƒï¼‰
generate_self_signed_cert() {
    local domain=$1
    local cert_file="$CERT_DIR/$domain.crt"
    local key_file="$KEY_DIR/$domain.key"

    log "ä¸ºåŸŸå $domain ç”Ÿæˆè‡ªç­¾åè¯ä¹¦..."

    # åˆ›å»ºç›®å½•
    mkdir -p "$CERT_DIR" "$KEY_DIR"

    # ç”Ÿæˆç§é’¥
    openssl genrsa -out "$key_file" 4096

    # ç”Ÿæˆè¯ä¹¦
    openssl req -new -x509 -key "$key_file" -out "$cert_file" -days 365 \
        -subj "/C=CN/ST=State/L=City/O=Organization/CN=$domain"

    # è®¾ç½®æƒé™
    chmod 600 "$key_file"
    chmod 644 "$cert_file"

    log "è‡ªç­¾åè¯ä¹¦ç”Ÿæˆå®Œæˆ:"
    log "è¯ä¹¦æ–‡ä»¶: $cert_file"
    log "ç§é’¥æ–‡ä»¶: $key_file"
}

# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
check_certificate_expiry() {
    local domain=$1
    local cert_file="$CERT_DIR/$domain.crt"

    if [ ! -f "$cert_file" ]; then
        log "é”™è¯¯: è¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨ $cert_file"
        return 1
    fi

    local expiry_date=$(openssl x509 -in "$cert_file" -noout -enddate | cut -d= -f2)
    local expiry_timestamp=$(date -d "$expiry_date" +%s)
    local current_timestamp=$(date +%s)
    local days_until_expiry=$(( (expiry_timestamp - current_timestamp) / 86400 ))

    log "åŸŸå: $domain"
    log "è¿‡æœŸæ—¥æœŸ: $expiry_date"
    log "å‰©ä½™å¤©æ•°: $days_until_expiry"

    if [ "$days_until_expiry" -lt 30 ]; then
        log "è­¦å‘Š: è¯ä¹¦å°†åœ¨30å¤©å†…è¿‡æœŸï¼"
        return 1
    elif [ "$days_until_expiry" -lt 7 ]; then
        log "ä¸¥é‡è­¦å‘Š: è¯ä¹¦å°†åœ¨7å¤©å†…è¿‡æœŸï¼"
        return 2
    else
        log "è¯ä¹¦æœ‰æ•ˆæœŸæ­£å¸¸"
        return 0
    fi
}

# éªŒè¯è¯ä¹¦é“¾
verify_certificate_chain() {
    local domain=$1
    local cert_file="$CERT_DIR/$domain.crt"

    log "éªŒè¯è¯ä¹¦é“¾: $domain"

    if openssl verify -CAfile /etc/ssl/certs/ca-certificates.crt "$cert_file" > /dev/null 2>&1; then
        log "âœ“ è¯ä¹¦é“¾éªŒè¯é€šè¿‡"
        return 0
    else
        log "âœ— è¯ä¹¦é“¾éªŒè¯å¤±è´¥"
        return 1
    fi
}

# æ£€æŸ¥SSLé…ç½®å¼ºåº¦
check_ssl_configuration() {
    local domain=$1
    local port=${2:-443}

    log "æ£€æŸ¥SSLé…ç½®å¼ºåº¦: $domain:$port"

    # æ£€æŸ¥åè®®æ”¯æŒ
    echo "æ”¯æŒçš„SSL/TLSåè®®:"
    openssl s_client -connect "$domain:$port" -tls1 < /dev/null 2>/dev/null && echo "  âœ“ TLSv1.0" || echo "  âœ— TLSv1.0"
    openssl s_client -connect "$domain:$port" -tls1_1 < /dev/null 2>/dev/null && echo "  âœ“ TLSv1.1" || echo "  âœ— TLSv1.1"
    openssl s_client -connect "$domain:$port" -tls1_2 < /dev/null 2>/dev/null && echo "  âœ“ TLSv1.2" || echo "  âœ— TLSv1.2"
    openssl s_client -connect "$domain:$port" -tls1_3 < /dev/null 2>/dev/null && echo "  âœ“ TLSv1.3" || echo "  âœ— TLSv1.3"

    # æ£€æŸ¥è¯ä¹¦ä¿¡æ¯
    echo "è¯ä¹¦ä¿¡æ¯:"
    openssl s_client -connect "$domain:$port" -showcerts < /dev/null 2>/dev/null | openssl x509 -noout -dates -subject -issuer
}

# ä¸»å‡½æ•°
main() {
    if [ -z "$DOMAIN" ]; then
        echo "ç”¨æ³•: $0 <domain> <action>"
        echo "æ“ä½œ: generate-self-signed, check-expiry, verify-chain, check-config"
        exit 1
    fi

    case "$ACTION" in
        "generate-self-signed")
            generate_self_signed_cert "$DOMAIN"
            ;;
        "check-expiry")
            check_certificate_expiry "$DOMAIN"
            ;;
        "verify-chain")
            verify_certificate_chain "$DOMAIN"
            ;;
        "check-config")
            check_ssl_configuration "$DOMAIN"
            ;;
        *)
            echo "ä¸æ”¯æŒçš„æ“ä½œ: $ACTION"
            echo "æ”¯æŒçš„æ“ä½œ: generate-self-signed, check-expiry, verify-chain, check-config"
            exit 1
            ;;
    esac
}

main "$@"
```

### 6.3 CORS å®‰å…¨é…ç½®

#### 6.3.1 CORS ç­–ç•¥é…ç½®

```yaml
# config/packages/nelmio_cors.yaml - ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®
nelmio_cors:
    defaults:
        origin_regex: false # ç”Ÿäº§ç¯å¢ƒå…³é—­æ­£åˆ™è¡¨è¾¾å¼
        allow_origin: ["%env(json:CORS_ALLOW_ORIGIN)%"] # ä»ç¯å¢ƒå˜é‡è¯»å–
        allow_methods: ["GET", "POST", "PUT", "PATCH", "DELETE", "OPTIONS"]
        allow_headers:
            ["Content-Type", "Authorization", "X-Requested-With", "Accept"]
        expose_headers: ["Link", "X-Total-Count"]
        max_age: 3600
        allow_credentials: true # å…è®¸æºå¸¦è®¤è¯ä¿¡æ¯
    paths:
        # å…¬å…±APIè·¯å¾„ - å…è®¸æ›´å¤šåŸŸå
        "^/public-api/":
            allow_origin:
                [
                    "https://yourdomain.com",
                    "https://www.yourdomain.com",
                    "https://admin.yourdomain.com",
                ]
            allow_methods: ["GET", "OPTIONS"]
            max_age: 3600

        # å®˜æ–¹APIè·¯å¾„ - ä¸¥æ ¼é™åˆ¶
        "^/official-api/":
            allow_origin:
                ["https://yourdomain.com", "https://www.yourdomain.com"]
            allow_headers: ["Content-Type", "Authorization"]
            max_age: 3600

        # APIæ–‡æ¡£è·¯å¾„ - ä»…å…è®¸å†…ç½‘è®¿é—®
        "^/api/doc":
            allow_origin: ["https://admin.yourdomain.com"]
            allow_methods: ["GET"]
            max_age: 3600
```

#### 6.3.2 å®‰å…¨å¤´é…ç½®

**Content Security Policy (CSP)**ï¼š

```nginx
# ä¸¥æ ¼çš„CSPé…ç½®
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self';" always;
```

**å…¶ä»–å®‰å…¨å¤´é…ç½®**ï¼š

```nginx
# ç‚¹å‡»åŠ«æŒé˜²æŠ¤
add_header X-Frame-Options "SAMEORIGIN" always;

# MIMEç±»å‹å—…æ¢é˜²æŠ¤
add_header X-Content-Type-Options "nosniff" always;

# XSSè¿‡æ»¤å™¨
add_header X-XSS-Protection "1; mode=block" always;

# å¼•ç”¨ç­–ç•¥
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# æƒé™ç­–ç•¥
add_header Permissions-Policy "geolocation=(), microphone=(), camera=()" always;
```

#### 6.3.3 CORS å®‰å…¨éªŒè¯è„šæœ¬

```bash
#!/bin/bash
# CORSå®‰å…¨éªŒè¯è„šæœ¬ - cors_security_check.sh
set -e

DOMAIN=$1
API_BASE_URL="https://$DOMAIN"
LOG_FILE="/var/log/cors_security_check.log"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# æ£€æŸ¥CORSå¤´
check_cors_headers() {
    local endpoint=$1
    local origin=$2

    log "æ£€æŸ¥ç«¯ç‚¹: $endpoint"
    log "æµ‹è¯•Origin: $origin"

    # å‘é€é¢„æ£€è¯·æ±‚
    local response=$(curl -s -I -H "Origin: $origin" -H "Access-Control-Request-Method: POST" -H "Access-Control-Request-Headers: Content-Type, Authorization" -X OPTIONS "$endpoint")

    # æ£€æŸ¥CORSç›¸å…³å¤´
    echo "$response" | grep -i "Access-Control-Allow-Origin" || log "è­¦å‘Š: ç¼ºå°‘ Access-Control-Allow-Origin å¤´"
    echo "$response" | grep -i "Access-Control-Allow-Methods" || log "è­¦å‘Š: ç¼ºå°‘ Access-Control-Allow-Methods å¤´"
    echo "$response" | grep -i "Access-Control-Allow-Headers" || log "è­¦å‘Š: ç¼ºå°‘ Access-Control-Allow-Headers å¤´"
    echo "$response" | grep -i "Access-Control-Max-Age" || log "è­¦å‘Š: ç¼ºå°‘ Access-Control-Max-Age å¤´"

    log "CORSå¤´æ£€æŸ¥å®Œæˆ"
}

# æ£€æŸ¥å®‰å…¨å¤´
check_security_headers() {
    local endpoint=$1

    log "æ£€æŸ¥å®‰å…¨å¤´: $endpoint"

    local response=$(curl -s -I "$endpoint")

    # æ£€æŸ¥å„ç§å®‰å…¨å¤´
    if echo "$response" | grep -q "X-Frame-Options"; then
        log "âœ“ X-Frame-Options å¤´å­˜åœ¨"
    else
        log "âœ— X-Frame-Options å¤´ç¼ºå¤±"
    fi

    if echo "$response" | grep -q "X-Content-Type-Options"; then
        log "âœ“ X-Content-Type-Options å¤´å­˜åœ¨"
    else
        log "âœ— X-Content-Type-Options å¤´ç¼ºå¤±"
    fi

    if echo "$response" | grep -q "X-XSS-Protection"; then
        log "âœ“ X-XSS-Protection å¤´å­˜åœ¨"
    else
        log "âœ— X-XSS-Protection å¤´ç¼ºå¤±"
    fi

    if echo "$response" | grep -q "Strict-Transport-Security"; then
        log "âœ“ Strict-Transport-Security å¤´å­˜åœ¨"
    else
        log "âœ— Strict-Transport-Security å¤´ç¼ºå¤±"
    fi

    if echo "$response" | grep -q "Content-Security-Policy"; then
        log "âœ“ Content-Security-Policy å¤´å­˜åœ¨"
    else
        log "âœ— Content-Security-Policy å¤´ç¼ºå¤±"
    fi

    log "å®‰å…¨å¤´æ£€æŸ¥å®Œæˆ"
}

# æµ‹è¯•æ¶æ„Origin
test_malicious_origins() {
    local endpoint=$1

    log "æµ‹è¯•æ¶æ„Origin..."

    local malicious_origins=(
        "http://evil.com"
        "https://evil.com"
        "null"
        "javascript://evil.com"
        "data:text/html,<script>alert('xss')</script>"
    )

    for origin in "${malicious_origins[@]}"; do
        log "æµ‹è¯•æ¶æ„Origin: $origin"
        local response=$(curl -s -I -H "Origin: $origin" -X OPTIONS "$endpoint")

        if echo "$response" | grep -q "Access-Control-Allow-Origin.*\*"; then
            log "è­¦å‘Š: æ£€æµ‹åˆ°é€šé…ç¬¦CORSç­–ç•¥ï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é£é™©"
        fi
    done

    log "æ¶æ„Originæµ‹è¯•å®Œæˆ"
}

# ä¸»æ£€æŸ¥æµç¨‹
main() {
    if [ -z "$DOMAIN" ]; then
        echo "ç”¨æ³•: $0 <domain>"
        echo "ç¤ºä¾‹: $0 yourdomain.com"
        exit 1
    fi

    log "å¼€å§‹CORSå®‰å…¨æ£€æŸ¥: $DOMAIN"

    # æ£€æŸ¥ä¸åŒçš„APIç«¯ç‚¹
    local endpoints=(
        "$API_BASE_URL/official-api/docs"
        "$API_BASE_URL/public-api/news"
        "$API_BASE_URL/api/doc"
    )

    local trusted_origins=(
        "https://$DOMAIN"
        "https://www.$DOMAIN"
        "https://admin.$DOMAIN"
    )

    for endpoint in "${endpoints[@]}"; do
        log "===================="
        check_security_headers "$endpoint"

        for origin in "${trusted_origins[@]}"; do
            check_cors_headers "$endpoint" "$origin"
        done

        test_malicious_origins "$endpoint"
    done

    log "CORSå®‰å…¨æ£€æŸ¥å®Œæˆ"
}

main "$@"
```

### 6.4 æ•°æ®åº“å®‰å…¨

#### 6.4.1 ç”¨æˆ·æƒé™ç®¡ç†

**æœ€å°æƒé™åŸåˆ™**ï¼š

```sql
-- åˆ›å»ºåªè¯»ç”¨æˆ·ï¼ˆç”¨äºç”¨æˆ·æ•°æ®åº“ï¼‰
CREATE USER 'readonly_user'@'localhost' IDENTIFIED BY '[å¼ºå¯†ç ]';
GRANT SELECT ON official_website_user.* TO 'readonly_user'@'localhost';

-- åˆ›å»ºåº”ç”¨ç”¨æˆ·ï¼ˆç”¨äºä¸»æ•°æ®åº“ï¼‰
CREATE USER 'app_user'@'localhost' IDENTIFIED BY '[å¼ºå¯†ç ]';
GRANT SELECT, INSERT, UPDATE, DELETE ON official_website.* TO 'app_user'@'localhost';

-- åˆ›å»ºè¿ç§»ç”¨æˆ·ï¼ˆä»…ç”¨äºæ•°æ®åº“è¿ç§»ï¼‰
CREATE USER 'migration_user'@'localhost' IDENTIFIED BY '[å¼ºå¯†ç ]';
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, ALTER, INDEX, DROP, REFERENCES ON official_website.* TO 'migration_user'@'localhost';
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, ALTER, INDEX, DROP, REFERENCES ON official_website_user.* TO 'migration_user'@'localhost';

-- åˆ·æ–°æƒé™
FLUSH PRIVILEGES;
```

**ç®¡ç†å‘˜è´¦æˆ·å®‰å…¨**ï¼š

-   ç¦ç”¨ root è¿œç¨‹ç™»å½•
-   ä½¿ç”¨å¼ºå¯†ç ç­–ç•¥
-   å®šæœŸæ›´æ¢å¯†ç 
-   å¯ç”¨ç™»å½•å®¡è®¡

#### 6.4.2 æ•°æ®åº“è¿æ¥å®‰å…¨

**SSL è¿æ¥é…ç½®**ï¼š

```yaml
# config/packages/doctrine.yaml - SSLè¿æ¥é…ç½®
doctrine:
    dbal:
        connections:
            default:
                url: "%env(resolve:DATABASE_URL)%"
                driver_options:
                    # å¯ç”¨SSL
                    1014: 1 # PDO::MYSQL_ATTR_SSL_VERIFY_SERVER_CERT
                    1015: 1 # PDO::MYSQL_ATTR_SSL_USE_SYSTEM_CA
                    # SSL CAè¯ä¹¦è·¯å¾„
                    1016: "/etc/ssl/certs/mysql-ca.pem"
            user:
                url: "%env(resolve:USER_DATABASE_URL)%"
                driver_options:
                    1014: 1
                    1015: 1
                    1016: "/etc/ssl/certs/mysql-ca.pem"
```

**è¿æ¥åŠ å¯†è®¾ç½®**ï¼š

```ini
# MySQLæœåŠ¡å™¨SSLé…ç½®
[mysqld]
ssl-ca=/etc/mysql/ssl/ca-cert.pem
ssl-cert=/etc/mysql/ssl/server-cert.pem
ssl-key=/etc/mysql/ssl/server-key.pem
require_secure_transport=ON
```

#### 6.4.3 æ•°æ®åº“å®‰å…¨é…ç½®è„šæœ¬

```bash
#!/bin/bash
# æ•°æ®åº“å®‰å…¨é…ç½®è„šæœ¬ - db_security_setup.sh
set -e

MYSQL_ROOT_PASSWORD=""
APP_DB="official_website"
USER_DB="official_website_user"
LOG_FILE="/var/log/db_security_setup.log"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# ç”Ÿæˆå¼ºå¯†ç 
generate_strong_password() {
    openssl rand -base64 32 | tr -d "=+/" | cut -c1-25
}

# åˆ›å»ºæ•°æ®åº“ç”¨æˆ·
create_database_users() {
    log "å¼€å§‹åˆ›å»ºæ•°æ®åº“ç”¨æˆ·..."

    # ç”Ÿæˆå¯†ç 
    local app_password=$(generate_strong_password)
    local readonly_password=$(generate_strong_password)
    local migration_password=$(generate_strong_password)
    local backup_password=$(generate_strong_password)

    # ä¿å­˜å¯†ç åˆ°å®‰å…¨æ–‡ä»¶
    local password_file="/root/.db_passwords"
    cat > "$password_file" << EOF
# æ•°æ®åº“ç”¨æˆ·å¯†ç  - ç”Ÿæˆæ—¶é—´: $(date)
app_user_password=$app_password
readonly_user_password=$readonly_password
migration_user_password=$migration_password
backup_user_password=$backup_password
EOF
    chmod 600 "$password_file"

    log "å¯†ç å·²ä¿å­˜åˆ°: $password_file"

    # åˆ›å»ºåº”ç”¨ç”¨æˆ·
    mysql -u root -p"$MYSQL_ROOT_PASSWORD" << EOF
-- åˆ é™¤ç°æœ‰ç”¨æˆ·ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
DROP USER IF EXISTS 'app_user'@'localhost';
DROP USER IF EXISTS 'readonly_user'@'localhost';
DROP USER IF EXISTS 'migration_user'@'localhost';
DROP USER IF EXISTS 'backup_user'@'localhost';

-- åˆ›å»ºåº”ç”¨ç”¨æˆ·
CREATE USER 'app_user'@'localhost' IDENTIFIED BY '$app_password';
GRANT SELECT, INSERT, UPDATE, DELETE ON $APP_DB.* TO 'app_user'@'localhost';

-- åˆ›å»ºåªè¯»ç”¨æˆ·
CREATE USER 'readonly_user'@'localhost' IDENTIFIED BY '$readonly_password';
GRANT SELECT ON $USER_DB.* TO 'readonly_user'@'localhost';

-- åˆ›å»ºè¿ç§»ç”¨æˆ·
CREATE USER 'migration_user'@'localhost' IDENTIFIED BY '$migration_password';
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, ALTER, INDEX, DROP, REFERENCES ON $APP_DB.* TO 'migration_user'@'localhost';
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, ALTER, INDEX, DROP, REFERENCES ON $USER_DB.* TO 'migration_user'@'localhost';

-- åˆ›å»ºå¤‡ä»½ç”¨æˆ·
CREATE USER 'backup_user'@'localhost' IDENTIFIED BY '$backup_password';
GRANT SELECT, LOCK TABLES, SHOW VIEW, EVENT, TRIGGER ON *.* TO 'backup_user'@'localhost';

-- åˆ·æ–°æƒé™
FLUSH PRIVILEGES;
EOF

    log "æ•°æ®åº“ç”¨æˆ·åˆ›å»ºå®Œæˆ"
}

# é…ç½®SSLè¯ä¹¦
setup_mysql_ssl() {
    log "é…ç½®MySQL SSL..."

    local ssl_dir="/etc/mysql/ssl"
    mkdir -p "$ssl_dir"

    # ç”ŸæˆCAè¯ä¹¦
    if [ ! -f "$ssl_dir/ca-cert.pem" ]; then
        log "ç”ŸæˆCAè¯ä¹¦..."
        openssl genrsa 4096 > "$ssl_dir/ca-key.pem"
        openssl req -new -x509 -days 3650 -key "$ssl_dir/ca-key.pem" -out "$ssl_dir/ca-cert.pem" -subj "/C=CN/ST=State/L=City/O=Organization/CN=MySQL-CA"
    fi

    # ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦
    if [ ! -f "$ssl_dir/server-cert.pem" ]; then
        log "ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦..."
        openssl req -newkey rsa:4096 -days 3650 -nodes -keyout "$ssl_dir/server-key.pem" -out "$ssl_dir/server-req.pem" -subj "/C=CN/ST=State/L=City/O=Organization/CN=mysql-server"
        openssl rsa -in "$ssl_dir/server-key.pem" -out "$ssl_dir/server-key.pem"
        openssl x509 -req -in "$ssl_dir/server-req.pem" -days 3650 -CA "$ssl_dir/ca-cert.pem" -CAkey "$ssl_dir/ca-key.pem" -set_serial 01 -out "$ssl_dir/server-cert.pem"
    fi

    # ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦
    if [ ! -f "$ssl_dir/client-cert.pem" ]; then
        log "ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦..."
        openssl req -newkey rsa:4096 -days 3650 -nodes -keyout "$ssl_dir/client-key.pem" -out "$ssl_dir/client-req.pem" -subj "/C=CN/ST=State/L=City/O=Organization/CN=mysql-client"
        openssl rsa -in "$ssl_dir/client-key.pem" -out "$ssl_dir/client-key.pem"
        openssl x509 -req -in "$ssl_dir/client-req.pem" -days 3650 -CA "$ssl_dir/ca-cert.pem" -CAkey "$ssl_dir/ca-key.pem" -set_serial 01 -out "$ssl_dir/client-cert.pem"
    fi

    # è®¾ç½®æƒé™
    chmod 644 "$ssl_dir"/*.pem
    chmod 600 "$ssl_dir"/*key.pem
    chown mysql:mysql "$ssl_dir"/*

    log "MySQL SSLè¯ä¹¦é…ç½®å®Œæˆ"
}

# é…ç½®MySQLå®‰å…¨å‚æ•°
configure_mysql_security() {
    log "é…ç½®MySQLå®‰å…¨å‚æ•°..."

    cat >> /etc/mysql/mysql.conf.d/mysqld.cnf << EOF

# å®‰å…¨é…ç½®
require_secure_transport=ON
ssl-ca=/etc/mysql/ssl/ca-cert.pem
ssl-cert=/etc/mysql/ssl/server-cert.pem
ssl-key=/etc/mysql/ssl/server-key.pem

# ç¦ç”¨ä¸å®‰å…¨åŠŸèƒ½
skip-name-resolve
local_infile=0
symbolic-links=0

# è¿æ¥é™åˆ¶
max_connect_errors=1000
connect_timeout=10
wait_timeout=600
interactive_timeout=600

# å®¡è®¡æ—¥å¿—
general_log=0
general_log_file=/var/log/mysql/general.log
slow_query_log=1
slow_query_log_file=/var/log/mysql/slow.log
long_query_time=2
log_queries_not_using_indexes=1
EOF

    log "MySQLå®‰å…¨å‚æ•°é…ç½®å®Œæˆ"
}

# éªŒè¯å®‰å…¨é…ç½®
validate_security_config() {
    log "éªŒè¯æ•°æ®åº“å®‰å…¨é…ç½®..."

    # æ£€æŸ¥ç”¨æˆ·æƒé™
    mysql -u root -p"$MYSQL_ROOT_PASSWORD" -e "
        SELECT user, host, authentication_string FROM mysql.user WHERE user NOT IN ('mysql.sys', 'mysql.session');
    "

    # æµ‹è¯•SSLè¿æ¥
    if mysql -u app_user -p"$(grep app_user_password /root/.db_passwords | cut -d= -f2)" --ssl-mode=REQUIRED -e "SELECT 1;" $APP_DB > /dev/null 2>&1; then
        log "âœ“ SSLè¿æ¥æµ‹è¯•é€šè¿‡"
    else
        log "âœ— SSLè¿æ¥æµ‹è¯•å¤±è´¥"
    fi

    # æ£€æŸ¥æ–‡ä»¶æƒé™
    local mysql_files="/etc/mysql/ssl/*.pem /root/.db_passwords"
    for file in $mysql_files; do
        if [ -f "$file" ]; then
            local perms=$(stat -c "%a" "$file")
            log "æ–‡ä»¶æƒé™: $file -> $perms"
        fi
    done

    log "å®‰å…¨é…ç½®éªŒè¯å®Œæˆ"
}

# ä¸»å‡½æ•°
main() {
    case "$1" in
        "create-users")
            create_database_users
            ;;
        "setup-ssl")
            setup_mysql_ssl
            ;;
        "configure")
            configure_mysql_security
            ;;
        "validate")
            validate_security_config
            ;;
        "all")
            create_database_users
            setup_mysql_ssl
            configure_mysql_security
            validate_security_config
            ;;
        *)
            echo "ç”¨æ³•: $0 {create-users|setup-ssl|configure|validate|all}"
            exit 1
            ;;
    esac
}

main "$@"
```

### 6.5 åº”ç”¨å±‚å®‰å…¨

#### 6.5.1 è¾“å…¥éªŒè¯å’Œè¿‡æ»¤

**SQL æ³¨å…¥é˜²æŠ¤**ï¼š

-   ä½¿ç”¨ Doctrine ORM å‚æ•°åŒ–æŸ¥è¯¢
-   ç¦ç”¨åŠ¨æ€ SQL æ‹¼æ¥
-   å®æ–½æŸ¥è¯¢ç™½åå•æœºåˆ¶

```php
// å®‰å…¨çš„æŸ¥è¯¢ç¤ºä¾‹
$users = $this->createQueryBuilder('u')
    ->where('u.email = :email')
    ->setParameter('email', $email)
    ->getQuery()
    ->getResult();
```

**XSS æ”»å‡»é˜²æŠ¤**ï¼š

```php
// è¾“å‡ºè½¬ä¹‰
use Symfony\Component\HttpFoundation\Response;

$response = new Response($this->twig->render('template.html', [
    'content' => htmlspecialchars($userInput, ENT_QUOTES, 'UTF-8')
]));
```

**CSRF ä»¤ç‰ŒéªŒè¯**ï¼š

```yaml
# config/packages/framework.yaml
framework:
    csrf_protection:
        enabled: true
        token_id: "csrf_token"
```

#### 6.5.2 æ–‡ä»¶ä¸Šä¼ å®‰å…¨

**æ–‡ä»¶ç±»å‹é™åˆ¶**ï¼š

```php
// æ–‡ä»¶ä¸Šä¼ éªŒè¯
public function uploadFile(UploadedFile $file): string
{
    // å…è®¸çš„æ–‡ä»¶ç±»å‹
    $allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'];

    if (!in_array($file->getMimeType(), $allowedTypes)) {
        throw new \InvalidArgumentException('ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹');
    }

    // æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆ5MBï¼‰
    if ($file->getSize() > 5 * 1024 * 1024) {
        throw new \InvalidArgumentException('æ–‡ä»¶å¤§å°è¶…è¿‡é™åˆ¶');
    }

    // ç”Ÿæˆå®‰å…¨çš„æ–‡ä»¶å
    $filename = uniqid() . '.' . $file->guessExtension();

    // ç§»åŠ¨åˆ°å®‰å…¨ç›®å½•
    $file->move($this->uploadDir, $filename);

    return $filename;
}
```

**ä¸Šä¼ ç›®å½•æƒé™æ§åˆ¶**ï¼š

```bash
# è®¾ç½®ä¸Šä¼ ç›®å½•æƒé™
chmod 755 /var/www/official_website_backend/public/uploads
chown www-data:www-data /var/www/official_website_backend/public/uploads

# ç¦æ­¢PHPæ‰§è¡Œ
echo "Options -ExecCGI" > /var/www/official_website_backend/public/uploads/.htaccess
echo "php_flag engine off" >> /var/www/official_website_backend/public/uploads/.htaccess
```

#### 6.5.3 åº”ç”¨å®‰å…¨é…ç½®è„šæœ¬

```bash
#!/bin/bash
# åº”ç”¨å®‰å…¨é…ç½®è„šæœ¬ - app_security_setup.sh
set -e

APP_DIR="/var/www/official_website_backend"
UPLOAD_DIR="$APP_DIR/public/uploads"
LOG_FILE="/var/log/app_security_setup.log"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# è®¾ç½®æ–‡ä»¶æƒé™
set_file_permissions() {
    log "è®¾ç½®åº”ç”¨æ–‡ä»¶æƒé™..."

    # è®¾ç½®åŸºæœ¬ç›®å½•æƒé™
    chown -R www-data:www-data "$APP_DIR"
    find "$APP_DIR" -type d -exec chmod 755 {} \;
    find "$APP_DIR" -type f -exec chmod 644 {} \;

    # è®¾ç½®å¯æ‰§è¡Œæ–‡ä»¶æƒé™
    chmod +x "$APP_DIR/bin/console"
    find "$APP_DIR/bin" -type f -exec chmod 755 {} \;

    # è®¾ç½®ç¼“å­˜å’Œæ—¥å¿—ç›®å½•æƒé™
    chmod -R 775 "$APP_DIR/var/cache"
    chmod -R 775 "$APP_DIR/var/log"

    # è®¾ç½®æ•æ„Ÿæ–‡ä»¶æƒé™
    if [ -f "$APP_DIR/.env.local" ]; then
        chmod 600 "$APP_DIR/.env.local"
        chown www-data:www-data "$APP_DIR/.env.local"
    fi

    # è®¾ç½®JWTå¯†é’¥æ–‡ä»¶æƒé™
    if [ -d "$APP_DIR/config/jwt" ]; then
        chown -R www-data:www-data "$APP_DIR/config/jwt"
        chmod 600 "$APP_DIR/config/jwt/private.pem"
        chmod 644 "$APP_DIR/config/jwt/public.pem"
    fi

    log "æ–‡ä»¶æƒé™è®¾ç½®å®Œæˆ"
}

# é…ç½®ä¸Šä¼ ç›®å½•å®‰å…¨
configure_upload_security() {
    log "é…ç½®ä¸Šä¼ ç›®å½•å®‰å…¨..."

    # åˆ›å»ºä¸Šä¼ ç›®å½•
    mkdir -p "$UPLOAD_DIR"

    # è®¾ç½®æƒé™
    chown -R www-data:www-data "$UPLOAD_DIR"
    chmod 755 "$UPLOAD_DIR"

    # åˆ›å»º.htaccessæ–‡ä»¶ç¦æ­¢è„šæœ¬æ‰§è¡Œ
    cat > "$UPLOAD_DIR/.htaccess" << 'EOF'
# ç¦æ­¢PHPæ‰§è¡Œ
php_flag engine off

# ç¦æ­¢CGIæ‰§è¡Œ
Options -ExecCGI

# ç¦æ­¢è„šæœ¬è®¿é—®
<FilesMatch "\.(php|phtml|php3|php4|php5|pl|py|cgi|sh|exe)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# è®¾ç½®å®‰å…¨å¤´
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
</IfModule>
EOF

    # åˆ›å»ºnginxé…ç½®ï¼ˆå¦‚æœä½¿ç”¨nginxï¼‰
    cat > "/etc/nginx/snippets/upload-security.conf" << 'EOF'
# ä¸Šä¼ ç›®å½•å®‰å…¨é…ç½®
location ~* ^/uploads/.*\.(php|phtml|php3|php4|php5|pl|py|cgi|sh|exe)$ {
    deny all;
}

location ~* ^/uploads/ {
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;

    expires 1y;
    add_header Cache-Control "public, immutable";
}
EOF

    log "ä¸Šä¼ ç›®å½•å®‰å…¨é…ç½®å®Œæˆ"
}

# é…ç½®Symfonyå®‰å…¨è®¾ç½®
configure_symfony_security() {
    log "é…ç½®Symfonyå®‰å…¨è®¾ç½®..."

    # æ›´æ–°å®‰å…¨é…ç½®
    cat > "$APP_DIR/config/packages/security.yaml" << 'EOF'
security:
    enable_authenticator_manager: true
    password_hashers:
        Symfony\Component\Security\Core\User\PasswordAuthenticatedUserInterface:
            algorithm: 'auto'
            cost: 15

    providers:
        app_user_provider:
            entity:
                class: App\Entity\User
                property: email

    firewalls:
        dev:
            pattern: ^/(_(profiler|wdt)|css|images|js)/
            security: false

        login:
            pattern: ^/api/login
            stateless: true
            json_login:
                check_path: /api/login
                username_path: email
                password_path: password
                success_handler: lexik_jwt_authentication.handler.authentication_success
                failure_handler: lexik_jwt_authentication.handler.authentication_failure

        api:
            pattern: ^/api
            stateless: true
            provider: app_user_provider
            guard:
                authenticators:
                    - lexik_jwt_authentication.jwt_token_authenticator

        main:
            lazy: true
            provider: app_user_provider

    access_control:
        - { path: ^/api/login, roles: PUBLIC_ACCESS }
        - { path: ^/api/docs, roles: PUBLIC_ACCESS }
        - { path: ^/public-api, roles: PUBLIC_ACCESS }
        - { path: ^/official-api, roles: ROLE_USER }
        - { path: ^/admin, roles: ROLE_ADMIN }
EOF

    log "Symfonyå®‰å…¨é…ç½®å®Œæˆ"
}

# åˆ›å»ºå®‰å…¨æ£€æŸ¥è„šæœ¬
create_security_check_script() {
    log "åˆ›å»ºå®‰å…¨æ£€æŸ¥è„šæœ¬..."

    cat > "$APP_DIR/scripts/security_check.sh" << 'EOF'
#!/bin/bash
# åº”ç”¨å®‰å…¨æ£€æŸ¥è„šæœ¬

APP_DIR="/var/www/official_website_backend"
SECURITY_LOG="/var/log/security_check.log"

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$SECURITY_LOG"
}

# æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶æƒé™
check_sensitive_files() {
    log "æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶æƒé™..."

    local sensitive_files=(
        "$APP_DIR/.env.local"
        "$APP_DIR/config/jwt/private.pem"
        "$APP_DIR/config/jwt/public.pem"
    )

    for file in "${sensitive_files[@]}"; do
        if [ -f "$file" ]; then
            local perms=$(stat -c "%a" "$file")
            local owner=$(stat -c "%U" "$file")
            log "æ–‡ä»¶: $file, æƒé™: $perms, æ‰€æœ‰è€…: $owner"

            case "$file" in
                *.env*|*private.pem)
                    if [ "$perms" != "600" ]; then
                        log "è­¦å‘Š: $file æƒé™ä¸å®‰å…¨ (å½“å‰: $perms, æœŸæœ›: 600)"
                    fi
                    ;;
                *public.pem)
                    if [ "$perms" != "644" ]; then
                        log "è­¦å‘Š: $file æƒé™ä¸å®‰å…¨ (å½“å‰: $perms, æœŸæœ›: 644)"
                    fi
                    ;;
            esac
        fi
    done
}

# æ£€æŸ¥ç›®å½•æƒé™
check_directory_permissions() {
    log "æ£€æŸ¥ç›®å½•æƒé™..."

    local critical_dirs=(
        "$APP_DIR/var/cache"
        "$APP_DIR/var/log"
        "$APP_DIR/public/uploads"
    )

    for dir in "${critical_dirs[@]}"; do
        if [ -d "$dir" ]; then
            local perms=$(stat -c "%a" "$dir")
            local owner=$(stat -c "%U" "$dir")
            log "ç›®å½•: $dir, æƒé™: $perms, æ‰€æœ‰è€…: $owner"
        fi
    done
}

# æ£€æŸ¥å¯å†™æ–‡ä»¶
check_writable_files() {
    log "æ£€æŸ¥å¯å†™æ–‡ä»¶..."

    # æŸ¥æ‰¾éé¢„æœŸçš„å¯å†™æ–‡ä»¶
    find "$APP_DIR" -type f -writable -not -path "$APP_DIR/var/*" -not -path "$APP_DIR/public/uploads/*" | while read file; do
        log "è­¦å‘Š: å‘ç°å¯å†™æ–‡ä»¶: $file"
    done
}

# æ£€æŸ¥å¯ç–‘æ–‡ä»¶
check_suspicious_files() {
    log "æ£€æŸ¥å¯ç–‘æ–‡ä»¶..."

    # æ£€æŸ¥å¤§æ–‡ä»¶
    find "$APP_DIR" -name "*.php" -size +1M | while read file; do
        log "è­¦å‘Š: å‘ç°å¤§PHPæ–‡ä»¶: $file"
    done

    # æ£€æŸ¥å¯ç–‘çš„è„šæœ¬æ–‡ä»¶
    find "$APP_DIR" -name "*.sh" -o -name "*.py" -o -name "*.pl" | while read file; do
        log "è­¦å‘Š: å‘ç°è„šæœ¬æ–‡ä»¶: $file"
    done
}

# ä¸»æ£€æŸ¥æµç¨‹
main() {
    log "å¼€å§‹åº”ç”¨å®‰å…¨æ£€æŸ¥..."

    check_sensitive_files
    check_directory_permissions
    check_writable_files
    check_suspicious_files

    log "å®‰å…¨æ£€æŸ¥å®Œæˆ"
}

main "$@"
EOF

    chmod +x "$APP_DIR/scripts/security_check.sh"
    log "å®‰å…¨æ£€æŸ¥è„šæœ¬åˆ›å»ºå®Œæˆ"
}

# ä¸»å‡½æ•°
main() {
    case "$1" in
        "permissions")
            set_file_permissions
            ;;
        "upload")
            configure_upload_security
            ;;
        "symfony")
            configure_symfony_security
            ;;
        "check-script")
            create_security_check_script
            ;;
        "all")
            set_file_permissions
            configure_upload_security
            configure_symfony_security
            create_security_check_script
            ;;
        *)
            echo "ç”¨æ³•: $0 {permissions|upload|symfony|check-script|all}"
            exit 1
            ;;
    esac
}

main "$@"
```

### 6.6 å®‰å…¨ç›‘æ§å’Œå®¡è®¡

#### 6.6.1 å®‰å…¨äº‹ä»¶ç›‘æ§

```yaml
# config/packages/monolog.yaml - å®‰å…¨æ—¥å¿—é…ç½®
monolog:
    handlers:
        security:
            type: stream
            path: "%kernel.logs_dir%/security.log"
            level: warning
            channels: ["security"]

        audit:
            type: rotating_file
            path: "%kernel.logs_dir%/audit.log"
            max_files: 30
            level: info
            channels: ["audit"]

        failed_login:
            type: rotating_file
            path: "%kernel.logs_dir%/failed_login.log"
            max_files: 30
            level: warning
            channels: ["security"]
```

#### 6.6.2 å®‰å…¨æ‰«æå’Œæ£€æŸ¥

```bash
#!/bin/bash
# å®‰å…¨æ‰«æè„šæœ¬ - security_scan.sh
set -e

APP_DIR="/var/www/official_website_backend"
SCAN_REPORT="/var/log/security_scan_$(date +%Y%m%d_%H%M%S).log"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$SCAN_REPORT"
}

# æ£€æŸ¥æ–‡ä»¶æƒé™
check_file_permissions() {
    log "æ£€æŸ¥æ–‡ä»¶æƒé™..."

    # æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶
    find "$APP_DIR" -name "*.env*" -type f -exec ls -la {} \; | tee -a "$SCAN_REPORT"
    find "$APP_DIR" -name "*.pem" -type f -exec ls -la {} \; | tee -a "$SCAN_REPORT"

    # æ£€æŸ¥å¯å†™ç›®å½•
    log "æ£€æŸ¥å¯å†™ç›®å½•..."
    find "$APP_DIR" -type d -writable 2>/dev/null | tee -a "$SCAN_REPORT"
}

# æ£€æŸ¥å¯ç–‘æ–‡ä»¶
check_suspicious_files() {
    log "æ£€æŸ¥å¯ç–‘æ–‡ä»¶..."

    # æ£€æŸ¥å¤§æ–‡ä»¶
    find "$APP_DIR" -name "*.php" -size +1M | tee -a "$SCAN_REPORT"

    # æ£€æŸ¥è„šæœ¬æ–‡ä»¶
    find "$APP_DIR" -name "*.sh" -o -name "*.py" -o -name "*.pl" | tee -a "$SCAN_REPORT"

    # æ£€æŸ¥éšè—æ–‡ä»¶
    find "$APP_DIR" -name ".*" -type f | head -20 | tee -a "$SCAN_REPORT"
}

# æ£€æŸ¥ä»£ç å®‰å…¨
check_code_security() {
    log "æ£€æŸ¥ä»£ç å®‰å…¨..."

    # æ£€æŸ¥å¯èƒ½çš„SQLæ³¨å…¥
    grep -r "mysql_query\|mysqli_query" "$APP_DIR/src" | head -10 | tee -a "$SCAN_REPORT"

    # æ£€æŸ¥å¯èƒ½çš„XSSæ¼æ´
    grep -r "echo.*\$_" "$APP_DIR/src" | head -10 | tee -a "$SCAN_REPORT"

    # æ£€æŸ¥ç¡¬ç¼–ç å¯†ç 
    grep -r -i "password.*=.*'" "$APP_DIR/src" | head -10 | tee -a "$SCAN_REPORT"
}

# æ£€æŸ¥ä¾èµ–æ¼æ´
check_dependency_vulnerabilities() {
    log "æ£€æŸ¥ä¾èµ–æ¼æ´..."

    cd "$APP_DIR"

    # ä½¿ç”¨composer auditæ£€æŸ¥å®‰å…¨æ¼æ´
    if command -v composer &> /dev/null; then
        composer audit | tee -a "$SCAN_REPORT"
    fi
}

# ä¸»æ‰«ææµç¨‹
main() {
    log "å¼€å§‹å®‰å…¨æ‰«æ..."

    check_file_permissions
    check_suspicious_files
    check_code_security
    check_dependency_vulnerabilities

    log "å®‰å…¨æ‰«æå®Œæˆï¼ŒæŠ¥å‘Šä¿å­˜è‡³: $SCAN_REPORT"
}

main "$@"
```

### 6.7 å®‰å…¨é…ç½®æ£€æŸ¥æ¸…å•

-   [ ] JWT å¯†é’¥æ–‡ä»¶æƒé™æ­£ç¡®ï¼ˆ600/644ï¼‰
-   [ ] æ•°æ®åº“ç”¨æˆ·æƒé™æœ€å°åŒ–
-   [ ] CORS é…ç½®ä»…å…è®¸ä¿¡ä»»åŸŸå
-   [ ] SSL è¯ä¹¦æœ‰æ•ˆä¸”é…ç½®æ­£ç¡®
-   [ ] å®‰å…¨å¤´é…ç½®å®Œæ•´
-   [ ] æ–‡ä»¶ä¸Šä¼ é™åˆ¶ç”Ÿæ•ˆ
-   [ ] æ•æ„Ÿæ–‡ä»¶ä¸å¯é€šè¿‡ Web è®¿é—®
-   [ ] é”™è¯¯ä¿¡æ¯ä¸æ³„éœ²æ•æ„Ÿä¿¡æ¯
-   [ ] æ—¥å¿—è®°å½•å®‰å…¨äº‹ä»¶
-   [ ] å®šæœŸå®‰å…¨æ‰«ææ‰§è¡Œ

---

## 7. ç›‘æ§ä¸ç»´æŠ¤

### 7.1 æ—¥å¿—ç®¡ç†

#### 7.1.1 é«˜çº§æ—¥å¿—é…ç½®

```yaml
# config/packages/monolog.yaml - ç”Ÿäº§ç¯å¢ƒé«˜çº§é…ç½®
monolog:
    channels: ["security", "audit", "performance", "api", "database"]

    handlers:
        # ä¸»åº”ç”¨æ—¥å¿—
        main:
            type: fingers_crossed
            action_level: error
            handler: nested
            excluded_http_codes: [404, 405]
            buffer_size: 50
            stop_buffering: true

        nested:
            type: rotating_file
            path: "%kernel.logs_dir%/application.log"
            level: debug
            max_files: 30
            rotate_pattern: "Y-m-d"
            date_format: "Y-m-d H:i:s"

        # å®‰å…¨æ—¥å¿—
        security:
            type: rotating_file
            path: "%kernel.logs_dir%/security.log"
            level: warning
            max_files: 90
            channels: ["security"]
            formatter: security_formatter

        # å®¡è®¡æ—¥å¿—
        audit:
            type: rotating_file
            path: "%kernel.logs_dir%/audit.log"
            level: info
            max_files: 365
            channels: ["audit"]
            formatter: audit_formatter

        # APIè®¿é—®æ—¥å¿—
        api_access:
            type: rotating_file
            path: "%kernel.logs_dir%/api_access.log"
            level: info
            max_files: 30
            channels: ["api"]
            formatter: json_formatter

        # æ€§èƒ½æ—¥å¿—
        performance:
            type: rotating_file
            path: "%kernel.logs_dir%/performance.log"
            level: info
            max_files: 14
            channels: ["performance"]
            formatter: performance_formatter

        # æ•°æ®åº“æ—¥å¿—
        database:
            type: rotating_file
            path: "%kernel.logs_dir%/database.log"
            level: warning
            max_files: 30
            channels: ["doctrine"]

        # é”™è¯¯é‚®ä»¶é€šçŸ¥
        error_email:
            type: fingers_crossed
            action_level: critical
            handler: buffered_error_email
            buffer_size: 10
            stop_buffering: true

        buffered_error_email:
            type: swift_mailer
            from_email: "alerts@yourdomain.com"
            to_email: "admin@yourdomain.com"
            subject: "ç”Ÿäº§ç¯å¢ƒä¸¥é‡é”™è¯¯å‘Šè­¦"
            level: critical
            formatter: html_formatter

        # æ§åˆ¶å°è¾“å‡º
        console:
            type: console
            process_psr_3_messages: false
            channels: ["!event", "!doctrine"]

    formatters:
        # å®‰å…¨æ—¥å¿—æ ¼å¼å™¨
        security_formatter:
            format: "[%datetime%] [SECURITY] %channel%.%level_name%: %message% %context% %extra%\n"

        # å®¡è®¡æ—¥å¿—æ ¼å¼å™¨
        audit_formatter:
            format: "[%datetime%] [AUDIT] %channel%.%level_name% [user:%extra.user%] [ip:%extra.ip%] %message% %context%\n"

        # JSONæ ¼å¼å™¨ï¼ˆç”¨äºæ—¥å¿—åˆ†æï¼‰
        json_formatter:
            service: "monolog.formatter.json"

        # æ€§èƒ½æ—¥å¿—æ ¼å¼å™¨
        performance_formatter:
            format: "[%datetime%] [PERF] %channel%.%level_name% [duration:%extra.duration%ms] [memory:%extra.memory%MB] %message%\n"

        # HTMLé‚®ä»¶æ ¼å¼å™¨
        html_formatter:
            service: "monolog.formatter.html"
```

#### 7.1.2 æ—¥å¿—è½®è½¬å’Œå½’æ¡£é…ç½®

```bash
# /etc/logrotate.d/official_website - ç”Ÿäº§ç¯å¢ƒæ—¥å¿—è½®è½¬é…ç½®
/var/www/official_website_backend/var/log/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    sharedscripts
    postrotate
        # é‡æ–°åŠ è½½PHP-FPMä»¥ç¡®ä¿æ—¥å¿—æ–‡ä»¶å¥æŸ„æ›´æ–°
        systemctl reload php8.2-fpm

        # æ¸…ç†æ—§çš„å‹ç¼©æ—¥å¿—ï¼ˆä¿ç•™90å¤©ï¼‰
        find /var/www/official_website_backend/var/log -name "*.log.*.gz" -mtime +90 -delete

        # å‘é€æ—¥å¿—ç»Ÿè®¡æŠ¥å‘Š
        /scripts/log_summary.sh daily
    endscript
}

# å®‰å…¨æ—¥å¿—ç‰¹æ®Šé…ç½®ï¼ˆä¿ç•™æ›´é•¿æ—¶é—´ï¼‰
/var/www/official_website_backend/var/log/security.log {
    daily
    missingok
    rotate 90
    compress
    delaycompress
    notifempty
    create 640 www-data www-data
    sharedscripts
    postrotate
        # å®‰å…¨æ—¥å¿—åˆ†æ
        /scripts/security_log_analysis.sh
    endscript
}

# å®¡è®¡æ—¥å¿—ç‰¹æ®Šé…ç½®ï¼ˆä¿ç•™1å¹´ï¼‰
/var/www/official_website_backend/var/log/audit.log {
    daily
    missingok
    rotate 365
    compress
    delaycompress
    notifempty
    create 640 www-data www-data
    sharedscripts
    postrotate
        # å®¡è®¡æ—¥å¿—å½’æ¡£åˆ°é•¿æœŸå­˜å‚¨
        /scripts/archive_audit_logs.sh
    endscript
}
```

#### 7.1.3 æ—¥å¿—ç®¡ç†è„šæœ¬

**æ—¥å¿—ç®¡ç†ä¸»è„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ—¥å¿—ç®¡ç†è„šæœ¬ - log_manager.sh
set -e

LOG_DIR="/var/www/official_website_backend/var/log"
ARCHIVE_DIR="/backup/logs"
REPORT_DIR="/var/log/reports"
TEMP_DIR="/tmp/log_processing"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "/var/log/log_manager.log"
}

# åˆ›å»ºå¿…è¦ç›®å½•
create_directories() {
    mkdir -p "$ARCHIVE_DIR"/{daily,weekly,monthly}
    mkdir -p "$REPORT_DIR"
    mkdir -p "$TEMP_DIR"
}

# åˆ†æåº”ç”¨æ—¥å¿—
analyze_application_logs() {
    local date_filter=$1
    local report_file="$REPORT_DIR/application_analysis_$(date +%Y%m%d).html"

    log "å¼€å§‹åˆ†æåº”ç”¨æ—¥å¿—..."

    # ç”ŸæˆHTMLæŠ¥å‘Š
    cat > "$report_file" << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>åº”ç”¨æ—¥å¿—åˆ†ææŠ¥å‘Š</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>åº”ç”¨æ—¥å¿—åˆ†ææŠ¥å‘Š</h1>
    <p>ç”Ÿæˆæ—¶é—´: $(date)</p>
EOF

    # é”™è¯¯ç»Ÿè®¡
    local error_count=$(grep -c "ERROR" "$LOG_DIR/application.log" 2>/dev/null || echo 0)
    local warning_count=$(grep -c "WARNING" "$LOG_DIR/application.log" 2>/dev/null || echo 0)

    cat >> "$report_file" << EOF
    <div class="section">
        <h2>é”™è¯¯ç»Ÿè®¡</h2>
        <table>
            <tr><th>çº§åˆ«</th><th>æ•°é‡</th></tr>
            <tr class="error"><td>ERROR</td><td>$error_count</td></tr>
            <tr class="warning"><td>WARNING</td><td>$warning_count</td></tr>
        </table>
    </div>
EOF

    # Top 10 é”™è¯¯
    if [ "$error_count" -gt 0 ]; then
        cat >> "$report_file" << 'EOF'
    <div class="section">
        <h2>Top 10 é”™è¯¯ä¿¡æ¯</h2>
        <table>
            <tr><th>é”™è¯¯ä¿¡æ¯</th><th>å‡ºç°æ¬¡æ•°</th></tr>
EOF
        grep "ERROR" "$LOG_DIR/application.log" | awk -F'ERROR' '{print $2}' | sort | uniq -c | sort -nr | head -10 | while read count message; do
            echo "<tr><td>$message</td><td>$count</td></tr>" >> "$report_file"
        done
        cat >> "$report_file" << 'EOF'
        </table>
    </div>
EOF
    fi

    cat >> "$report_file" << 'EOF'
</body>
</html>
EOF

    log "åº”ç”¨æ—¥å¿—åˆ†æå®Œæˆ: $report_file"
}

# åˆ†æAPIè®¿é—®æ—¥å¿—
analyze_api_logs() {
    local report_file="$REPORT_DIR/api_analysis_$(date +%Y%m%d).html"

    log "å¼€å§‹åˆ†æAPIè®¿é—®æ—¥å¿—..."

    cat > "$report_file" << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>APIè®¿é—®åˆ†ææŠ¥å‘Š</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>APIè®¿é—®åˆ†ææŠ¥å‘Š</h1>
    <p>ç”Ÿæˆæ—¶é—´: $(date)</p>
EOF

    # APIè°ƒç”¨ç»Ÿè®¡
    if [ -f "$LOG_DIR/api_access.log" ]; then
        local total_requests=$(wc -l < "$LOG_DIR/api_access.log")
        local unique_ips=$(awk '{print $1}' "$LOG_DIR/api_access.log" | sort -u | wc -l)

        cat >> "$report_file" << EOF
    <div class="section">
        <h2>è®¿é—®ç»Ÿè®¡</h2>
        <table>
            <tr><th>æŒ‡æ ‡</th><th>æ•°å€¼</th></tr>
            <tr><td>æ€»è¯·æ±‚æ•°</td><td>$total_requests</td></tr>
            <tr><td>ç‹¬ç«‹IPæ•°</td><td>$unique_ips</td></tr>
        </table>
    </div>
EOF

        # Top 10 APIç«¯ç‚¹
        cat >> "$report_file" << 'EOF'
    <div class="section">
        <h2>Top 10 APIç«¯ç‚¹</h2>
        <table>
            <tr><th>ç«¯ç‚¹</th><th>è®¿é—®æ¬¡æ•°</th></tr>
EOF
        grep -o '"endpoint":"[^"]*"' "$LOG_DIR/api_access.log" | sort | uniq -c | sort -nr | head -10 | while read count endpoint; do
            endpoint=$(echo "$endpoint" | sed 's/"endpoint":"\([^"]*\)"/\1/')
            echo "<tr><td>$endpoint</td><td>$count</td></tr>" >> "$report_file"
        done
        cat >> "$report_file" << 'EOF'
        </table>
    </div>
EOF
    fi

    cat >> "$report_file" << 'EOF'
</body>
</html>
EOF

    log "APIè®¿é—®æ—¥å¿—åˆ†æå®Œæˆ: $report_file"
}

# æ—¥å¿—å½’æ¡£
archive_logs() {
    local archive_type=$1
    local date_pattern=$(date +%Y%m%d)

    log "å¼€å§‹å½’æ¡£æ—¥å¿— - ç±»å‹: $archive_type"

    case "$archive_type" in
        "daily")
            # å½’æ¡£æ˜¨å¤©çš„æ—¥å¿—
            local yesterday=$(date -d "yesterday" +%Y%m%d)
            find "$LOG_DIR" -name "*$yesterday*.log*" -exec tar -czf "$ARCHIVE_DIR/daily/logs_$yesterday.tar.gz" {} \;
            ;;
        "weekly")
            # å½’æ¡£ä¸Šå‘¨çš„æ—¥å¿—
            local week_start=$(date -d "last monday" +%Y%m%d)
            local week_end=$(date -d "last sunday" +%Y%m%d)
            find "$LOG_DIR" -name "*log*" -mtime -7 -mtime +0 -exec tar -czf "$ARCHIVE_DIR/weekly/logs_week_$week_start-$week_end.tar.gz" {} \;
            ;;
        "monthly")
            # å½’æ¡£ä¸Šä¸ªæœˆçš„æ—¥å¿—
            local last_month=$(date -d "last month" +%Y%m)
            find "$LOG_DIR" -name "*$last_month*.log*" -exec tar -czf "$ARCHIVE_DIR/monthly/logs_$last_month.tar.gz" {} \;
            ;;
    esac

    log "æ—¥å¿—å½’æ¡£å®Œæˆ"
}

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
cleanup_temp_files() {
    log "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
    rm -rf "$TEMP_DIR"
    find "$LOG_DIR" -name "*.tmp" -mtime +1 -delete
}

# ä¸»å‡½æ•°
main() {
    local action=$1

    create_directories

    case "$action" in
        "analyze-app")
            analyze_application_logs
            ;;
        "analyze-api")
            analyze_api_logs
            ;;
        "archive-daily")
            archive_logs daily
            ;;
        "archive-weekly")
            archive_logs weekly
            ;;
        "archive-monthly")
            archive_logs monthly
            ;;
        "cleanup")
            cleanup_temp_files
            ;;
        "all")
            analyze_application_logs
            analyze_api_logs
            archive_logs daily
            cleanup_temp_files
            ;;
        *)
            echo "ç”¨æ³•: $0 {analyze-app|analyze-api|archive-daily|archive-weekly|archive-monthly|cleanup|all}"
            exit 1
            ;;
    esac
}

main "$@"
```

**å®æ—¶æ—¥å¿—ç›‘æ§è„šæœ¬**ï¼š

```bash
#!/bin/bash
# å®æ—¶æ—¥å¿—ç›‘æ§è„šæœ¬ - log_monitor.sh
set -e

LOG_DIR="/var/www/official_website_backend/var/log"
ALERT_EMAIL="admin@yourdomain.com"
WEBHOOK_URL="[å‘Šè­¦Webhook URL]"

# æ—¥å¿—ç›‘æ§é…ç½®
ERROR_THRESHOLD=10          # é”™è¯¯æ•°é‡é˜ˆå€¼
WARNING_THRESHOLD=50        # è­¦å‘Šæ•°é‡é˜ˆå€¼
RESPONSE_TIME_THRESHOLD=5000 # å“åº”æ—¶é—´é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰

# ç›‘æ§å‡½æ•°
monitor_log_file() {
    local log_file=$1
    local pattern=$2
    local threshold=$3
    local alert_type=$4

    local count=$(tail -100 "$log_file" 2>/dev/null | grep -c "$pattern" || echo 0)

    if [ "$count" -gt "$threshold" ]; then
        send_alert "$alert_type" "åœ¨ $log_file ä¸­æ£€æµ‹åˆ° $count ä¸ª $pattern äº‹ä»¶ï¼ˆé˜ˆå€¼: $thresholdï¼‰"
    fi
}

# å‘é€å‘Šè­¦
send_alert() {
    local alert_type=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    # å‘é€é‚®ä»¶å‘Šè­¦
    echo "[$timestamp] $alert_type: $message" | mail -s "æ—¥å¿—ç›‘æ§å‘Šè­¦: $alert_type" "$ALERT_EMAIL"

    # å‘é€Webhookå‘Šè­¦
    if [ -n "$WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš¨ $alert_type\\næ—¶é—´: $timestamp\\n$message\"}" \
            "$WEBHOOK_URL" 2>/dev/null || true
    fi

    echo "[$timestamp] å‘Šè­¦å·²å‘é€: $alert_type - $message"
}

# ç›‘æ§åº”ç”¨é”™è¯¯
monitor_application_errors() {
    if [ -f "$LOG_DIR/application.log" ]; then
        monitor_log_file "$LOG_DIR/application.log" "ERROR" "$ERROR_THRESHOLD" "åº”ç”¨é”™è¯¯"
        monitor_log_file "$LOG_DIR/application.log" "WARNING" "$WARNING_THRESHOLD" "åº”ç”¨è­¦å‘Š"
    fi
}

# ç›‘æ§å®‰å…¨äº‹ä»¶
monitor_security_events() {
    if [ -f "$LOG_DIR/security.log" ]; then
        # ç›‘æ§ç™»å½•å¤±è´¥
        local failed_logins=$(tail -100 "$LOG_DIR/security.log" | grep -c "authentication failed" || echo 0)
        if [ "$failed_logins" -gt 5 ]; then
            send_alert "å®‰å…¨å‘Šè­¦" "æ£€æµ‹åˆ° $failed_logins æ¬¡ç™»å½•å¤±è´¥"
        fi

        # ç›‘æ§å¯ç–‘è®¿é—®
        local suspicious_access=$(tail -100 "$LOG_DIR/security.log" | grep -c "suspicious" || echo 0)
        if [ "$suspicious_access" -gt 0 ]; then
            send_alert "å®‰å…¨å‘Šè­¦" "æ£€æµ‹åˆ° $suspicious_access æ¬¡å¯ç–‘è®¿é—®"
        fi
    fi
}

# ç›‘æ§APIæ€§èƒ½
monitor_api_performance() {
    if [ -f "$LOG_DIR/performance.log" ]; then
        # ç›‘æ§å“åº”æ—¶é—´
        local slow_requests=$(tail -100 "$LOG_DIR/performance.log" | grep -E "duration:[0-9]{4,}" | wc -l)
        if [ "$slow_requests" -gt 3 ]; then
            send_alert "æ€§èƒ½å‘Šè­¦" "æ£€æµ‹åˆ° $slow_requests ä¸ªæ…¢è¯·æ±‚ï¼ˆ>${RESPONSE_TIME_THRESHOLD}msï¼‰"
        fi

        # ç›‘æ§å†…å­˜ä½¿ç”¨
        local high_memory=$(tail -100 "$LOG_DIR/performance.log" | grep -E "memory:[0-9]{3,}" | wc -l)
        if [ "$high_memory" -gt 5 ]; then
            send_alert "æ€§èƒ½å‘Šè­¦" "æ£€æµ‹åˆ° $high_memory æ¬¡é«˜å†…å­˜ä½¿ç”¨ï¼ˆ>100MBï¼‰"
        fi
    fi
}

# ç›‘æ§æ•°æ®åº“è¿æ¥
monitor_database_connections() {
    if [ -f "$LOG_DIR/database.log" ]; then
        local connection_errors=$(tail -100 "$LOG_DIR/database.log" | grep -c "connection" || echo 0)
        if [ "$connection_errors" -gt 3 ]; then
            send_alert "æ•°æ®åº“å‘Šè­¦" "æ£€æµ‹åˆ° $connection_errors ä¸ªæ•°æ®åº“è¿æ¥é”™è¯¯"
        fi
    fi
}

# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶å¤§å°
check_log_file_sizes() {
    for log_file in "$LOG_DIR"/*.log; do
        if [ -f "$log_file" ]; then
            local file_size=$(du -m "$log_file" | cut -f1)
            if [ "$file_size" -gt 100 ]; then
                send_alert "æ—¥å¿—å‘Šè­¦" "æ—¥å¿—æ–‡ä»¶è¿‡å¤§: $log_file (${file_size}MB)"
            fi
        fi
    done
}

# ä¸»ç›‘æ§å¾ªç¯
main() {
    echo "å¼€å§‹å®æ—¶æ—¥å¿—ç›‘æ§..."
    echo "ç›‘æ§é—´éš”: 60ç§’"
    echo "æ—¥å¿—ç›®å½•: $LOG_DIR"

    while true; do
        monitor_application_errors
        monitor_security_events
        monitor_api_performance
        monitor_database_connections
        check_log_file_sizes

        sleep 60
    done
}

# ä¿¡å·å¤„ç†
trap 'echo "ç›‘æ§åœæ­¢"; exit 0' SIGINT SIGTERM

# å¯åŠ¨ç›‘æ§
main "$@"
```

#### 7.1.4 æ—¥å¿—åˆ†æè„šæœ¬

**æ—¥å¿—ç»Ÿè®¡æŠ¥å‘Šè„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ—¥å¿—ç»Ÿè®¡æŠ¥å‘Šè„šæœ¬ - log_summary.sh
set -e

LOG_DIR="/var/www/official_website_backend/var/log"
REPORT_DIR="/var/log/reports"
PERIOD=$1  # daily, weekly, monthly

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "/var/log/log_summary.log"
}

# ç”Ÿæˆæ—¥æŠ¥
generate_daily_report() {
    local report_file="$REPORT_DIR/daily_report_$(date +%Y%m%d).html"
    local log_date=$(date +%Y-%m-%d)

    log "ç”Ÿæˆæ—¥æŠ¥: $log_date"

    cat > "$report_file" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>ç³»ç»Ÿæ—¥æŠ¥ - $log_date</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .header { background-color: #f0f0f0; padding: 20px; margin-bottom: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .critical { color: red; font-weight: bold; }
        .warning { color: orange; }
        .success { color: green; }
        table { border-collapse: collapse; width: 100%; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .chart { margin: 20px 0; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="header">
        <h1>ç³»ç»Ÿè¿è¡Œæ—¥æŠ¥</h1>
        <p>æ—¥æœŸ: $log_date</p>
        <p>ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')</p>
    </div>
EOF

    # ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ
    cat >> "$report_file" << EOF
    <div class="section">
        <h2>ç³»ç»ŸçŠ¶æ€æ¦‚è§ˆ</h2>
        <table>
            <tr><th>æœåŠ¡</th><th>çŠ¶æ€</th><th>CPUä½¿ç”¨ç‡</th><th>å†…å­˜ä½¿ç”¨ç‡</th><th>ç£ç›˜ä½¿ç”¨ç‡</th></tr>
EOF

    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    local services=("nginx" "php8.2-fpm" "mysql" "redis-server")
    for service in "${services[@]}"; do
        local status="è¿è¡Œä¸­"
        if ! systemctl is-active --quiet "$service"; then
            status="<span class='critical'>åœæ­¢</span>"
        fi

        local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d% -f1)
        local memory_usage=$(free | grep Mem | awk '{printf("%.1f", $3/$2 * 100.0)}')
        local disk_usage=$(df / | tail -1 | awk '{print $5}' | cut -d% -f1)

        echo "<tr><td>$service</td><td>$status</td><td>${cpu_usage}%</td><td>${memory_usage}%</td><td>${disk_usage}%</td></tr>" >> "$report_file"
    done

    cat >> "$report_file" << 'EOF'
        </table>
    </div>
EOF

    # åº”ç”¨é”™è¯¯ç»Ÿè®¡
    if [ -f "$LOG_DIR/application.log" ]; then
        local error_count=$(grep -c "$(date +%Y-%m-%d)" "$LOG_DIR/application.log" | grep "ERROR" | wc -l)
        local warning_count=$(grep -c "$(date +%Y-%m-%d)" "$LOG_DIR/application.log" | grep "WARNING" | wc -l)

        cat >> "$report_file" << EOF
    <div class="section">
        <h2>åº”ç”¨é”™è¯¯ç»Ÿè®¡</h2>
        <table>
            <tr><th>é”™è¯¯çº§åˆ«</th><th>æ•°é‡</th><th>è¶‹åŠ¿</th></tr>
            <tr><td>ERROR</td><td>$error_count</td><td>$([ $error_count -eq 0 ] && echo "<span class='success'>æ­£å¸¸</span>" || echo "<span class='critical'>éœ€è¦å…³æ³¨</span>")</td></tr>
            <tr><td>WARNING</td><td>$warning_count</td><td>$([ $warning_count -lt 10 ] && echo "<span class='success'>æ­£å¸¸</span>" || echo "<span class='warning'>éœ€è¦å…³æ³¨</span>")</td></tr>
        </table>
    </div>
EOF
    fi

    # APIè®¿é—®ç»Ÿè®¡
    if [ -f "$LOG_DIR/api_access.log" ]; then
        local total_requests=$(grep "$(date +%Y-%m-%d)" "$LOG_DIR/api_access.log" | wc -l)
        local unique_ips=$(grep "$(date +%Y-%m-%d)" "$LOG_DIR/api_access.log" | awk '{print $1}' | sort -u | wc -l)
        local avg_response_time=$(grep "$(date +%Y-%m-%d)" "$LOG_DIR/api_access.log" | grep -o '"response_time":[0-9]*' | cut -d: -f2 | awk '{sum+=$1; count++} END {if(count>0) print sum/count; else print 0}')

        cat >> "$report_file" << EOF
    <div class="section">
        <h2>APIè®¿é—®ç»Ÿè®¡</h2>
        <table>
            <tr><th>æ€»è¯·æ±‚æ•°</th><th>ç‹¬ç«‹IPæ•°</th><th>å¹³å‡å“åº”æ—¶é—´(ms)</th></tr>
            <tr><td>$total_requests</td><td>$unique_ips</td><td>${avg_response_time}</td></tr>
        </table>
    </div>
EOF
    fi

    cat >> "$report_file" << 'EOF'
</body>
</html>
EOF

    log "æ—¥æŠ¥ç”Ÿæˆå®Œæˆ: $report_file"

    # å‘é€é‚®ä»¶æŠ¥å‘Š
    if command -v mail &> /dev/null; then
        echo "ç³»ç»Ÿæ—¥æŠ¥å·²ç”Ÿæˆï¼Œè¯·æŸ¥çœ‹é™„ä»¶" | mail -s "ç³»ç»Ÿæ—¥æŠ¥ - $log_date" -a "$report_file" "admin@yourdomain.com"
    fi
}

# ç”Ÿæˆå‘¨æŠ¥
generate_weekly_report() {
    local report_file="$REPORT_DIR/weekly_report_$(date +%Y%U).html"
    local week_start=$(date -d "last monday" +%Y-%m-%d)
    local week_end=$(date -d "last sunday" +%Y-%m-%d)

    log "ç”Ÿæˆå‘¨æŠ¥: $week_start åˆ° $week_end"

    # ç±»ä¼¼æ—¥æŠ¥çš„ç”Ÿæˆé€»è¾‘ï¼Œä½†ç»Ÿè®¡ä¸€å‘¨çš„æ•°æ®
    # ... å‘¨æŠ¥ç”Ÿæˆä»£ç  ...

    log "å‘¨æŠ¥ç”Ÿæˆå®Œæˆ: $report_file"
}

# ä¸»å‡½æ•°
main() {
    mkdir -p "$REPORT_DIR"

    case "$PERIOD" in
        "daily")
            generate_daily_report
            ;;
        "weekly")
            generate_weekly_report
            ;;
        *)
            echo "ç”¨æ³•: $0 {daily|weekly}"
            exit 1
            ;;
    esac
}

main "$@"
```

### 7.2 æ€§èƒ½ç›‘æ§

#### 7.2.1 åº”ç”¨æ€§èƒ½æŒ‡æ ‡

**APM æœåŠ¡å®ç°**ï¼š

```php
<?php
// src/Service/PerformanceMonitorService.php
namespace App\Service;

use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Psr\Log\LoggerInterface;

class PerformanceMonitorService
{
    private LoggerInterface $logger;
    private array $metrics = [];

    public function __construct(LoggerInterface $logger)
    {
        $this->logger = $logger;
    }

    public function startRequest(Request $request): string
    {
        $requestId = uniqid('req_', true);
        $this->metrics[$requestId] = [
            'start_time' => microtime(true),
            'start_memory' => memory_get_usage(true),
            'method' => $request->getMethod(),
            'uri' => $request->getRequestUri(),
            'ip' => $request->getClientIp(),
            'user_agent' => $request->headers->get('User-Agent'),
        ];
        return $requestId;
    }

    public function endRequest(string $requestId, Response $response): void
    {
        if (!isset($this->metrics[$requestId])) {
            return;
        }

        $metric = $this->metrics[$requestId];
        $endTime = microtime(true);
        $endMemory = memory_get_usage(true);

        $duration = round(($endTime - $metric['start_time']) * 1000, 2); // æ¯«ç§’
        $memoryUsed = round(($endMemory - $metric['start_memory']) / 1024 / 1024, 2); // MB

        $this->logger->info('Performance metric', [
            'channel' => 'performance',
            'request_id' => $requestId,
            'method' => $metric['method'],
            'uri' => $metric['uri'],
            'status_code' => $response->getStatusCode(),
            'duration' => $duration,
            'memory_used' => $memoryUsed,
            'peak_memory' => round(memory_get_peak_usage(true) / 1024 / 1024, 2),
            'ip' => $metric['ip'],
        ]);

        // æ£€æŸ¥æ€§èƒ½é˜ˆå€¼
        if ($duration > 5000) { // 5ç§’
            $this->logger->warning('Slow request detected', [
                'channel' => 'performance',
                'request_id' => $requestId,
                'duration' => $duration,
                'uri' => $metric['uri'],
            ]);
        }

        unset($this->metrics[$requestId]);
    }

    public function logCustomMetric(string $name, float $value, array $context = []): void
    {
        $this->logger->info('Custom metric', [
            'channel' => 'performance',
            'metric_name' => $name,
            'metric_value' => $value,
            'context' => $context,
        ]);
    }
}
```

**æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶**ï¼š

```php
<?php
// src/Middleware/PerformanceMiddleware.php
namespace App\Middleware;

use App\Service\PerformanceMonitorService;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\HttpFoundation\Response;
use Symfony\Component\HttpKernel\Event\RequestEvent;
use Symfony\Component\HttpKernel\Event\TerminateEvent;

class PerformanceMiddleware
{
    private PerformanceMonitorService $monitor;
    private array $requestMap = [];

    public function __construct(PerformanceMonitorService $monitor)
    {
        $this->monitor = $monitor;
    }

    public function onKernelRequest(RequestEvent $event): void
    {
        if (!$event->isMainRequest()) {
            return;
        }

        $request = $event->getRequest();
        $requestId = $this->monitor->startRequest($request);
        $this->requestMap[spl_object_hash($request)] = $requestId;
    }

    public function onKernelTerminate(TerminateEvent $event): void
    {
        $request = $event->getRequest();
        $response = $event->getResponse();
        $requestHash = spl_object_hash($request);

        if (isset($this->requestMap[$requestHash])) {
            $this->monitor->endRequest($this->requestMap[$requestHash], $response);
            unset($this->requestMap[$requestHash]);
        }
    }
}
```

**APM ç›‘æ§è„šæœ¬**ï¼š

```bash
#!/bin/bash
# APMæ€§èƒ½ç›‘æ§è„šæœ¬ - apm_monitor.sh
set -e

API_BASE_URL="https://yourdomain.com"
LOG_FILE="/var/log/apm_monitor.log"
ALERT_THRESHOLD=5000  # å“åº”æ—¶é—´é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
ERROR_RATE_THRESHOLD=5  # é”™è¯¯ç‡é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼‰

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# æµ‹è¯•APIå“åº”æ—¶é—´
test_api_response_time() {
    local endpoint=$1
    local method=${2:-GET}
    local data=${3:-""}

    local start_time=$(date +%s%N)
    local http_code=$(curl -s -o /dev/null -w "%{http_code}" \
        -X "$method" \
        -H "Content-Type: application/json" \
        -d "$data" \
        --max-time 30 \
        "$API_BASE_URL$endpoint")

    local end_time=$(date +%s%N)
    local response_time=$(( (end_time - start_time) / 1000000 ))  # è½¬æ¢ä¸ºæ¯«ç§’

    log "APIæµ‹è¯•: $endpoint - HTTP: $http_code - å“åº”æ—¶é—´: ${response_time}ms"

    if [ "$http_code" -ge 400 ]; then
        log "é”™è¯¯: APIè¿”å›é”™è¯¯çŠ¶æ€ç  $http_code"
        return 1
    fi

    if [ "$response_time" -gt "$ALERT_THRESHOLD" ]; then
        log "è­¦å‘Š: APIå“åº”æ—¶é—´è¿‡é•¿ ${response_time}ms (é˜ˆå€¼: ${ALERT_THRESHOLD}ms)"
        return 1
    fi

    return 0
}

# æ‰¹é‡APIæµ‹è¯•
batch_api_test() {
    log "å¼€å§‹æ‰¹é‡APIæ€§èƒ½æµ‹è¯•..."

    local endpoints=(
        "/official-api/docs"
        "/public-api/news"
        "/official-api/articles"
        "/public-api/categories"
    )

    local total_tests=0
    local failed_tests=0
    local total_response_time=0

    for endpoint in "${endpoints[@]}"; do
        if test_api_response_time "$endpoint"; then
            total_response_time=$((total_response_time + response_time))
        else
            ((failed_tests++))
        fi
        ((total_tests++))
    done

    local avg_response_time=$((total_response_time / total_tests))
    local error_rate=$((failed_tests * 100 / total_tests))

    log "æ‰¹é‡æµ‹è¯•ç»“æœ:"
    log "  æ€»æµ‹è¯•æ•°: $total_tests"
    log "  å¤±è´¥æ•°: $failed_tests"
    log "  é”™è¯¯ç‡: ${error_rate}%"
    log "  å¹³å‡å“åº”æ—¶é—´: ${avg_response_time}ms"

    if [ "$error_rate" -gt "$ERROR_RATE_THRESHOLD" ]; then
        log "å‘Šè­¦: é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼ ${ERROR_RATE_THRESHOLD}%"
        # å‘é€å‘Šè­¦é€šçŸ¥
        send_apm_alert "é«˜é”™è¯¯ç‡" "é”™è¯¯ç‡: ${error_rate}%, é˜ˆå€¼: ${ERROR_RATE_THRESHOLD}%"
    fi
}

# æ•°æ®åº“æ€§èƒ½æµ‹è¯•
test_database_performance() {
    log "æµ‹è¯•æ•°æ®åº“æ€§èƒ½..."

    local start_time=$(date +%s%N)

    # æµ‹è¯•æ•°æ®åº“è¿æ¥
    if php bin/console doctrine:database:exists --env=prod > /dev/null 2>&1; then
        local end_time=$(date +%s%N)
        local connection_time=$(( (end_time - start_time) / 1000000 ))
        log "æ•°æ®åº“è¿æ¥æ—¶é—´: ${connection_time}ms"

        if [ "$connection_time" -gt 1000 ]; then
            log "è­¦å‘Š: æ•°æ®åº“è¿æ¥æ—¶é—´è¿‡é•¿ ${connection_time}ms"
        fi
    else
        log "é”™è¯¯: æ•°æ®åº“è¿æ¥å¤±è´¥"
        return 1
    fi

    # æµ‹è¯•æŸ¥è¯¢æ€§èƒ½
    local query_start=$(date +%s%N)
    if php bin/console doctrine:query:sql "SELECT COUNT(*) FROM sys_news_article" --env=prod > /dev/null 2>&1; then
        local query_end=$(date +%s%N)
        local query_time=$(( (query_end - query_start) / 1000000 ))
        log "æ•°æ®åº“æŸ¥è¯¢æ—¶é—´: ${query_time}ms"

        if [ "$query_time" -gt 2000 ]; then
            log "è­¦å‘Š: æ•°æ®åº“æŸ¥è¯¢æ—¶é—´è¿‡é•¿ ${query_time}ms"
        fi
    else
        log "é”™è¯¯: æ•°æ®åº“æŸ¥è¯¢å¤±è´¥"
        return 1
    fi
}

# ç¼“å­˜æ€§èƒ½æµ‹è¯•
test_cache_performance() {
    log "æµ‹è¯•ç¼“å­˜æ€§èƒ½..."

    # æµ‹è¯•Redisè¿æ¥
    if redis-cli ping > /dev/null 2>&1; then
        log "Redisè¿æ¥æ­£å¸¸"

        # æµ‹è¯•ç¼“å­˜è¯»å†™æ€§èƒ½
        local cache_start=$(date +%s%N)
        redis-cli set test_key "test_value" > /dev/null 2>&1
        redis-cli get test_key > /dev/null 2>&1
        redis-cli del test_key > /dev/null 2>&1
        local cache_end=$(date +%s%N)
        local cache_time=$(( (cache_end - cache_start) / 1000000 ))
        log "ç¼“å­˜æ“ä½œæ—¶é—´: ${cache_time}ms"

        if [ "$cache_time" -gt 100 ]; then
            log "è­¦å‘Š: ç¼“å­˜æ“ä½œæ—¶é—´è¿‡é•¿ ${cache_time}ms"
        fi
    else
        log "é”™è¯¯: Redisè¿æ¥å¤±è´¥"
        return 1
    fi
}

# ç³»ç»Ÿèµ„æºç›‘æ§
monitor_system_resources() {
    log "ç›‘æ§ç³»ç»Ÿèµ„æº..."

    # CPUä½¿ç”¨ç‡
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d% -f1)
    log "CPUä½¿ç”¨ç‡: ${cpu_usage}%"

    # å†…å­˜ä½¿ç”¨ç‡
    local memory_usage=$(free | grep Mem | awk '{printf("%.1f", $3/$2 * 100.0)}')
    log "å†…å­˜ä½¿ç”¨ç‡: ${memory_usage}%"

    # ç£ç›˜ä½¿ç”¨ç‡
    local disk_usage=$(df / | tail -1 | awk '{print $5}' | cut -d% -f1)
    log "ç£ç›˜ä½¿ç”¨ç‡: ${disk_usage}%"

    # ç½‘ç»œè¿æ¥æ•°
    local connections=$(netstat -an | grep :443 | grep ESTABLISHED | wc -l)
    log "HTTPSè¿æ¥æ•°: $connections"

    # æ£€æŸ¥èµ„æºé˜ˆå€¼
    if (( $(echo "$cpu_usage > 80" | bc -l) )); then
        log "è­¦å‘Š: CPUä½¿ç”¨ç‡è¿‡é«˜ ${cpu_usage}%"
    fi

    if (( $(echo "$memory_usage > 85" | bc -l) )); then
        log "è­¦å‘Š: å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ ${memory_usage}%"
    fi

    if [ "$disk_usage" -gt 90 ]; then
        log "è­¦å‘Š: ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜ ${disk_usage}%"
    fi
}

# å‘é€APMå‘Šè­¦
send_apm_alert() {
    local alert_type=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    # å‘é€é‚®ä»¶å‘Šè­¦
    echo "[$timestamp] APMå‘Šè­¦: $alert_type - $message" | mail -s "APMæ€§èƒ½å‘Šè­¦: $alert_type" "admin@yourdomain.com"

    # å‘é€Webhookå‘Šè­¦
    if [ -n "$WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš¨ APMæ€§èƒ½å‘Šè­¦\\nç±»å‹: $alert_type\\næ—¶é—´: $timestamp\\n$message\"}" \
            "$WEBHOOK_URL" 2>/dev/null || true
    fi

    log "APMå‘Šè­¦å·²å‘é€: $alert_type - $message"
}

# ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
generate_performance_report() {
    local report_file="/var/log/performance_report_$(date +%Y%m%d_%H%M%S).html"

    cat > "$report_file" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>æ€§èƒ½ç›‘æ§æŠ¥å‘Š</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .warning { color: orange; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>æ€§èƒ½ç›‘æ§æŠ¥å‘Š</h1>
    <p>ç”Ÿæˆæ—¶é—´: $(date)</p>

    <div class="section">
        <h2>ç³»ç»Ÿèµ„æºçŠ¶æ€</h2>
        <table>
            <tr><th>æŒ‡æ ‡</th><th>å½“å‰å€¼</th><th>çŠ¶æ€</th></tr>
            <tr><td>CPUä½¿ç”¨ç‡</td><td>${cpu_usage}%</td><td>$([ $(echo "$cpu_usage > 80" | bc -l) -eq 1 ] && echo "<span class='error'>è¿‡é«˜</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
            <tr><td>å†…å­˜ä½¿ç”¨ç‡</td><td>${memory_usage}%</td><td>$([ $(echo "$memory_usage > 85" | bc -l) -eq 1 ] && echo "<span class='error'>è¿‡é«˜</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
            <tr><td>ç£ç›˜ä½¿ç”¨ç‡</td><td>${disk_usage}%</td><td>$([ "$disk_usage" -gt 90 ] && echo "<span class='error'>è¿‡é«˜</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
            <tr><td>HTTPSè¿æ¥æ•°</td><td>$connections</td><td><span class='success'>æ­£å¸¸</span></td></tr>
        </table>
    </div>

    <div class="section">
        <h2>APIæ€§èƒ½æµ‹è¯•ç»“æœ</h2>
        <table>
            <tr><th>æŒ‡æ ‡</th><th>æ•°å€¼</th><th>çŠ¶æ€</th></tr>
            <tr><td>æ€»æµ‹è¯•æ•°</td><td>$total_tests</td><td><span class='success'>æ­£å¸¸</span></td></tr>
            <tr><td>å¤±è´¥æ•°</td><td>$failed_tests</td><td>$([ "$failed_tests" -gt 0 ] && echo "<span class='error'>å¼‚å¸¸</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
            <tr><td>é”™è¯¯ç‡</td><td>${error_rate}%</td><td>$([ "$error_rate" -gt "$ERROR_RATE_THRESHOLD" ] && echo "<span class='error'>è¿‡é«˜</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
            <tr><td>å¹³å‡å“åº”æ—¶é—´</td><td>${avg_response_time}ms</td><td>$([ "$avg_response_time" -gt "$ALERT_THRESHOLD" ] && echo "<span class='warning'>è¾ƒæ…¢</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
        </table>
    </div>
</body>
</html>
EOF

    log "æ€§èƒ½æŠ¥å‘Šç”Ÿæˆå®Œæˆ: $report_file"
}

# ä¸»ç›‘æ§å¾ªç¯
main() {
    log "å¼€å§‹APMæ€§èƒ½ç›‘æ§..."

    # æ‰§è¡Œå„é¡¹æ€§èƒ½æµ‹è¯•
    batch_api_test
    test_database_performance
    test_cache_performance
    monitor_system_resources

    # ç”ŸæˆæŠ¥å‘Š
    generate_performance_report

    log "APMæ€§èƒ½ç›‘æ§å®Œæˆ"
}

# æ‰§è¡Œç›‘æ§
main "$@"
```

#### 7.2.2 æ•°æ®åº“æ€§èƒ½ç›‘æ§

**æ•°æ®åº“æ€§èƒ½ç›‘æ§è„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ•°æ®åº“æ€§èƒ½ç›‘æ§è„šæœ¬ - db_performance_monitor.sh
set -e

LOG_FILE="/var/log/db_performance_monitor.log"
ALERT_EMAIL="admin@yourdomain.com"
SLOW_QUERY_THRESHOLD=2000  # æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
CONNECTION_THRESHOLD=80    # è¿æ¥æ•°é˜ˆå€¼ï¼ˆç™¾åˆ†æ¯”ï¼‰

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# è·å–MySQLçŠ¶æ€å˜é‡
get_mysql_status() {
    mysql -u root -p -e "SHOW GLOBAL STATUS LIKE '$1';" 2>/dev/null | tail -1 | awk '{print $2}'
}

# è·å–MySQLç³»ç»Ÿå˜é‡
get_mysql_variable() {
    mysql -u root -p -e "SHOW GLOBAL VARIABLES LIKE '$1';" 2>/dev/null | tail -1 | awk '{print $2}'
}

# ç›‘æ§æ•°æ®åº“è¿æ¥
monitor_connections() {
    log "ç›‘æ§æ•°æ®åº“è¿æ¥çŠ¶æ€..."

    local max_connections=$(get_mysql_variable "max_connections")
    local threads_connected=$(get_mysql_status "Threads_connected")
    local threads_running=$(get_mysql_status "Threads_running")
    local connection_usage=$((threads_connected * 100 / max_connections))

    log "æœ€å¤§è¿æ¥æ•°: $max_connections"
    log "å½“å‰è¿æ¥æ•°: $threads_connected"
    log "æ´»è·ƒè¿æ¥æ•°: $threads_running"
    log "è¿æ¥ä½¿ç”¨ç‡: ${connection_usage}%"

    if [ "$connection_usage" -gt "$CONNECTION_THRESHOLD" ]; then
        log "è­¦å‘Š: æ•°æ®åº“è¿æ¥ä½¿ç”¨ç‡è¿‡é«˜ ${connection_usage}%"
        send_db_alert "è¿æ¥æ•°å‘Šè­¦" "è¿æ¥ä½¿ç”¨ç‡: ${connection_usage}% (${threads_connected}/${max_connections})"
    fi
}

# ç›‘æ§æŸ¥è¯¢æ€§èƒ½
monitor_query_performance() {
    log "ç›‘æ§æŸ¥è¯¢æ€§èƒ½..."

    local slow_queries=$(get_mysql_status "Slow_queries")
    local questions=$(get_mysql_status "Questions")
    local uptime=$(get_mysql_status "Uptime")
    local qps=$((questions / uptime))  # æ¯ç§’æŸ¥è¯¢æ•°

    log "æ…¢æŸ¥è¯¢æ•°é‡: $slow_queries"
    log "æ€»æŸ¥è¯¢æ•°: $questions"
    log "è¿è¡Œæ—¶é—´: ${uptime}ç§’"
    log "æ¯ç§’æŸ¥è¯¢æ•°(QPS): $qps"

    if [ "$qps" -gt 1000 ]; then
        log "è­¦å‘Š: QPSè¿‡é«˜ $qps"
    fi

    # æ£€æŸ¥æ…¢æŸ¥è¯¢å¢é•¿ç‡
    local last_slow_queries_file="/tmp/last_slow_queries.txt"
    local last_slow_queries=0

    if [ -f "$last_slow_queries_file" ]; then
        last_slow_queries=$(cat "$last_slow_queries_file")
    fi

    local new_slow_queries=$((slow_queries - last_slow_queries))
    echo "$slow_queries" > "$last_slow_queries_file"

    if [ "$new_slow_queries" -gt 10 ]; then
        log "è­¦å‘Š: æ£€æµ‹åˆ° $new_slow_queries ä¸ªæ–°æ…¢æŸ¥è¯¢"
        send_db_alert "æ…¢æŸ¥è¯¢å‘Šè­¦" "æ–°å¢æ…¢æŸ¥è¯¢: $new_slow_queries"
    fi
}

# ç›‘æ§InnoDBæ€§èƒ½
monitor_innodb_performance() {
    log "ç›‘æ§InnoDBæ€§èƒ½..."

    local innodb_buffer_pool_read_requests=$(get_mysql_status "Innodb_buffer_pool_read_requests")
    local innodb_buffer_pool_reads=$(get_mysql_status "Innodb_buffer_pool_reads")
    local innodb_buffer_pool_read_ahead=$(get_mysql_status "Innodb_buffer_pool_read_ahead")
    local innodb_buffer_pool_pages_total=$(get_mysql_status "Innodb_buffer_pool_pages_total")
    local innodb_buffer_pool_pages_free=$(get_mysql_status "Innodb_buffer_pool_pages_free")
    local innodb_buffer_pool_pages_dirty=$(get_mysql_status "Innodb_buffer_pool_pages_dirty")

    # è®¡ç®—ç¼“å†²æ± å‘½ä¸­ç‡
    if [ "$innodb_buffer_pool_read_requests" -gt 0 ]; then
        local buffer_pool_hit_rate=$(((innodb_buffer_pool_read_requests - innodb_buffer_pool_reads) * 100 / innodb_buffer_pool_read_requests))
        log "InnoDBç¼“å†²æ± å‘½ä¸­ç‡: ${buffer_pool_hit_rate}%"

        if [ "$buffer_pool_hit_rate" -lt 95 ]; then
            log "è­¦å‘Š: InnoDBç¼“å†²æ± å‘½ä¸­ç‡è¿‡ä½ ${buffer_pool_hit_rate}%"
        fi
    fi

    # è®¡ç®—ç¼“å†²æ± ä½¿ç”¨ç‡
    if [ "$innodb_buffer_pool_pages_total" -gt 0 ]; then
        local buffer_pool_usage=$(((innodb_buffer_pool_pages_total - innodb_buffer_pool_pages_free) * 100 / innodb_buffer_pool_pages_total))
        log "InnoDBç¼“å†²æ± ä½¿ç”¨ç‡: ${buffer_pool_usage}%"

        if [ "$buffer_pool_usage" -gt 90 ]; then
            log "è­¦å‘Š: InnoDBç¼“å†²æ± ä½¿ç”¨ç‡è¿‡é«˜ ${buffer_pool_usage}%"
        fi
    fi

    log "è„é¡µæ•°é‡: $innodb_buffer_pool_pages_dirty"

    if [ "$innodb_buffer_pool_pages_dirty" -gt 1000 ]; then
        log "è­¦å‘Š: è„é¡µæ•°é‡è¿‡å¤š $innodb_buffer_pool_pages_dirty"
    fi
}

# ç›‘æ§æŸ¥è¯¢ç¼“å­˜
monitor_query_cache() {
    log "ç›‘æ§æŸ¥è¯¢ç¼“å­˜..."

    local qcache_hits=$(get_mysql_status "Qcache_hits")
    local qcache_inserts=$(get_mysql_status "Qcache_inserts")
    local qcache_not_cached=$(get_mysql_status "Qcache_not_cached")
    local qcache_lowmem_prunes=$(get_mysql_status "Qcache_lowmem_prunes")

    local total_cache_operations=$((qcache_hits + qcache_inserts + qcache_not_cached))

    if [ "$total_cache_operations" -gt 0 ]; then
        local cache_hit_rate=$((qcache_hits * 100 / total_cache_operations))
        log "æŸ¥è¯¢ç¼“å­˜å‘½ä¸­ç‡: ${cache_hit_rate}%"

        if [ "$cache_hit_rate" -lt 80 ]; then
            log "è­¦å‘Š: æŸ¥è¯¢ç¼“å­˜å‘½ä¸­ç‡è¿‡ä½ ${cache_hit_rate}%"
        fi
    fi

    log "å†…å­˜ä¸è¶³æ¸…ç†æ¬¡æ•°: $qcache_lowmem_prunes"

    if [ "$qcache_lowmem_prunes" -gt 100 ]; then
        log "è­¦å‘Š: æŸ¥è¯¢ç¼“å­˜å†…å­˜ä¸è¶³é¢‘ç¹æ¸…ç†"
    fi
}

# ç›‘æ§è¡¨é”
monitor_table_locks() {
    log "ç›‘æ§è¡¨é”çŠ¶æ€..."

    local table_locks_waited=$(get_mysql_status "Table_locks_waited")
    local table_locks_immediate=$(get_mysql_status "Table_locks_immediate")
    local total_locks=$((table_locks_waited + table_locks_immediate))

    if [ "$total_locks" -gt 0 ]; then
        local lock_wait_rate=$((table_locks_waited * 100 / total_locks))
        log "è¡¨é”ç­‰å¾…ç‡: ${lock_wait_rate}%"

        if [ "$lock_wait_rate" -gt 5 ]; then
            log "è­¦å‘Š: è¡¨é”ç­‰å¾…ç‡è¿‡é«˜ ${lock_wait_rate}%"
        fi
    fi

    log "è¡¨é”ç­‰å¾…æ¬¡æ•°: $table_locks_waited"
    log "è¡¨é”ç«‹å³è·å¾—æ¬¡æ•°: $table_locks_immediate"
}

# ç›‘æ§ä¸´æ—¶è¡¨
monitor_temp_tables() {
    log "ç›‘æ§ä¸´æ—¶è¡¨ä½¿ç”¨..."

    local created_tmp_disk_tables=$(get_mysql_status "Created_tmp_disk_tables")
    local created_tmp_tables=$(get_mysql_status "Created_tmp_tables")

    if [ "$created_tmp_tables" -gt 0 ]; then
        local disk_tmp_table_rate=$((created_tmp_disk_tables * 100 / created_tmp_tables))
        log "ç£ç›˜ä¸´æ—¶è¡¨æ¯”ç‡: ${disk_tmp_table_rate}%"

        if [ "$disk_tmp_table_rate" -gt 25 ]; then
            log "è­¦å‘Š: ç£ç›˜ä¸´æ—¶è¡¨æ¯”ç‡è¿‡é«˜ ${disk_tmp_table_rate}%"
        fi
    fi

    log "åˆ›å»ºçš„ç£ç›˜ä¸´æ—¶è¡¨: $created_tmp_disk_tables"
    log "åˆ›å»ºçš„ä¸´æ—¶è¡¨æ€»æ•°: $created_tmp_tables"
}

# åˆ†ææ…¢æŸ¥è¯¢
analyze_slow_queries() {
    log "åˆ†ææ…¢æŸ¥è¯¢..."

    local slow_log_file=$(get_mysql_variable "slow_query_log_file")

    if [ -f "$slow_log_file" ]; then
        local recent_slow_queries=$(tail -100 "$slow_log_file" | grep -c "# Query_time")
        log "æœ€è¿‘100è¡Œæ—¥å¿—ä¸­çš„æ…¢æŸ¥è¯¢æ•°: $recent_slow_queries"

        if [ "$recent_slow_queries" -gt 5 ]; then
            log "è­¦å‘Š: æœ€è¿‘æ…¢æŸ¥è¯¢è¾ƒå¤š $recent_slow_queries"

            # æå–æœ€æ…¢çš„æŸ¥è¯¢
            local slowest_query=$(tail -50 "$slow_log_file" | grep -A1 "# Query_time" | grep -v "# Query_time" | head -1)
            log "æœ€æ…¢æŸ¥è¯¢ç¤ºä¾‹: $slowest_query"
        fi
    else
        log "æ…¢æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $slow_log_file"
    fi
}

# å‘é€æ•°æ®åº“å‘Šè­¦
send_db_alert() {
    local alert_type=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    # å‘é€é‚®ä»¶å‘Šè­¦
    echo "[$timestamp] æ•°æ®åº“å‘Šè­¦: $alert_type - $message" | mail -s "æ•°æ®åº“æ€§èƒ½å‘Šè­¦: $alert_type" "$ALERT_EMAIL"

    # å‘é€Webhookå‘Šè­¦
    if [ -n "$WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš¨ æ•°æ®åº“æ€§èƒ½å‘Šè­¦\\nç±»å‹: $alert_type\\næ—¶é—´: $timestamp\\n$message\"}" \
            "$WEBHOOK_URL" 2>/dev/null || true
    fi

    log "æ•°æ®åº“å‘Šè­¦å·²å‘é€: $alert_type - $message"
}

# ç”Ÿæˆæ•°æ®åº“æ€§èƒ½æŠ¥å‘Š
generate_db_performance_report() {
    local report_file="/var/log/db_performance_report_$(date +%Y%m%d_%H%M%S).html"

    cat > "$report_file" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>æ•°æ®åº“æ€§èƒ½ç›‘æ§æŠ¥å‘Š</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .warning { color: orange; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>æ•°æ®åº“æ€§èƒ½ç›‘æ§æŠ¥å‘Š</h1>
    <p>ç”Ÿæˆæ—¶é—´: $(date)</p>

    <div class="section">
        <h2>è¿æ¥çŠ¶æ€</h2>
        <table>
            <tr><th>æŒ‡æ ‡</th><th>æ•°å€¼</th><th>çŠ¶æ€</th></tr>
            <tr><td>æœ€å¤§è¿æ¥æ•°</td><td>$max_connections</td><td><span class='success'>æ­£å¸¸</span></td></tr>
            <tr><td>å½“å‰è¿æ¥æ•°</td><td>$threads_connected</td><td><span class='success'>æ­£å¸¸</span></td></tr>
            <tr><td>è¿æ¥ä½¿ç”¨ç‡</td><td>${connection_usage}%</td><td>$([ "$connection_usage" -gt "$CONNECTION_THRESHOLD" ] && echo "<span class='error'>è¿‡é«˜</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
        </table>
    </div>

    <div class="section">
        <h2>æŸ¥è¯¢æ€§èƒ½</h2>
        <table>
            <tr><th>æŒ‡æ ‡</th><th>æ•°å€¼</th><th>çŠ¶æ€</th></tr>
            <tr><td>æ…¢æŸ¥è¯¢æ•°é‡</td><td>$slow_queries</td><td><span class='success'>æ­£å¸¸</span></td></tr>
            <tr><td>æ¯ç§’æŸ¥è¯¢æ•°</td><td>$qps</td><td>$([ "$qps" -gt 1000 ] && echo "<span class='warning'>è¾ƒé«˜</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
            <tr><td>æ–°å¢æ…¢æŸ¥è¯¢</td><td>$new_slow_queries</td><td>$([ "$new_slow_queries" -gt 10 ] && echo "<span class='error'>å¼‚å¸¸</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
        </table>
    </div>

    <div class="section">
        <h2>InnoDBæ€§èƒ½</h2>
        <table>
            <tr><th>æŒ‡æ ‡</th><th>æ•°å€¼</th><th>çŠ¶æ€</th></tr>
            <tr><td>ç¼“å†²æ± å‘½ä¸­ç‡</td><td>${buffer_pool_hit_rate}%</td><td>$([ "$buffer_pool_hit_rate" -lt 95 ] && echo "<span class='warning'>è¾ƒä½</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
            <tr><td>ç¼“å†²æ± ä½¿ç”¨ç‡</td><td>${buffer_pool_usage}%</td><td>$([ "$buffer_pool_usage" -gt 90 ] && echo "<span class='error'>è¿‡é«˜</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
            <tr><td>è„é¡µæ•°é‡</td><td>$innodb_buffer_pool_pages_dirty</td><td>$([ "$innodb_buffer_pool_pages_dirty" -gt 1000 ] && echo "<span class='warning'>è¾ƒå¤š</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
        </table>
    </div>
</body>
</html>
EOF

    log "æ•°æ®åº“æ€§èƒ½æŠ¥å‘Šç”Ÿæˆå®Œæˆ: $report_file"
}

# ä¸»ç›‘æ§æµç¨‹
main() {
    log "å¼€å§‹æ•°æ®åº“æ€§èƒ½ç›‘æ§..."

    # æ‰§è¡Œå„é¡¹ç›‘æ§
    monitor_connections
    monitor_query_performance
    monitor_innodb_performance
    monitor_query_cache
    monitor_table_locks
    monitor_temp_tables
    analyze_slow_queries

    # ç”ŸæˆæŠ¥å‘Š
    generate_db_performance_report

    log "æ•°æ®åº“æ€§èƒ½ç›‘æ§å®Œæˆ"
}

# æ‰§è¡Œç›‘æ§
main "$@"
```

#### 7.2.3 æœåŠ¡å™¨èµ„æºç›‘æ§

**ç³»ç»Ÿèµ„æºç›‘æ§è„šæœ¬**ï¼š

```bash
#!/bin/bash
# ç³»ç»Ÿèµ„æºç›‘æ§è„šæœ¬ - system_monitor.sh
set -e

LOG_FILE="/var/log/system_monitor.log"
ALERT_EMAIL="admin@yourdomain.com"
CPU_THRESHOLD=80
MEMORY_THRESHOLD=85
DISK_THRESHOLD=90
NETWORK_THRESHOLD=1000  # ç½‘ç»œè¿æ¥æ•°é˜ˆå€¼

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# ç›‘æ§CPUä½¿ç”¨ç‡
monitor_cpu() {
    log "ç›‘æ§CPUä½¿ç”¨ç‡..."

    # è·å–CPUä½¿ç”¨ç‡ï¼ˆå–1åˆ†é’Ÿå¹³å‡ï¼‰
    local cpu_idle=$(top -bn1 | grep "Cpu(s)" | awk '{print $8}' | cut -d% -f1)
    local cpu_usage=$(echo "100 - $cpu_idle" | bc)

    log "CPUä½¿ç”¨ç‡: ${cpu_usage}%"

    # è·å–CPUè´Ÿè½½
    local load_1min=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | sed 's/,//')
    local load_5min=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $2}' | sed 's/,//')
    local load_15min=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $3}')

    log "CPUè´Ÿè½½: 1åˆ†é’Ÿ=$load_1min, 5åˆ†é’Ÿ=$load_5min, 15åˆ†é’Ÿ=$load_15min"

    # è·å–CPUæ ¸å¿ƒæ•°
    local cpu_cores=$(nproc)
    log "CPUæ ¸å¿ƒæ•°: $cpu_cores"

    # æ£€æŸ¥è´Ÿè½½æ˜¯å¦è¿‡é«˜
    local load_threshold=$(echo "$cpu_cores * 2" | bc)
    if (( $(echo "$load_1min > $load_threshold" | bc -l) )); then
        log "è­¦å‘Š: CPUè´Ÿè½½è¿‡é«˜ $load_1min (é˜ˆå€¼: $load_threshold)"
        send_system_alert "CPUè´Ÿè½½å‘Šè­¦" "1åˆ†é’Ÿè´Ÿè½½: $load_1min, é˜ˆå€¼: $load_threshold"
    fi

    if (( $(echo "$cpu_usage > $CPU_THRESHOLD" | bc -l) )); then
        log "è­¦å‘Š: CPUä½¿ç”¨ç‡è¿‡é«˜ ${cpu_usage}%"
        send_system_alert "CPUä½¿ç”¨ç‡å‘Šè­¦" "CPUä½¿ç”¨ç‡: ${cpu_usage}%, é˜ˆå€¼: ${CPU_THRESHOLD}%"
    fi
}

# ç›‘æ§å†…å­˜ä½¿ç”¨
monitor_memory() {
    log "ç›‘æ§å†…å­˜ä½¿ç”¨..."

    # è·å–å†…å­˜ä¿¡æ¯
    local total_memory=$(free -m | awk 'NR==2{print $2}')
    local used_memory=$(free -m | awk 'NR==2{print $3}')
    local free_memory=$(free -m | awk 'NR==2{print $4}')
    local available_memory=$(free -m | awk 'NR==2{print $7}')
    local memory_usage=$(echo "scale=1; $used_memory * 100 / $total_memory" | bc)

    log "æ€»å†…å­˜: ${total_memory}MB"
    log "å·²ç”¨å†…å­˜: ${used_memory}MB"
    log "ç©ºé—²å†…å­˜: ${free_memory}MB"
    log "å¯ç”¨å†…å­˜: ${available_memory}MB"
    log "å†…å­˜ä½¿ç”¨ç‡: ${memory_usage}%"

    # è·å–äº¤æ¢åˆ†åŒºä¿¡æ¯
    local total_swap=$(free -m | awk 'NR==3{print $2}')
    local used_swap=$(free -m | awk 'NR==3{print $3}')
    local swap_usage=0

    if [ "$total_swap" -gt 0 ]; then
        swap_usage=$(echo "scale=1; $used_swap * 100 / $total_swap" | bc)
        log "æ€»äº¤æ¢åˆ†åŒº: ${total_swap}MB"
        log "å·²ç”¨äº¤æ¢åˆ†åŒº: ${used_swap}MB"
        log "äº¤æ¢åˆ†åŒºä½¿ç”¨ç‡: ${swap_usage}%"

        if [ "$swap_usage" -gt 50 ]; then
            log "è­¦å‘Š: äº¤æ¢åˆ†åŒºä½¿ç”¨ç‡è¿‡é«˜ ${swap_usage}%"
        fi
    fi

    # æ£€æŸ¥å†…å­˜é˜ˆå€¼
    if (( $(echo "$memory_usage > $MEMORY_THRESHOLD" | bc -l) )); then
        log "è­¦å‘Š: å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ ${memory_usage}%"
        send_system_alert "å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦" "å†…å­˜ä½¿ç”¨ç‡: ${memory_usage}%, é˜ˆå€¼: ${MEMORY_THRESHOLD}%"
    fi

    # æ£€æŸ¥å¯ç”¨å†…å­˜
    if [ "$available_memory" -lt 512 ]; then
        log "è­¦å‘Š: å¯ç”¨å†…å­˜è¿‡ä½ ${available_memory}MB"
        send_system_alert "å¯ç”¨å†…å­˜å‘Šè­¦" "å¯ç”¨å†…å­˜: ${available_memory}MB, é˜ˆå€¼: 512MB"
    fi
}

# ç›‘æ§ç£ç›˜ä½¿ç”¨
monitor_disk() {
    log "ç›‘æ§ç£ç›˜ä½¿ç”¨..."

    # ç›‘æ§æ ¹åˆ†åŒº
    local root_usage=$(df / | tail -1 | awk '{print $5}' | cut -d% -f1)
    local root_available=$(df -h / | tail -1 | awk '{print $4}')

    log "æ ¹åˆ†åŒºä½¿ç”¨ç‡: ${root_usage}%"
    log "æ ¹åˆ†åŒºå¯ç”¨ç©ºé—´: $root_available"

    if [ "$root_usage" -gt "$DISK_THRESHOLD" ]; then
        log "è­¦å‘Š: æ ¹åˆ†åŒºä½¿ç”¨ç‡è¿‡é«˜ ${root_usage}%"
        send_system_alert "ç£ç›˜ä½¿ç”¨ç‡å‘Šè­¦" "æ ¹åˆ†åŒºä½¿ç”¨ç‡: ${root_usage}%, å¯ç”¨: $root_available"
    fi

    # ç›‘æ§åº”ç”¨åˆ†åŒº
    if [ -d "/var/www" ]; then
        local app_usage=$(df /var/www | tail -1 | awk '{print $5}' | cut -d% -f1)
        local app_available=$(df -h /var/www | tail -1 | awk '{print $4}')

        log "åº”ç”¨åˆ†åŒºä½¿ç”¨ç‡: ${app_usage}%"
        log "åº”ç”¨åˆ†åŒºå¯ç”¨ç©ºé—´: $app_available"

        if [ "$app_usage" -gt "$DISK_THRESHOLD" ]; then
            log "è­¦å‘Š: åº”ç”¨åˆ†åŒºä½¿ç”¨ç‡è¿‡é«˜ ${app_usage}%"
            send_system_alert "åº”ç”¨ç£ç›˜å‘Šè­¦" "åº”ç”¨åˆ†åŒºä½¿ç”¨ç‡: ${app_usage}%, å¯ç”¨: $app_available"
        fi
    fi

    # ç›‘æ§ç£ç›˜I/O
    local io_wait=$(iostat -c 1 2 | tail -2 | head -1 | awk '{print $4}')
    log "ç£ç›˜I/Oç­‰å¾…: ${io_wait}%"

    if (( $(echo "$io_wait > 20" | bc -l) )); then
        log "è­¦å‘Š: ç£ç›˜I/Oç­‰å¾…è¿‡é«˜ ${io_wait}%"
    fi
}

# ç›‘æ§ç½‘ç»œçŠ¶æ€
monitor_network() {
    log "ç›‘æ§ç½‘ç»œçŠ¶æ€..."

    # è·å–ç½‘ç»œæ¥å£ä¿¡æ¯
    local interfaces=$(ip link show | grep -E '^[0-9]+:' | awk -F': ' '{print $2}' | grep -v lo)

    for interface in $interfaces; do
        # è·å–ç½‘ç»œæµé‡ç»Ÿè®¡
        local rx_bytes=$(cat /sys/class/net/$interface/statistics/rx_bytes)
        local tx_bytes=$(cat /sys/class/net/$interface/statistics/tx_bytes)
        local rx_packets=$(cat /sys/class/net/$interface/statistics/rx_packets)
        local tx_packets=$(cat /sys/class/net/$interface/statistics/tx_packets)

        log "ç½‘ç»œæ¥å£ $interface:"
        log "  æ¥æ”¶å­—èŠ‚: $rx_bytes"
        log "  å‘é€å­—èŠ‚: $tx_bytes"
        log "  æ¥æ”¶åŒ…æ•°: $rx_packets"
        log "  å‘é€åŒ…æ•°: $tx_packets"
    done

    # ç›‘æ§ç½‘ç»œè¿æ¥æ•°
    local total_connections=$(netstat -an | wc -l)
    local established_connections=$(netstat -an | grep ESTABLISHED | wc -l)
    local time_wait_connections=$(netstat -an | grep TIME_WAIT | wc -l)
    local https_connections=$(netstat -an | grep :443 | grep ESTABLISHED | wc -l)

    log "æ€»è¿æ¥æ•°: $total_connections"
    log "å·²å»ºç«‹è¿æ¥: $established_connections"
    log "TIME_WAITè¿æ¥: $time_wait_connections"
    log "HTTPSè¿æ¥: $https_connections"

    if [ "$https_connections" -gt "$NETWORK_THRESHOLD" ]; then
        log "è­¦å‘Š: HTTPSè¿æ¥æ•°è¿‡å¤š $https_connections"
        send_system_alert "ç½‘ç»œè¿æ¥å‘Šè­¦" "HTTPSè¿æ¥æ•°: $https_connections, é˜ˆå€¼: $NETWORK_THRESHOLD"
    fi

    # æ£€æŸ¥ç½‘ç»œé”™è¯¯
    local network_errors=$(netstat -s | grep -i "packet receive errors" | awk '{print $1}' || echo 0)
    if [ "$network_errors" -gt 100 ]; then
        log "è­¦å‘Š: ç½‘ç»œé”™è¯¯è¾ƒå¤š $network_errors"
    fi
}

# ç›‘æ§è¿›ç¨‹çŠ¶æ€
monitor_processes() {
    log "ç›‘æ§è¿›ç¨‹çŠ¶æ€..."

    # è·å–ç³»ç»Ÿè¿›ç¨‹æ•°
    local total_processes=$(ps aux | wc -l)
    local running_processes=$(ps aux | awk '$8 ~ /R/ {count++} END {print count+0}')
    local sleeping_processes=$(ps aux | awk '$8 ~ /S/ {count++} END {print count+0}')

    log "æ€»è¿›ç¨‹æ•°: $total_processes"
    log "è¿è¡Œä¸­è¿›ç¨‹: $running_processes"
    log "ç¡çœ è¿›ç¨‹: $sleeping_processes"

    # æ£€æŸ¥åƒµå°¸è¿›ç¨‹
    local zombie_processes=$(ps aux | awk '$8 ~ /Z/ {count++} END {print count+0}')
    log "åƒµå°¸è¿›ç¨‹æ•°: $zombie_processes"

    if [ "$zombie_processes" -gt 5 ]; then
        log "è­¦å‘Š: åƒµå°¸è¿›ç¨‹è¾ƒå¤š $zombie_processes"
        send_system_alert "åƒµå°¸è¿›ç¨‹å‘Šè­¦" "åƒµå°¸è¿›ç¨‹æ•°: $zombie_processes"
    fi

    # ç›‘æ§å…³é”®æœåŠ¡è¿›ç¨‹
    local services=("nginx" "php-fpm" "mysql" "redis-server")

    for service in "${services[@]}"; do
        local service_processes=$(pgrep -c "$service" 2>/dev/null || echo 0)
        log "$service è¿›ç¨‹æ•°: $service_processes"

        if [ "$service_processes" -eq 0 ]; then
            log "è­¦å‘Š: $service æœåŠ¡æœªè¿è¡Œ"
            send_system_alert "æœåŠ¡åœæ­¢å‘Šè­¦" "$service æœåŠ¡æœªè¿è¡Œ"
        fi
    done
}

# ç›‘æ§ç³»ç»Ÿæ¸©åº¦ï¼ˆå¦‚æœå¯ç”¨ï¼‰
monitor_temperature() {
    if command -v sensors &> /dev/null; then
        log "ç›‘æ§ç³»ç»Ÿæ¸©åº¦..."

        local temp_output=$(sensors 2>/dev/null)
        if [ -n "$temp_output" ]; then
            echo "$temp_output" | while read line; do
                if echo "$line" | grep -q "Core"; then
                    local temp=$(echo "$line" | awk '{print $3}' | sed 's/+//' | sed 's/Â°C//')
                    log "$line"

                    if (( $(echo "$temp > 80" | bc -l) )); then
                        log "è­¦å‘Š: ç³»ç»Ÿæ¸©åº¦è¿‡é«˜ ${temp}Â°C"
                        send_system_alert "æ¸©åº¦å‘Šè­¦" "ç³»ç»Ÿæ¸©åº¦: ${temp}Â°C"
                    fi
                fi
            done
        fi
    fi
}

# å‘é€ç³»ç»Ÿå‘Šè­¦
send_system_alert() {
    local alert_type=$1
    local message=$2
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    # å‘é€é‚®ä»¶å‘Šè­¦
    echo "[$timestamp] ç³»ç»Ÿå‘Šè­¦: $alert_type - $message" | mail -s "ç³»ç»Ÿèµ„æºå‘Šè­¦: $alert_type" "$ALERT_EMAIL"

    # å‘é€Webhookå‘Šè­¦
    if [ -n "$WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš¨ ç³»ç»Ÿèµ„æºå‘Šè­¦\\nç±»å‹: $alert_type\\næ—¶é—´: $timestamp\\n$message\"}" \
            "$WEBHOOK_URL" 2>/dev/null || true
    fi

    log "ç³»ç»Ÿå‘Šè­¦å·²å‘é€: $alert_type - $message"
}

# ç”Ÿæˆç³»ç»Ÿèµ„æºæŠ¥å‘Š
generate_system_report() {
    local report_file="/var/log/system_monitor_report_$(date +%Y%m%d_%H%M%S).html"

    cat > "$report_file" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>ç³»ç»Ÿèµ„æºç›‘æ§æŠ¥å‘Š</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .warning { color: orange; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h1>ç³»ç»Ÿèµ„æºç›‘æ§æŠ¥å‘Š</h1>
    <p>ç”Ÿæˆæ—¶é—´: $(date)</p>

    <div class="section">
        <h2>CPUçŠ¶æ€</h2>
        <table>
            <tr><th>æŒ‡æ ‡</th><th>æ•°å€¼</th><th>çŠ¶æ€</th></tr>
            <tr><td>CPUä½¿ç”¨ç‡</td><td>${cpu_usage}%</td><td>$([ $(echo "$cpu_usage > $CPU_THRESHOLD" | bc -l) -eq 1 ] && echo "<span class='error'>è¿‡é«˜</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
            <tr><td>1åˆ†é’Ÿè´Ÿè½½</td><td>$load_1min</td><td>$([ $(echo "$load_1min > $load_threshold" | bc -l) -eq 1 ] && echo "<span class='error'>è¿‡é«˜</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
            <tr><td>CPUæ ¸å¿ƒæ•°</td><td>$cpu_cores</td><td><span class='success'>æ­£å¸¸</span></td></tr>
        </table>
    </div>

    <div class="section">
        <h2>å†…å­˜çŠ¶æ€</h2>
        <table>
            <tr><th>æŒ‡æ ‡</th><th>æ•°å€¼</th><th>çŠ¶æ€</th></tr>
            <tr><td>æ€»å†…å­˜</td><td>${total_memory}MB</td><td><span class='success'>æ­£å¸¸</span></td></tr>
            <tr><td>å·²ç”¨å†…å­˜</td><td>${used_memory}MB</td><td><span class='success'>æ­£å¸¸</span></td></tr>
            <tr><td>å¯ç”¨å†…å­˜</td><td>${available_memory}MB</td><td>$([ "$available_memory" -lt 512 ] && echo "<span class='error'>è¿‡ä½</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
            <tr><td>å†…å­˜ä½¿ç”¨ç‡</td><td>${memory_usage}%</td><td>$([ $(echo "$memory_usage > $MEMORY_THRESHOLD" | bc -l) -eq 1 ] && echo "<span class='error'>è¿‡é«˜</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
            <tr><td>äº¤æ¢åˆ†åŒºä½¿ç”¨ç‡</td><td>${swap_usage}%</td><td>$([ "$swap_usage" -gt 50 ] && echo "<span class='warning'>è¾ƒé«˜</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
        </table>
    </div>

    <div class="section">
        <h2>ç£ç›˜çŠ¶æ€</h2>
        <table>
            <tr><th>åˆ†åŒº</th><th>ä½¿ç”¨ç‡</th><th>å¯ç”¨ç©ºé—´</th><th>çŠ¶æ€</th></tr>
            <tr><td>æ ¹åˆ†åŒº</td><td>${root_usage}%</td><td>$root_available</td><td>$([ "$root_usage" -gt "$DISK_THRESHOLD" ] && echo "<span class='error'>è¿‡é«˜</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
            <tr><td>åº”ç”¨åˆ†åŒº</td><td>${app_usage}%</td><td>$app_available</td><td>$([ "$app_usage" -gt "$DISK_THRESHOLD" ] && echo "<span class='error'>è¿‡é«˜</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
        </table>
    </div>

    <div class="section">
        <h2>ç½‘ç»œçŠ¶æ€</h2>
        <table>
            <tr><th>æŒ‡æ ‡</th><th>æ•°å€¼</th><th>çŠ¶æ€</th></tr>
            <tr><td>æ€»è¿æ¥æ•°</td><td>$total_connections</td><td><span class='success'>æ­£å¸¸</span></td></tr>
            <tr><td>å·²å»ºç«‹è¿æ¥</td><td>$established_connections</td><td><span class='success'>æ­£å¸¸</span></td></tr>
            <tr><td>HTTPSè¿æ¥</td><td>$https_connections</td><td>$([ "$https_connections" -gt "$NETWORK_THRESHOLD" ] && echo "<span class='warning'>è¾ƒå¤š</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
            <tr><td>TIME_WAITè¿æ¥</td><td>$time_wait_connections</td><td><span class='success'>æ­£å¸¸</span></td></tr>
        </table>
    </div>

    <div class="section">
        <h2>è¿›ç¨‹çŠ¶æ€</h2>
        <table>
            <tr><th>æŒ‡æ ‡</th><th>æ•°å€¼</th><th>çŠ¶æ€</th></tr>
            <tr><td>æ€»è¿›ç¨‹æ•°</td><td>$total_processes</td><td><span class='success'>æ­£å¸¸</span></td></tr>
            <tr><td>è¿è¡Œä¸­è¿›ç¨‹</td><td>$running_processes</td><td><span class='success'>æ­£å¸¸</span></td></tr>
            <tr><td>åƒµå°¸è¿›ç¨‹</td><td>$zombie_processes</td><td>$([ "$zombie_processes" -gt 5 ] && echo "<span class='error'>å¼‚å¸¸</span>" || echo "<span class='success'>æ­£å¸¸</span>")</td></tr>
        </table>
    </div>
</body>
</html>
EOF

    log "ç³»ç»Ÿèµ„æºæŠ¥å‘Šç”Ÿæˆå®Œæˆ: $report_file"
}

# ä¸»ç›‘æ§æµç¨‹
main() {
    log "å¼€å§‹ç³»ç»Ÿèµ„æºç›‘æ§..."

    # æ‰§è¡Œå„é¡¹ç›‘æ§
    monitor_cpu
    monitor_memory
    monitor_disk
    monitor_network
    monitor_processes
    monitor_temperature

    # ç”ŸæˆæŠ¥å‘Š
    generate_system_report

    log "ç³»ç»Ÿèµ„æºç›‘æ§å®Œæˆ"
}

# æ‰§è¡Œç›‘æ§
main "$@"
```

### 7.3 å‘Šè­¦é…ç½®

#### 7.3.1 å‘Šè­¦è§„åˆ™è®¾ç½®

**å‘Šè­¦é…ç½®æ–‡ä»¶**ï¼š

```yaml
# config/alerts/alert_rules.yaml
alerts:
    # åº”ç”¨é”™è¯¯ç‡å‘Šè­¦
    application_error_rate:
        enabled: true
        threshold: 5.0 # é”™è¯¯ç‡ç™¾åˆ†æ¯”
        window: 5m # æ—¶é—´çª—å£
        severity: critical
        description: "åº”ç”¨é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼"
        condition: "error_rate > threshold"

    # å“åº”æ—¶é—´å‘Šè­¦
    response_time:
        enabled: true
        threshold: 5000 # å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        window: 2m
        severity: warning
        description: "APIå“åº”æ—¶é—´è¿‡é•¿"
        condition: "avg_response_time > threshold"

    # æ•°æ®åº“è¿æ¥å‘Šè­¦
    database_connections:
        enabled: true
        threshold: 80 # è¿æ¥ä½¿ç”¨ç‡ç™¾åˆ†æ¯”
        window: 1m
        severity: critical
        description: "æ•°æ®åº“è¿æ¥æ•°è¿‡å¤š"
        condition: "connection_usage > threshold"

    # CPUä½¿ç”¨ç‡å‘Šè­¦
    cpu_usage:
        enabled: true
        threshold: 80 # CPUä½¿ç”¨ç‡ç™¾åˆ†æ¯”
        window: 3m
        severity: warning
        description: "CPUä½¿ç”¨ç‡è¿‡é«˜"
        condition: "cpu_usage > threshold"

    # å†…å­˜ä½¿ç”¨ç‡å‘Šè­¦
    memory_usage:
        enabled: true
        threshold: 85 # å†…å­˜ä½¿ç”¨ç‡ç™¾åˆ†æ¯”
        window: 2m
        severity: critical
        description: "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜"
        condition: "memory_usage > threshold"

    # ç£ç›˜ç©ºé—´å‘Šè­¦
    disk_usage:
        enabled: true
        threshold: 90 # ç£ç›˜ä½¿ç”¨ç‡ç™¾åˆ†æ¯”
        window: 5m
        severity: critical
        description: "ç£ç›˜ç©ºé—´ä¸è¶³"
        condition: "disk_usage > threshold"

    # SSLè¯ä¹¦è¿‡æœŸå‘Šè­¦
    ssl_certificate_expiry:
        enabled: true
        threshold: 30 # è¿‡æœŸå¤©æ•°
        window: 1h
        severity: warning
        description: "SSLè¯ä¹¦å³å°†è¿‡æœŸ"
        condition: "days_until_expiry < threshold"

    # æ…¢æŸ¥è¯¢å‘Šè­¦
    slow_queries:
        enabled: true
        threshold: 10 # æ…¢æŸ¥è¯¢æ•°é‡
        window: 5m
        severity: warning
        description: "æ…¢æŸ¥è¯¢æ•°é‡è¿‡å¤š"
        condition: "slow_query_count > threshold"

    # å®‰å…¨äº‹ä»¶å‘Šè­¦
    security_events:
        enabled: true
        threshold: 5 # å¤±è´¥ç™»å½•æ¬¡æ•°
        window: 1m
        severity: critical
        description: "æ£€æµ‹åˆ°å¯ç–‘å®‰å…¨äº‹ä»¶"
        condition: "failed_login_count > threshold"

# å‘Šè­¦å‡çº§ç­–ç•¥
escalation:
    levels:
        - level: 1
          delay: 5m
          channels: ["email", "webhook"]
        - level: 2
          delay: 15m
          channels: ["email", "webhook", "sms"]
        - level: 3
          delay: 30m
          channels: ["email", "webhook", "sms", "phone"]
```

**å‘Šè­¦è§„åˆ™å¼•æ“**ï¼š

```php
<?php
// src/Service/AlertEngineService.php
namespace App\Service;

use Symfony\Component\DependencyInjection\ParameterBag\ParameterBagInterface;
use Psr\Log\LoggerInterface;

class AlertEngineService
{
    private LoggerInterface $logger;
    private array $rules = [];
    private array $activeAlerts = [];

    public function __construct(LoggerInterface $logger, ParameterBagInterface $params)
    {
        $this->logger = $logger;
        $this->loadRules($params->get('kernel.project_dir') . '/config/alerts/alert_rules.yaml');
    }

    private function loadRules(string $rulesFile): void
    {
        if (file_exists($rulesFile)) {
            $this->rules = yaml_parse_file($rulesFile);
            $this->logger->info('å‘Šè­¦è§„åˆ™åŠ è½½å®Œæˆ', ['rules_count' => count($this->rules['alerts'])]);
        }
    }

    public function evaluateMetrics(array $metrics): void
    {
        foreach ($this->rules['alerts'] as $alertName => $rule) {
            if (!$rule['enabled']) {
                continue;
            }

            $alertKey = $this->generateAlertKey($alertName, $metrics);

            if ($this->shouldTriggerAlert($alertName, $rule, $metrics)) {
                $this->triggerAlert($alertName, $rule, $metrics, $alertKey);
            } else {
                $this->resolveAlert($alertKey);
            }
        }
    }

    private function shouldTriggerAlert(string $alertName, array $rule, array $metrics): bool
    {
        switch ($alertName) {
            case 'application_error_rate':
                return $this->evaluateCondition($rule['condition'], [
                    'error_rate' => $metrics['error_rate'] ?? 0
                ]);

            case 'response_time':
                return $this->evaluateCondition($rule['condition'], [
                    'avg_response_time' => $metrics['avg_response_time'] ?? 0
                ]);

            case 'database_connections':
                return $this->evaluateCondition($rule['condition'], [
                    'connection_usage' => $metrics['db_connection_usage'] ?? 0
                ]);

            case 'cpu_usage':
                return $this->evaluateCondition($rule['condition'], [
                    'cpu_usage' => $metrics['cpu_usage'] ?? 0
                ]);

            case 'memory_usage':
                return $this->evaluateCondition($rule['condition'], [
                    'memory_usage' => $metrics['memory_usage'] ?? 0
                ]);

            case 'disk_usage':
                return $this->evaluateCondition($rule['condition'], [
                    'disk_usage' => $metrics['disk_usage'] ?? 0
                ]);

            default:
                return false;
        }
    }

    private function evaluateCondition(string $condition, array $variables): bool
    {
        // ç®€å•çš„æ¡ä»¶è¯„ä¼°å™¨
        // åœ¨ç”Ÿäº§ç¯å¢ƒä¸­åº”è¯¥ä½¿ç”¨æ›´å®‰å…¨çš„è¡¨è¾¾å¼è¯„ä¼°å™¨
        extract($variables);

        try {
            return eval("return $condition;");
        } catch (\Throwable $e) {
            $this->logger->error('å‘Šè­¦æ¡ä»¶è¯„ä¼°å¤±è´¥', [
                'condition' => $condition,
                'variables' => $variables,
                'error' => $e->getMessage()
            ]);
            return false;
        }
    }

    private function triggerAlert(string $alertName, array $rule, array $metrics, string $alertKey): void
    {
        if (isset($this->activeAlerts[$alertKey])) {
            // å‘Šè­¦å·²ç»æ¿€æ´»ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦å‡çº§
            $this->checkEscalation($alertKey, $rule);
            return;
        }

        $this->activeAlerts[$alertKey] = [
            'name' => $alertName,
            'severity' => $rule['severity'],
            'description' => $rule['description'],
            'triggered_at' => new \DateTime(),
            'metrics' => $metrics,
            'escalation_level' => 1,
            'last_notification' => null
        ];

        $this->logger->warning('å‘Šè­¦è§¦å‘', [
            'alert_name' => $alertName,
            'severity' => $rule['severity'],
            'description' => $rule['description'],
            'metrics' => $metrics
        ]);

        $this->sendNotification($alertKey, $rule, 1);
    }

    private function resolveAlert(string $alertKey): void
    {
        if (isset($this->activeAlerts[$alertKey])) {
            $this->logger->info('å‘Šè­¦è§£é™¤', [
                'alert_key' => $alertKey,
                'alert_name' => $this->activeAlerts[$alertKey]['name'],
                'duration' => $this->activeAlerts[$alertKey]['triggered_at']->diff(new \DateTime())->format('%iåˆ†é’Ÿ')
            ]);

            unset($this->activeAlerts[$alertKey]);
        }
    }

    private function checkEscalation(string $alertKey, array $rule): void
    {
        $alert = &$this->activeAlerts[$alertKey];
        $currentLevel = $alert['escalation_level'];

        if (!isset($this->rules['escalation']['levels'][$currentLevel])) {
            return;
        }

        $nextLevel = $this->rules['escalation']['levels'][$currentLevel];
        $delay = new \DateInterval('PT' . str_replace('m', 'M', $nextLevel['delay']));

        if ($alert['triggered_at']->add($delay) <= new \DateTime() &&
            $alert['last_notification'] === null) {

            $alert['escalation_level'] = $currentLevel + 1;
            $this->sendNotification($alertKey, $rule, $alert['escalation_level']);
        }
    }

    private function sendNotification(string $alertKey, array $rule, int $escalationLevel): void
    {
        $alert = $this->activeAlerts[$alertKey];
        $escalationConfig = $this->rules['escalation']['levels'][$escalationLevel - 1] ?? null;

        if (!$escalationConfig) {
            return;
        }

        foreach ($escalationConfig['channels'] as $channel) {
            switch ($channel) {
                case 'email':
                    $this->sendEmailNotification($alert);
                    break;
                case 'webhook':
                    $this->sendWebhookNotification($alert);
                    break;
                case 'sms':
                    $this->sendSmsNotification($alert);
                    break;
            }
        }

        $alert['last_notification'] = new \DateTime();
    }

    private function sendEmailNotification(array $alert): void
    {
        $subject = "[{$alert['severity']}] {$alert['name']} - ç³»ç»Ÿå‘Šè­¦";
        $message = $this->formatEmailMessage($alert);

        // å‘é€é‚®ä»¶é€»è¾‘
        $this->logger->info('å‘é€é‚®ä»¶å‘Šè­¦', [
            'subject' => $subject,
            'to' => 'admin@yourdomain.com'
        ]);

        // å®é™…é‚®ä»¶å‘é€ä»£ç 
        // mail('admin@yourdomain.com', $subject, $message);
    }

    private function sendWebhookNotification(array $alert): void
    {
        $payload = [
            'text' => "ğŸš¨ ç³»ç»Ÿå‘Šè­¦\n",
            'alert_name' => $alert['name'],
            'severity' => $alert['severity'],
            'description' => $alert['description'],
            'triggered_at' => $alert['triggered_at']->format('Y-m-d H:i:s'),
            'escalation_level' => $alert['escalation_level']
        ];

        // å‘é€Webhook
        $this->logger->info('å‘é€Webhookå‘Šè­¦', ['payload' => $payload]);

        // å®é™…Webhookå‘é€ä»£ç 
        // curl -X POST -H 'Content-type: application/json' --data json_encode($payload) $webhookUrl;
    }

    private function sendSmsNotification(array $alert): void
    {
        // SMSå‘é€é€»è¾‘
        $this->logger->info('å‘é€çŸ­ä¿¡å‘Šè­¦', [
            'alert_name' => $alert['name'],
            'severity' => $alert['severity']
        ]);
    }

    private function formatEmailMessage(array $alert): string
    {
        return "ç³»ç»Ÿå‘Šè­¦é€šçŸ¥\n\n" .
               "å‘Šè­¦åç§°: {$alert['name']}\n" .
               "ä¸¥é‡ç¨‹åº¦: {$alert['severity']}\n" .
               "æè¿°: {$alert['description']}\n" .
               "è§¦å‘æ—¶é—´: {$alert['triggered_at']->format('Y-m-d H:i:s')}\n" .
               "å‡çº§çº§åˆ«: {$alert['escalation_level']}\n\n" .
               "å½“å‰æŒ‡æ ‡:\n" .
               json_encode($alert['metrics'], JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
    }

    private function generateAlertKey(string $alertName, array $metrics): string
    {
        return md5($alertName . serialize($metrics));
    }

    public function getActiveAlerts(): array
    {
        return $this->activeAlerts;
    }
}
```

**å‘Šè­¦ç›‘æ§è„šæœ¬**ï¼š

```bash
#!/bin/bash
# å‘Šè­¦ç›‘æ§è„šæœ¬ - alert_monitor.sh
set -e

ALERT_RULES_FILE="/var/www/official_website_backend/config/alerts/alert_rules.yaml"
METRICS_CACHE_FILE="/tmp/metrics_cache.json"
LOG_FILE="/var/log/alert_monitor.log"
ALERT_STATE_FILE="/tmp/alert_state.json"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# æ”¶é›†ç³»ç»ŸæŒ‡æ ‡
collect_metrics() {
    local metrics_file=$1

    # CPUä½¿ç”¨ç‡
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d% -f1)

    # å†…å­˜ä½¿ç”¨ç‡
    local memory_usage=$(free | grep Mem | awk '{printf("%.1f", $3/$2 * 100.0)}')

    # ç£ç›˜ä½¿ç”¨ç‡
    local disk_usage=$(df / | tail -1 | awk '{print $5}' | cut -d% -f1)

    # æ•°æ®åº“è¿æ¥ä½¿ç”¨ç‡
    local max_connections=$(mysql -u root -p -e "SHOW VARIABLES LIKE 'max_connections';" 2>/dev/null | tail -1 | awk '{print $2}' || echo 100)
    local current_connections=$(mysql -u root -p -e "SHOW STATUS LIKE 'Threads_connected';" 2>/dev/null | tail -1 | awk '{print $2}' || echo 0)
    local db_connection_usage=$((current_connections * 100 / max_connections))

    # åº”ç”¨é”™è¯¯ç‡ï¼ˆä»æ—¥å¿—ä¸­è®¡ç®—ï¼‰
    local error_count=$(tail -1000 /var/www/official_website_backend/var/log/application.log 2>/dev/null | grep -c "ERROR" || echo 0)
    local total_requests=$(tail -1000 /var/www/official_website_backend/var/log/application.log 2>/dev/null | wc -l || echo 1)
    local error_rate=$((error_count * 100 / total_requests))

    # å¹³å‡å“åº”æ—¶é—´ï¼ˆä»æ—¥å¿—ä¸­è®¡ç®—ï¼‰
    local avg_response_time=0
    if [ -f "/var/www/official_website_backend/var/log/performance.log" ]; then
        avg_response_time=$(tail -100 /var/www/official_website_backend/var/log/performance.log | grep -o '"duration":[0-9]*' | cut -d: -f2 | awk '{sum+=$1; count++} END {if(count>0) print sum/count; else print 0}')
    fi

    # SSLè¯ä¹¦è¿‡æœŸå¤©æ•°
    local days_until_expiry=365
    if command -v openssl &> /dev/null; then
        local expiry_date=$(echo | openssl s_client -servername yourdomain.com -connect yourdomain.com:443 2>/dev/null | openssl x509 -noout -dates | grep "notAfter" | cut -d= -f2)
        if [ -n "$expiry_date" ]; then
            local expiry_timestamp=$(date -d "$expiry_date" +%s)
            local current_timestamp=$(date +%s)
            days_until_expiry=$(( (expiry_timestamp - current_timestamp) / 86400 ))
        fi
    fi

    # æ…¢æŸ¥è¯¢æ•°é‡
    local slow_query_count=0
    if [ -f "/var/log/mysql/slow.log" ]; then
        slow_query_count=$(tail -100 /var/log/mysql/slow.log | grep -c "# Query_time" || echo 0)
    fi

    # å¤±è´¥ç™»å½•æ¬¡æ•°
    local failed_login_count=0
    if [ -f "/var/www/official_website_backend/var/log/security.log" ]; then
        failed_login_count=$(tail -100 /var/www/official_website_backend/var/log/security.log | grep -c "authentication failed" || echo 0)
    fi

    # ç”ŸæˆJSONæ ¼å¼çš„æŒ‡æ ‡æ•°æ®
    cat > "$metrics_file" << EOF
{
    "timestamp": "$(date -Iseconds)",
    "cpu_usage": $cpu_usage,
    "memory_usage": $memory_usage,
    "disk_usage": $disk_usage,
    "db_connection_usage": $db_connection_usage,
    "error_rate": $error_rate,
    "avg_response_time": $avg_response_time,
    "days_until_expiry": $days_until_expiry,
    "slow_query_count": $slow_query_count,
    "failed_login_count": $failed_login_count,
    "max_connections": $max_connections,
    "current_connections": $current_connections
}
EOF

    log "æŒ‡æ ‡æ”¶é›†å®Œæˆ: $metrics_file"
}

# ä¸»ç›‘æ§å¾ªç¯
main() {
    log "å¼€å§‹å‘Šè­¦ç›‘æ§..."

    while true; do
        # æ”¶é›†æŒ‡æ ‡
        collect_metrics "$METRICS_CACHE_FILE"

        # è¯„ä¼°å‘Šè­¦
        evaluate_alerts "$METRICS_CACHE_FILE"

        # ç­‰å¾…ä¸‹æ¬¡æ£€æŸ¥
        sleep 60
    done
}

# ä¿¡å·å¤„ç†
trap 'echo "å‘Šè­¦ç›‘æ§åœæ­¢"; exit 0' SIGINT SIGTERM

# å¯åŠ¨ç›‘æ§
main "$@"
```

#### 7.3.2 å‘Šè­¦é€šçŸ¥æ¸ é“

**å¤šæ¸ é“é€šçŸ¥é…ç½®**ï¼š

```yaml
# config/notifications/channels.yaml
notification_channels:
    email:
        enabled: true
        smtp_server: smtp.example.com
        smtp_port: 587
        username: alerts@example.com
        password: [SMTPå¯†ç ]
        from_address: alerts@example.com
        to_addresses:
            - admin@example.com
            - ops@example.com
        templates:
            subject: "[{severity}] {alert_name} - ç³»ç»Ÿå‘Šè­¦"
            body: |
                å‘Šè­¦è¯¦æƒ…:
                - å‘Šè­¦åç§°: {alert_name}
                - ä¸¥é‡ç¨‹åº¦: {severity}
                - è§¦å‘æ—¶é—´: {triggered_at}
                - å½“å‰æŒ‡æ ‡: {metrics}
                - æè¿°ä¿¡æ¯: {description}
                - å‡çº§çº§åˆ«: {escalation_level}

    webhook:
        enabled: true
        endpoints:
            - name: slack
              url: https://hooks.slack.com/services/XXX/YYY/ZZZ
              method: POST
              headers:
                  Content-Type: application/json
              template: |
                  {
                    "text": "ğŸš¨ ç³»ç»Ÿå‘Šè­¦\\n{alert_name}\\n{severity}\\n{message}"
                  }

            - name: dingtalk
              url: https://oapi.dingtalk.com/robot/send?access_token=XXX
              method: POST
              headers:
                  Content-Type: application/json
              template: |
                  {
                    "msgtype": "text",
                    "text": {
                      "content": "ğŸš¨ ç³»ç»Ÿå‘Šè­¦\\nå‘Šè­¦åç§°: {alert_name}\\nä¸¥é‡ç¨‹åº¦: {severity}\\næ¶ˆæ¯: {message}"
                    }
                  }

    sms:
        enabled: true
        provider: aliyun
        access_key: [é˜¿é‡Œäº‘AccessKey]
        access_secret: [é˜¿é‡Œäº‘AccessSecret]
        sign_name: ç³»ç»Ÿå‘Šè­¦
        template_code: SMS_123456789
        phone_numbers:
            - 13800138000
            - 13900139000

    phone:
        enabled: false
        provider: twilio
        account_sid: [Twilio Account SID]
        auth_token: [Twilio Auth Token]
        from_number: +1234567890
        to_numbers:
            - +8613800138000
```

### 7.4 å®šæœŸç»´æŠ¤ä»»åŠ¡

#### 7.4.1 æ—¥å¸¸ç»´æŠ¤

**æ—¥å¸¸ç»´æŠ¤è„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ—¥å¸¸ç»´æŠ¤è„šæœ¬ - daily_maintenance.sh
set -e

MAINTENANCE_LOG="/var/log/daily_maintenance_$(date +%Y%m%d).log"
APP_DIR="/var/www/official_website_backend"
BACKUP_DIR="/backup/maintenance"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$MAINTENANCE_LOG"
}

# æ¸…ç†åº”ç”¨æ—¥å¿—
cleanup_application_logs() {
    log "å¼€å§‹æ¸…ç†åº”ç”¨æ—¥å¿—..."

    local log_dir="$APP_DIR/var/log"
    local keep_days=7

    # å‹ç¼©7å¤©å‰çš„æ—¥å¿—æ–‡ä»¶
    find "$log_dir" -name "*.log" -mtime +$keep_days -exec gzip {} \;
    log "å‹ç¼©å®Œæˆ: $keep_dayså¤©å‰çš„æ—¥å¿—æ–‡ä»¶"

    # åˆ é™¤30å¤©å‰çš„å‹ç¼©æ—¥å¿—
    find "$log_dir" -name "*.log.gz" -mtime +30 -delete
    log "åˆ é™¤å®Œæˆ: 30å¤©å‰çš„å‹ç¼©æ—¥å¿—æ–‡ä»¶"

    # æ¸…ç†ä¸´æ—¶æ—¥å¿—æ–‡ä»¶
    find "$log_dir" -name "*.tmp" -mtime +1 -delete
    log "æ¸…ç†å®Œæˆ: ä¸´æ—¶æ—¥å¿—æ–‡ä»¶"

    log "åº”ç”¨æ—¥å¿—æ¸…ç†å®Œæˆ"
}

# æ¸…ç†ç¼“å­˜
cleanup_cache() {
    log "å¼€å§‹æ¸…ç†ç¼“å­˜..."

    # æ¸…ç†Symfonyç¼“å­˜
    cd "$APP_DIR"
    php bin/console cache:clear --env=prod > /dev/null 2>&1 || true
    log "Symfonyç¼“å­˜æ¸…ç†å®Œæˆ"

    # æ¸…ç†Redisç¼“å­˜
    if command -v redis-cli &> /dev/null; then
        # æ¸…ç†è¿‡æœŸçš„ç¼“å­˜é”®
        redis-cli --scan --pattern "expired:*" | xargs redis-cli del > /dev/null 2>&1 || true
        log "Redisè¿‡æœŸç¼“å­˜æ¸…ç†å®Œæˆ"

        # æ¸…ç†ä¸´æ—¶ç¼“å­˜
        redis-cli --scan --pattern "temp:*" | xargs redis-cli del > /dev/null 2>&1 || true
        log "Redisä¸´æ—¶ç¼“å­˜æ¸…ç†å®Œæˆ"
    fi

    # æ¸…ç†OPcache
    if php -m | grep -q opcache; then
        php -r "if (function_exists('opcache_reset')) { opcache_reset(); echo 'OPcacheé‡ç½®å®Œæˆ\n'; }"
    fi

    log "ç¼“å­˜æ¸…ç†å®Œæˆ"
}

# æ£€æŸ¥ç³»ç»Ÿæ›´æ–°
check_system_updates() {
    log "å¼€å§‹æ£€æŸ¥ç³»ç»Ÿæ›´æ–°..."

    # æ£€æŸ¥ç³»ç»ŸåŒ…æ›´æ–°
    if command -v apt &> /dev/null; then
        apt list --upgradable 2>/dev/null | grep -v "WARNING" > /tmp/system_updates.txt
        local update_count=$(wc -l < /tmp/system_updates.txt)

        if [ "$update_count" -gt 0 ]; then
            log "å‘ç° $update_count ä¸ªç³»ç»ŸåŒ…æ›´æ–°:"
            head -10 /tmp/system_updates.txt | tee -a "$MAINTENANCE_LOG"
        else
            log "ç³»ç»ŸåŒ…å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
        fi

        rm -f /tmp/system_updates.txt
    fi

    log "ç³»ç»Ÿæ›´æ–°æ£€æŸ¥å®Œæˆ"
}

# ä¸»ç»´æŠ¤æµç¨‹
main() {
    log "å¼€å§‹æ—¥å¸¸ç»´æŠ¤ä»»åŠ¡..."

    # æ‰§è¡Œå„é¡¹ç»´æŠ¤ä»»åŠ¡
    cleanup_application_logs
    cleanup_cache
    check_system_updates

    log "æ—¥å¸¸ç»´æŠ¤ä»»åŠ¡å®Œæˆ"
}

# æ‰§è¡Œç»´æŠ¤
main "$@"
```

#### 7.4.2 å‘¨æœŸæ€§ç»´æŠ¤

**å‘¨æœŸæ€§ç»´æŠ¤è„šæœ¬**ï¼š

```bash
#!/bin/bash
# å‘¨æœŸæ€§ç»´æŠ¤è„šæœ¬ - periodic_maintenance.sh
set -e

MAINTENANCE_TYPE=$1  # weekly, monthly, quarterly
MAINTENANCE_LOG="/var/log/periodic_maintenance_$(date +%Y%m%d).log"
APP_DIR="/var/www/official_website_backend"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$MAINTENANCE_LOG"
}

# æ•°æ®åº“ä¼˜åŒ–
optimize_database() {
    log "å¼€å§‹æ•°æ®åº“ä¼˜åŒ–..."

    cd "$APP_DIR"

    # ä¼˜åŒ–è¡¨
    local tables=$(mysql -u root -p -e "SHOW TABLES FROM official_website;" 2>/dev/null | tail -n +2)

    for table in $tables; do
        log "ä¼˜åŒ–è¡¨: $table"
        mysql -u root -p -e "OPTIMIZE TABLE official_website.$table;" 2>/dev/null || true
    done

    log "æ•°æ®åº“ä¼˜åŒ–å®Œæˆ"
}

# é‡å»ºç´¢å¼•
rebuild_indexes() {
    log "å¼€å§‹é‡å»ºç´¢å¼•..."

    cd "$APP_DIR"

    # è·å–éœ€è¦é‡å»ºç´¢å¼•çš„è¡¨
    local tables=$(mysql -u root -p -e "
        SELECT table_name
        FROM information_schema.tables
        WHERE table_schema = 'official_website'
        AND table_rows > 1000;
    " 2>/dev/null | tail -n +2)

    for table in $tables; do
        log "é‡å»ºè¡¨ $table çš„ç´¢å¼•"
        mysql -u root -p -e "REPAIR TABLE official_website.$table;" 2>/dev/null || true
    done

    log "ç´¢å¼•é‡å»ºå®Œæˆ"
}

# æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
update_statistics() {
    log "å¼€å§‹æ›´æ–°ç»Ÿè®¡ä¿¡æ¯..."

    cd "$APP_DIR"

    # æ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯
    mysql -u root -p -e "
        SELECT table_name
        FROM information_schema.tables
        WHERE table_schema = 'official_website';
    " 2>/dev/null | tail -n +2 | while read table; do
        log "æ›´æ–°è¡¨ç»Ÿè®¡ä¿¡æ¯: $table"
        mysql -u root -p -e "ANALYZE TABLE official_website.$table;" 2>/dev/null || true
    done

    log "ç»Ÿè®¡ä¿¡æ¯æ›´æ–°å®Œæˆ"
}

# æ€§èƒ½è°ƒä¼˜
performance_tuning() {
    log "å¼€å§‹æ€§èƒ½è°ƒä¼˜..."

    # æ£€æŸ¥MySQLé…ç½®
    local mysql_config="/etc/mysql/mysql.conf.d/mysqld.cnf"

    if [ -f "$mysql_config" ]; then
        log "æ£€æŸ¥MySQLé…ç½®..."

        # æ£€æŸ¥InnoDBç¼“å†²æ± å¤§å°
        local innodb_buffer_pool=$(grep "innodb_buffer_pool_size" "$mysql_config" | awk '{print $3}' || echo "æœªé…ç½®")
        log "InnoDBç¼“å†²æ± å¤§å°: $innodb_buffer_pool"

        # æ£€æŸ¥æŸ¥è¯¢ç¼“å­˜é…ç½®
        local query_cache_size=$(grep "query_cache_size" "$mysql_config" | awk '{print $3}' || echo "æœªé…ç½®")
        log "æŸ¥è¯¢ç¼“å­˜å¤§å°: $query_cache_size"

        # æ£€æŸ¥è¿æ¥æ•°é…ç½®
        local max_connections=$(grep "max_connections" "$mysql_config" | awk '{print $3}' || echo "æœªé…ç½®")
        log "æœ€å¤§è¿æ¥æ•°: $max_connections"
    fi

    log "æ€§èƒ½è°ƒä¼˜æ£€æŸ¥å®Œæˆ"
}

# ä¸»ç»´æŠ¤æµç¨‹
main() {
    if [ -z "$MAINTENANCE_TYPE" ]; then
        echo "ç”¨æ³•: $0 {weekly|monthly|quarterly}"
        exit 1
    fi

    log "å¼€å§‹$MAINTENANCE_TYPEå‘¨æœŸæ€§ç»´æŠ¤..."

    case "$MAINTENANCE_TYPE" in
        "weekly")
            optimize_database
            rebuild_indexes
            update_statistics
            performance_tuning
            ;;
        "monthly")
            optimize_database
            rebuild_indexes
            update_statistics
            performance_tuning
            ;;
        "quarterly")
            optimize_database
            rebuild_indexes
            update_statistics
            performance_tuning
            ;;
        *)
            echo "ä¸æ”¯æŒçš„ç»´æŠ¤ç±»å‹: $MAINTENANCE_TYPE"
            exit 1
            ;;
    esac

    log "$MAINTENANCE_TYPEå‘¨æœŸæ€§ç»´æŠ¤å®Œæˆ"
}

# æ‰§è¡Œç»´æŠ¤
main "$@"
```

**Cron ä»»åŠ¡é…ç½®**ï¼š

```bash
# ç¼–è¾‘crontab
crontab -e

# æ·»åŠ ä»¥ä¸‹å‘¨æœŸæ€§ç»´æŠ¤ä»»åŠ¡

# æ—¥å¸¸ç»´æŠ¤ - æ¯å¤©å‡Œæ™¨3ç‚¹
0 3 * * * /scripts/daily_maintenance.sh >> /var/log/cron_daily.log 2>&1

# å‘¨æœŸæ€§ç»´æŠ¤ - æ¯å‘¨æ—¥å‡Œæ™¨4ç‚¹
0 4 * * 0 /scripts/periodic_maintenance.sh weekly >> /var/log/cron_weekly.log 2>&1

# æœˆåº¦ç»´æŠ¤ - æ¯æœˆ1æ—¥å‡Œæ™¨5ç‚¹
0 5 1 * * /scripts/periodic_maintenance.sh monthly >> /var/log/cron_monthly.log 2>&1

# å­£åº¦ç»´æŠ¤ - æ¯å­£åº¦ç¬¬ä¸€å¤©å‡Œæ™¨6ç‚¹
0 6 1 1,4,7,10 * /scripts/periodic_maintenance.sh quarterly >> /var/log/cron_quarterly.log 2>&1

# å®æ—¶ç›‘æ§ - æ¯åˆ†é’Ÿæ£€æŸ¥å‘Šè­¦
* * * * * /scripts/alert_monitor.sh >> /var/log/cron_alert.log 2>&1

# æ€§èƒ½ç›‘æ§ - æ¯5åˆ†é’Ÿæ£€æŸ¥æ€§èƒ½
*/5 * * * * /scripts/apm_monitor.sh >> /var/log/cron_apm.log 2>&1

# æ•°æ®åº“ç›‘æ§ - æ¯10åˆ†é’Ÿæ£€æŸ¥æ•°æ®åº“
*/10 * * * * /scripts/db_performance_monitor.sh >> /var/log/cron_db.log 2>&1

# ç³»ç»Ÿç›‘æ§ - æ¯15åˆ†é’Ÿæ£€æŸ¥ç³»ç»Ÿèµ„æº
*/15 * * * * /scripts/system_monitor.sh >> /var/log/cron_system.log 2>&1
```

## ç¬¬ 9 ç« ï¼šå›æ»šç­–ç•¥

### 9.1 å›æ»šè§¦å‘æ¡ä»¶

#### 9.1.1 è‡ªåŠ¨æ£€æµ‹è§¦å‘æ¡ä»¶

**å¥åº·æ£€æŸ¥å¤±è´¥**ï¼š

```bash
#!/bin/bash
# å¥åº·æ£€æŸ¥è„šæœ¬ - health_check.sh
set -e

HEALTH_CHECK_LOG="/var/log/health_check.log"
ROLLBACK_TRIGGER_FILE="/tmp/rollback_triggered"
ROLLBACK_REASON_FILE="/tmp/rollback_reason"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$HEALTH_CHECK_LOG"
}

# æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
check_application_health() {
    local app_url="https://api.yourdomain.com/health"
    local timeout=10
    local max_retries=3
    local retry_count=0

    while [ $retry_count -lt $max_retries ]; do
        if curl -f -s --max-time $timeout "$app_url" > /dev/null 2>&1; then
            log "åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
            return 0
        fi

        retry_count=$((retry_count + 1))
        log "åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œé‡è¯• $retry_count/$max_retries"
        sleep 5
    done

    log "åº”ç”¨å¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥"
    return 1
}

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
check_database_health() {
    local db_host="localhost"
    local db_user="health_check"
    local db_pass="health_check_pass"
    local db_name="official_website"

    if mysql -h "$db_host" -u "$db_user" -p"$db_pass" -e "SELECT 1 FROM $db_name LIMIT 1;" > /dev/null 2>&1; then
        log "æ•°æ®åº“å¥åº·æ£€æŸ¥é€šè¿‡"
        return 0
    else
        log "æ•°æ®åº“å¥åº·æ£€æŸ¥å¤±è´¥"
        return 1
    fi
}

# æ£€æŸ¥Redisè¿æ¥
check_redis_health() {
    if redis-cli ping > /dev/null 2>&1; then
        log "Rediså¥åº·æ£€æŸ¥é€šè¿‡"
        return 0
    else
        log "Rediså¥åº·æ£€æŸ¥å¤±è´¥"
        return 1
    fi
}

# æ£€æŸ¥å…³é”®APIç«¯ç‚¹
check_api_endpoints() {
    local endpoints=(
        "https://api.yourdomain.com/api/news"
        "https://api.yourdomain.com/api/articles"
        "https://api.yourdomain.com/api/wechat"
    )

    local failed_count=0

    for endpoint in "${endpoints[@]}"; do
        if ! curl -f -s --max-time 5 "$endpoint" > /dev/null 2>&1; then
            log "APIç«¯ç‚¹æ£€æŸ¥å¤±è´¥: $endpoint"
            failed_count=$((failed_count + 1))
        fi
    done

    if [ "$failed_count" -gt 0 ]; then
        log "APIç«¯ç‚¹æ£€æŸ¥å¤±è´¥: $failed_count ä¸ªç«¯ç‚¹æ— å“åº”"
        return 1
    else
        log "APIç«¯ç‚¹æ£€æŸ¥é€šè¿‡"
        return 0
    fi
}

# æ£€æŸ¥é”™è¯¯ç‡
check_error_rate() {
    local log_file="/var/log/nginx/access.log"
    local recent_minutes=5
    local error_threshold=10  # é”™è¯¯ç‡é˜ˆå€¼ç™¾åˆ†æ¯”

    # ç»Ÿè®¡æœ€è¿‘5åˆ†é’Ÿçš„è¯·æ±‚å’Œé”™è¯¯
    local total_requests=$(tail -1000 "$log_file" | awk -v date="$(date -d '$recent_minutes minutes ago' '+%d/%b/%Y:%H:%M')" '$4 >= date {count++} END {print count+0}')
    local error_requests=$(tail -1000 "$log_file" | awk -v date="$(date -d '$recent_minutes minutes ago' '+%d/%b/%Y:%H:%M')" '$4 >= date && $9 >= 400 {count++} END {print count+0}')

    if [ "$total_requests" -gt 0 ]; then
        local error_rate=$((error_requests * 100 / total_requests))

        if [ "$error_rate" -gt "$error_threshold" ]; then
            log "é”™è¯¯ç‡è¿‡é«˜: $error_rate% (é˜ˆå€¼: $error_threshold%)"
            return 1
        else
            log "é”™è¯¯ç‡æ­£å¸¸: $error_rate%"
            return 0
        fi
    else
        log "æ— æœ€è¿‘è¯·æ±‚æ•°æ®"
        return 0
    fi
}

# æ£€æŸ¥å“åº”æ—¶é—´
check_response_time() {
    local url="https://api.yourdomain.com/health"
    local max_response_time=5000  # æœ€å¤§å“åº”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
    local response_time=$(curl -o /dev/null -s -w '%{time_total}' --max-time 10 "$url" | awk '{printf("%.0f", $1 * 1000)}')

    if [ "$response_time" -gt "$max_response_time" ]; then
        log "å“åº”æ—¶é—´è¿‡é•¿: ${response_time}ms (é˜ˆå€¼: ${max_response_time}ms)"
        return 1
    else
        log "å“åº”æ—¶é—´æ­£å¸¸: ${response_time}ms"
        return 0
    fi
}

# è§¦å‘å›æ»š
trigger_rollback() {
    local reason=$1

    log "è§¦å‘å›æ»š: $reason"

    # åˆ›å»ºå›æ»šè§¦å‘æ–‡ä»¶
    echo "$(date -Iseconds)" > "$ROLLBACK_TRIGGER_FILE"
    echo "$reason" > "$ROLLBACK_REASON_FILE"

    # å‘é€å‘Šè­¦
    send_rollback_alert "$reason"

    # æ‰§è¡Œå›æ»š
    execute_rollback
}

# å‘é€å›æ»šå‘Šè­¦
send_rollback_alert() {
    local reason=$1
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    # å‘é€é‚®ä»¶å‘Šè­¦
    echo "[$timestamp] è‡ªåŠ¨å›æ»šè§¦å‘: $reason" | mail -s "ç´§æ€¥: ç³»ç»Ÿè‡ªåŠ¨å›æ»š" "admin@yourdomain.com"

    # å‘é€Webhookå‘Šè­¦
    if [ -n "$WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš¨ ç´§æ€¥å›æ»š\\næ—¶é—´: $timestamp\\nåŸå› : $reason\\nçŠ¶æ€: å·²è§¦å‘\"}" \
            "$WEBHOOK_URL" 2>/dev/null || true
    fi
}

# ä¸»å¥åº·æ£€æŸ¥æµç¨‹
main() {
    log "å¼€å§‹å¥åº·æ£€æŸ¥..."

    local failed_checks=0
    local reasons=""

    # æ‰§è¡Œå„é¡¹å¥åº·æ£€æŸ¥
    if ! check_application_health; then
        failed_checks=$((failed_checks + 1))
        reasons="$reasons åº”ç”¨æ— å“åº”;"
    fi

    if ! check_database_health; then
        failed_checks=$((failed_checks + 1))
        reasons="$reasons æ•°æ®åº“è¿æ¥å¤±è´¥;"
    fi

    if ! check_redis_health; then
        failed_checks=$((failed_checks + 1))
        reasons="$reasons Redisè¿æ¥å¤±è´¥;"
    fi

    if ! check_api_endpoints; then
        failed_checks=$((failed_checks + 1))
        reasons="$reasons APIç«¯ç‚¹å¤±è´¥;"
    fi

    if ! check_error_rate; then
        failed_checks=$((failed_checks + 1))
        reasons="$reasons é”™è¯¯ç‡è¿‡é«˜;"
    fi

    if ! check_response_time; then
        failed_checks=$((failed_checks + 1))
        reasons="$reasons å“åº”æ—¶é—´è¿‡é•¿;"
    fi

    # å¦‚æœå¤±è´¥æ£€æŸ¥è¶…è¿‡é˜ˆå€¼ï¼Œè§¦å‘å›æ»š
    if [ "$failed_checks" -ge 2 ]; then
        trigger_rollback "å¥åº·æ£€æŸ¥å¤±è´¥: $reasons"
    else
        log "å¥åº·æ£€æŸ¥é€šè¿‡"

        # æ¸…ç†å›æ»šè§¦å‘æ–‡ä»¶
        rm -f "$ROLLBACK_TRIGGER_FILE" "$ROLLBACK_REASON_FILE"
    fi
}

# æ‰§è¡Œå¥åº·æ£€æŸ¥
main "$@"
```

**æ€§èƒ½é˜ˆå€¼ç›‘æ§**ï¼š

```php
<?php
// src/Service/RollbackTriggerService.php
namespace App\Service;

use Symfony\Component\DependencyInjection\ParameterBag\ParameterBagInterface;
use Psr\Log\LoggerInterface;

class RollbackTriggerService
{
    private LoggerInterface $logger;
    private array $thresholds;

    public function __construct(LoggerInterface $logger, ParameterBagInterface $params)
    {
        $this->logger = $logger;
        $this->loadThresholds($params->get('kernel.project_dir') . '/config/rollback/thresholds.yaml');
    }

    private function loadThresholds(string $thresholdsFile): void
    {
        if (file_exists($thresholdsFile)) {
            $this->thresholds = yaml_parse_file($thresholdsFile);
        }
    }

    public function checkPerformanceMetrics(array $metrics): bool
    {
        $shouldRollback = false;
        $reasons = [];

        // æ£€æŸ¥å“åº”æ—¶é—´
        if (isset($metrics['avg_response_time']) &&
            $metrics['avg_response_time'] > $this->thresholds['response_time']['max']) {
            $shouldRollback = true;
            $reasons[] = "å“åº”æ—¶é—´è¿‡é•¿: {$metrics['avg_response_time']}ms";
        }

        // æ£€æŸ¥é”™è¯¯ç‡
        if (isset($metrics['error_rate']) &&
            $metrics['error_rate'] > $this->thresholds['error_rate']['max']) {
            $shouldRollback = true;
            $reasons[] = "é”™è¯¯ç‡è¿‡é«˜: {$metrics['error_rate']}%";
        }

        // æ£€æŸ¥å†…å­˜ä½¿ç”¨ç‡
        if (isset($metrics['memory_usage']) &&
            $metrics['memory_usage'] > $this->thresholds['memory_usage']['max']) {
            $shouldRollback = true;
            $reasons[] = "å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: {$metrics['memory_usage']}%";
        }

        // æ£€æŸ¥æ•°æ®åº“è¿æ¥æ•°
        if (isset($metrics['db_connections']) &&
            $metrics['db_connections'] > $this->thresholds['db_connections']['max']) {
            $shouldRollback = true;
            $reasons[] = "æ•°æ®åº“è¿æ¥æ•°è¿‡å¤š: {$metrics['db_connections']}";
        }

        if ($shouldRollback) {
            $this->triggerRollback(implode(', ', $reasons));
        }

        return $shouldRollback;
    }

    private function triggerRollback(string $reason): void
    {
        $this->logger->critical('è§¦å‘è‡ªåŠ¨å›æ»š', ['reason' => $reason]);

        // åˆ›å»ºå›æ»šè§¦å‘æ–‡ä»¶
        file_put_contents('/tmp/rollback_triggered', date('Y-m-d H:i:s'));
        file_put_contents('/tmp/rollback_reason', $reason);

        // æ‰§è¡Œå›æ»šè„šæœ¬
        exec('/scripts/rollback.sh auto >> /var/log/rollback.log 2>&1 &');
    }
}
```

#### 9.1.2 æ‰‹åŠ¨è§¦å‘æ¡ä»¶

**æ‰‹åŠ¨å›æ»šè„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ‰‹åŠ¨å›æ»šè„šæœ¬ - manual_rollback.sh
set -e

ROLLBACK_LOG="/var/log/manual_rollback.log"
BACKUP_DIR="/backup/deployments"
APP_DIR="/var/www/official_website_backend"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$ROLLBACK_LOG"
}

# æ˜¾ç¤ºå¯ç”¨ç‰ˆæœ¬
show_available_versions() {
    log "å¯ç”¨çš„å›æ»šç‰ˆæœ¬:"

    local versions=($(ls -t "$BACKUP_DIR" | grep -E "backup_[0-9]{8}" | head -10))

    for i in "${!versions[@]}"; do
        local version="${versions[$i]}"
        local date=$(echo "$version" | sed 's/backup_//' | sed 's/\(....\)\(..\)\(..\)/\1-\2-\3/')
        local time=$(stat -c %y "$BACKUP_DIR/$version" | cut -d' ' -f2 | cut -d. -f1)

        echo "  $((i+1)). $version ($date $time)"
    done
}

# é€‰æ‹©å›æ»šç‰ˆæœ¬
select_version() {
    if [ -n "$1" ]; then
        local selected_version="$1"

        if [ -d "$BACKUP_DIR/$selected_version" ]; then
            echo "$selected_version"
            return 0
        else
            log "é”™è¯¯: ç‰ˆæœ¬ $selected_version ä¸å­˜åœ¨"
            return 1
        fi
    else
        show_available_versions

        while true; do
            read -p "è¯·é€‰æ‹©è¦å›æ»šçš„ç‰ˆæœ¬ç¼–å· (1-10): " choice

            if [[ "$choice" =~ ^[1-9]|10$ ]]; then
                local versions=($(ls -t "$BACKUP_DIR" | grep -E "backup_[0-9]{8}" | head -10))
                local selected_index=$((choice - 1))

                if [ $selected_index -lt ${#versions[@]} ]; then
                    echo "${versions[$selected_index]}"
                    return 0
                else
                    log "é”™è¯¯: æ— æ•ˆçš„é€‰æ‹©"
                fi
            else
                log "é”™è¯¯: è¯·è¾“å…¥æœ‰æ•ˆçš„ç¼–å· (1-10)"
            fi
        done
    fi
}

# ç¡®è®¤å›æ»š
confirm_rollback() {
    local version=$1

    echo ""
    echo "è­¦å‘Š: å³å°†å›æ»šåˆ°ç‰ˆæœ¬ $version"
    echo "è¿™å°†:"
    echo "  1. åœæ­¢å½“å‰åº”ç”¨æœåŠ¡"
    echo "  2. æ¢å¤ä»£ç åˆ°ç‰ˆæœ¬ $version"
    echo "  3. æ¢å¤æ•°æ®åº“ï¼ˆå¦‚éœ€è¦ï¼‰"
    echo "  4. é‡å¯åº”ç”¨æœåŠ¡"
    echo ""

    read -p "ç¡®è®¤æ‰§è¡Œå›æ»š? (yes/no): " confirm

    if [ "$confirm" = "yes" ]; then
        return 0
    else
        log "å›æ»šå·²å–æ¶ˆ"
        exit 0
    fi
}

# æ‰§è¡Œå›æ»š
execute_rollback() {
    local version=$1
    local reason=$2

    log "å¼€å§‹æ‰§è¡Œå›æ»šåˆ°ç‰ˆæœ¬ $version"
    log "å›æ»šåŸå› : $reason"

    # åˆ›å»ºå½“å‰ç‰ˆæœ¬å¤‡ä»½
    local current_backup="backup_$(date +%Y%m%d)_$(date +%H%M%S)"
    local current_backup_dir="$BACKUP_DIR/$current_backup"

    log "åˆ›å»ºå½“å‰ç‰ˆæœ¬å¤‡ä»½: $current_backup"
    mkdir -p "$current_backup_dir"

    # å¤‡ä»½å½“å‰ä»£ç 
    cp -r "$APP_DIR" "$current_backup_dir/app"

    # å¤‡ä»½å½“å‰æ•°æ®åº“
    mysqldump -u root -p official_website > "$current_backup_dir/database.sql"

    # å¤‡ä»½é…ç½®æ–‡ä»¶
    cp -r /etc/nginx/sites-available/* "$current_backup_dir/nginx/"
    cp -r "$APP_DIR/.env*" "$current_backup_dir/" 2>/dev/null || true

    log "å½“å‰ç‰ˆæœ¬å¤‡ä»½å®Œæˆ"

    # åœæ­¢åº”ç”¨æœåŠ¡
    log "åœæ­¢åº”ç”¨æœåŠ¡..."
    systemctl stop nginx
    systemctl stop php8.2-fpm

    # æ¢å¤ä»£ç 
    log "æ¢å¤ä»£ç åˆ°ç‰ˆæœ¬ $version..."
    rm -rf "$APP_DIR"/*
    cp -r "$BACKUP_DIR/$version/app/"* "$APP_DIR/"

    # æ¢å¤æƒé™
    chown -R www-data:www-data "$APP_DIR"
    chmod -R 755 "$APP_DIR"

    # æ¢å¤é…ç½®æ–‡ä»¶
    if [ -f "$BACKUP_DIR/$version/.env.local" ]; then
        cp "$BACKUP_DIR/$version/.env.local" "$APP_DIR/"
    fi

    # æ¢å¤Nginxé…ç½®
    if [ -d "$BACKUP_DIR/$version/nginx" ]; then
        cp -r "$BACKUP_DIR/$version/nginx/"* /etc/nginx/sites-available/
        nginx -t
    fi

    # é‡å¯æœåŠ¡
    log "é‡å¯åº”ç”¨æœåŠ¡..."
    systemctl start php8.2-fpm
    systemctl start nginx

    # éªŒè¯å›æ»š
    log "éªŒè¯å›æ»šç»“æœ..."
    sleep 10

    if curl -f -s "https://api.yourdomain.com/health" > /dev/null 2>&1; then
        log "å›æ»šæˆåŠŸ: åº”ç”¨æ­£å¸¸è¿è¡Œ"

        # å‘é€é€šçŸ¥
        send_rollback_notification "$version" "success" "$reason"
    else
        log "å›æ»šå¤±è´¥: åº”ç”¨æ— å“åº”"

        # å‘é€å‘Šè­¦
        send_rollback_notification "$version" "failure" "$reason"

        exit 1
    fi
}

# å‘é€å›æ»šé€šçŸ¥
send_rollback_notification() {
    local version=$1
    local status=$2
    local reason=$3
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    local status_text="æˆåŠŸ"
    local emoji="âœ…"

    if [ "$status" = "failure" ]; then
        status_text="å¤±è´¥"
        emoji="âŒ"
    fi

    # å‘é€é‚®ä»¶é€šçŸ¥
    echo "[$timestamp] æ‰‹åŠ¨å›æ»š$status_text\\nç‰ˆæœ¬: $version\\nåŸå› : $reason" | \
        mail -s "æ‰‹åŠ¨å›æ»š$status_texté€šçŸ¥" "admin@yourdomain.com"

    # å‘é€Webhooké€šçŸ¥
    if [ -n "$WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$emoji æ‰‹åŠ¨å›æ»š$status_text\\næ—¶é—´: $timestamp\\nç‰ˆæœ¬: $version\\nåŸå› : $reason\"}" \
            "$WEBHOOK_URL" 2>/dev/null || true
    fi
}

# ä¸»æµç¨‹
main() {
    local reason="æ‰‹åŠ¨è§¦å‘"
    local version=""

    # è§£æå‚æ•°
    while [[ $# -gt 0 ]]; do
        case $1 in
            --version)
                version="$2"
                shift 2
                ;;
            --reason)
                reason="$2"
                shift 2
                ;;
            --help)
                echo "ç”¨æ³•: $0 [--version VERSION] [--reason REASON]"
                echo "  --version  æŒ‡å®šå›æ»šç‰ˆæœ¬"
                echo "  --reason   å›æ»šåŸå› "
                echo ""
                echo "ç¤ºä¾‹:"
                echo "  $0 --version backup_20231201 --reason 'ä¿®å¤ä¸¥é‡bug'"
                echo "  $0 --reason 'æ€§èƒ½é—®é¢˜å›æ»š'"
                exit 0
                ;;
            *)
                log "æœªçŸ¥å‚æ•°: $1"
                exit 1
                ;;
        esac
    done

    log "å¼€å§‹æ‰‹åŠ¨å›æ»šæµç¨‹"

    # é€‰æ‹©ç‰ˆæœ¬
    local selected_version
    selected_version=$(select_version "$version")

    # ç¡®è®¤å›æ»š
    confirm_rollback "$selected_version"

    # æ‰§è¡Œå›æ»š
    execute_rollback "$selected_version" "$reason"

    log "æ‰‹åŠ¨å›æ»šæµç¨‹å®Œæˆ"
}

# æ‰§è¡Œå›æ»š
main "$@"
```

### 9.2 å›æ»šæµç¨‹

#### 9.2.1 ä»£ç å›æ»š

**è‡ªåŠ¨åŒ–å›æ»šè„šæœ¬**ï¼š

```bash
#!/bin/bash
# è‡ªåŠ¨åŒ–å›æ»šè„šæœ¬ - rollback.sh
set -e

ROLLBACK_TYPE=$1  # auto, manual
ROLLBACK_REASON=$2  # å›æ»šåŸå› 
ROLLBACK_LOG="/var/log/rollback_$(date +%Y%m%d_%H%M%S).log"
BACKUP_DIR="/backup/deployments"
APP_DIR="/var/www/official_website_backend"
TEMP_DIR="/tmp/rollback_$$"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$ROLLBACK_LOG"
}

# é”™è¯¯å¤„ç†å‡½æ•°
error_exit() {
    log "é”™è¯¯: $1"

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    rm -rf "$TEMP_DIR"

    # å‘é€é”™è¯¯å‘Šè­¦
    send_error_alert "$1"

    exit 1
}

# å‘é€é”™è¯¯å‘Šè­¦
send_error_alert() {
    local error_message=$1
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    # å‘é€é‚®ä»¶å‘Šè­¦
    echo "[$timestamp] å›æ»šé”™è¯¯: $error_message" | \
        mail -s "ç´§æ€¥: å›æ»šè¿‡ç¨‹å‡ºé”™" "admin@yourdomain.com"

    # å‘é€Webhookå‘Šè­¦
    if [ -n "$WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš¨ å›æ»šé”™è¯¯\\næ—¶é—´: $timestamp\\né”™è¯¯: $error_message\\nçŠ¶æ€: éœ€è¦äººå·¥å¹²é¢„\"}" \
            "$WEBHOOK_URL" 2>/dev/null || true
    fi
}

# éªŒè¯å›æ»šå‰ç½®æ¡ä»¶
verify_prerequisites() {
    log "éªŒè¯å›æ»šå‰ç½®æ¡ä»¶..."

    # æ£€æŸ¥å¤‡ä»½ç›®å½•
    if [ ! -d "$BACKUP_DIR" ]; then
        error_exit "å¤‡ä»½ç›®å½•ä¸å­˜åœ¨: $BACKUP_DIR"
    fi

    # æ£€æŸ¥åº”ç”¨ç›®å½•
    if [ ! -d "$APP_DIR" ]; then
        error_exit "åº”ç”¨ç›®å½•ä¸å­˜åœ¨: $APP_DIR"
    fi

    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    local available_space=$(df "$APP_DIR" | tail -1 | awk '{print $4}')
    local required_space=1048576  # 1GB in KB

    if [ "$available_space" -lt "$required_space" ]; then
        error_exit "ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œéœ€è¦è‡³å°‘1GBå¯ç”¨ç©ºé—´"
    fi

    # æ£€æŸ¥æ•°æ®åº“è¿æ¥
    if ! mysql -u root -p -e "SELECT 1;" > /dev/null 2>&1; then
        error_exit "æ— æ³•è¿æ¥åˆ°æ•°æ®åº“"
    fi

    log "å‰ç½®æ¡ä»¶éªŒè¯é€šè¿‡"
}

# è·å–æœ€æ–°ç¨³å®šç‰ˆæœ¬
get_latest_stable_version() {
    local latest_version=$(ls -t "$BACKUP_DIR" | grep -E "backup_[0-9]{8}" | head -1)

    if [ -z "$latest_version" ]; then
        error_exit "æœªæ‰¾åˆ°å¯ç”¨çš„å›æ»šç‰ˆæœ¬"
    fi

    echo "$latest_version"
}

# éªŒè¯ç‰ˆæœ¬å®Œæ•´æ€§
verify_version_integrity() {
    local version=$1

    log "éªŒè¯ç‰ˆæœ¬ $version çš„å®Œæ•´æ€§..."

    local version_dir="$BACKUP_DIR/$version"

    # æ£€æŸ¥ç‰ˆæœ¬ç›®å½•
    if [ ! -d "$version_dir" ]; then
        error_exit "ç‰ˆæœ¬ç›®å½•ä¸å­˜åœ¨: $version_dir"
    fi

    # æ£€æŸ¥åº”ç”¨å¤‡ä»½
    if [ ! -d "$version_dir/app" ]; then
        error_exit "åº”ç”¨å¤‡ä»½ä¸å­˜åœ¨: $version_dir/app"
    fi

    # æ£€æŸ¥æ•°æ®åº“å¤‡ä»½
    if [ ! -f "$version_dir/database.sql" ]; then
        error_exit "æ•°æ®åº“å¤‡ä»½ä¸å­˜åœ¨: $version_dir/database.sql"
    fi

    # æ£€æŸ¥å…³é”®æ–‡ä»¶
    local critical_files=(
        "app/composer.json"
        "app/symfony.lock"
        "app/public/index.php"
        "app/config/services.yaml"
    )

    for file in "${critical_files[@]}"; do
        if [ ! -f "$version_dir/$file" ]; then
            error_exit "å…³é”®æ–‡ä»¶ç¼ºå¤±: $version_dir/$file"
        fi
    done

    # éªŒè¯æ•°æ®åº“å¤‡ä»½å®Œæ•´æ€§
    if ! gzip -t "$version_dir/database.sql.gz" 2>/dev/null && \
       ! mysql --help > /dev/null 2>&1 < "$version_dir/database.sql"; then
        error_exit "æ•°æ®åº“å¤‡ä»½æŸå: $version_dir/database.sql"
    fi

    log "ç‰ˆæœ¬å®Œæ•´æ€§éªŒè¯é€šè¿‡"
}

# åˆ›å»ºå½“å‰ç‰ˆæœ¬å¿«ç…§
create_current_snapshot() {
    local snapshot_name="snapshot_$(date +%Y%m%d_%H%M%S)"
    local snapshot_dir="$BACKUP_DIR/$snapshot_name"

    log "åˆ›å»ºå½“å‰ç‰ˆæœ¬å¿«ç…§: $snapshot_name"

    mkdir -p "$snapshot_dir"

    # å¤‡ä»½åº”ç”¨ä»£ç 
    log "å¤‡ä»½åº”ç”¨ä»£ç ..."
    cp -r "$APP_DIR" "$snapshot_dir/app"

    # å¤‡ä»½æ•°æ®åº“
    log "å¤‡ä»½æ•°æ®åº“..."
    mysqldump -u root -p --single-transaction --routines --triggers \
        official_website | gzip > "$snapshot_dir/database.sql.gz"

    # å¤‡ä»½é…ç½®æ–‡ä»¶
    log "å¤‡ä»½é…ç½®æ–‡ä»¶..."
    mkdir -p "$snapshot_dir/config"

    # å¤‡ä»½ç¯å¢ƒé…ç½®
    cp "$APP_DIR/.env.local" "$snapshot_dir/config/" 2>/dev/null || true
    cp "$APP_DIR/.env.prod" "$snapshot_dir/config/" 2>/dev/null || true

    # å¤‡ä»½Nginxé…ç½®
    mkdir -p "$snapshot_dir/nginx"
    cp /etc/nginx/sites-available/* "$snapshot_dir/nginx/"

    # å¤‡ä»½PHP-FPMé…ç½®
    mkdir -p "$snapshot_dir/php"
    cp /etc/php/8.2/fpm/pool.d/www.conf "$snapshot_dir/php/"

    # åˆ›å»ºå…ƒæ•°æ®
    cat > "$snapshot_dir/metadata.json" << EOF
{
    "snapshot_name": "$snapshot_name",
    "created_at": "$(date -Iseconds)",
    "rollback_type": "$ROLLBACK_TYPE",
    "rollback_reason": "$ROLLBACK_REASON",
    "git_commit": "$(cd $APP_DIR && git rev-parse HEAD 2>/dev/null || echo 'unknown')",
    "git_branch": "$(cd $APP_DIR && git branch --show-current 2>/dev/null || echo 'unknown')",
    "php_version": "$(php -v | head -1)",
    "mysql_version": "$(mysql --version)",
    "nginx_version": "$(nginx -v 2>&1)"
}
EOF

    log "å½“å‰ç‰ˆæœ¬å¿«ç…§åˆ›å»ºå®Œæˆ: $snapshot_dir"
}

# åœæ­¢åº”ç”¨æœåŠ¡
stop_services() {
    log "åœæ­¢åº”ç”¨æœåŠ¡..."

    # åœæ­¢Nginx
    if systemctl is-active nginx > /dev/null 2>&1; then
        systemctl stop nginx
        log "Nginxå·²åœæ­¢"
    fi

    # åœæ­¢PHP-FPM
    if systemctl is-active php8.2-fpm > /dev/null 2>&1; then
        systemctl stop php8.2-fpm
        log "PHP-FPMå·²åœæ­¢"
    fi

    # åœæ­¢Redisï¼ˆå¯é€‰ï¼‰
    if systemctl is-active redis > /dev/null 2>&1; then
        # Redisé€šå¸¸ä¸éœ€è¦åœæ­¢ï¼Œé™¤éæ˜¯Redisç›¸å…³çš„é—®é¢˜
        log "Redisä¿æŒè¿è¡Œ"
    fi

    log "åº”ç”¨æœåŠ¡åœæ­¢å®Œæˆ"
}

# æ¢å¤åº”ç”¨ä»£ç 
restore_application_code() {
    local version=$1

    log "æ¢å¤åº”ç”¨ä»£ç åˆ°ç‰ˆæœ¬ $version..."

    local source_dir="$BACKUP_DIR/$version/app"
    local temp_app_dir="$TEMP_DIR/app"

    # åˆ›å»ºä¸´æ—¶ç›®å½•
    mkdir -p "$temp_app_dir"

    # å¤åˆ¶ä»£ç åˆ°ä¸´æ—¶ç›®å½•
    cp -r "$source_dir"/* "$temp_app_dir/"

    # æ¸…ç†å½“å‰åº”ç”¨ç›®å½•ï¼ˆä¿ç•™å¿…è¦çš„é…ç½®æ–‡ä»¶ï¼‰
    local backup_configs="$TEMP_DIR/configs"
    mkdir -p "$backup_configs"

    # å¤‡ä»½å½“å‰é…ç½®æ–‡ä»¶
    [ -f "$APP_DIR/.env.local" ] && cp "$APP_DIR/.env.local" "$backup_configs/"
    [ -f "$APP_DIR/.env.prod" ] && cp "$APP_DIR/.env.prod" "$backup_configs/"

    # æ¸…ç†åº”ç”¨ç›®å½•
    rm -rf "$APP_DIR"/*

    # æ¢å¤ä»£ç 
    cp -r "$temp_app_dir"/* "$APP_DIR/"

    # æ¢å¤é…ç½®æ–‡ä»¶
    [ -f "$backup_configs/.env.local" ] && cp "$backup_configs/.env.local" "$APP_DIR/"
    [ -f "$backup_configs/.env.prod" ] && cp "$backup_configs/.env.prod" "$APP_DIR/"

    # è®¾ç½®æƒé™
    chown -R www-data:www-data "$APP_DIR"
    find "$APP_DIR" -type d -exec chmod 755 {} \;
    find "$APP_DIR" -type f -exec chmod 644 {} \;

    # è®¾ç½®å¯æ‰§è¡Œæƒé™
    chmod +x "$APP_DIR/bin/console"
    chmod +x "$APP_DIR/public/index.php"

    # æ¸…ç†ç¼“å­˜
    rm -rf "$APP_DIR/var/cache/*"

    log "åº”ç”¨ä»£ç æ¢å¤å®Œæˆ"
}

# æ¢å¤æ•°æ®åº“
restore_database() {
    local version=$1
    local restore_db=${2:-true}

    if [ "$restore_db" != "true" ]; then
        log "è·³è¿‡æ•°æ®åº“æ¢å¤"
        return 0
    fi

    log "æ¢å¤æ•°æ®åº“åˆ°ç‰ˆæœ¬ $version..."

    local db_backup="$BACKUP_DIR/$version/database.sql"
    local temp_db_backup="$TEMP_DIR/database.sql"

    # å¤åˆ¶å¤‡ä»½æ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
    if [ -f "$db_backup.gz" ]; then
        gunzip -c "$db_backup.gz" > "$temp_db_backup"
    elif [ -f "$db_backup" ]; then
        cp "$db_backup" "$temp_db_backup"
    else
        error_exit "æ•°æ®åº“å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: $db_backup"
    fi

    # éªŒè¯å¤‡ä»½æ–‡ä»¶
    if ! mysql --help > /dev/null 2>&1 < "$temp_db_backup"; then
        error_exit "æ•°æ®åº“å¤‡ä»½æ–‡ä»¶æŸå"
    fi

    # åˆ›å»ºæ•°æ®åº“å¤‡ä»½ï¼ˆä»¥é˜²æ¢å¤å¤±è´¥ï¼‰
    local pre_restore_backup="pre_restore_$(date +%Y%m%d_%H%M%S).sql"
    mysqldump -u root -p official_website > "/tmp/$pre_restore_backup"

    log "æ•°æ®åº“é¢„æ¢å¤å¤‡ä»½åˆ›å»ºå®Œæˆ: $pre_restore_backup"

    # æ¢å¤æ•°æ®åº“
    log "å¼€å§‹æ¢å¤æ•°æ®åº“..."

    if mysql -u root -p official_website < "$temp_db_backup"; then
        log "æ•°æ®åº“æ¢å¤å®Œæˆ"

        # åˆ é™¤é¢„æ¢å¤å¤‡ä»½
        rm -f "/tmp/$pre_restore_backup"
    else
        log "æ•°æ®åº“æ¢å¤å¤±è´¥ï¼Œå°è¯•æ¢å¤é¢„å¤‡ä»½"

        # å°è¯•æ¢å¤é¢„å¤‡ä»½
        mysql -u root -p official_website < "/tmp/$pre_restore_backup" || true

        error_exit "æ•°æ®åº“æ¢å¤å¤±è´¥"
    fi
}

# æ¢å¤é…ç½®æ–‡ä»¶
restore_configurations() {
    local version=$1

    log "æ¢å¤é…ç½®æ–‡ä»¶åˆ°ç‰ˆæœ¬ $version..."

    local config_dir="$BACKUP_DIR/$version"

    # æ¢å¤Nginxé…ç½®
    if [ -d "$config_dir/nginx" ]; then
        log "æ¢å¤Nginxé…ç½®..."

        # å¤‡ä»½å½“å‰Nginxé…ç½®
        mkdir -p "$TEMP_DIR/nginx_backup"
        cp /etc/nginx/sites-available/* "$TEMP_DIR/nginx_backup/" 2>/dev/null || true

        # æ¢å¤é…ç½®
        cp "$config_dir/nginx/"* /etc/nginx/sites-available/

        # æµ‹è¯•Nginxé…ç½®
        if nginx -t; then
            log "Nginxé…ç½®æµ‹è¯•é€šè¿‡"
        else
            log "Nginxé…ç½®æµ‹è¯•å¤±è´¥ï¼Œæ¢å¤åŸé…ç½®"
            cp "$TEMP_DIR/nginx_backup/"* /etc/nginx/sites-available/
            error_exit "Nginxé…ç½®æ¢å¤å¤±è´¥"
        fi
    fi

    # æ¢å¤PHP-FPMé…ç½®
    if [ -f "$config_dir/php/www.conf" ]; then
        log "æ¢å¤PHP-FPMé…ç½®..."

        # å¤‡ä»½å½“å‰é…ç½®
        cp /etc/php/8.2/fpm/pool.d/www.conf "$TEMP_DIR/www.conf.backup"

        # æ¢å¤é…ç½®
        cp "$config_dir/php/www.conf" /etc/php/8.2/fpm/pool.d/

        # æµ‹è¯•PHP-FPMé…ç½®
        if php-fpm8.2 -t; then
            log "PHP-FPMé…ç½®æµ‹è¯•é€šè¿‡"
        else
            log "PHP-FPMé…ç½®æµ‹è¯•å¤±è´¥ï¼Œæ¢å¤åŸé…ç½®"
            cp "$TEMP_DIR/www.conf.backup" /etc/php/8.2/fpm/pool.d/
            error_exit "PHP-FPMé…ç½®æ¢å¤å¤±è´¥"
        fi
    fi

    log "é…ç½®æ–‡ä»¶æ¢å¤å®Œæˆ"
}

# å¯åŠ¨åº”ç”¨æœåŠ¡
start_services() {
    log "å¯åŠ¨åº”ç”¨æœåŠ¡..."

    # å¯åŠ¨PHP-FPM
    systemctl start php8.2-fpm
    if systemctl is-active php8.2-fpm > /dev/null 2>&1; then
        log "PHP-FPMå¯åŠ¨æˆåŠŸ"
    else
        error_exit "PHP-FPMå¯åŠ¨å¤±è´¥"
    fi

    # å¯åŠ¨Nginx
    systemctl start nginx
    if systemctl is-active nginx > /dev/null 2>&1; then
        log "Nginxå¯åŠ¨æˆåŠŸ"
    else
        error_exit "Nginxå¯åŠ¨å¤±è´¥"
    fi

    # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨
    sleep 10

    log "åº”ç”¨æœåŠ¡å¯åŠ¨å®Œæˆ"
}

# éªŒè¯å›æ»šç»“æœ
verify_rollback() {
    local version=$1

    log "éªŒè¯å›æ»šç»“æœ..."

    local verification_failed=false
    local verification_errors=()

    # æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
    log "æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€..."
    if curl -f -s --max-time 10 "https://api.yourdomain.com/health" > /dev/null 2>&1; then
        log "åº”ç”¨å¥åº·æ£€æŸ¥é€šè¿‡"
    else
        verification_failed=true
        verification_errors+=("åº”ç”¨å¥åº·æ£€æŸ¥å¤±è´¥")
    fi

    # æ£€æŸ¥å…³é”®APIç«¯ç‚¹
    log "æ£€æŸ¥å…³é”®APIç«¯ç‚¹..."
    local endpoints=(
        "https://api.yourdomain.com/api/news"
        "https://api.yourdomain.com/api/articles"
    )

    for endpoint in "${endpoints[@]}"; do
        if curl -f -s --max-time 5 "$endpoint" > /dev/null 2>&1; then
            log "APIç«¯ç‚¹æ£€æŸ¥é€šè¿‡: $endpoint"
        else
            verification_failed=true
            verification_errors+=("APIç«¯ç‚¹æ£€æŸ¥å¤±è´¥: $endpoint")
        fi
    done

    # æ£€æŸ¥æ•°æ®åº“è¿æ¥
    log "æ£€æŸ¥æ•°æ®åº“è¿æ¥..."
    if mysql -u root -p -e "SELECT 1 FROM official_website LIMIT 1;" > /dev/null 2>&1; then
        log "æ•°æ®åº“è¿æ¥æ£€æŸ¥é€šè¿‡"
    else
        verification_failed=true
        verification_errors+=("æ•°æ®åº“è¿æ¥å¤±è´¥")
    fi

    # æ£€æŸ¥Redisè¿æ¥
    log "æ£€æŸ¥Redisè¿æ¥..."
    if redis-cli ping > /dev/null 2>&1; then
        log "Redisè¿æ¥æ£€æŸ¥é€šè¿‡"
    else
        verification_failed=true
        verification_errors+=("Redisè¿æ¥å¤±è´¥")
    fi

    # éªŒè¯ç»“æœ
    if [ "$verification_failed" = true ]; then
        log "å›æ»šéªŒè¯å¤±è´¥:"
        for error in "${verification_errors[@]}"; do
            log "  - $error"
        done

        send_rollback_notification "$version" "failure" "éªŒè¯å¤±è´¥: ${verification_errors[*]}"

        error_exit "å›æ»šéªŒè¯å¤±è´¥"
    else
        log "å›æ»šéªŒè¯æˆåŠŸ"

        send_rollback_notification "$version" "success" "å›æ»šæˆåŠŸ"
    fi
}

# å‘é€å›æ»šé€šçŸ¥
send_rollback_notification() {
    local version=$1
    local status=$2
    local details=$3
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    local status_text="æˆåŠŸ"
    local emoji="âœ…"

    if [ "$status" = "failure" ]; then
        status_text="å¤±è´¥"
        emoji="âŒ"
    fi

    # å‘é€é‚®ä»¶é€šçŸ¥
    {
        echo "å›æ»š$status_texté€šçŸ¥"
        echo ""
        echo "æ—¶é—´: $timestamp"
        echo "ç±»å‹: $ROLLBACK_TYPE"
        echo "ç‰ˆæœ¬: $version"
        echo "åŸå› : $ROLLBACK_REASON"
        echo "è¯¦æƒ…: $details"
        echo ""
        echo "æ—¥å¿—æ–‡ä»¶: $ROLLBACK_LOG"
    } | mail -s "å›æ»š$status_text: $version" "admin@yourdomain.com"

    # å‘é€Webhooké€šçŸ¥
    if [ -n "$WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"$emoji å›æ»š$status_text\\næ—¶é—´: $timestamp\\nç±»å‹: $ROLLBACK_TYPE\\nç‰ˆæœ¬: $version\\nåŸå› : $ROLLBACK_REASON\\nè¯¦æƒ…: $details\"}" \
            "$WEBHOOK_URL" 2>/dev/null || true
    fi
}

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
cleanup() {
    log "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
    rm -rf "$TEMP_DIR"
    log "ä¸´æ—¶æ–‡ä»¶æ¸…ç†å®Œæˆ"
}

# ä¸»å›æ»šæµç¨‹
main() {
    local version=""
    local restore_db="true"

    # è§£æå‚æ•°
    while [[ $# -gt 0 ]]; do
        case $1 in
            --version)
                version="$2"
                shift 2
                ;;
            --no-restore-db)
                restore_db="false"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    log "å¼€å§‹å›æ»šæµç¨‹"
    log "å›æ»šç±»å‹: $ROLLBACK_TYPE"
    log "å›æ»šåŸå› : $ROLLBACK_REASON"

    # åˆ›å»ºä¸´æ—¶ç›®å½•
    mkdir -p "$TEMP_DIR"

    # éªŒè¯å‰ç½®æ¡ä»¶
    verify_prerequisites

    # è·å–ç‰ˆæœ¬
    if [ -z "$version" ]; then
        version=$(get_latest_stable_version)
    fi

    log "é€‰æ‹©å›æ»šç‰ˆæœ¬: $version"

    # éªŒè¯ç‰ˆæœ¬å®Œæ•´æ€§
    verify_version_integrity "$version"

    # åˆ›å»ºå½“å‰ç‰ˆæœ¬å¿«ç…§
    create_current_snapshot

    # åœæ­¢æœåŠ¡
    stop_services

    # æ¢å¤åº”ç”¨ä»£ç 
    restore_application_code "$version"

    # æ¢å¤æ•°æ®åº“
    restore_database "$version" "$restore_db"

    # æ¢å¤é…ç½®æ–‡ä»¶
    restore_configurations "$version"

    # å¯åŠ¨æœåŠ¡
    start_services

    # éªŒè¯å›æ»šç»“æœ
    verify_rollback "$version"

    # æ¸…ç†
    cleanup

    log "å›æ»šæµç¨‹å®Œæˆ"
}

# é”™è¯¯å¤„ç†
trap 'error_exit "å›æ»šè¿‡ç¨‹è¢«ä¸­æ–­"' INT TERM

# æ‰§è¡Œå›æ»š
main "$@"
```

#### 9.2.2 æ•°æ®åº“å›æ»š

**æ•°æ®åº“ä¸“ç”¨å›æ»šè„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ•°æ®åº“å›æ»šè„šæœ¬ - db_rollback.sh
set -e

DB_ROLLBACK_LOG="/var/log/db_rollback_$(date +%Y%m%d_%H%M%S).log"
BACKUP_DIR="/backup/database"
TEMP_DIR="/tmp/db_rollback_$$"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$DB_ROLLBACK_LOG"
}

# åˆ›å»ºæ•°æ®åº“å¤‡ä»½
create_database_backup() {
    local backup_name="db_backup_$(date +%Y%m%d_%H%M%S).sql.gz"
    local backup_file="$BACKUP_DIR/$backup_name"

    log "åˆ›å»ºæ•°æ®åº“å¤‡ä»½: $backup_file"

    mkdir -p "$BACKUP_DIR"

    # åˆ›å»ºå®Œæ•´å¤‡ä»½
    mysqldump -u root -p --single-transaction --routines --triggers --events \
        --all-databases | gzip > "$backup_file"

    if [ $? -eq 0 ]; then
        log "æ•°æ®åº“å¤‡ä»½åˆ›å»ºæˆåŠŸ: $backup_file"
        echo "$backup_file"
    else
        error_exit "æ•°æ®åº“å¤‡ä»½åˆ›å»ºå¤±è´¥"
    fi
}

# æ¢å¤æ•°æ®åº“
restore_database() {
    local backup_file=$1
    local target_db=${2:-official_website}

    log "æ¢å¤æ•°æ®åº“: $backup_file -> $target_db"

    local temp_sql="$TEMP_DIR/restore.sql"

    # è§£å‹å¤‡ä»½æ–‡ä»¶
    if [[ "$backup_file" == *.gz ]]; then
        gunzip -c "$backup_file" > "$temp_sql"
    else
        cp "$backup_file" "$temp_sql"
    fi

    # éªŒè¯SQLæ–‡ä»¶
    if ! mysql --help > /dev/null 2>&1 < "$temp_sql"; then
        error_exit "æ•°æ®åº“å¤‡ä»½æ–‡ä»¶æŸå"
    fi

    # åˆ›å»ºé¢„æ¢å¤å¤‡ä»½
    local pre_restore_backup="pre_restore_$(date +%Y%m%d_%H%M%S).sql.gz"
    mysqldump -u root -p "$target_db" | gzip > "$BACKUP_DIR/$pre_restore_backup"
    log "é¢„æ¢å¤å¤‡ä»½åˆ›å»º: $pre_restore_backup"

    # æ¢å¤æ•°æ®åº“
    if mysql -u root -p "$target_db" < "$temp_sql"; then
        log "æ•°æ®åº“æ¢å¤æˆåŠŸ"

        # åˆ é™¤ä¸´æ—¶æ–‡ä»¶
        rm -f "$temp_sql"
    else
        log "æ•°æ®åº“æ¢å¤å¤±è´¥ï¼Œå°è¯•æ¢å¤é¢„å¤‡ä»½"

        # æ¢å¤é¢„å¤‡ä»½
        gunzip -c "$BACKUP_DIR/$pre_restore_backup" | mysql -u root -p "$target_db"

        error_exit "æ•°æ®åº“æ¢å¤å¤±è´¥"
    fi
}

# ä¸»æµç¨‹
main() {
    local backup_file=$1

    if [ -z "$backup_file" ]; then
        log "ç”¨æ³•: $0 <backup_file>"
        exit 1
    fi

    mkdir -p "$TEMP_DIR"

    # åˆ›å»ºå½“å‰å¤‡ä»½
    create_database_backup

    # æ¢å¤æŒ‡å®šå¤‡ä»½
    restore_database "$backup_file"

    # æ¸…ç†
    rm -rf "$TEMP_DIR"

    log "æ•°æ®åº“å›æ»šå®Œæˆ"
}

main "$@"
```

### 9.3 éªŒè¯æ£€æŸ¥

#### 9.3.1 åŠŸèƒ½éªŒè¯

**åŠŸèƒ½éªŒè¯è„šæœ¬**ï¼š

```bash
#!/bin/bash
# åŠŸèƒ½éªŒè¯è„šæœ¬ - functional_verification.sh
set -e

VERIFICATION_LOG="/var/log/functional_verification_$(date +%Y%m%d_%H%M%S).log"
API_BASE_URL="https://api.yourdomain.com"
FAILED_TESTS=0
TOTAL_TESTS=0

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$VERIFICATION_LOG"
}

# æµ‹è¯•å‡½æ•°
test_endpoint() {
    local endpoint=$1
    local method=${2:-GET}
    local data=${3:-""}
    local expected_status=${4:-200}
    local test_name=$5

    TOTAL_TESTS=$((TOTAL_TESTS + 1))

    log "æµ‹è¯•: $test_name"
    log "  ç«¯ç‚¹: $method $endpoint"
    log "  æœŸæœ›çŠ¶æ€: $expected_status"

    local response_status=$(curl -s -o /dev/null -w "%{http_code}" \
        -X "$method" \
        -H "Content-Type: application/json" \
        ${data:+-d "$data"} \
        "$API_BASE_URL$endpoint")

    if [ "$response_status" = "$expected_status" ]; then
        log "  ç»“æœ: âœ… é€šè¿‡ ($response_status)"
        return 0
    else
        log "  ç»“æœ: âŒ å¤±è´¥ ($response_status)"
        FAILED_TESTS=$((FAILED_TESTS + 1))
        return 1
    fi
}

# æ•°æ®åº“è¿æ¥æµ‹è¯•
test_database_connection() {
    log "æµ‹è¯•æ•°æ®åº“è¿æ¥..."

    if mysql -u root -p -e "SELECT 1 FROM official_website.users LIMIT 1;" > /dev/null 2>&1; then
        log "  ç»“æœ: âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
        return 0
    else
        log "  ç»“æœ: âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
        FAILED_TESTS=$((FAILED_TESTS + 1))
        return 1
    fi
}

# Redisè¿æ¥æµ‹è¯•
test_redis_connection() {
    log "æµ‹è¯•Redisè¿æ¥..."

    if redis-cli ping > /dev/null 2>&1; then
        log "  ç»“æœ: âœ… Redisè¿æ¥æ­£å¸¸"
        return 0
    else
        log "  ç»“æœ: âŒ Redisè¿æ¥å¤±è´¥"
        FAILED_TESTS=$((FAILED_TESTS + 1))
        return 1
    fi
}

# JWTè®¤è¯æµ‹è¯•
test_jwt_authentication() {
    log "æµ‹è¯•JWTè®¤è¯..."

    # è·å–JWTä»¤ç‰Œ
    local token=$(curl -s -X POST \
        -H "Content-Type: application/json" \
        -d '{"email":"admin@test.com","password":"test123"}' \
        "$API_BASE_URL/api/login" | jq -r '.token // empty')

    if [ -n "$token" ] && [ "$token" != "null" ]; then
        log "  ç»“æœ: âœ… JWTè®¤è¯æ­£å¸¸"
        echo "$token" > /tmp/test_jwt_token
        return 0
    else
        log "  ç»“æœ: âŒ JWTè®¤è¯å¤±è´¥"
        FAILED_TESTS=$((FAILED_TESTS + 1))
        return 1
    fi
}

# æ–°é—»APIæµ‹è¯•
test_news_api() {
    local token=$(cat /tmp/test_jwt_token 2>/dev/null)

    # æµ‹è¯•è·å–æ–°é—»åˆ—è¡¨
    test_endpoint "/api/news" "GET" "" "200" "è·å–æ–°é—»åˆ—è¡¨"

    # æµ‹è¯•åˆ›å»ºæ–°é—»ï¼ˆéœ€è¦è®¤è¯ï¼‰
    if [ -n "$token" ]; then
        test_endpoint "/api/news" "POST" \
            '{"title":"æµ‹è¯•æ–°é—»","content":"æµ‹è¯•å†…å®¹","category_id":1}' \
            "201" "åˆ›å»ºæ–°é—»"
    fi
}

# æ–‡ç« APIæµ‹è¯•
test_articles_api() {
    local token=$(cat /tmp/test_jwt_token 2>/dev/null)

    # æµ‹è¯•è·å–æ–‡ç« åˆ—è¡¨
    test_endpoint "/api/articles" "GET" "" "200" "è·å–æ–‡ç« åˆ—è¡¨"

    # æµ‹è¯•è®°å½•é˜…è¯»ï¼ˆéœ€è¦è®¤è¯ï¼‰
    if [ -n "$token" ]; then
        test_endpoint "/api/articles/read" "POST" \
            '{"article_id":1,"user_id":1}' \
            "200" "è®°å½•æ–‡ç« é˜…è¯»"
    fi
}

# å¾®ä¿¡APIæµ‹è¯•
test_wechat_api() {
    local token=$(cat /tmp/test_jwt_token 2>/dev/null)

    # æµ‹è¯•è·å–å…¬ä¼—å·åˆ—è¡¨
    test_endpoint "/api/wechat/accounts" "GET" "" "200" "è·å–å…¬ä¼—å·åˆ—è¡¨"

    # æµ‹è¯•åŒæ­¥æ–‡ç« ï¼ˆéœ€è¦è®¤è¯ï¼‰
    if [ -n "$token" ]; then
        test_endpoint "/api/wechat/sync" "POST" \
            '{"account_id":1}' \
            "200" "åŒæ­¥å¾®ä¿¡æ–‡ç« "
    fi
}

# æ€§èƒ½æµ‹è¯•
test_performance() {
    log "æµ‹è¯•APIæ€§èƒ½..."

    local endpoint="/api/news"
    local max_response_time=2000  # 2ç§’
    local response_time=$(curl -o /dev/null -s -w '%{time_total}' \
        --max-time 10 "$API_BASE_URL$endpoint")

    local response_time_ms=$(echo "$response_time" | awk '{printf("%.0f", $1 * 1000)}')

    if [ "$response_time_ms" -le "$max_response_time" ]; then
        log "  ç»“æœ: âœ… æ€§èƒ½æµ‹è¯•é€šè¿‡ (${response_time_ms}ms)"
        return 0
    else
        log "  ç»“æœ: âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥ (${response_time_ms}ms > ${max_response_time}ms)"
        FAILED_TESTS=$((FAILED_TESTS + 1))
        return 1
    fi
}

# å®‰å…¨æµ‹è¯•
test_security() {
    log "æµ‹è¯•å®‰å…¨é…ç½®..."

    # æµ‹è¯•HTTPSé‡å®šå‘
    local http_status=$(curl -s -o /dev/null -w "%{http_code}" \
        "http://api.yourdomain.com/health")

    if [ "$http_status" = "301" ] || [ "$http_status" = "302" ]; then
        log "  ç»“æœ: âœ… HTTPSé‡å®šå‘æ­£å¸¸"
    else
        log "  ç»“æœ: âŒ HTTPSé‡å®šå‘å¤±è´¥ ($http_status)"
        FAILED_TESTS=$((FAILED_TESTS + 1))
    fi

    # æµ‹è¯•å®‰å…¨å¤´
    local security_headers=$(curl -s -I "$API_BASE_URL/health")

    if echo "$security_headers" | grep -q "X-Content-Type-Options:" && \
       echo "$security_headers" | grep -q "X-Frame-Options:"; then
        log "  ç»“æœ: âœ… å®‰å…¨å¤´é…ç½®æ­£å¸¸"
    else
        log "  ç»“æœ: âŒ å®‰å…¨å¤´é…ç½®ç¼ºå¤±"
        FAILED_TESTS=$((FAILED_TESTS + 1))
    fi
}

# ç”ŸæˆéªŒè¯æŠ¥å‘Š
generate_report() {
    local report_file="/var/log/verification_report_$(date +%Y%m%d_%H%M%S).html"
    local success_rate=$(( (TOTAL_TESTS - FAILED_TESTS) * 100 / TOTAL_TESTS ))

    cat > "$report_file" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>åŠŸèƒ½éªŒè¯æŠ¥å‘Š</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .failure { color: red; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>åŠŸèƒ½éªŒè¯æŠ¥å‘Š</h1>
    <p>ç”Ÿæˆæ—¶é—´: $(date)</p>

    <div class="section">
        <h2>éªŒè¯ç»“æœæ¦‚è§ˆ</h2>
        <table>
            <tr><th>æ€»æµ‹è¯•æ•°</th><td>$TOTAL_TESTS</td></tr>
            <tr><th>æˆåŠŸæµ‹è¯•</th><td>$((TOTAL_TESTS - FAILED_TESTS))</td></tr>
            <tr><th>å¤±è´¥æµ‹è¯•</th><td>$FAILED_TESTS</td></tr>
            <tr><th>æˆåŠŸç‡</th><td>$success_rate%</td></tr>
        </table>
    </div>

    <div class="section">
        <h2>è¯¦ç»†æµ‹è¯•æ—¥å¿—</h2>
        <pre>$(cat "$VERIFICATION_LOG")</pre>
    </div>
</body>
</html>
EOF

    log "éªŒè¯æŠ¥å‘Šç”Ÿæˆ: $report_file"

    # å‘é€æŠ¥å‘Š
    if [ "$FAILED_TESTS" -eq 0 ]; then
        echo "åŠŸèƒ½éªŒè¯å…¨éƒ¨é€šè¿‡" | mail -s "åŠŸèƒ½éªŒè¯æˆåŠŸ" "admin@yourdomain.com"
    else
        echo "åŠŸèƒ½éªŒè¯å¤±è´¥: $FAILED_TESTS/$TOTAL_TESTS æµ‹è¯•å¤±è´¥" | \
            mail -s "åŠŸèƒ½éªŒè¯å¤±è´¥" "admin@yourdomain.com"
    fi
}

# ä¸»éªŒè¯æµç¨‹
main() {
    log "å¼€å§‹åŠŸèƒ½éªŒè¯..."

    # åŸºç¡€è¿æ¥æµ‹è¯•
    test_database_connection
    test_redis_connection

    # è®¤è¯æµ‹è¯•
    test_jwt_authentication

    # APIåŠŸèƒ½æµ‹è¯•
    test_news_api
    test_articles_api
    test_wechat_api

    # æ€§èƒ½æµ‹è¯•
    test_performance

    # å®‰å…¨æµ‹è¯•
    test_security

    # ç”ŸæˆæŠ¥å‘Š
    generate_report

    # æ¸…ç†
    rm -f /tmp/test_jwt_token

    log "åŠŸèƒ½éªŒè¯å®Œæˆ"
    log "æ€»æµ‹è¯•: $TOTAL_TESTS, æˆåŠŸ: $((TOTAL_TESTS - FAILED_TESTS)), å¤±è´¥: $FAILED_TESTS"

    if [ "$FAILED_TESTS" -eq 0 ]; then
        log "ç»“æœ: æ‰€æœ‰æµ‹è¯•é€šè¿‡"
        exit 0
    else
        log "ç»“æœ: å­˜åœ¨å¤±è´¥çš„æµ‹è¯•"
        exit 1
    fi
}

main "$@"
```

#### 9.3.2 æ€§èƒ½éªŒè¯

**æ€§èƒ½åŸºå‡†æµ‹è¯•è„šæœ¬**ï¼š

```bash
#!/bin/bash
# æ€§èƒ½éªŒè¯è„šæœ¬ - performance_verification.sh
set -e

PERF_LOG="/var/log/perf_verification_$(date +%Y%m%d_%H%M%S).log"
API_BASE_URL="https://api.yourdomain.com"
RESULTS_DIR="/tmp/perf_results_$$"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$PERF_LOG"
}

# è´Ÿè½½æµ‹è¯•
load_test() {
    local endpoint=$1
    local concurrency=${2:-10}
    local requests=${3:-100}
    local test_name=$4

    log "å¼€å§‹è´Ÿè½½æµ‹è¯•: $test_name"
    log "  ç«¯ç‚¹: $endpoint"
    log "  å¹¶å‘æ•°: $concurrency"
    log "  è¯·æ±‚æ•°: $requests"

    mkdir -p "$RESULTS_DIR"

    # ä½¿ç”¨abè¿›è¡Œè´Ÿè½½æµ‹è¯•
    local result_file="$RESULTS_DIR/${test_name// /_}.txt"

    ab -n "$requests" -c "$concurrency" -g "$result_file" "$API_BASE_URL$endpoint" > "$RESULTS_DIR/${test_name// /_}_summary.txt" 2>&1

    if [ $? -eq 0 ]; then
        log "  è´Ÿè½½æµ‹è¯•å®Œæˆ"

        # è§£æç»“æœ
        local requests_per_sec=$(grep "Requests per second" "$RESULTS_DIR/${test_name// /_}_summary.txt" | awk '{print $4}')
        local time_per_request=$(grep "Time per request" "$RESULTS_DIR/${test_name// /_}_summary.txt" | head -1 | awk '{print $4}')
        local failed_requests=$(grep "Failed requests" "$RESULTS_DIR/${test_name// /_}_summary.txt" | awk '{print $3}')

        log "  RPS: $requests_per_sec"
        log "  å“åº”æ—¶é—´: ${time_per_request}ms"
        log "  å¤±è´¥è¯·æ±‚: $failed_requests"

        # ä¿å­˜ç»“æœ
        cat >> "$RESULTS_DIR/performance_summary.csv" << EOF
"$test_name","$endpoint",$concurrency,$requests,$requests_per_sec,$time_per_request,$failed_requests
EOF

        return 0
    else
        log "  è´Ÿè½½æµ‹è¯•å¤±è´¥"
        return 1
    fi
}

# å†…å­˜ä½¿ç”¨æµ‹è¯•
memory_test() {
    local test_duration=300  # 5åˆ†é’Ÿ
    local sample_interval=10  # 10ç§’

    log "å¼€å§‹å†…å­˜ä½¿ç”¨æµ‹è¯• (æŒç»­ ${test_duration}ç§’)..."

    local memory_log="$RESULTS_DIR/memory_usage.log"
    echo "timestamp,used_memory,available_memory,memory_usage_percent" > "$memory_log"

    local end_time=$(($(date +%s) + test_duration))

    while [ $(date +%s) -lt $end_time ]; do
        local memory_info=$(free -m | grep Mem)
        local used_memory=$(echo "$memory_info" | awk '{print $3}')
        local available_memory=$(echo "$memory_info" | awk '{print $7}')
        local total_memory=$(echo "$memory_info" | awk '{print $2}')
        local memory_usage=$((used_memory * 100 / total_memory))

        echo "$(date -Iseconds),$used_memory,$available_memory,$memory_usage" >> "$memory_log"

        sleep $sample_interval
    done

    log "å†…å­˜ä½¿ç”¨æµ‹è¯•å®Œæˆ"

    # åˆ†æç»“æœ
    local max_memory_usage=$(awk -F, 'NR>1 {print $4}' "$memory_log" | sort -n | tail -1)
    local avg_memory_usage=$(awk -F, 'NR>1 {sum+=$4; count++} END {print sum/count}' "$memory_log")

    log "æœ€å¤§å†…å­˜ä½¿ç”¨ç‡: ${max_memory_usage}%"
    log "å¹³å‡å†…å­˜ä½¿ç”¨ç‡: ${avg_memory_usage}%"
}

# CPUä½¿ç”¨ç‡æµ‹è¯•
cpu_test() {
    local test_duration=300  # 5åˆ†é’Ÿ
    local sample_interval=10  # 10ç§’

    log "å¼€å§‹CPUä½¿ç”¨ç‡æµ‹è¯• (æŒç»­ ${test_duration}ç§’)..."

    local cpu_log="$RESULTS_DIR/cpu_usage.log"
    echo "timestamp,cpu_usage_percent" > "$cpu_log"

    local end_time=$(($(date +%s) + test_duration))

    while [ $(date +%s) -lt $end_time ]; do
        local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d% -f1)
        echo "$(date -Iseconds),$cpu_usage" >> "$cpu_log"

        sleep $sample_interval
    done

    log "CPUä½¿ç”¨ç‡æµ‹è¯•å®Œæˆ"

    # åˆ†æç»“æœ
    local max_cpu_usage=$(awk -F, 'NR>1 {print $2}' "$cpu_log" | sort -n | tail -1)
    local avg_cpu_usage=$(awk -F, 'NR>1 {sum+=$2; count++} END {print sum/count}' "$cpu_log")

    log "æœ€å¤§CPUä½¿ç”¨ç‡: ${max_cpu_usage}%"
    log "å¹³å‡CPUä½¿ç”¨ç‡: ${avg_cpu_usage}%"
}

# æ•°æ®åº“æ€§èƒ½æµ‹è¯•
database_performance_test() {
    log "å¼€å§‹æ•°æ®åº“æ€§èƒ½æµ‹è¯•..."

    local db_log="$RESULTS_DIR/database_performance.log"

    # æµ‹è¯•æŸ¥è¯¢æ€§èƒ½
    echo "timestamp,query_type,response_time" > "$db_log"

    for i in {1..100}; do
        local start_time=$(date +%s.%N)

        # æ‰§è¡Œæµ‹è¯•æŸ¥è¯¢
        mysql -u root -p -e "SELECT COUNT(*) FROM official_website.sys_news_articles;" > /dev/null 2>&1

        local end_time=$(date +%s.%N)
        local response_time=$(echo "$end_time - $start_time" | bc)

        echo "$(date -Iseconds),select_count,$response_time" >> "$db_log"
    done

    # åˆ†æç»“æœ
    local avg_query_time=$(awk -F, 'NR>1 && $3=="select_count" {sum+=$3; count++} END {print sum/count}' "$db_log")
    local max_query_time=$(awk -F, 'NR>1 && $3=="select_count" {print $3}' "$db_log" | sort -n | tail -1)

    log "å¹³å‡æŸ¥è¯¢æ—¶é—´: ${avg_query_time}ç§’"
    log "æœ€å¤§æŸ¥è¯¢æ—¶é—´: ${max_query_time}ç§’"
}

# ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š
generate_performance_report() {
    local report_file="/var/log/performance_report_$(date +%Y%m%d_%H%M%S).html"

    cat > "$report_file" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>æ€§èƒ½éªŒè¯æŠ¥å‘Š</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .chart { margin: 20px 0; }
    </style>
</head>
<body>
    <h1>æ€§èƒ½éªŒè¯æŠ¥å‘Š</h1>
    <p>ç”Ÿæˆæ—¶é—´: $(date)</p>

    <div class="section">
        <h2>è´Ÿè½½æµ‹è¯•ç»“æœ</h2>
        <table>
            <tr><th>æµ‹è¯•åç§°</th><th>ç«¯ç‚¹</th><th>RPS</th><th>å“åº”æ—¶é—´(ms)</th><th>å¤±è´¥è¯·æ±‚</th></tr>
EOF

    if [ -f "$RESULTS_DIR/performance_summary.csv" ]; then
        tail -n +2 "$RESULTS_DIR/performance_summary.csv" | while IFS=, read -r name endpoint concurrency rps time failed; do
            echo "            <tr><td>$name</td><td>$endpoint</td><td>$rps</td><td>$time</td><td>$failed</td></tr>" >> "$report_file"
        done
    fi

    cat >> "$report_file" << EOF
        </table>
    </div>

    <div class="section">
        <h2>ç³»ç»Ÿèµ„æºä½¿ç”¨</h2>
        <p>è¯¦ç»†çš„æ€§èƒ½æ•°æ®è¯·æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶: $PERF_LOG</p>
    </div>

    <div class="section">
        <h2>æµ‹è¯•æ—¥å¿—</h2>
        <pre>$(cat "$PERF_LOG")</pre>
    </div>
</body>
</html>
EOF

    log "æ€§èƒ½æŠ¥å‘Šç”Ÿæˆ: $report_file"

    # å‘é€æŠ¥å‘Š
    echo "æ€§èƒ½éªŒè¯å®Œæˆï¼Œè¯·æŸ¥çœ‹é™„ä»¶æŠ¥å‘Š" | \
        mail -s "æ€§èƒ½éªŒè¯æŠ¥å‘Š" -a "$report_file" "admin@yourdomain.com"
}

# ä¸»æ€§èƒ½éªŒè¯æµç¨‹
main() {
    log "å¼€å§‹æ€§èƒ½éªŒè¯..."

    mkdir -p "$RESULTS_DIR"

    # è´Ÿè½½æµ‹è¯•
    load_test "/api/news" 10 100 "æ–°é—»åˆ—è¡¨API"
    load_test "/api/articles" 20 200 "æ–‡ç« åˆ—è¡¨API"
    load_test "/api/health" 50 500 "å¥åº·æ£€æŸ¥API"

    # èµ„æºä½¿ç”¨æµ‹è¯•
    memory_test
    cpu_test

    # æ•°æ®åº“æ€§èƒ½æµ‹è¯•
    database_performance_test

    # ç”ŸæˆæŠ¥å‘Š
    generate_performance_report

    # æ¸…ç†
    rm -rf "$RESULTS_DIR"

    log "æ€§èƒ½éªŒè¯å®Œæˆ"
}

main "$@"
```

### 9.4 é£é™©è¯„ä¼°

#### 9.4.1 å›æ»šé£é™©åˆ†æ

**é£é™©è¯„ä¼°è„šæœ¬**ï¼š

```bash
#!/bin/bash
# å›æ»šé£é™©è¯„ä¼°è„šæœ¬ - rollback_risk_assessment.sh
set -e

RISK_LOG="/var/log/rollback_risk_assessment_$(date +%Y%m%d_%H%M%S).log"
RISK_SCORE=0
RISK_LEVEL="LOW"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$RISK_LOG"
}

# é£é™©è¯„ä¼°å‡½æ•°
assess_risk() {
    local factor=$1
    local score=$2
    local description=$3

    RISK_SCORE=$((RISK_SCORE + score))

    log "é£é™©è¯„ä¼°: $factor (å¾—åˆ†: $score)"
    log "  æè¿°: $description"
}

# æ£€æŸ¥æ•°æ®åº“å¤§å°
check_database_size() {
    log "æ£€æŸ¥æ•°æ®åº“å¤§å°..."

    local db_size_mb=$(mysql -u root -p -e "
        SELECT ROUND(SUM(data_length + index_length) / 1024 / 1024, 1)
        FROM information_schema.tables
        WHERE table_schema = 'official_website';
    " 2>/dev/null | tail -1)

    if [ "$db_size_mb" -gt 1000 ]; then
        assess_risk "æ•°æ®åº“å¤§å°" 20 "æ•°æ®åº“è¾ƒå¤§ (${db_size_mb}MB)ï¼Œå›æ»šæ—¶é—´å¯èƒ½è¾ƒé•¿"
    elif [ "$db_size_mb" -gt 500 ]; then
        assess_risk "æ•°æ®åº“å¤§å°" 10 "æ•°æ®åº“ä¸­ç­‰å¤§å° (${db_size_mb}MB)"
    else
        assess_risk "æ•°æ®åº“å¤§å°" 0 "æ•°æ®åº“è¾ƒå° (${db_size_mb}MB)ï¼Œé£é™©è¾ƒä½"
    fi
}

# æ£€æŸ¥å½“å‰é”™è¯¯ç‡
check_current_error_rate() {
    log "æ£€æŸ¥å½“å‰é”™è¯¯ç‡..."

    local error_rate=$(tail -1000 /var/log/nginx/access.log 2>/dev/null | \
        awk '$9 >= 400 {count++} END {print (count>0) ? count/NR*100 : 0}')

    if (( $(echo "$error_rate > 20" | bc -l) )); then
        assess_risk "é”™è¯¯ç‡" 30 "å½“å‰é”™è¯¯ç‡è¿‡é«˜ (${error_rate}%)"
    elif (( $(echo "$error_rate > 10" | bc -l) )); then
        assess_risk "é”™è¯¯ç‡" 15 "å½“å‰é”™è¯¯ç‡è¾ƒé«˜ (${error_rate}%)"
    else
        assess_risk "é”™è¯¯ç‡" 0 "å½“å‰é”™è¯¯ç‡æ­£å¸¸ (${error_rate}%)"
    fi
}

# æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
check_system_load() {
    log "æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½..."

    local load_1min=$(uptime | awk -F'load average:' '{print $2}' | cut -d, -f1 | xargs)
    local cpu_cores=$(nproc)
    local load_threshold=$((cpu_cores * 2))

    if (( $(echo "$load_1min > $load_threshold" | bc -l) )); then
        assess_risk "ç³»ç»Ÿè´Ÿè½½" 25 "ç³»ç»Ÿè´Ÿè½½è¿‡é«˜ ($load_1min)"
    elif (( $(echo "$load_1min > $cpu_cores" | bc -l) )); then
        assess_risk "ç³»ç»Ÿè´Ÿè½½" 10 "ç³»ç»Ÿè´Ÿè½½è¾ƒé«˜ ($load_1min)"
    else
        assess_risk "ç³»ç»Ÿè´Ÿè½½" 0 "ç³»ç»Ÿè´Ÿè½½æ­£å¸¸ ($load_1min)"
    fi
}

# æ£€æŸ¥ç£ç›˜ç©ºé—´
check_disk_space() {
    log "æ£€æŸ¥ç£ç›˜ç©ºé—´..."

    local available_space=$(df / | tail -1 | awk '{print $4}')
    local required_space=1048576  # 1GB in KB

    if [ "$available_space" -lt $((required_space / 2)) ]; then
        assess_risk "ç£ç›˜ç©ºé—´" 35 "ç£ç›˜ç©ºé—´ä¸¥é‡ä¸è¶³"
    elif [ "$available_space" -lt $required_space ]; then
        assess_risk "ç£ç›˜ç©ºé—´" 15 "ç£ç›˜ç©ºé—´ä¸è¶³"
    else
        assess_risk "ç£ç›˜ç©ºé—´" 0 "ç£ç›˜ç©ºé—´å……è¶³"
    fi
}

# æ£€æŸ¥å¤‡ä»½å®Œæ•´æ€§
check_backup_integrity() {
    log "æ£€æŸ¥å¤‡ä»½å®Œæ•´æ€§..."

    local backup_dir="/backup/deployments"
    local latest_backup=$(ls -t "$backup_dir" | grep -E "backup_[0-9]{8}" | head -1)

    if [ -z "$latest_backup" ]; then
        assess_risk "å¤‡ä»½å®Œæ•´æ€§" 50 "æœªæ‰¾åˆ°å¯ç”¨å¤‡ä»½"
    elif [ ! -f "$backup_dir/$latest_backup/database.sql" ]; then
        assess_risk "å¤‡ä»½å®Œæ•´æ€§" 30 "æ•°æ®åº“å¤‡ä»½ç¼ºå¤±"
    elif [ ! -d "$backup_dir/$latest_backup/app" ]; then
        assess_risk "å¤‡ä»½å®Œæ•´æ€§" 30 "åº”ç”¨å¤‡ä»½ç¼ºå¤±"
    else
        assess_risk "å¤‡ä»½å®Œæ•´æ€§" 0 "å¤‡ä»½å®Œæ•´æ€§è‰¯å¥½"
    fi
}

# æ£€æŸ¥ä¾èµ–æœåŠ¡
check_dependencies() {
    log "æ£€æŸ¥ä¾èµ–æœåŠ¡..."

    local failed_services=0

    # æ£€æŸ¥MySQL
    if ! systemctl is-active mysql > /dev/null 2>&1; then
        failed_services=$((failed_services + 1))
    fi

    # æ£€æŸ¥Redis
    if ! systemctl is-active redis > /dev/null 2>&1; then
        failed_services=$((failed_services + 1))
    fi

    # æ£€æŸ¥Nginx
    if ! systemctl is-active nginx > /dev/null 2>&1; then
        failed_services=$((failed_services + 1))
    fi

    if [ $failed_services -ge 2 ]; then
        assess_risk "ä¾èµ–æœåŠ¡" 40 "$failed_services ä¸ªå…³é”®æœåŠ¡æœªè¿è¡Œ"
    elif [ $failed_services -eq 1 ]; then
        assess_risk "ä¾èµ–æœåŠ¡" 15 "1ä¸ªå…³é”®æœåŠ¡æœªè¿è¡Œ"
    else
        assess_risk "ä¾èµ–æœåŠ¡" 0 "æ‰€æœ‰ä¾èµ–æœåŠ¡æ­£å¸¸è¿è¡Œ"
    fi
}

# æ£€æŸ¥æ—¶é—´çª—å£
check_time_window() {
    log "æ£€æŸ¥å›æ»šæ—¶é—´çª—å£..."

    local current_hour=$(date +%H)
    local current_day=$(date +%u)  # 1-7 (Monday=1)

    # å·¥ä½œæ—¶é—´ (9:00-18:00)
    if [ $current_hour -ge 9 ] && [ $current_hour -lt 18 ]; then
        if [ $current_day -le 5 ]; then
            assess_risk "æ—¶é—´çª—å£" 20 "å·¥ä½œæ—¶é—´å›æ»šï¼Œå¯èƒ½å½±å“ä¸šåŠ¡"
        else
            assess_risk "æ—¶é—´çª—å£" 10 "å‘¨æœ«å·¥ä½œæ—¶é—´"
        fi
    else
        assess_risk "æ—¶é—´çª—å£" 0 "éå·¥ä½œæ—¶é—´ï¼Œå½±å“è¾ƒå°"
    fi
}

# ç¡®å®šé£é™©çº§åˆ«
determine_risk_level() {
    if [ "$RISK_SCORE" -ge 80 ]; then
        RISK_LEVEL="CRITICAL"
    elif [ "$RISK_SCORE" -ge 60 ]; then
        RISK_LEVEL="HIGH"
    elif [ "$RISK_SCORE" -ge 40 ]; then
        RISK_LEVEL="MEDIUM"
    elif [ "$RISK_SCORE" -ge 20 ]; then
        RISK_LEVEL="LOW"
    else
        RISK_LEVEL="VERY_LOW"
    fi
}

# ç”Ÿæˆé£é™©æŠ¥å‘Š
generate_risk_report() {
    local report_file="/var/log/rollback_risk_report_$(date +%Y%m%d_%H%M%S).html"

    cat > "$report_file" << EOF
<!DOCTYPE html>
<html>
<head>
    <title>å›æ»šé£é™©è¯„ä¼°æŠ¥å‘Š</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .critical { background-color: #ffebee; color: #c62828; }
        .high { background-color: #fff3e0; color: #ef6c00; }
        .medium { background-color: #fff8e1; color: #f57f17; }
        .low { background-color: #e8f5e8; color: #2e7d32; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <h1>å›æ»šé£é™©è¯„ä¼°æŠ¥å‘Š</h1>
    <p>è¯„ä¼°æ—¶é—´: $(date)</p>

    <div class="section $RISK_LEVEL">
        <h2>æ€»ä½“é£é™©çº§åˆ«: $RISK_LEVEL</h2>
        <p>é£é™©å¾—åˆ†: $RISK_SCORE</p>
    </div>

    <div class="section">
        <h2>è¯¦ç»†è¯„ä¼°ç»“æœ</h2>
        <pre>$(cat "$RISK_LOG")</pre>
    </div>

    <div class="section">
        <h2>å»ºè®®æªæ–½</h2>
EOF

    case "$RISK_LEVEL" in
        "CRITICAL")
            cat >> "$report_file" << EOF
        <p><strong>ä¸å»ºè®®æ‰§è¡Œå›æ»š</strong></p>
        <ul>
            <li>ç­‰å¾…é£é™©å› ç´ ç¼“è§£åå†è€ƒè™‘å›æ»š</li>
            <li>ä¼˜å…ˆè§£å†³å½“å‰ç³»ç»Ÿé—®é¢˜</li>
            <li>å‡†å¤‡åº”æ€¥å“åº”æ–¹æ¡ˆ</li>
        </ul>
EOF
            ;;
        "HIGH")
            cat >> "$report_file" << EOF
        <p><strong>è°¨æ…æ‰§è¡Œå›æ»š</strong></p>
        <ul>
            <li>ç¡®ä¿æœ‰å®Œæ•´çš„äººå‘˜æ”¯æŒ</li>
            <li>å‡†å¤‡å›æ»šå¤±è´¥åçš„åº”æ€¥æ–¹æ¡ˆ</li>
            <li>è€ƒè™‘åœ¨ä½å³°æœŸæ‰§è¡Œ</li>
        </ul>
EOF
            ;;
        "MEDIUM")
            cat >> "$report_file" << EOF
        <p><strong>å¯ä»¥æ‰§è¡Œå›æ»šï¼Œä½†éœ€è°¨æ…</strong></p>
        <ul>
            <li>ç¡®ä¿å¤‡ä»½å®Œæ•´æ€§</li>
            <li>ç›‘æ§å›æ»šè¿‡ç¨‹</li>
            <li>å‡†å¤‡éªŒè¯æµ‹è¯•</li>
        </ul>
EOF
            ;;
        "LOW"|"VERY_LOW")
            cat >> "$report_file" << EOF
        <p><strong>å¯ä»¥å®‰å…¨æ‰§è¡Œå›æ»š</strong></p>
        <ul>
            <li>æŒ‰æ ‡å‡†æµç¨‹æ‰§è¡Œ</li>
            <li>æ‰§è¡ŒåéªŒè¯</li>
            <li>è®°å½•æ“ä½œæ—¥å¿—</li>
        </ul>
EOF
            ;;
    esac

    cat >> "$report_file" << EOF
    </div>
</body>
</html>
EOF

    log "é£é™©è¯„ä¼°æŠ¥å‘Šç”Ÿæˆ: $report_file"

    # å‘é€æŠ¥å‘Š
    echo "å›æ»šé£é™©è¯„ä¼°å®Œæˆï¼Œé£é™©çº§åˆ«: $RISK_LEVEL (å¾—åˆ†: $RISK_SCORE)" | \
        mail -s "å›æ»šé£é™©è¯„ä¼°æŠ¥å‘Š" -a "$report_file" "admin@yourdomain.com"
}

# ä¸»è¯„ä¼°æµç¨‹
main() {
    log "å¼€å§‹å›æ»šé£é™©è¯„ä¼°..."

    # æ‰§è¡Œå„é¡¹è¯„ä¼°
    check_database_size
    check_current_error_rate
    check_system_load
    check_disk_space
    check_backup_integrity
    check_dependencies
    check_time_window

    # ç¡®å®šé£é™©çº§åˆ«
    determine_risk_level

    log "é£é™©è¯„ä¼°å®Œæˆ"
    log "æ€»é£é™©å¾—åˆ†: $RISK_SCORE"
    log "é£é™©çº§åˆ«: $RISK_LEVEL"

    # ç”ŸæˆæŠ¥å‘Š
    generate_risk_report

    log "è¯„ä¼°æŠ¥å‘Šå·²å‘é€"
}

main "$@"
```

#### 9.4.2 ç¼“è§£æªæ–½

**é£é™©ç¼“è§£è„šæœ¬**ï¼š

```bash
#!/bin/bash
# é£é™©ç¼“è§£æªæ–½è„šæœ¬ - rollback_mitigation.sh
set -e

MITIGATION_LOG="/var/log/rollback_mitigation_$(date +%Y%m%d_%H%M%S).log"

# æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$MITIGATION_LOG"
}

# æ¸…ç†ç£ç›˜ç©ºé—´
cleanup_disk_space() {
    log "æ‰§è¡Œç£ç›˜ç©ºé—´æ¸…ç†..."

    # æ¸…ç†æ—¥å¿—æ–‡ä»¶
    find /var/log -name "*.log" -mtime +7 -exec gzip {} \;
    find /var/log -name "*.log.gz" -mtime +30 -delete

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    find /tmp -mtime +1 -delete
    find /var/tmp -mtime +1 -delete

    # æ¸…ç†åº”ç”¨ç¼“å­˜
    rm -rf /var/www/official_website_backend/var/cache/*

    log "ç£ç›˜ç©ºé—´æ¸…ç†å®Œæˆ"
}

# ä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½
optimize_system_performance() {
    log "æ‰§è¡Œç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–..."

    # è°ƒæ•´ç³»ç»Ÿå‚æ•°
    echo 'vm.swappiness=10' >> /etc/sysctl.conf
    echo 'net.core.somaxconn=65535' >> /etc/sysctl.conf
    sysctl -p

    # ä¼˜åŒ–MySQLé…ç½®
    sed -i 's/innodb_buffer_pool_size.*/innodb_buffer_pool_size = 1G/' /etc/mysql/mysql.conf.d/mysqld.cnf
    systemctl restart mysql

    log "ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–å®Œæˆ"
}

# å‡†å¤‡åº”æ€¥æ–¹æ¡ˆ
prepare_emergency_plan() {
    log "å‡†å¤‡åº”æ€¥æ–¹æ¡ˆ..."

    # åˆ›å»ºåº”æ€¥è„šæœ¬
    cat > /tmp/emergency_rollback.sh << 'EOF'
#!/bin/bash
# åº”æ€¥å›æ»šè„šæœ¬
echo "æ‰§è¡Œåº”æ€¥å›æ»š..."
systemctl stop nginx
systemctl stop php8.2-fpm
# è¿™é‡Œæ·»åŠ å…·ä½“çš„åº”æ€¥å›æ»šå‘½ä»¤
systemctl start php8.2-fpm
systemctl start nginx
echo "åº”æ€¥å›æ»šå®Œæˆ"
EOF

    chmod +x /tmp/emergency_rollback.sh

    log "åº”æ€¥æ–¹æ¡ˆå‡†å¤‡å®Œæˆ"
}

# é€šçŸ¥ç›¸å…³äººå‘˜
notify_stakeholders() {
    log "é€šçŸ¥ç›¸å…³äººå‘˜..."

    local message="å³å°†æ‰§è¡Œå›æ»šæ“ä½œï¼Œè¯·ç›¸å…³äººå‘˜åšå¥½å‡†å¤‡"

    # å‘é€é‚®ä»¶é€šçŸ¥
    echo "$message" | mail -s "å›æ»šæ“ä½œé€šçŸ¥" "admin@yourdomain.com,ops@yourdomain.com"

    # å‘é€Webhooké€šçŸ¥
    if [ -n "$WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"âš ï¸ $message\"}" \
            "$WEBHOOK_URL" 2>/dev/null || true
    fi

    log "ç›¸å…³äººå‘˜é€šçŸ¥å®Œæˆ"
}

# åˆ›å»ºæ£€æŸ¥ç‚¹
create_checkpoint() {
    log "åˆ›å»ºå›æ»šæ£€æŸ¥ç‚¹..."

    local checkpoint_name="checkpoint_$(date +%Y%m%d_%H%M%S)"
    local checkpoint_dir="/backup/checkpoints/$checkpoint_name"

    mkdir -p "$checkpoint_dir"

    # ä¿å­˜å½“å‰çŠ¶æ€
    ps aux > "$checkpoint_dir/processes.txt"
    netstat -tulpn > "$checkpoint_dir/connections.txt"
    df -h > "$checkpoint_dir/disk_usage.txt"
    free -m > "$checkpoint_dir/memory_usage.txt"

    log "æ£€æŸ¥ç‚¹åˆ›å»ºå®Œæˆ: $checkpoint_dir"
}

# ä¸»ç¼“è§£æµç¨‹
main() {
    log "å¼€å§‹æ‰§è¡Œé£é™©ç¼“è§£æªæ–½..."

    # æ‰§è¡Œç¼“è§£æªæ–½
    cleanup_disk_space
    optimize_system_performance
    prepare_emergency_plan
    notify_stakeholders
    create_checkpoint

    log "é£é™©ç¼“è§£æªæ–½æ‰§è¡Œå®Œæˆ"
}

main "$@"
```

---

## 8. æ•…éšœæ’é™¤

### 8.1 å¸¸è§é—®é¢˜è¯Šæ–­

#### 8.1.1 åº”ç”¨å¯åŠ¨é—®é¢˜

**é—®é¢˜**: åº”ç”¨æ— æ³•å¯åŠ¨æˆ–å“åº”å¼‚å¸¸

**å¿«é€Ÿè¯Šæ–­è„šæœ¬**:

```bash
# ä½¿ç”¨æ•…éšœæ’é™¤åŠ©æ‰‹
./scripts/troubleshooting_helper.sh
# é€‰æ‹©é€‰é¡¹ 1: åº”ç”¨å¯åŠ¨é—®é¢˜
```

**è¯¦ç»†æ’æŸ¥æ­¥éª¤**:

1. **æ£€æŸ¥ PHP é”™è¯¯æ—¥å¿—**

```bash
# æŸ¥çœ‹PHPé”™è¯¯æ—¥å¿—
tail -f /var/log/php8.2-fpm.log
tail -f /www/wwwroot/official_website_backend/var/log/prod.log

# æŸ¥æ‰¾æœ€è¿‘çš„ä¸¥é‡é”™è¯¯
grep -i "fatal\|critical\|error" /var/log/php8.2-fpm.log | tail -20
```

2. **éªŒè¯é…ç½®æ–‡ä»¶è¯­æ³•**

```bash
# æ£€æŸ¥PHPè¯­æ³•
php -l public/index.php
php -l src/Kernel.php

# æ£€æŸ¥Composeré…ç½®
composer validate --no-check-all --strict

# æ£€æŸ¥Symfonyé…ç½®
php bin/console debug:config --env=prod
```

3. **æ£€æŸ¥æ–‡ä»¶æƒé™**

```bash
# æ£€æŸ¥å…³é”®ç›®å½•æƒé™
ls -la var/cache/
ls -la var/log/
ls -la public/

# ä¿®å¤æƒé™é—®é¢˜
chmod -R 755 var/
chmod -R 755 public/
chown -R www-data:www-data var/
```

4. **éªŒè¯ä¾èµ–å®Œæ•´æ€§**

```bash
# æ£€æŸ¥Composerä¾èµ–
composer install --no-dev --optimize-autoloader

# æ¸…ç†ç¼“å­˜
php bin/console cache:clear --env=prod
php bin/console cache:warmup --env=prod
```

**å¸¸è§è§£å†³æ–¹æ¡ˆ**:

| é”™è¯¯ç±»å‹            | è§£å†³æ–¹æ¡ˆ                               |
| ------------------- | -------------------------------------- |
| "Class not found"   | è¿è¡Œ `composer dump-autoload`          |
| "Permission denied" | ä¿®å¤æ–‡ä»¶æƒé™ `chown www-data:www-data` |
| "Out of memory"     | å¢åŠ  `memory_limit` æˆ–ä¼˜åŒ–ä»£ç          |
| "Service not found" | æ£€æŸ¥ `services.yaml` é…ç½®              |

#### 8.1.2 æ•°æ®åº“è¿æ¥é—®é¢˜

**é—®é¢˜**: æ•°æ®åº“è¿æ¥å¤±è´¥æˆ–å“åº”ç¼“æ…¢

**å¿«é€Ÿè¯Šæ–­è„šæœ¬**:

```bash
# ä½¿ç”¨æ•…éšœæ’é™¤åŠ©æ‰‹
./scripts/troubleshooting_helper.sh
# é€‰æ‹©é€‰é¡¹ 2: æ•°æ®åº“è¿æ¥é—®é¢˜
```

**è¯¦ç»†æ’æŸ¥æ­¥éª¤**:

1. **æ£€æŸ¥æ•°æ®åº“æœåŠ¡çŠ¶æ€**

```bash
# MySQL/MariaDBçŠ¶æ€æ£€æŸ¥
systemctl status mysql
systemctl status mariadb

# æ£€æŸ¥æ•°æ®åº“è¿›ç¨‹
ps aux | grep mysql
netstat -tlnp | grep 3306
```

2. **éªŒè¯è¿æ¥å‚æ•°**

```bash
# æµ‹è¯•æ•°æ®åº“è¿æ¥
mysql -u username -p -h localhost database_name

# æ£€æŸ¥Symfonyæ•°æ®åº“é…ç½®
php bin/console debug:config doctrine dbal --env=prod

# æµ‹è¯•Doctrineè¿æ¥
php bin/console doctrine:database:create --if-not-exists --env=prod
```

3. **æ£€æŸ¥ç½‘ç»œè¿æ¥**

```bash
# æµ‹è¯•ç«¯å£è¿é€šæ€§
telnet localhost 3306
nc -zv localhost 3306

# æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
ufw status
iptables -L
```

4. **éªŒè¯ç”¨æˆ·æƒé™**

```sql
-- æ£€æŸ¥ç”¨æˆ·æƒé™
SHOW GRANTS FOR 'username'@'localhost';

-- æˆäºˆå¿…è¦æƒé™
GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, ALTER, INDEX ON database_name.* TO 'username'@'localhost';
FLUSH PRIVILEGES;
```

**æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ**:

```sql
-- æ£€æŸ¥æ…¢æŸ¥è¯¢
SHOW VARIABLES LIKE 'slow_query_log';
SHOW VARIABLES LIKE 'long_query_time';

-- å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;

-- æŸ¥çœ‹è¿æ¥æ•°
SHOW STATUS LIKE 'Threads_connected';
SHOW VARIABLES LIKE 'max_connections';
```

#### 8.1.3 JWT è®¤è¯é—®é¢˜

**é—®é¢˜**: JWT è®¤è¯å¤±è´¥æˆ–ä»¤ç‰Œæ— æ•ˆ

**å¿«é€Ÿè¯Šæ–­è„šæœ¬**:

```bash
# ä½¿ç”¨æ•…éšœæ’é™¤åŠ©æ‰‹
./scripts/troubleshooting_helper.sh
# é€‰æ‹©é€‰é¡¹ 6: JWTè®¤è¯é—®é¢˜
```

**è¯¦ç»†æ’æŸ¥æ­¥éª¤**:

1. **æ£€æŸ¥ JWT é…ç½®**

```bash
# æŸ¥çœ‹JWTé…ç½®
cat config/packages/lexik_jwt_authentication.yaml

# æ£€æŸ¥ç¯å¢ƒå˜é‡
grep JWT_ .env.local
grep LEXIK_JWT_ .env.local
```

2. **éªŒè¯å¯†é’¥æ–‡ä»¶**

```bash
# æ£€æŸ¥å¯†é’¥æ–‡ä»¶æƒé™
ls -la config/jwt/private.pem
ls -la config/jwt/public.pem

# ä¿®å¤å¯†é’¥æƒé™
chmod 600 config/jwt/private.pem
chmod 644 config/jwt/public.pem
chown www-data:www-data config/jwt/*
```

3. **æµ‹è¯• JWT ç”Ÿæˆå’ŒéªŒè¯**

```bash
# ç”Ÿæˆæµ‹è¯•ä»¤ç‰Œ
php bin/console lexik:jwt:generate-token --env=prod

# éªŒè¯ä»¤ç‰Œ
curl -H "Authorization: Bearer YOUR_TOKEN" http://localhost/api/protected_endpoint
```

4. **æ£€æŸ¥å®‰å…¨é…ç½®**

```bash
# æŸ¥çœ‹å®‰å…¨é…ç½®
cat config/packages/security.yaml

# è°ƒè¯•é˜²ç«å¢™é…ç½®
php bin/console debug:firewall --env=prod
```

**å¸¸è§ JWT é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ**:

| é”™è¯¯ä¿¡æ¯             | åŸå›          | è§£å†³æ–¹æ¡ˆ                   |
| -------------------- | ------------ | -------------------------- |
| "Invalid JWT Token"  | ä»¤ç‰Œæ ¼å¼é”™è¯¯ | æ£€æŸ¥ Bearer å‰ç¼€å’Œä»¤ç‰Œæ ¼å¼ |
| "Expired JWT Token"  | ä»¤ç‰Œè¿‡æœŸ     | åˆ·æ–°ä»¤ç‰Œæˆ–è°ƒæ•´è¿‡æœŸæ—¶é—´     |
| "Unable to load key" | å¯†é’¥æ–‡ä»¶é—®é¢˜ | æ£€æŸ¥å¯†é’¥æ–‡ä»¶è·¯å¾„å’Œæƒé™     |
| "Invalid signature"  | ç­¾åéªŒè¯å¤±è´¥ | æ£€æŸ¥å…¬é’¥ç§é’¥åŒ¹é…           |

#### 8.1.4 API è®¿é—®é—®é¢˜

**é—®é¢˜**: API ç«¯ç‚¹æ— æ³•è®¿é—®æˆ–å“åº”å¼‚å¸¸

**è¯Šæ–­æ­¥éª¤**:

1. **æ£€æŸ¥ Web æœåŠ¡å™¨é…ç½®**

```bash
# Nginxé…ç½®æµ‹è¯•
nginx -t
systemctl reload nginx

# æ£€æŸ¥ç«™ç‚¹é…ç½®
cat /etc/nginx/sites-available/your-site
```

2. **æµ‹è¯• API ç«¯ç‚¹**

```bash
# åŸºæœ¬è¿é€šæ€§æµ‹è¯•
curl -I http://localhost/api
curl -I http://localhost/api/docs

# è¯¦ç»†å“åº”æµ‹è¯•
curl -v http://localhost/api/health
curl -H "Accept: application/json" http://localhost/api
```

3. **æ£€æŸ¥è·¯ç”±é…ç½®**

```bash
# æŸ¥çœ‹æ‰€æœ‰è·¯ç”±
php bin/console debug:router --env=prod

# æ£€æŸ¥APIè·¯ç”±
php bin/console debug:router --env=prod | grep api
```

4. **éªŒè¯ CORS é…ç½®**

```bash
# æ£€æŸ¥CORSé…ç½®
cat config/packages/nelmio_cors.yaml

# æµ‹è¯•è·¨åŸŸè¯·æ±‚
curl -H "Origin: http://example.com" -H "Access-Control-Request-Method: GET" -X OPTIONS http://localhost/api
```

### 8.2 æ€§èƒ½é—®é¢˜æ’æŸ¥

#### 8.2.1 å“åº”æ—¶é—´è¿‡é•¿

**é—®é¢˜**: API å“åº”ç¼“æ…¢ï¼Œç”¨æˆ·ä½“éªŒå·®

**å¿«é€Ÿè¯Šæ–­è„šæœ¬**:

```bash
# ä½¿ç”¨æ•…éšœæ’é™¤åŠ©æ‰‹
./scripts/troubleshooting_helper.sh
# é€‰æ‹©é€‰é¡¹ 4: æ€§èƒ½é—®é¢˜æ’æŸ¥
```

**è¯¦ç»†æ’æŸ¥æ­¥éª¤**:

1. **å¯ç”¨æ€§èƒ½åˆ†æ**

```bash
# å¯ç”¨Symfonyæ€§èƒ½åˆ†æå™¨
php bin/console cache:clear --env=prod
# åœ¨å¼€å‘ç¯å¢ƒå¯ç”¨åˆ†æå™¨
APP_ENV=dev php bin/console server:start

# æŸ¥çœ‹æ€§èƒ½åˆ†ææ•°æ®
# è®¿é—®: http://localhost/_profiler/
```

2. **æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—**

```bash
# MySQLæ…¢æŸ¥è¯¢åˆ†æ
mysqldumpslow /var/log/mysql/mysql-slow.log | head -20

# æŸ¥çœ‹å½“å‰æ…¢æŸ¥è¯¢
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;

# åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM table_name WHERE condition;
```

3. **ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡**

```bash
# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
php bin/console cache:pool:stats cache.app --env=prod
php bin/console cache:pool:stats cache.system --env=prod

# Redisç¼“å­˜ç›‘æ§
redis-cli info stats
redis-cli info memory
```

4. **åˆ†æä»£ç æ‰§è¡Œè·¯å¾„**

```bash
# ä½¿ç”¨Xdebugåˆ†ææ€§èƒ½
# å®‰è£…Xdebug
pecl install xdebug

# é…ç½®php.ini
xdebug.mode=profile
xdebug.output_dir=/tmp

# åˆ†æç”Ÿæˆçš„æ€§èƒ½æ–‡ä»¶
# ä½¿ç”¨å·¥å…·å¦‚: qcachegrind /tmp/cachegrind.out.*
```

**æ€§èƒ½ä¼˜åŒ–å»ºè®®**:

| ä¼˜åŒ–é¢†åŸŸ | å…·ä½“æªæ–½                   | é¢„æœŸæ•ˆæœ           |
| -------- | -------------------------- | ------------------ |
| æ•°æ®åº“   | æ·»åŠ ç´¢å¼•ã€ä¼˜åŒ–æŸ¥è¯¢         | 50-80%æ€§èƒ½æå‡     |
| ç¼“å­˜     | å¯ç”¨ Redisã€ä¼˜åŒ–ç¼“å­˜ç­–ç•¥   | 30-60%å“åº”æ—¶é—´å‡å°‘ |
| ä»£ç      | ç®—æ³•ä¼˜åŒ–ã€å‡å°‘å¾ªç¯         | 20-40%æ€§èƒ½æå‡     |
| æœåŠ¡å™¨   | å¯ç”¨ OPcacheã€è°ƒæ•´ PHP-FPM | 15-30%æ€§èƒ½æå‡     |

#### 8.2.2 å†…å­˜ä½¿ç”¨è¿‡é«˜

**é—®é¢˜**: å†…å­˜å ç”¨æŒç»­å¢é•¿ï¼Œå¯èƒ½å¯¼è‡´ç³»ç»Ÿä¸ç¨³å®š

**è¯Šæ–­æ­¥éª¤**:

1. **å†…å­˜ä½¿ç”¨åˆ†æ**

```bash
# ç³»ç»Ÿå†…å­˜ä½¿ç”¨æƒ…å†µ
free -h
top -p $(pgrep php-fpm)

# PHPè¿›ç¨‹å†…å­˜ä½¿ç”¨
ps aux | grep php-fpm | awk '{print $6 " " $11}' | sort -nr

# å†…å­˜æ³„æ¼æ£€æµ‹
php -d memory_limit=-1 bin/console your:command
```

2. **ç¼“å­˜é…ç½®æ£€æŸ¥**

```bash
# æ£€æŸ¥ç¼“å­˜å¤§å°
du -sh var/cache/prod/

# æ¸…ç†è¿‡æœŸç¼“å­˜
php bin/console cache:pool:clear cache.app --env=prod

# ç›‘æ§Rediså†…å­˜ä½¿ç”¨
redis-cli info memory | grep used_memory_human
```

3. **æ•°æ®å¤„ç†é€»è¾‘ä¼˜åŒ–**

```bash
# æ£€æŸ¥å¤§æŸ¥è¯¢
php bin/console doctrine:query:sql "SELECT COUNT(*) FROM large_table"

# åˆ†æ‰¹å¤„ç†å¤§æ•°æ®
php bin/console app:process-large-data --batch-size=1000
```

4. **ä»£ç å®¡æŸ¥**

```bash
# ä½¿ç”¨é™æ€åˆ†æå·¥å…·
composer require --dev phpstan/phpstan
./vendor/bin/phpstan analyse src/

# æ£€æŸ¥å¾ªç¯å¼•ç”¨
php -d memory_limit=128M -r "
// æ£€æµ‹å¾ªç¯å¼•ç”¨çš„ä»£ç ç¤ºä¾‹
\$data = [];
\$data['self'] = &\$data;
var_dump(memory_get_usage());
unset(\$data);
var_dump(memory_get_usage());
"
```

**å†…å­˜ä¼˜åŒ–é…ç½®**:

```ini
; php.ini ä¼˜åŒ–é…ç½®
memory_limit = 256M
max_execution_time = 300
max_input_vars = 3000
opcache.enable = 1
opcache.memory_consumption = 128
opcache.max_accelerated_files = 4000
```

#### 8.2.3 CPU ä½¿ç”¨ç‡é«˜

**é—®é¢˜**: CPU æŒç»­é«˜è´Ÿè½½ï¼Œå½±å“ç³»ç»Ÿæ•´ä½“æ€§èƒ½

**æ’æŸ¥æ­¥éª¤**:

1. **CPU ä½¿ç”¨åˆ†æ**

```bash
# æŸ¥çœ‹CPUä½¿ç”¨æƒ…å†µ
top -p $(pgrep php-fpm)
htop

# æŸ¥çœ‹CPUå¯†é›†å‹è¿›ç¨‹
ps aux --sort=-%cpu | head -10

# ç³»ç»Ÿè´Ÿè½½åˆ†æ
uptime
vmstat 1 5
```

2. **PHP-FPM è¿›ç¨‹ä¼˜åŒ–**

```bash
# æŸ¥çœ‹PHP-FPMè¿›ç¨‹çŠ¶æ€
ps aux | grep php-fpm
cat /etc/php/8.2/fpm/pool.d/www.conf | grep -E "pm|max_children|start_servers"

# è°ƒæ•´PHP-FPMé…ç½®
# /etc/php/8.2/fpm/pool.d/www.conf
pm = dynamic
pm.max_children = 50
pm.start_servers = 5
pm.min_spare_servers = 5
pm.max_spare_servers = 35
pm.max_requests = 500
```

3. **æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–**

```bash
# æŸ¥çœ‹æ´»è·ƒæŸ¥è¯¢
SHOW FULL PROCESSLIST;

# æ€æ­»é•¿æ—¶é—´è¿è¡Œçš„æŸ¥è¯¢
KILL QUERY_ID;

# ä¼˜åŒ–é…ç½®
# /etc/mysql/mysql.conf.d/mysqld.cnf
innodb_buffer_pool_size = 1G
query_cache_size = 64M
max_connections = 100
```

4. **ä»£ç æ€§èƒ½åˆ†æ**

```bash
# ä½¿ç”¨Blackfireè¿›è¡Œæ€§èƒ½åˆ†æ
# å®‰è£…Blackfire
wget -O - https://packagecloud.io/gpg.key | apt-key add -
echo "deb http://packages.blackfire.io/debian any main" > /etc/apt/sources.list.d/blackfire.list
apt-get update && apt-get install blackfire-php

# åˆ†ææ€§èƒ½
blackfire run php bin/console your:command
```

#### 8.2.2 å†…å­˜ä½¿ç”¨è¿‡é«˜

**å¯èƒ½åŸå› **:

-   å†…å­˜æ³„æ¼
-   ç¼“å­˜é…ç½®ä¸å½“
-   å¤§æ•°æ®å¤„ç†é—®é¢˜
-   å¾ªç¯å¼•ç”¨

**æ’æŸ¥æ–¹æ³•**:

-   å†…å­˜ä½¿ç”¨åˆ†æ
-   ç¼“å­˜é…ç½®æ£€æŸ¥
-   æ•°æ®å¤„ç†é€»è¾‘ä¼˜åŒ–
-   ä»£ç å®¡æŸ¥

### 8.3 å®‰å…¨äº‹ä»¶å¤„ç†

#### 8.3.1 ç–‘ä¼¼æ”»å‡»æ£€æµ‹

**æ£€æµ‹æŒ‡æ ‡**:

-   å¼‚å¸¸è®¿é—®æ¨¡å¼
-   å¤§é‡å¤±è´¥ç™»å½•
-   å¼‚å¸¸ API è°ƒç”¨
-   æ•°æ®è®¿é—®å¼‚å¸¸

**é—®é¢˜**: ç³»ç»Ÿå¯èƒ½é­å—æ¶æ„æ”»å‡»æˆ–æœªæˆæƒè®¿é—®

**å¿«é€Ÿè¯Šæ–­è„šæœ¬**:

```bash
# ä½¿ç”¨æ•…éšœæ’é™¤åŠ©æ‰‹
./scripts/troubleshooting_helper.sh
# é€‰æ‹©é€‰é¡¹ 5: å®‰å…¨äº‹ä»¶å¤„ç†
```

**æ£€æµ‹æŒ‡æ ‡å’Œç›‘æ§**:

1. **å¼‚å¸¸è®¿é—®æ¨¡å¼æ£€æµ‹**

```bash
# æ£€æŸ¥å¼‚å¸¸IPè®¿é—®
awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10

# æ£€æŸ¥å¯ç–‘User-Agent
grep -E "bot|crawler|scanner|sqlmap" /var/log/nginx/access.log | tail -20

# æ£€æŸ¥å¼‚å¸¸è¯·æ±‚é¢‘ç‡
awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | awk '$1 > 100 {print $2 " - " $1 " requests"}'
```

2. **å¤±è´¥ç™»å½•ç›‘æ§**

```bash
# æ£€æŸ¥SSHå¤±è´¥ç™»å½•
grep "Failed password" /var/log/auth.log | tail -20

# æ£€æŸ¥Webåº”ç”¨å¤±è´¥ç™»å½•
grep "401\|403" /var/log/nginx/access.log | tail -20

# ç»Ÿè®¡å¤±è´¥ç™»å½•IP
grep "Failed password" /var/log/auth.log | awk '{print $(NF-3)}' | sort | uniq -c | sort -nr | head -10
```

3. **å¼‚å¸¸ API è°ƒç”¨æ£€æµ‹**

```bash
# æ£€æŸ¥APIå¼‚å¸¸è°ƒç”¨
grep -E "500|502|503" /var/log/nginx/access.log | tail -10

# æ£€æŸ¥å¤§é‡APIè°ƒç”¨
awk '$7 ~ /\/api\// {print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -nr | head -10

# æ£€æŸ¥å¼‚å¸¸è¯·æ±‚æ–¹æ³•
awk '$6 != "GET" && $6 != "POST" {print $0}' /var/log/nginx/access.log | tail -10
```

4. **æ•°æ®è®¿é—®å¼‚å¸¸ç›‘æ§**

```bash
# æ£€æŸ¥æ•°æ®åº“å¼‚å¸¸æŸ¥è¯¢
grep -i "error\|failed\|denied" /var/log/mysql/error.log | tail -10

# æ£€æŸ¥æ–‡ä»¶è®¿é—®å¼‚å¸¸
grep -i "permission denied\|no such file" /var/log/syslog | tail -10
```

**å®‰å…¨äº‹ä»¶å“åº”æµç¨‹**:

```bash
#!/bin/bash
# å®‰å…¨äº‹ä»¶åº”æ€¥å“åº”è„šæœ¬

# 1. ç«‹å³éš”ç¦»å—å½±å“ç³»ç»Ÿ
isolate_system() {
    echo "æ­£åœ¨éš”ç¦»å—å½±å“ç³»ç»Ÿ..."

    # å°é”æ¶æ„IP
    malicious_ips=$(grep "Failed password" /var/log/auth.log | awk '{print $(NF-3)}' | sort | uniq -c | awk '$1 > 10 {print $2}')

    for ip in $malicious_ips; do
        iptables -A INPUT -s $ip -j DROP
        echo "å·²å°é”IP: $ip"
    done

    # ä¸´æ—¶å…³é—­ä¸å¿…è¦çš„æœåŠ¡
    systemctl stop vsftpd 2>/dev/null
    systemctl stop telnet 2>/dev/null
}

# 2. æ”¶é›†å’Œåˆ†ææ—¥å¿—
collect_logs() {
    echo "æ”¶é›†å®‰å…¨ç›¸å…³æ—¥å¿—..."

    mkdir -p /tmp/security_incident_$(date +%Y%m%d_%H%M%S)
    cd /tmp/security_incident_$(date +%Y%m%d_%H%M%S)

    # æ”¶é›†ç³»ç»Ÿæ—¥å¿—
    cp /var/log/auth.log .
    cp /var/log/nginx/access.log .
    cp /var/log/nginx/error.log .
    cp /var/log/mysql/error.log .

    # ç”Ÿæˆåˆ†ææŠ¥å‘Š
    echo "=== å®‰å…¨äº‹ä»¶åˆ†ææŠ¥å‘Š ===" > incident_report.txt
    echo "ç”Ÿæˆæ—¶é—´: $(date)" >> incident_report.txt
    echo "" >> incident_report.txt

    echo "=== å¤±è´¥ç™»å½•ç»Ÿè®¡ ===" >> incident_report.txt
    grep "Failed password" auth.log | awk '{print $(NF-3)}' | sort | uniq -c | sort -nr >> incident_report.txt
}

# 3. è¯„ä¼°å½±å“èŒƒå›´
assess_impact() {
    echo "è¯„ä¼°å®‰å…¨äº‹ä»¶å½±å“èŒƒå›´..."

    # æ£€æŸ¥ç³»ç»Ÿå®Œæ•´æ€§
    find /www/wwwroot -type f -perm /o+w 2>/dev/null > world_writable_files.txt

    # æ£€æŸ¥æ–°å¢ç”¨æˆ·
    tail -20 /etc/passwd > recent_users.txt

    # æ£€æŸ¥è®¡åˆ’ä»»åŠ¡
    tail -20 /var/log/cron.log > recent_cron.txt
}

# 4. å®æ–½æ¢å¤æªæ–½
recover_system() {
    echo "å®æ–½ç³»ç»Ÿæ¢å¤æªæ–½..."

    # é‡ç½®å…³é”®æ–‡ä»¶æƒé™
    chown -R www-data:www-data /www/wwwroot
    find /www/wwwroot -type f -exec chmod 644 {} \;
    find /www/wwwroot -type d -exec chmod 755 {} \;

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    find /tmp -type f -mtime +7 -delete

    # é‡å¯å…³é”®æœåŠ¡
    systemctl restart nginx
    systemctl restart php8.2-fpm
}

# 5. åŠ å¼ºå®‰å…¨é˜²æŠ¤
enhance_security() {
    echo "åŠ å¼ºç³»ç»Ÿå®‰å…¨é˜²æŠ¤..."

    # æ›´æ–°ç³»ç»Ÿ
    apt-get update && apt-get upgrade -y

    # å®‰è£…å®‰å…¨å·¥å…·
    apt-get install -y fail2ban rkhunter chkrootkit

    # é…ç½®fail2ban
    cat > /etc/fail2ban/jail.local << EOF
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 3

[sshd]
enabled = true
port = ssh
logpath = /var/log/auth.log

[nginx-http-auth]
enabled = true
port = http,https
logpath = /var/log/nginx/error.log
EOF

    systemctl restart fail2ban
}

# æ‰§è¡Œåº”æ€¥å“åº”
isolate_system
collect_logs
assess_impact
recover_system
enhance_security

echo "å®‰å…¨äº‹ä»¶å“åº”å®Œæˆï¼"
```

**å¸¸è§æ”»å‡»ç±»å‹åŠé˜²å¾¡æªæ–½**:

| æ”»å‡»ç±»å‹  | æ£€æµ‹æ–¹æ³•           | é˜²å¾¡æªæ–½             |
| --------- | ------------------ | -------------------- |
| æš´åŠ›ç ´è§£  | ç›‘æ§å¤±è´¥ç™»å½•æ¬¡æ•°   | fail2banã€è´¦æˆ·é”å®š   |
| SQL æ³¨å…¥  | æ£€æŸ¥å¼‚å¸¸æ•°æ®åº“æŸ¥è¯¢ | å‚æ•°åŒ–æŸ¥è¯¢ã€è¾“å…¥éªŒè¯ |
| XSS æ”»å‡»  | æ£€æŸ¥å¼‚å¸¸ HTTP è¯·æ±‚ | è¾“å‡ºç¼–ç ã€CSP ç­–ç•¥   |
| CSRF æ”»å‡» | æ£€æŸ¥è·¨ç«™è¯·æ±‚æ¨¡å¼   | CSRF ä»¤ç‰ŒéªŒè¯        |
| DDoS æ”»å‡» | ç›‘æ§è¯·æ±‚é¢‘ç‡å¼‚å¸¸   | é™æµã€CDN é˜²æŠ¤       |

#### 8.3.2 æ•°æ®æ³„éœ²å¤„ç†

**é—®é¢˜**: å‘ç°æ•°æ®æ³„éœ²æˆ–æ•æ„Ÿä¿¡æ¯æš´éœ²

**åº”æ€¥å¤„ç†æ­¥éª¤**:

1. **ç«‹å³å“åº”æªæ–½**

```bash
# åœæ­¢æ•°æ®å¯¼å‡ºæœåŠ¡
systemctl stop mysql 2>/dev/null
systemctl stop nginx 2>/dev/null

# å¤‡ä»½å½“å‰çŠ¶æ€
mkdir -p /tmp/incident_backup_$(date +%Y%m%d_%H%M%S)
cp -r /www/wwwroot /tmp/incident_backup_$(date +%Y%m%d_%H%M%S)/
mysqldump --all-databases > /tmp/incident_backup_$(date +%Y%m%d_%H%M%S)/full_backup.sql
```

2. **æ³„éœ²èŒƒå›´è¯„ä¼°**

```bash
# æ£€æŸ¥æ–‡ä»¶è®¿é—®æ—¥å¿—
find /www/wwwroot -name "*.log" -exec grep -l "password\|token\|secret" {} \;

# æ£€æŸ¥æ•°æ®åº“è®¿é—®è®°å½•
mysql -e "SELECT user, host, db, command, time, state FROM information_schema.processlist WHERE command != 'Sleep';"

# åˆ†æç½‘ç»œè¿æ¥
netstat -tulpn | grep -E ":80|:443|:3306"
```

3. **æ•°æ®ä¿®å¤å’ŒåŠ å›º**

```bash
# é‡æ–°ç”Ÿæˆå¯†é’¥
php bin/console lexik:jwt:generate-keypair --env=prod

# æ›´æ–°æ‰€æœ‰å¯†ç 
mysql -e "UPDATE user SET password = PASSWORD('new_strong_password') WHERE user != 'root';"

# åŠ å¯†æ•æ„Ÿé…ç½®æ–‡ä»¶
openssl enc -aes-256-cbc -salt -in .env.local -out .env.local.enc
```

4. **é€šçŸ¥å’ŒæŠ¥å‘Š**

```bash
# ç”Ÿæˆäº‹ä»¶æŠ¥å‘Š
cat > /tmp/data_leak_report.txt << EOF
æ•°æ®æ³„éœ²äº‹ä»¶æŠ¥å‘Š
================
äº‹ä»¶æ—¶é—´: $(date)
å½±å“èŒƒå›´: [è¯¦ç»†æè¿°]
å·²é‡‡å–æªæ–½: [åˆ—å‡ºæªæ–½]
åç»­è®¡åˆ’: [æ”¹è¿›è®¡åˆ’]
EOF

# å‘é€é€šçŸ¥é‚®ä»¶
mail -s "å®‰å…¨äº‹ä»¶: æ•°æ®æ³„éœ²" security-team@company.com < /tmp/data_leak_report.txt
```

**å¤„ç†æµç¨‹**:

1. ç«‹å³éš”ç¦»å—å½±å“ç³»ç»Ÿ
2. æ”¶é›†å’Œåˆ†ææ—¥å¿—
3. è¯„ä¼°å½±å“èŒƒå›´
4. å®æ–½ä¿®å¤æªæ–½
5. åŠ å¼ºå®‰å…¨é˜²æŠ¤

### 8.4 æ•…éšœæ¢å¤æµç¨‹

**é—®é¢˜**: ç³»ç»ŸæœåŠ¡ä¸­æ–­ï¼Œéœ€è¦å¿«é€Ÿæ¢å¤

**æ¢å¤æµç¨‹**:

1. **è¯„ä¼°æ•…éšœå½±å“**

```bash
# å¿«é€Ÿè¯Šæ–­è„šæœ¬
./scripts/system_diagnosis.sh

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
systemctl status nginx php8.2-fpm mysql

# è¯„ä¼°å½±å“èŒƒå›´
ps aux | grep -E "(nginx|php|mysql)" | grep -v grep
netstat -tulpn | grep -E ":80|:443|:3306"
```

2. **å¯åŠ¨åº”æ€¥å“åº”**

```bash
#!/bin/bash
# åº”æ€¥å“åº”è„šæœ¬

# ç«‹å³é‡å¯å…³é”®æœåŠ¡
restart_critical_services() {
    echo "é‡å¯å…³é”®æœåŠ¡..."

    # é‡å¯WebæœåŠ¡å™¨
    systemctl restart nginx
    if systemctl is-active --quiet nginx; then
        echo "âœ… Nginxé‡å¯æˆåŠŸ"
    else
        echo "âŒ Nginxé‡å¯å¤±è´¥"
    fi

    # é‡å¯PHP-FPM
    systemctl restart php8.2-fpm
    if pgrep -f "php-fpm" > /dev/null; then
        echo "âœ… PHP-FPMé‡å¯æˆåŠŸ"
    else
        echo "âŒ PHP-FPMé‡å¯å¤±è´¥"
    fi

    # é‡å¯æ•°æ®åº“
    systemctl restart mysql
    if systemctl is-active --quiet mysql; then
        echo "âœ… MySQLé‡å¯æˆåŠŸ"
    else
        echo "âŒ MySQLé‡å¯å¤±è´¥"
    fi
}

# æ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶
cleanup_system() {
    echo "æ¸…ç†ç³»ç»Ÿç¼“å­˜..."

    # æ¸…ç†Symfonyç¼“å­˜
    php bin/console cache:clear --env=prod

    # æ¸…ç†ç³»ç»Ÿä¸´æ—¶æ–‡ä»¶
    find /tmp -name "php*" -mtime +1 -delete
    find /tmp -name "sess_*" -mtime +1 -delete

    # æ¸…ç†æ—¥å¿—æ–‡ä»¶
    find /var/log -name "*.log" -size +100M -exec truncate -s 50M {} \;
}

# æ£€æŸ¥ç³»ç»Ÿèµ„æº
check_resources() {
    echo "æ£€æŸ¥ç³»ç»Ÿèµ„æº..."

    # æ£€æŸ¥ç£ç›˜ç©ºé—´
    df -h | grep -E "/$|/var|/tmp"

    # æ£€æŸ¥å†…å­˜ä½¿ç”¨
    free -h

    # æ£€æŸ¥CPUè´Ÿè½½
    uptime

    # å¦‚æœèµ„æºä¸è¶³ï¼Œæ‰§è¡Œæ¸…ç†
    disk_usage=$(df / | awk 'NR==2 {print $5}' | cut -d'%' -f1)
    if [[ $disk_usage -gt 90 ]]; then
        echo "ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œæ‰§è¡Œæ¸…ç†..."
        find /var/log -name "*.log.*" -delete
        apt-get clean
    fi
}

# æ‰§è¡Œåº”æ€¥å“åº”
restart_critical_services
cleanup_system
check_resources

echo "åº”æ€¥å“åº”å®Œæˆï¼"
```

3. **æ‰§è¡Œæ¢å¤æ–¹æ¡ˆ**

```bash
# å®Œæ•´æ¢å¤è„šæœ¬
#!/bin/bash

full_recovery() {
    echo "å¼€å§‹å®Œæ•´æ¢å¤æµç¨‹..."

    # 1. å¤‡ä»½å½“å‰çŠ¶æ€
    backup_current_state() {
        echo "å¤‡ä»½å½“å‰çŠ¶æ€..."
        mkdir -p /tmp/emergency_backup_$(date +%Y%m%d_%H%M%S)

        # å¤‡ä»½é…ç½®æ–‡ä»¶
        cp -r /etc/nginx /tmp/emergency_backup_$(date +%Y%m%d_%H%M%S)/
        cp -r /etc/php /tmp/emergency_backup_$(date +%Y%m%d_%H%M%S)/
        cp -r /etc/mysql /tmp/emergency_backup_$(date +%Y%m%d_%H%M%S)/

        # å¤‡ä»½åº”ç”¨æ•°æ®
        mysqldump --all-databases > /tmp/emergency_backup_$(date +%Y%m%d_%H%M%S)/full_backup.sql
    }

    # 2. ä¿®å¤é…ç½®æ–‡ä»¶
    fix_configurations() {
        echo "ä¿®å¤é…ç½®æ–‡ä»¶..."

        # é‡æ–°ç”Ÿæˆé…ç½®
        nginx -t
        if [[ $? -ne 0 ]]; then
            # ä½¿ç”¨å¤‡ä»½é…ç½®
            cp /etc/nginx/sites-available/default.backup /etc/nginx/sites-available/default
        fi

        # æ£€æŸ¥PHPé…ç½®
        php -v
        if [[ $? -ne 0 ]]; then
            # é‡æ–°åŠ è½½PHPé…ç½®
            systemctl reload php8.2-fpm
        fi
    }

    # 3. æ¢å¤æœåŠ¡
    restore_services() {
        echo "æ¢å¤æœåŠ¡..."

        # æŒ‰ä¾èµ–é¡ºåºé‡å¯æœåŠ¡
        systemctl restart mysql
        sleep 5
        systemctl restart php8.2-fpm
        sleep 3
        systemctl restart nginx

        # éªŒè¯æœåŠ¡çŠ¶æ€
        systemctl status mysql php8.2-fpm nginx
    }

    # 4. éªŒè¯åŠŸèƒ½
    verify_functionality() {
        echo "éªŒè¯ç³»ç»ŸåŠŸèƒ½..."

        # æµ‹è¯•æ•°æ®åº“è¿æ¥
        mysql -e "SELECT 1;" &>/dev/null && echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸" || echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"

        # æµ‹è¯•WebæœåŠ¡
        curl -s -o /dev/null -w "%{http_code}" http://localhost | grep -q "200" && echo "âœ… WebæœåŠ¡æ­£å¸¸" || echo "âŒ WebæœåŠ¡å¼‚å¸¸"

        # æµ‹è¯•API
        curl -s -o /dev/null -w "%{http_code}" http://localhost/api | grep -q "200" && echo "âœ… APIæœåŠ¡æ­£å¸¸" || echo "âŒ APIæœåŠ¡å¼‚å¸¸"
    }

    backup_current_state
    fix_configurations
    restore_services
    verify_functionality
}

full_recovery
```

4. **éªŒè¯æœåŠ¡æ¢å¤**

```bash
# æœåŠ¡éªŒè¯è„šæœ¬
verify_recovery() {
    echo "éªŒè¯æœåŠ¡æ¢å¤çŠ¶æ€..."

    # æ£€æŸ¥æ‰€æœ‰å…³é”®æœåŠ¡
    services=("nginx" "php8.2-fpm" "mysql")

    for service in "${services[@]}"; do
        if systemctl is-active --quiet "$service"; then
            echo "âœ… $service è¿è¡Œæ­£å¸¸"
        else
            echo "âŒ $service æœªè¿è¡Œ"
        fi
    done

    # åŠŸèƒ½æµ‹è¯•
    echo "æ‰§è¡ŒåŠŸèƒ½æµ‹è¯•..."

    # æµ‹è¯•é¦–é¡µ
    response_code=$(curl -s -o /dev/null -w "%{http_code}" http://localhost)
    if [[ "$response_code" == "200" ]]; then
        echo "âœ… é¦–é¡µè®¿é—®æ­£å¸¸"
    else
        echo "âŒ é¦–é¡µè®¿é—®å¼‚å¸¸ (HTTP $response_code)"
    fi

    # æµ‹è¯•APIå¥åº·æ£€æŸ¥
    api_response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/api/health)
    if [[ "$api_response" == "200" ]]; then
        echo "âœ… APIå¥åº·æ£€æŸ¥æ­£å¸¸"
    else
        echo "âŒ APIå¥åº·æ£€æŸ¥å¼‚å¸¸ (HTTP $api_response)"
    fi

    # æµ‹è¯•æ•°æ®åº“è¿æ¥
    if mysql -e "SELECT 1;" &>/dev/null; then
        echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
    else
        echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
    fi
}

verify_recovery
```

5. **æ€»ç»“ç»éªŒæ•™è®­**

```bash
# ç”Ÿæˆæ•…éšœæŠ¥å‘Š
generate_incident_report() {
    local report_file="/var/log/incident_report_$(date +%Y%m%d_%H%M%S).md"

    cat > "$report_file" << EOF
# æ•…éšœæ¢å¤æŠ¥å‘Š

## åŸºæœ¬ä¿¡æ¯
- **æ•…éšœæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
- **æ¢å¤æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
- **å½±å“æ—¶é•¿**: è®¡ç®—æ—¶é•¿
- **å½±å“èŒƒå›´**: [æè¿°å½±å“çš„æœåŠ¡å’Œç”¨æˆ·]

## æ•…éšœæè¿°
[è¯¦ç»†æè¿°æ•…éšœç°è±¡å’Œå½±å“]

## æ ¹æœ¬åŸå› 
[åˆ†ææ•…éšœçš„æ ¹æœ¬åŸå› ]

## æ¢å¤æªæ–½
[åˆ—å‡ºé‡‡å–çš„æ¢å¤æªæ–½]

## é¢„é˜²æªæ–½
[æå‡ºé¢„é˜²ç±»ä¼¼æ•…éšœçš„æªæ–½]

## ç»éªŒæ•™è®­
[æ€»ç»“ç»éªŒæ•™è®­å’Œæ”¹è¿›å»ºè®®]

---
*æŠ¥å‘Šç”Ÿæˆæ—¶é—´: $(date)*
EOF

    echo "æ•…éšœæŠ¥å‘Šå·²ç”Ÿæˆ: $report_file"
}

generate_incident_report
```

#### 8.4.2 æ•°æ®æŸåæ¢å¤

**é—®é¢˜**: æ•°æ®åº“æˆ–æ–‡ä»¶æ•°æ®æŸåï¼Œéœ€è¦æ¢å¤

**æ¢å¤æµç¨‹**:

1. **åœæ­¢ç›¸å…³æœåŠ¡**

```bash
#!/bin/bash
# æ•°æ®æŸååº”æ€¥å¤„ç†

stop_services() {
    echo "åœæ­¢ç›¸å…³æœåŠ¡..."

    # åœæ­¢WebæœåŠ¡ï¼Œé˜²æ­¢è¿›ä¸€æ­¥å†™å…¥
    systemctl stop nginx
    systemctl stop php8.2-fpm

    # åœæ­¢æ•°æ®åº“æœåŠ¡
    systemctl stop mysql

    echo "æ‰€æœ‰ç›¸å…³æœåŠ¡å·²åœæ­¢"
}
```

2. **è¯„ä¼°æ•°æ®æŸåèŒƒå›´**

```bash
assess_data_corruption() {
    echo "è¯„ä¼°æ•°æ®æŸåèŒƒå›´..."

    # æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§
    check_database_integrity() {
        echo "æ£€æŸ¥æ•°æ®åº“å®Œæ•´æ€§..."

        # æ£€æŸ¥MySQLæ•°æ®æ–‡ä»¶
        mysql_check_result=$(mysqlcheck --check --all-databases 2>&1)
        echo "$mysql_check_result" > /tmp/mysql_check_result.log

        # æ£€æŸ¥è¡¨æŸåæƒ…å†µ
        corrupted_tables=$(mysql -e "SELECT table_schema, table_name FROM information_schema.tables WHERE table_type = 'BASE TABLE' AND table_schema NOT IN ('information_schema', 'mysql', 'performance_schema');" | while read schema table; do
            if [[ -n "$schema" && -n "$table" ]]; then
                check_result=$(mysqlcheck -c "$schema" "$table" 2>&1)
                if [[ "$check_result" == *"error"* ]]; then
                    echo "$schema.$table:æŸå"
                fi
            fi
        done)

        if [[ -n "$corrupted_tables" ]]; then
            echo "å‘ç°æŸåçš„è¡¨:"
            echo "$corrupted_tables"
        else
            echo "æœªå‘ç°æ˜æ˜¾çš„æ•°æ®æŸå"
        fi
    }

    # æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿå®Œæ•´æ€§
    check_filesystem_integrity() {
        echo "æ£€æŸ¥æ–‡ä»¶ç³»ç»Ÿå®Œæ•´æ€§..."

        # æ£€æŸ¥é‡è¦æ–‡ä»¶
        critical_files=(
            "/www/wwwroot/official_website_backend/.env.local"
            "/www/wwwroot/official_website_backend/config/packages/security.yaml"
            "/www/wwwroot/official_website_backend/public/index.php"
        )

        for file in "${critical_files[@]}"; do
            if [[ -f "$file" ]]; then
                file_size=$(stat -c%s "$file")
                if [[ $file_size -eq 0 ]]; then
                    echo "âš ï¸  æ–‡ä»¶ä¸ºç©º: $file"
                elif [[ $file_size -lt 100 ]]; then
                    echo "âš ï¸  æ–‡ä»¶è¿‡å°: $file ($file_size bytes)"
                else
                    echo "âœ… æ–‡ä»¶æ­£å¸¸: $file ($file_size bytes)"
                fi
            else
                echo "âŒ æ–‡ä»¶ç¼ºå¤±: $file"
            fi
        done
    }

    check_database_integrity
    check_filesystem_integrity
}
```

3. **é€‰æ‹©æ¢å¤ç­–ç•¥**

```bash
choose_recovery_strategy() {
    echo "é€‰æ‹©æ¢å¤ç­–ç•¥..."

    # ç­–ç•¥1: ä»å¤‡ä»½æ¢å¤
    restore_from_backup() {
        local backup_file="$1"

        echo "ä»å¤‡ä»½æ¢å¤: $backup_file"

        # éªŒè¯å¤‡ä»½æ–‡ä»¶
        if [[ ! -f "$backup_file" ]]; then
            echo "âŒ å¤‡ä»½æ–‡ä»¶ä¸å­˜åœ¨: $backup_file"
            return 1
        fi

        # æ£€æŸ¥å¤‡ä»½å®Œæ•´æ€§
        if gzip -t "$backup_file" 2>/dev/null; then
            echo "âœ… å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§éªŒè¯é€šè¿‡"
        else
            echo "âŒ å¤‡ä»½æ–‡ä»¶æŸå"
            return 1
        fi

        return 0
    }

    # ç­–ç•¥2: ä½¿ç”¨äºŒè¿›åˆ¶æ—¥å¿—æ¢å¤
    restore_from_binlog() {
        echo "ä½¿ç”¨äºŒè¿›åˆ¶æ—¥å¿—æ¢å¤..."

        # æŸ¥çœ‹äºŒè¿›åˆ¶æ—¥å¿—
        mysql -e "SHOW BINARY LOGS;"

        # ä»æŒ‡å®šæ—¶é—´ç‚¹æ¢å¤
        read -p "è¾“å…¥æ¢å¤æ—¶é—´ç‚¹ (YYYY-MM-DD HH:MM:SS): " recovery_time

        mysqlbinlog --start-datetime="$recovery_time" /var/log/mysql/mysql-bin.* | mysql

        echo "äºŒè¿›åˆ¶æ—¥å¿—æ¢å¤å®Œæˆ"
    }

    # ç­–ç•¥3: ä¿®å¤æŸåçš„è¡¨
    repair_corrupted_tables() {
        echo "ä¿®å¤æŸåçš„è¡¨..."

        # ä¿®å¤æ‰€æœ‰æŸåçš„è¡¨
        mysql -e "SELECT CONCAT('REPAIR TABLE \`', table_schema, '\`.\`', table_name, '\`;') FROM information_schema.tables WHERE table_type = 'BASE TABLE' AND table_schema NOT IN ('information_schema', 'mysql', 'performance_schema');" | mysql

        echo "è¡¨ä¿®å¤å®Œæˆ"
    }

    # æ ¹æ®æƒ…å†µé€‰æ‹©ç­–ç•¥
    echo "å¯ç”¨æ¢å¤ç­–ç•¥:"
    echo "1. ä»å¤‡ä»½æ¢å¤"
    echo "2. ä½¿ç”¨äºŒè¿›åˆ¶æ—¥å¿—æ¢å¤"
    echo "3. ä¿®å¤æŸåçš„è¡¨"

    read -p "é€‰æ‹©ç­–ç•¥ (1-3): " strategy

    case $strategy in
        1)
            read -p "è¾“å…¥å¤‡ä»½æ–‡ä»¶è·¯å¾„: " backup_file
            restore_from_backup "$backup_file"
            ;;
        2)
            restore_from_binlog
            ;;
        3)
            repair_corrupted_tables
            ;;
        *)
            echo "æ— æ•ˆé€‰æ‹©"
            return 1
            ;;
    esac
}
```

4. **æ‰§è¡Œæ•°æ®æ¢å¤**

```bash
execute_data_recovery() {
    echo "æ‰§è¡Œæ•°æ®æ¢å¤..."

    # å®Œæ•´æ¢å¤æµç¨‹
    full_data_recovery() {
        echo "å¼€å§‹å®Œæ•´æ•°æ®æ¢å¤..."

        # 1. åœæ­¢æœåŠ¡
        stop_services

        # 2. å¤‡ä»½å½“å‰çŠ¶æ€
        backup_current_state() {
            echo "å¤‡ä»½å½“å‰æŸåçŠ¶æ€..."
            mkdir -p /tmp/corrupted_backup_$(date +%Y%m%d_%H%M%S)
            cp -r /var/lib/mysql /tmp/corrupted_backup_$(date +%Y%m%d_%H%M%S)/
            cp -r /www/wwwroot /tmp/corrupted_backup_$(date +%Y%m%d_%H%M%S)/
        }

        # 3. é€‰æ‹©å¹¶æ‰§è¡Œæ¢å¤ç­–ç•¥
        choose_recovery_strategy

        # 4. é‡å¯æœåŠ¡
        restart_services() {
            echo "é‡å¯æœåŠ¡..."
            systemctl start mysql
            sleep 10
            systemctl start php8.2-fpm
            sleep 5
            systemctl start nginx
        }

        # 5. éªŒè¯æ•°æ®å®Œæ•´æ€§
        verify_data_integrity() {
            echo "éªŒè¯æ•°æ®å®Œæ•´æ€§..."

            # æ£€æŸ¥æ•°æ®åº“
            mysql -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'your_database';"

            # æ£€æŸ¥åº”ç”¨æ•°æ®
            curl -s http://localhost/api/health | jq '.'
        }

        backup_current_state
        restart_services
        verify_data_integrity

        echo "æ•°æ®æ¢å¤å®Œæˆ"
    }

    full_data_recovery
}
```

5. **éªŒè¯æ•°æ®å®Œæ•´æ€§**

```bash
verify_data_integrity() {
    echo "éªŒè¯æ•°æ®å®Œæ•´æ€§..."

    # æ•°æ®åº“å®Œæ•´æ€§æ£€æŸ¥
    verify_database_integrity() {
        echo "éªŒè¯æ•°æ®åº“å®Œæ•´æ€§..."

        # æ£€æŸ¥æ‰€æœ‰è¡¨
        mysql -e "SELECT table_schema, table_name, table_rows FROM information_schema.tables WHERE table_schema NOT IN ('information_schema', 'mysql', 'performance_schema', 'sys') ORDER BY table_schema, table_name;"

        # æ£€æŸ¥å¤–é”®çº¦æŸ
        mysql -e "SELECT TABLE_SCHEMA, TABLE_NAME, CONSTRAINT_NAME FROM information_schema.TABLE_CONSTRAINTS WHERE CONSTRAINT_TYPE = 'FOREIGN KEY';"

        # æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
        mysql -e "SELECT table_schema, SUM(data_length + index_length) / 1024 / 1024 AS 'DB Size in MB' FROM information_schema.tables GROUP BY table_schema;"
    }

    # åº”ç”¨æ•°æ®éªŒè¯
    verify_application_data() {
        echo "éªŒè¯åº”ç”¨æ•°æ®..."

        # æµ‹è¯•APIç«¯ç‚¹
        api_endpoints=(
            "/api"
            "/api/health"
            "/api/docs"
        )

        for endpoint in "${api_endpoints[@]}"; do
            response=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost$endpoint")
            if [[ "$response" == "200" ]]; then
                echo "âœ… $endpoint æ­£å¸¸"
            else
                echo "âŒ $endpoint å¼‚å¸¸ (HTTP $response)"
            fi
        done

        # æ£€æŸ¥å…³é”®ä¸šåŠ¡æ•°æ®
        # è¿™é‡Œæ ¹æ®å®é™…ä¸šåŠ¡éœ€æ±‚æ·»åŠ å…·ä½“çš„æ•°æ®éªŒè¯é€»è¾‘
    }

    verify_database_integrity
    verify_application_data

    echo "æ•°æ®å®Œæ•´æ€§éªŒè¯å®Œæˆ"
}
```

**æ•°æ®æ¢å¤æœ€ä½³å®è·µ**:

| æ¢å¤ç±»å‹       | æ¢å¤æ—¶é—´ | æ•°æ®ä¸¢å¤±é£é™© | é€‚ç”¨åœºæ™¯     |
| -------------- | -------- | ------------ | ------------ |
| å®Œæ•´å¤‡ä»½æ¢å¤   | æ…¢       | é«˜           | ä¸¥é‡æ•°æ®æŸå |
| å¢é‡å¤‡ä»½æ¢å¤   | ä¸­ç­‰     | ä¸­ç­‰         | éƒ¨åˆ†æ•°æ®æŸå |
| äºŒè¿›åˆ¶æ—¥å¿—æ¢å¤ | å¿«       | ä½           | è¯¯åˆ é™¤æ“ä½œ   |
| è¡¨ä¿®å¤         | æœ€å¿«     | æä½         | å•è¡¨æŸå     |

#### 8.4.3 æ•…éšœé¢„é˜²æªæ–½

**é—®é¢˜**: é¢„é˜²æœªæ¥æ•…éšœå‘ç”Ÿ

**é¢„é˜²ç­–ç•¥**:

1. **å¥åº·æ£€æŸ¥æœºåˆ¶**

```bash
# è‡ªåŠ¨å¥åº·æ£€æŸ¥è„šæœ¬
#!/bin/bash

daily_health_check() {
    echo "æ‰§è¡Œæ¯æ—¥å¥åº·æ£€æŸ¥..."

    # ç³»ç»Ÿèµ„æºæ£€æŸ¥
    check_system_resources() {
        echo "æ£€æŸ¥ç³»ç»Ÿèµ„æº..."

        # CPUä½¿ç”¨ç‡
        cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
        if (( $(echo "$cpu_usage > 80" | bc -l) )); then
            echo "âš ï¸  CPUä½¿ç”¨ç‡è¿‡é«˜: $cpu_usage%"
        fi

        # å†…å­˜ä½¿ç”¨ç‡
        memory_usage=$(free | awk '/Mem:/ {printf "%.1f", $3/$2 * 100.0}')
        if (( $(echo "$memory_usage > 85" | bc -l) )); then
            echo "âš ï¸  å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜: $memory_usage%"
        fi

        # ç£ç›˜ä½¿ç”¨ç‡
        disk_usage=$(df / | awk 'NR==2 {print $5}' | cut -d'%' -f1)
        if [[ $disk_usage -gt 90 ]]; then
            echo "âš ï¸  ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜: $disk_usage%"
        fi
    }

    # æœåŠ¡çŠ¶æ€æ£€æŸ¥
    check_service_status() {
        echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€..."

        services=("nginx" "php8.2-fpm" "mysql")
        for service in "${services[@]}"; do
            if ! systemctl is-active --quiet "$service"; then
                echo "âŒ $service æœªè¿è¡Œ"
                # è‡ªåŠ¨é‡å¯æœåŠ¡
                systemctl restart "$service"
                echo "ğŸ”„ å·²å°è¯•é‡å¯ $service"
            fi
        done
    }

    # åº”ç”¨åŠŸèƒ½æ£€æŸ¥
    check_application_functionality() {
        echo "æ£€æŸ¥åº”ç”¨åŠŸèƒ½..."

        # æµ‹è¯•APIå¥åº·æ£€æŸ¥
        health_response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/api/health)
        if [[ "$health_response" != "200" ]]; then
            echo "âŒ APIå¥åº·æ£€æŸ¥å¤±è´¥ (HTTP $health_response)"
            # æ¸…ç†ç¼“å­˜
            php bin/console cache:clear --env=prod
        fi

        # æµ‹è¯•æ•°æ®åº“è¿æ¥
        if ! mysql -e "SELECT 1;" &>/dev/null; then
            echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
            # å°è¯•é‡å¯æ•°æ®åº“
            systemctl restart mysql
        fi
    }

    check_system_resources
    check_service_status
    check_application_functionality

    echo "æ¯æ—¥å¥åº·æ£€æŸ¥å®Œæˆ"
}

# è®¾ç½®å®šæ—¶ä»»åŠ¡
echo "0 6 * * * /path/to/health_check.sh >> /var/log/health_check.log 2>&1" | crontab -
```

2. **é¢„è­¦æœºåˆ¶**

```bash
# é¢„è­¦è„šæœ¬
#!/bin/bash

send_alert() {
    local severity="$1"
    local message="$2"

    # å‘é€é‚®ä»¶é¢„è­¦
    echo "$message" | mail -s "[ALERT] $severity" admin@example.com

    # å‘é€Slacké€šçŸ¥
    if [[ -n "$SLACK_WEBHOOK" ]]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš¨ $severity: $message\"}" \
            "$SLACK_WEBHOOK"
    fi

    # è®°å½•é¢„è­¦æ—¥å¿—
    echo "$(date '+%Y-%m-%d %H:%M:%S') [$severity] $message" >> /var/log/alerts.log
}

# ç›‘æ§æŒ‡æ ‡
monitor_metrics() {
    # ç›‘æ§ç³»ç»Ÿè´Ÿè½½
    load_average=$(uptime | awk -F'load average:' '{print $2}' | cut -d, -f1 | tr -d ' ')
    if (( $(echo "$load_average > 2.0" | bc -l) )); then
        send_alert "WARNING" "ç³»ç»Ÿè´Ÿè½½è¿‡é«˜: $load_average"
    fi

    # ç›‘æ§é”™è¯¯æ—¥å¿—
    error_count=$(grep -c "ERROR" /var/log/nginx/error.log 2>/dev/null || echo "0")
    if [[ $error_count -gt 10 ]]; then
        send_alert "ERROR" "Nginxé”™è¯¯æ—¥å¿—è¿‡å¤š: $error_count"
    fi

    # ç›‘æ§æ•°æ®åº“è¿æ¥æ•°
    db_connections=$(mysql -e "SHOW STATUS LIKE 'Threads_connected';" | tail -1 | awk '{print $2}')
    max_connections=$(mysql -e "SHOW VARIABLES LIKE 'max_connections';" | tail -1 | awk '{print $2}')
    connection_usage=$((db_connections * 100 / max_connections))

    if [[ $connection_usage -gt 80 ]]; then
        send_alert "WARNING" "æ•°æ®åº“è¿æ¥ä½¿ç”¨ç‡è¿‡é«˜: $connection_usage%"
    fi
}

monitor_metrics
```

3. **å®šæœŸå·¡æ£€**

```bash
# å®šæœŸå·¡æ£€è„šæœ¬
#!/bin/bash

weekly_inspection() {
    echo "æ‰§è¡Œæ¯å‘¨ç³»ç»Ÿå·¡æ£€..."

    # ç³»ç»Ÿæ›´æ–°æ£€æŸ¥
    check_system_updates() {
        echo "æ£€æŸ¥ç³»ç»Ÿæ›´æ–°..."
        apt list --upgradable 2>/dev/null | grep -v "WARNING" > /tmp/updates.txt
        update_count=$(wc -l < /tmp/updates.txt)

        if [[ $update_count -gt 0 ]]; then
            echo "å‘ç° $update_count ä¸ªå¯ç”¨æ›´æ–°"
            send_alert "INFO" "ç³»ç»Ÿæœ‰ $update_count ä¸ªå¯ç”¨æ›´æ–°"
        fi
    }

    # å®‰å…¨æ£€æŸ¥
    security_check() {
        echo "æ‰§è¡Œå®‰å…¨æ£€æŸ¥..."

        # æ£€æŸ¥ç™»å½•å¤±è´¥
        failed_logins=$(grep "Failed password" /var/log/auth.log | wc -l)
        if [[ $failed_logins -gt 50 ]]; then
            send_alert "SECURITY" "æœ¬å‘¨å¤±è´¥ç™»å½•æ¬¡æ•°è¿‡å¤š: $failed_logins"
        fi

        # æ£€æŸ¥æ–‡ä»¶æƒé™å¼‚å¸¸
        world_writable=$(find /www/wwwroot -type f -perm /o+w 2>/dev/null | wc -l)
        if [[ $world_writable -gt 0 ]]; then
            send_alert "SECURITY" "å‘ç° $world_writable ä¸ªå…¨å±€å¯å†™æ–‡ä»¶"
        fi
    }

    # æ€§èƒ½åˆ†æ
    performance_analysis() {
        echo "æ‰§è¡Œæ€§èƒ½åˆ†æ..."

        # åˆ†ææ…¢æŸ¥è¯¢
        slow_queries=$(mysql -e "SELECT COUNT(*) FROM mysql.slow_log;" 2>/dev/null | tail -1 || echo "0")
        if [[ $slow_queries -gt 100 ]]; then
            send_alert "PERFORMANCE" "æœ¬å‘¨æ…¢æŸ¥è¯¢æ•°é‡: $slow_queries"
        fi

        # åˆ†ææ—¥å¿—å¤§å°
        log_size=$(du -sh /var/log/nginx/ | cut -f1)
        echo "Nginxæ—¥å¿—å¤§å°: $log_size"

        if [[ ${log_size%G} -gt 5 ]]; then
            send_alert "MAINTENANCE" "æ—¥å¿—æ–‡ä»¶è¿‡å¤§ï¼Œéœ€è¦æ¸…ç†: $log_size"
        fi
    }

    # å¤‡ä»½éªŒè¯
    backup_verification() {
        echo "éªŒè¯å¤‡ä»½å®Œæ•´æ€§..."

        # æ£€æŸ¥æœ€æ–°å¤‡ä»½
        latest_backup=$(find /backup -name "*.sql.gz" -type f -printf '%T@ %p\n' | sort -n | tail -1 | cut -d' ' -f2-)

        if [[ -n "$latest_backup" ]]; then
            backup_age=$(( ($(date +%s) - $(stat -c %Y "$latest_backup")) / 86400 ))

            if [[ $backup_age -gt 1 ]]; then
                send_alert "BACKUP" "å¤‡ä»½æ–‡ä»¶è¿‡æœŸ: $backup_age å¤©"
            fi

            # éªŒè¯å¤‡ä»½å®Œæ•´æ€§
            if gzip -t "$latest_backup" 2>/dev/null; then
                echo "âœ… æœ€æ–°å¤‡ä»½å®Œæ•´æ€§éªŒè¯é€šè¿‡"
            else
                send_alert "BACKUP" "æœ€æ–°å¤‡ä»½æ–‡ä»¶æŸå"
            fi
        else
            send_alert "BACKUP" "æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
        fi
    }

    check_system_updates
    security_check
    performance_analysis
    backup_verification

    echo "æ¯å‘¨ç³»ç»Ÿå·¡æ£€å®Œæˆ"
}

weekly_inspection
```

4. **è‡ªåŠ¨åŒ–ç»´æŠ¤**

```bash
# è‡ªåŠ¨åŒ–ç»´æŠ¤è„šæœ¬
#!/bin/bash

automated_maintenance() {
    echo "æ‰§è¡Œè‡ªåŠ¨åŒ–ç»´æŠ¤..."

    # æ—¥å¿—è½®è½¬
    log_rotation() {
        echo "æ‰§è¡Œæ—¥å¿—è½®è½¬..."

        # å‹ç¼©æ—§æ—¥å¿—
        find /var/log -name "*.log" -mtime +7 -exec gzip {} \;

        # åˆ é™¤æ—§æ—¥å¿—
        find /var/log -name "*.log.gz" -mtime +30 -delete

        # æ¸…ç†åº”ç”¨æ—¥å¿—
        find /www/wwwroot/var/log -name "*.log" -mtime +7 -delete
    }

    # ç¼“å­˜æ¸…ç†
    cache_cleanup() {
        echo "æ¸…ç†ç¼“å­˜..."

        # æ¸…ç†Symfonyç¼“å­˜
        php bin/console cache:clear --env=prod

        # æ¸…ç†ç³»ç»Ÿç¼“å­˜
        apt-get clean

        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        find /tmp -type f -mtime +7 -delete

        # æ¸…ç†ä¼šè¯æ–‡ä»¶
        find /var/lib/php/sessions -type f -mtime +1 -delete
    }

    # æ•°æ®åº“ä¼˜åŒ–
    database_optimization() {
        echo "ä¼˜åŒ–æ•°æ®åº“..."

        # ä¼˜åŒ–è¡¨
        mysql -e "SELECT CONCAT('OPTIMIZE TABLE \`', table_schema, '\`.\`', table_name, '\`;') FROM information_schema.tables WHERE table_schema NOT IN ('information_schema', 'mysql', 'performance_schema');" | mysql

        # æ¸…ç†äºŒè¿›åˆ¶æ—¥å¿—
        mysql -e "PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);"

        # åˆ†æè¡¨
        mysql -e "SELECT CONCAT('ANALYZE TABLE \`', table_schema, '\`.\`', table_name, '\`;') FROM information_schema.tables WHERE table_schema NOT IN ('information_schema', 'mysql', 'performance_schema');" | mysql
    }

    # ç³»ç»Ÿæ›´æ–°
    system_update() {
        echo "æ£€æŸ¥ç³»ç»Ÿæ›´æ–°..."

        # æ›´æ–°åŒ…åˆ—è¡¨
        apt-get update

        # æ£€æŸ¥å®‰å…¨æ›´æ–°
        security_updates=$(apt-get -s upgrade | grep -i security | wc -l)

        if [[ $security_updates -gt 0 ]]; then
            echo "å‘ç° $security_updates ä¸ªå®‰å…¨æ›´æ–°"
            # è¿™é‡Œå¯ä»¥é…ç½®è‡ªåŠ¨å®‰è£…å®‰å…¨æ›´æ–°
        fi
    }

    log_rotation
    cache_cleanup
    database_optimization
    system_update

    echo "è‡ªåŠ¨åŒ–ç»´æŠ¤å®Œæˆ"
}

# è®¾ç½®ç»´æŠ¤ä»»åŠ¡
echo "0 2 * * 0 /path/to/maintenance.sh >> /var/log/maintenance.log 2>&1" | crontab -
```

**æ•…éšœé¢„é˜²æ£€æŸ¥è¡¨**:

| æ£€æŸ¥é¡¹ç›®     | é¢‘ç‡   | è´Ÿè´£äºº   | æ£€æŸ¥æ–¹æ³•              |
| ------------ | ------ | -------- | --------------------- |
| ç³»ç»Ÿèµ„æºç›‘æ§ | å®æ—¶   | è‡ªåŠ¨è„šæœ¬ | CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨ç‡ |
| æœåŠ¡çŠ¶æ€æ£€æŸ¥ | æ¯å°æ—¶ | è‡ªåŠ¨è„šæœ¬ | systemctl status      |
| åº”ç”¨åŠŸèƒ½æµ‹è¯• | æ¯æ—¥   | è‡ªåŠ¨è„šæœ¬ | API å¥åº·æ£€æŸ¥          |
| æ—¥å¿—åˆ†æ     | æ¯æ—¥   | è‡ªåŠ¨è„šæœ¬ | é”™è¯¯æ—¥å¿—ç»Ÿè®¡          |
| å¤‡ä»½éªŒè¯     | æ¯å‘¨   | è¿ç»´äººå‘˜ | å¤‡ä»½å®Œæ•´æ€§æµ‹è¯•        |
| å®‰å…¨æ‰«æ     | æ¯å‘¨   | å®‰å…¨å›¢é˜Ÿ | æ¼æ´æ‰«æ              |
| æ€§èƒ½åˆ†æ     | æ¯æœˆ   | è¿ç»´å›¢é˜Ÿ | æ€§èƒ½æŒ‡æ ‡åˆ†æ          |
| ç³»ç»Ÿæ›´æ–°     | æ¯æœˆ   | è¿ç»´å›¢é˜Ÿ | è¡¥ä¸ç®¡ç†              |

#### 8.4.1 æœåŠ¡ä¸­æ–­æ¢å¤

1. è¯„ä¼°æ•…éšœå½±å“
2. å¯åŠ¨åº”æ€¥å“åº”
3. æ‰§è¡Œæ¢å¤æ–¹æ¡ˆ
4. éªŒè¯æœåŠ¡æ¢å¤
5. æ€»ç»“ç»éªŒæ•™è®­

#### 8.4.2 æ•°æ®æŸåæ¢å¤

1. åœæ­¢ç›¸å…³æœåŠ¡
2. è¯„ä¼°æ•°æ®æŸåèŒƒå›´
3. é€‰æ‹©æ¢å¤ç­–ç•¥
4. æ‰§è¡Œæ•°æ®æ¢å¤
5. éªŒè¯æ•°æ®å®Œæ•´æ€§

---

## 9. å›æ»šç­–ç•¥

### 9.1 å›æ»šè§¦å‘æ¡ä»¶

#### 9.1.1 è‡ªåŠ¨å›æ»šæ¡ä»¶

-   éƒ¨ç½²åå¥åº·æ£€æŸ¥å¤±è´¥
-   é”™è¯¯ç‡è¶…è¿‡é˜ˆå€¼
-   å“åº”æ—¶é—´ä¸¥é‡è¶…æ ‡
-   å…³é”®åŠŸèƒ½ä¸å¯ç”¨

#### 9.1.2 æ‰‹åŠ¨å›æ»šæ¡ä»¶

-   å‘ç°ä¸¥é‡å®‰å…¨æ¼æ´
-   ä¸šåŠ¡é€»è¾‘é”™è¯¯
-   æ€§èƒ½ä¸¥é‡ä¸‹é™
-   ç”¨æˆ·åé¦ˆä¸¥é‡é—®é¢˜

### 9.2 å›æ»šæµç¨‹

#### 9.2.1 ç´§æ€¥å›æ»šæ­¥éª¤

```bash
# 1. åœæ­¢åº”ç”¨æœåŠ¡
systemctl stop nginx
systemctl stop php8.2-fpm

# 2. æ¢å¤ä»£ç ç‰ˆæœ¬
cd /var/www/official_website_backend
git checkout [ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬æ ‡ç­¾]

# 3. æ¢å¤ä¾èµ–
composer install --no-dev --optimize-autoloader --no-interaction

# 4. æ¢å¤æ•°æ®åº“ï¼ˆå¦‚éœ€è¦ï¼‰
mysql -u root -p official_website < /backup/db_backup_[æ—¶é—´æˆ³].sql

# 5. æ¸…é™¤ç¼“å­˜
php bin/console cache:clear --env=prod

# 6. é‡å¯æœåŠ¡
systemctl start php8.2-fpm
systemctl start nginx
```

#### 9.2.2 æ•°æ®åº“å›æ»šç­–ç•¥

-   ä½¿ç”¨å¤‡ä»½æ–‡ä»¶æ¢å¤
-   æ‰§è¡Œåå‘è¿ç§»è„šæœ¬
-   æ•°æ®ç‰ˆæœ¬æ§åˆ¶
-   å¢é‡æ•°æ®æ¢å¤

### 9.3 å›æ»šéªŒè¯

#### 9.3.1 åŠŸèƒ½éªŒè¯æ¸…å•

-   [ ] åº”ç”¨æ­£å¸¸å¯åŠ¨
-   [ ] æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸
-   [ ] æ•°æ®å®Œæ•´æ€§éªŒè¯
-   [ ] æ€§èƒ½æŒ‡æ ‡æ­£å¸¸

#### 9.3.2 å›æ»šåå¤„ç†

-   é—®é¢˜åˆ†æå’Œä¿®å¤
-   é‡æ–°éƒ¨ç½²è®¡åˆ’
-   æ–‡æ¡£æ›´æ–°
-   å›¢é˜ŸåŸ¹è®­

### 9.4 å›æ»šé£é™©è¯„ä¼°

#### 9.4.1 æ•°æ®ä¸€è‡´æ€§é£é™©

-   æ•°æ®ä¸¢å¤±é£é™©
-   æ•°æ®å†²çªé£é™©
-   ä¸šåŠ¡è¿ç»­æ€§é£é™©

#### 9.4.2 æœåŠ¡å¯ç”¨æ€§é£é™©

-   å›æ»šæ—¶é—´çª—å£
-   ç”¨æˆ·ä½“éªŒå½±å“
-   ä¸šåŠ¡æŸå¤±è¯„ä¼°

---

## 10. æ£€æŸ¥æ¸…å•

### 10.1 å‘å¸ƒå‰æ£€æŸ¥æ¸…å•

#### 10.1.1 ä»£ç è´¨é‡æ£€æŸ¥

| æ£€æŸ¥é¡¹ç›® | æ£€æŸ¥æ ‡å‡†                     | æ£€æŸ¥æ–¹æ³•                | è´Ÿè´£äºº     | å®ŒæˆçŠ¶æ€ | å¤‡æ³¨                |
| -------- | ---------------------------- | ----------------------- | ---------- | -------- | ------------------- |
| ä»£ç å®¡æŸ¥ | æ— æ˜æ˜¾å®‰å…¨æ¼æ´ï¼Œç¬¦åˆç¼–ç è§„èŒƒ | Code Review + é™æ€åˆ†æ  | å¼€å‘ç»„é•¿   | â˜        | æ£€æŸ¥ PR/MR          |
| å•å…ƒæµ‹è¯• | è¦†ç›–ç‡ â‰¥ 80%ï¼Œé€šè¿‡ç‡ 100%    | phpunit --coverage-text | æµ‹è¯•å·¥ç¨‹å¸ˆ | â˜        | ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š      |
| é›†æˆæµ‹è¯• | æ ¸å¿ƒåŠŸèƒ½æµ‹è¯•é€šè¿‡             | è¿è¡Œé›†æˆæµ‹è¯•å¥—ä»¶        | æµ‹è¯•å·¥ç¨‹å¸ˆ | â˜        | é‡ç‚¹æµ‹è¯• API        |
| å®‰å…¨æ‰«æ | æ— é«˜å±æ¼æ´                   | è¿è¡Œå®‰å…¨æ‰«æå·¥å…·        | å®‰å…¨å·¥ç¨‹å¸ˆ | â˜        | ä½¿ç”¨ phpstan ç­‰å·¥å…· |
| æ€§èƒ½æµ‹è¯• | å“åº”æ—¶é—´ < 2sï¼Œå¹¶å‘æ”¯æŒ      | å‹åŠ›æµ‹è¯• + æ€§èƒ½åˆ†æ     | æ€§èƒ½å·¥ç¨‹å¸ˆ | â˜        | æ¨¡æ‹Ÿç”Ÿäº§è´Ÿè½½        |
| æ–‡æ¡£æ›´æ–° | API æ–‡æ¡£ã€éƒ¨ç½²æ–‡æ¡£æ›´æ–°       | æ–‡æ¡£å®¡æŸ¥                | æŠ€æœ¯æ–‡æ¡£å‘˜ | â˜        | ç¡®ä¿æ–‡æ¡£åŒæ­¥        |

**è‡ªåŠ¨åŒ–æ£€æŸ¥è„šæœ¬**:

````bash
#!/bin/bash
# å‘å¸ƒå‰ä»£ç è´¨é‡æ£€æŸ¥è„šæœ¬

echo "=== ä»£ç è´¨é‡æ£€æŸ¥ ==="

# 1. ä»£ç é™æ€åˆ†æ
static_analysis() {
    echo "1. æ‰§è¡Œä»£ç é™æ€åˆ†æ..."

    # PHPStané™æ€åˆ†æ
    if ./vendor/bin/phpstan analyse src --level=5 --no-progress; then
        echo "âœ… PHPStané™æ€åˆ†æé€šè¿‡"
        return 0
    else
        echo "âŒ PHPStané™æ€åˆ†æå¤±è´¥"
        return 1
    fi
}

# 2. å•å…ƒæµ‹è¯•
unit_tests() {
    echo "2. æ‰§è¡Œå•å…ƒæµ‹è¯•..."

| æ£€æŸ¥é¡¹ç›® | æ£€æŸ¥æ ‡å‡† | æ£€æŸ¥æ–¹æ³• | è´Ÿè´£äºº | å®ŒæˆçŠ¶æ€ | å¤‡æ³¨ |
|---------|---------|---------|--------|---------|------|
| ä»£ç éƒ¨ç½² | æ— é”™è¯¯ï¼Œç‰ˆæœ¬æ­£ç¡® | éƒ¨ç½²è„šæœ¬æ—¥å¿— | éƒ¨ç½²å·¥ç¨‹å¸ˆ | â˜ | ç¡®è®¤git commit |
| ä¾èµ–å®‰è£… | æ‰€æœ‰ä¾èµ–å®‰è£…æˆåŠŸ | composer install | éƒ¨ç½²å·¥ç¨‹å¸ˆ | â˜ | æ£€æŸ¥vendorç›®å½• |
| ç¼“å­˜æ¸…ç† | æ—§ç¼“å­˜å®Œå…¨æ¸…ç† | cache:clearå‘½ä»¤ | éƒ¨ç½²å·¥ç¨‹å¸ˆ | â˜ | éªŒè¯ç¼“å­˜ç›®å½• |
| æ•°æ®åº“è¿ç§» | è¿ç§»æˆåŠŸæ— é”™è¯¯ | doctrine:migrations | æ•°æ®åº“ç®¡ç†å‘˜ | â˜ | å¤‡ä»½æ•°æ®åº“ |
| æƒé™è®¾ç½® | æ–‡ä»¶æƒé™æ­£ç¡® | chown/chmodå‘½ä»¤ | éƒ¨ç½²å·¥ç¨‹å¸ˆ | â˜ | æ£€æŸ¥å…³é”®ç›®å½• |
| æœåŠ¡é‡å¯ | æœåŠ¡è¿è¡Œæ­£å¸¸ | systemctl status | è¿ç»´å·¥ç¨‹å¸ˆ | â˜ | é€ä¸ªé‡å¯éªŒè¯ |

**éƒ¨ç½²è¿‡ç¨‹è‡ªåŠ¨åŒ–æ£€æŸ¥è„šæœ¬**:
```bash
#!/bin/bash
# å‘å¸ƒè¿‡ç¨‹æ£€æŸ¥è„šæœ¬

echo "=== å‘å¸ƒè¿‡ç¨‹æ£€æŸ¥ ==="

# 1. ä»£ç éƒ¨ç½²æ£€æŸ¥
check_code_deployment() {
    echo "1. æ£€æŸ¥ä»£ç éƒ¨ç½²..."

    # æ£€æŸ¥Gitç‰ˆæœ¬
    local current_commit=$(git rev-parse HEAD)
    echo "å½“å‰éƒ¨ç½²ç‰ˆæœ¬: $current_commit"

    # æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§
    if [[ -f "public/index.php" ]] && [[ -f "src/Kernel.php" ]]; then
        echo "âœ… å…³é”®æ–‡ä»¶å­˜åœ¨"
    else
        echo "âŒ å…³é”®æ–‡ä»¶ç¼ºå¤±"
        return 1
    fi

    # æ£€æŸ¥æ–‡ä»¶æƒé™
    local file_perms=$(stat -c "%a" "public/index.php")
    if [[ "$file_perms" == "644" ]]; then
        echo "âœ… æ–‡ä»¶æƒé™æ­£ç¡®"
    else
        echo "âš ï¸  æ–‡ä»¶æƒé™å¼‚å¸¸: $file_perms"
    fi
}

# 2. ä¾èµ–å®‰è£…æ£€æŸ¥
check_dependencies() {
    echo "2. æ£€æŸ¥ä¾èµ–å®‰è£…..."

    # æ£€æŸ¥composer.lock
    if [[ -f "composer.lock" ]]; then
        echo "âœ… composer.lockæ–‡ä»¶å­˜åœ¨"
    else
        echo "âŒ composer.lockæ–‡ä»¶ç¼ºå¤±"
        return 1
    fi

    # æ£€æŸ¥vendorç›®å½•
    if [[ -d "vendor" ]] && [[ $(ls vendor | wc -l) -gt 10 ]]; then
        echo "âœ… ä¾èµ–åŒ…å®‰è£…å®Œæ•´"
    else
        echo "âŒ ä¾èµ–åŒ…å®‰è£…ä¸å®Œæ•´"
        return 1
    fi

    # æ£€æŸ¥è‡ªåŠ¨åŠ è½½
    if php -r "require 'vendor/autoload.php'; echo 'autoload OK';" 2>/dev/null; then
        echo "âœ… è‡ªåŠ¨åŠ è½½æ­£å¸¸"
    else
        echo "âŒ è‡ªåŠ¨åŠ è½½å¤±è´¥"
        return 1
    fi
}

# 3. ç¼“å­˜æ¸…ç†æ£€æŸ¥
check_cache_cleanup() {
    echo "3. æ£€æŸ¥ç¼“å­˜æ¸…ç†..."

    # æ¸…ç†ç”Ÿäº§ç¼“å­˜
    if php bin/console cache:clear --env=prod --no-warmup; then
        echo "âœ… ç¼“å­˜æ¸…ç†æˆåŠŸ"
    else
        echo "âŒ ç¼“å­˜æ¸…ç†å¤±è´¥"
        return 1
    fi

    # æ£€æŸ¥ç¼“å­˜ç›®å½•
    local cache_size=$(du -sh var/cache/prod 2>/dev/null | cut -f1)
    if [[ -n "$cache_size" ]]; then
        echo "ç¼“å­˜ç›®å½•å¤§å°: $cache_size"
    fi

    # é¢„çƒ­ç¼“å­˜
    if php bin/console cache:warmup --env=prod; then
        echo "âœ… ç¼“å­˜é¢„çƒ­æˆåŠŸ"
    else
        echo "âš ï¸  ç¼“å­˜é¢„çƒ­å¤±è´¥"
    fi
}

# 4. æ•°æ®åº“è¿ç§»æ£€æŸ¥
check_database_migration() {
    echo "4. æ£€æŸ¥æ•°æ®åº“è¿ç§»..."

    # æ£€æŸ¥å¾…æ‰§è¡Œçš„è¿ç§»
    local pending_migrations=$(php bin/console doctrine:migrations:status --env=prod | grep -c "New")

    if [[ $pending_migrations -eq 0 ]]; then
        echo "âœ… æ— å¾…æ‰§è¡Œçš„æ•°æ®åº“è¿ç§»"
    else
        echo "âš ï¸  å‘ç° $pending_migrations ä¸ªå¾…æ‰§è¡Œçš„è¿ç§»"

        # æ‰§è¡Œè¿ç§»
        if php bin/console doctrine:migrations:migrate --env=prod --no-interaction; then
            echo "âœ… æ•°æ®åº“è¿ç§»æ‰§è¡ŒæˆåŠŸ"
        else
            echo "âŒ æ•°æ®åº“è¿ç§»æ‰§è¡Œå¤±è´¥"
            return 1
        fi
    fi

    # éªŒè¯æ•°æ®åº“è¿æ¥
    if php bin/console doctrine:database:create --if-not-exists --env=prod; then
        echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
    else
        echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
        return 1
    fi
}

# 5. æœåŠ¡é‡å¯æ£€æŸ¥
check_services_restart() {
    echo "5. æ£€æŸ¥æœåŠ¡é‡å¯..."

    # é‡å¯PHP-FPM
    if systemctl restart php8.2-fpm; then
        echo "âœ… PHP-FPMé‡å¯æˆåŠŸ"
    else
        echo "âŒ PHP-FPMé‡å¯å¤±è´¥"
        return 1
    fi

    # é‡å¯Nginx
    if nginx -t && systemctl reload nginx; then
        echo "âœ… Nginxé‡è½½æˆåŠŸ"
    else
        echo "âŒ Nginxé‡è½½å¤±è´¥"
        return 1
    fi

    # æ£€æŸ¥æœåŠ¡çŠ¶æ€
    sleep 3

    if systemctl is-active --quiet php8.2-fpm; then
        echo "âœ… PHP-FPMè¿è¡Œæ­£å¸¸"
    else
        echo "âŒ PHP-FPMè¿è¡Œå¼‚å¸¸"
        return 1
    fi

    if systemctl is-active --quiet nginx; then
        echo "âœ… Nginxè¿è¡Œæ­£å¸¸"
    else
        echo "âŒ Nginxè¿è¡Œå¼‚å¸¸"
        return 1
    fi
}

# æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
main() {
    local failed=0

    check_code_deployment || failed=1
    check_dependencies || failed=1
    check_cache_cleanup || failed=1
    check_database_migration || failed=1
    check_services_restart || failed=1

    echo ""
    if [[ $failed -eq 0 ]]; then
        echo "ğŸ‰ å‘å¸ƒè¿‡ç¨‹æ£€æŸ¥é€šè¿‡ï¼"
        exit 0
    else
        echo "âŒ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åé‡è¯•"
        exit 1
    fi
}

main "$@"
````

#### 10.2.2 åŠŸèƒ½ç¡®è®¤æ£€æŸ¥

| æ£€æŸ¥é¡¹ç›®   | æ£€æŸ¥æ ‡å‡†               | æ£€æŸ¥æ–¹æ³•          | è´Ÿè´£äºº     | å®ŒæˆçŠ¶æ€ | å¤‡æ³¨           |
| ---------- | ---------------------- | ----------------- | ---------- | -------- | -------------- |
| é¦–é¡µè®¿é—®   | HTTP 200ï¼ŒåŠ è½½æ­£å¸¸     | curl + æµè§ˆå™¨æµ‹è¯• | æµ‹è¯•å·¥ç¨‹å¸ˆ | â˜        | æ£€æŸ¥é™æ€èµ„æº   |
| API æ¥å£   | HTTP 200ï¼Œè¿”å›æ­£ç¡®æ•°æ® | API æµ‹è¯•å·¥å…·      | æµ‹è¯•å·¥ç¨‹å¸ˆ | â˜        | æµ‹è¯•æ ¸å¿ƒæ¥å£   |
| JWT è®¤è¯   | Token ç”Ÿæˆå’ŒéªŒè¯æ­£å¸¸   | ç™»å½•æ¥å£æµ‹è¯•      | æµ‹è¯•å·¥ç¨‹å¸ˆ | â˜        | æ£€æŸ¥æƒé™æ§åˆ¶   |
| æ•°æ®åº“æŸ¥è¯¢ | æŸ¥è¯¢å“åº”æ­£å¸¸           | æ•°æ®åº“è¿æ¥æµ‹è¯•    | æµ‹è¯•å·¥ç¨‹å¸ˆ | â˜        | æµ‹è¯• CRUD æ“ä½œ |
| ç¼“å­˜åŠŸèƒ½   | ç¼“å­˜è¯»å†™æ­£å¸¸           | ç¼“å­˜æµ‹è¯•          | æ€§èƒ½å·¥ç¨‹å¸ˆ | â˜        | æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡ |
| æ—¥å¿—è®°å½•   | æ—¥å¿—æ­£å¸¸ç”Ÿæˆ           | æ£€æŸ¥æ—¥å¿—æ–‡ä»¶      | è¿ç»´å·¥ç¨‹å¸ˆ | â˜        | ç¡®è®¤æ—¥å¿—è½®è½¬   |

**åŠŸèƒ½æµ‹è¯•è‡ªåŠ¨åŒ–è„šæœ¬**:

| æ£€æŸ¥é¡¹ç›® | æ£€æŸ¥æ ‡å‡†         | æ£€æŸ¥æ–¹æ³•         | è´Ÿè´£äºº       | å®ŒæˆçŠ¶æ€ | å¤‡æ³¨         |
| -------- | ---------------- | ---------------- | ------------ | -------- | ------------ |
| æœåŠ¡çŠ¶æ€ | æ‰€æœ‰æœåŠ¡è¿è¡Œæ­£å¸¸ | systemctl status | è¿ç»´å·¥ç¨‹å¸ˆ   | â˜        | æ£€æŸ¥å…³é”®æœåŠ¡ |
| ç›‘æ§å‘Šè­¦ | æ— ä¸¥é‡å‘Šè­¦       | ç›‘æ§å¹³å°æ£€æŸ¥     | ç›‘æ§å·¥ç¨‹å¸ˆ   | â˜        | ç¡®è®¤å‘Šè­¦è§„åˆ™ |
| ç”¨æˆ·åé¦ˆ | æ— é‡å¤§é—®é¢˜åé¦ˆ   | ç”¨æˆ·åé¦ˆæ¸ é“     | äº§å“ç»ç†     | â˜        | æ”¶é›†ç”¨æˆ·åé¦ˆ |
| æ•°æ®éªŒè¯ | æ•°æ®å®Œæ•´æ€§æ­£å¸¸   | æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥   | æ•°æ®åº“ç®¡ç†å‘˜ | â˜        | å…³é”®æ•°æ®éªŒè¯ |
| æ€§èƒ½æŒ‡æ ‡ | å“åº”æ—¶é—´æ­£å¸¸     | æ€§èƒ½ç›‘æ§         | æ€§èƒ½å·¥ç¨‹å¸ˆ   | â˜        | å¯¹æ¯”åŸºçº¿æ•°æ® |
| æ—¥å¿—åˆ†æ | æ— å¼‚å¸¸é”™è¯¯æ—¥å¿—   | æ—¥å¿—åˆ†æå·¥å…·     | è¿ç»´å·¥ç¨‹å¸ˆ   | â˜        | æ£€æŸ¥é”™è¯¯è¶‹åŠ¿ |

**å‘å¸ƒåç›‘æ§è„šæœ¬**:

```bash
#!/bin/bash
# å‘å¸ƒåæ£€æŸ¥è„šæœ¬

echo "=== å‘å¸ƒåæ£€æŸ¥ ==="

# 1. æœåŠ¡çŠ¶æ€æ£€æŸ¥
check_service_status() {
    echo "1. æ£€æŸ¥æœåŠ¡çŠ¶æ€..."

    local services=("nginx" "php8.2-fpm" "mysql" "redis-server")
    local failed_services=()

    for service in "${services[@]}"; do
        if systemctl is-active --quiet "$service"; then
            echo "âœ… $service è¿è¡Œæ­£å¸¸"
        else
            echo "âŒ $service è¿è¡Œå¼‚å¸¸"
            failed_services+=("$service")
        fi
    done

    if [[ ${#failed_services[@]} -gt 0 ]]; then
        echo "å¼‚å¸¸æœåŠ¡: ${failed_services[*]}"
        return 1
    fi

    # æ£€æŸ¥æœåŠ¡èµ„æºä½¿ç”¨
    for service in "${services[@]}"; do
        local memory_usage=$(ps aux | grep "$service" | grep -v grep | awk '{sum+=$6} END {print sum/1024}')
        echo "$service å†…å­˜ä½¿ç”¨: ${memory_usage}MB"
    done
}

# 2. ç›‘æ§å‘Šè­¦æ£€æŸ¥
check_monitoring_alerts() {
    echo "2. æ£€æŸ¥ç›‘æ§å‘Šè­¦..."

    # æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
    local load_avg=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')
    if (( $(echo "$load_avg < 2.0" | bc -l) )); then
        echo "âœ… ç³»ç»Ÿè´Ÿè½½æ­£å¸¸: $load_avg"
    else
        echo "âš ï¸  ç³»ç»Ÿè´Ÿè½½è¾ƒé«˜: $load_avg"
    fi

    # æ£€æŸ¥ç£ç›˜ä½¿ç”¨
    local disk_usage=$(df / | tail -1 | awk '{print $5}' | tr -d '%')
    if [[ $disk_usage -lt 80 ]]; then
        echo "âœ… ç£ç›˜ä½¿ç”¨æ­£å¸¸: $disk_usage%"
    else
        echo "âš ï¸  ç£ç›˜ä½¿ç”¨è¾ƒé«˜: $disk_usage%"
    fi

    # æ£€æŸ¥å†…å­˜ä½¿ç”¨
    local mem_usage=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
    if (( $(echo "$mem_usage < 80" | bc -l) )); then
        echo "âœ… å†…å­˜ä½¿ç”¨æ­£å¸¸: $mem_usage%"
    else
        echo "âš ï¸  å†…å­˜ä½¿ç”¨è¾ƒé«˜: $mem_usage%"
    fi

    # æ£€æŸ¥ç½‘ç»œè¿æ¥
    local connections=$(netstat -an | grep :80 | grep ESTABLISHED | wc -l)
    echo "å½“å‰HTTPè¿æ¥æ•°: $connections"
}

# 3. æ€§èƒ½æŒ‡æ ‡æ£€æŸ¥
check_performance_metrics() {
    echo "3. æ£€æŸ¥æ€§èƒ½æŒ‡æ ‡..."

    # æµ‹è¯•é¦–é¡µå“åº”æ—¶é—´
    local response_times=()
    for i in {1..5}; do
        local response_time=$(curl -s -o /dev/null -w "%{time_total}" "http://localhost")
        response_times+=("$response_time")
        sleep 1
    done

    local avg_time=$(printf '%s\n' "${response_times[@]}" | awk '{sum+=$1} END {print sum/NR}')
    if (( $(echo "$avg_time < 1.0" | bc -l) )); then
        echo "âœ… é¦–é¡µå“åº”æ—¶é—´æ­£å¸¸: ${avg_time}s"
    else
        echo "âš ï¸  é¦–é¡µå“åº”æ—¶é—´è¾ƒé•¿: ${avg_time}s"
    fi

    # æµ‹è¯•APIå“åº”æ—¶é—´
    local api_response_time=$(curl -s -o /dev/null -w "%{time_total}" "http://localhost/api/health")
    if (( $(echo "$api_response_time < 0.5" | bc -l) )); then
        echo "âœ… APIå“åº”æ—¶é—´æ­£å¸¸: ${api_response_time}s"
    else
        echo "âš ï¸  APIå“åº”æ—¶é—´è¾ƒé•¿: ${api_response_time}s"
    fi

    # æ£€æŸ¥æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
    local db_query_time=$(mysql -e "SELECT SLEEP(0.1);" 2>/dev/null | wc -l)
    if [[ $db_query_time -gt 0 ]]; then
        echo "âœ… æ•°æ®åº“å“åº”æ­£å¸¸"
    else
        echo "âš ï¸  æ•°æ®åº“å“åº”å¼‚å¸¸"
    fi
}

# 4. æ•°æ®éªŒè¯æ£€æŸ¥
check_data_integrity() {
    echo "4. æ£€æŸ¥æ•°æ®å®Œæ•´æ€§..."

    # æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„
    local expected_tables=20  # æ ¹æ®å®é™…è¡¨æ•°é‡è°ƒæ•´
    local actual_tables=$(mysql -e "SHOW TABLES;" 2>/dev/null | wc -l)

    if [[ $actual_tables -ge $expected_tables ]]; then
        echo "âœ… æ•°æ®åº“è¡¨æ•°é‡æ­£å¸¸: $actual_tables"
    else
        echo "âŒ æ•°æ®åº“è¡¨æ•°é‡å¼‚å¸¸: $actual_tables (æœŸæœ›: $expected_tables)"
    fi

    # æ£€æŸ¥å…³é”®è¡¨æ•°æ®
    local tables=("users" "sys_news_articles" "wechat_public_accounts")
    for table in "${tables[@]}"; do
        local record_count=$(mysql -e "SELECT COUNT(*) FROM $table;" 2>/dev/null | tail -1)
        if [[ $record_count -ge 0 ]]; then
            echo "âœ… $table è¡¨æ•°æ®æ­£å¸¸: $record_count æ¡è®°å½•"
        else
            echo "âŒ $table è¡¨æ•°æ®å¼‚å¸¸"
        fi
    done

    # æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
    local orphaned_records=$(mysql -e "
        SELECT COUNT(*) FROM sys_news_articles
        WHERE category_id NOT IN (SELECT id FROM sys_news_article_category WHERE id IS NOT NULL);
    " 2>/dev/null | tail -1)

    if [[ $orphaned_records -eq 0 ]]; then
        echo "âœ… æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥é€šè¿‡"
    else
        echo "âš ï¸  å‘ç° $orphaned_records æ¡å­¤ç«‹è®°å½•"
    fi
}

# 5. æ—¥å¿—åˆ†ææ£€æŸ¥
check_log_analysis() {
    echo "5. æ£€æŸ¥æ—¥å¿—åˆ†æ..."

    local log_file="var/log/prod.log"
    if [[ -f "$log_file" ]]; then
        # æ£€æŸ¥æœ€è¿‘1å°æ—¶çš„é”™è¯¯
        local recent_errors=$(tail -n 1000 "$log_file" | grep "$(date '+%Y-%m-%d %H:')" | grep -i "error\|critical" | wc -l)
        if [[ $recent_errors -eq 0 ]]; then
            echo "âœ… æœ€è¿‘1å°æ—¶æ— é”™è¯¯æ—¥å¿—"
        else
            echo "âš ï¸  æœ€è¿‘1å°æ—¶æœ‰ $recent_errors ä¸ªé”™è¯¯"
        fi

        # æ£€æŸ¥PHPé”™è¯¯
        local php_errors=$(tail -n 1000 "$log_file" | grep "PHP" | grep -i "fatal\|parse" | wc -l)
        if [[ $php_errors -eq 0 ]]; then
            echo "âœ… æ— PHPè‡´å‘½é”™è¯¯"
        else
            echo "âŒ å‘ç° $php_errors ä¸ªPHPè‡´å‘½é”™è¯¯"
        fi

        # æ£€æŸ¥æ•°æ®åº“é”™è¯¯
        local db_errors=$(tail -n 1000 "$log_file" | grep -i "database\|mysql\|doctrine" | grep -i "error\|failed" | wc -l)
        if [[ $db_errors -eq 0 ]]; then
            echo "âœ… æ— æ•°æ®åº“é”™è¯¯"
        else
            echo "âš ï¸  å‘ç° $db_errors ä¸ªæ•°æ®åº“é”™è¯¯"
        fi
    else
        echo "âŒ æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $log_file"
    fi
}

# 6. ç”¨æˆ·åé¦ˆæ¨¡æ‹Ÿæ£€æŸ¥
simulate_user_feedback() {
    echo "6. æ¨¡æ‹Ÿç”¨æˆ·åé¦ˆæ£€æŸ¥..."

    # æ¨¡æ‹Ÿç”¨æˆ·æ³¨å†Œæµç¨‹
    local register_response=$(curl -s -X POST \
        -H "Content-Type: application/json" \
        -d '{"email":"test$(date +%s)@example.com","password":"testpass123"}' \
        "http://localhost/api/register")

    if echo "$register_response" | jq -e '.id' &>/dev/null; then
        echo "âœ… ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½æ­£å¸¸"
    else
        echo "âš ï¸  ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½å¼‚å¸¸"
    fi

    # æ¨¡æ‹Ÿæ–‡ç« æµè§ˆ
    local article_response=$(curl -s "http://localhost/api/articles?limit=10")
    if echo "$article_response" | jq -e '.data' &>/dev/null; then
        echo "âœ… æ–‡ç« æµè§ˆåŠŸèƒ½æ­£å¸¸"
    else
        echo "âš ï¸  æ–‡ç« æµè§ˆåŠŸèƒ½å¼‚å¸¸"
    fi

    # æ¨¡æ‹Ÿæœç´¢åŠŸèƒ½
    local search_response=$(curl -s "http://localhost/api/search?q=test")
    if echo "$search_response" | jq -e '.data' &>/dev/null; then
        echo "âœ… æœç´¢åŠŸèƒ½æ­£å¸¸"
    else
        echo "âš ï¸  æœç´¢åŠŸèƒ½å¼‚å¸¸"
    fi
}

# æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
main() {
    local failed=0

    check_service_status || failed=1
    check_monitoring_alerts
    check_performance_metrics
    check_data_integrity
    check_log_analysis
    simulate_user_feedback

    echo ""
    if [[ $failed -eq 0 ]]; then
        echo "ğŸ‰ å‘å¸ƒåæ£€æŸ¥é€šè¿‡ï¼"
        exit 0
    else
        echo "âŒ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥ï¼Œè¯·å…³æ³¨å¹¶å¤„ç†"
        exit 1
    fi
}

main "$@"
```

### 10.4 ç´§æ€¥å›æ»šæ£€æŸ¥

#### 10.4.1 å›æ»šæ¡ä»¶éªŒè¯

| æ£€æŸ¥é¡¹ç›®   | å›æ»šæ¡ä»¶          | æ£€æŸ¥æ–¹æ³•     | è´Ÿè´£äºº       | å®ŒæˆçŠ¶æ€ | å¤‡æ³¨            |
| ---------- | ----------------- | ------------ | ------------ | -------- | --------------- |
| æœåŠ¡å¯ç”¨æ€§ | æ ¸å¿ƒæœåŠ¡ä¸å¯ç”¨    | å¥åº·æ£€æŸ¥å¤±è´¥ | è¿ç»´å·¥ç¨‹å¸ˆ   | â˜        | è¿ç»­ 3 æ¬¡å¤±è´¥   |
| é”™è¯¯ç‡     | é”™è¯¯ç‡è¶…è¿‡ 5%     | ç›‘æ§å‘Šè­¦     | ç›‘æ§å·¥ç¨‹å¸ˆ   | â˜        | æŒç»­ 5 åˆ†é’Ÿä»¥ä¸Š |
| å“åº”æ—¶é—´   | å“åº”æ—¶é—´è¶…è¿‡ 3 ç§’ | æ€§èƒ½ç›‘æ§     | æ€§èƒ½å·¥ç¨‹å¸ˆ   | â˜        | å½±å“ç”¨æˆ·ä½“éªŒ    |
| æ•°æ®å®Œæ•´æ€§ | æ•°æ®æŸåæˆ–ä¸¢å¤±    | æ•°æ®éªŒè¯     | æ•°æ®åº“ç®¡ç†å‘˜ | â˜        | å…³é”®ä¸šåŠ¡æ•°æ®    |
| å®‰å…¨é—®é¢˜   | å­˜åœ¨å®‰å…¨æ¼æ´      | å®‰å…¨æ‰«æ     | å®‰å…¨å·¥ç¨‹å¸ˆ   | â˜        | é«˜å±æ¼æ´        |
| ç”¨æˆ·åé¦ˆ   | å¤§é‡ç”¨æˆ·æŠ•è¯‰      | ç”¨æˆ·åé¦ˆæ¸ é“ | äº§å“ç»ç†     | â˜        | å½±å“é¢å¹¿æ³›      |

**å›æ»šæ¡ä»¶åˆ¤æ–­è„šæœ¬**:

````bash
#!/bin/bash
# å›æ»šæ¡ä»¶åˆ¤æ–­è„šæœ¬

echo "=== å›æ»šæ¡ä»¶éªŒè¯ ==="

# é˜ˆå€¼é…ç½®
ERROR_RATE_THRESHOLD=5
RESPONSE_TIME_THRESHOLD=3
AVAILABILITY_THRESHOLD=95
USER_COMPLAINT_THRESHOLD=10

# 1. æœåŠ¡å¯ç”¨æ€§æ£€æŸ¥
check_service_availability() {
    echo "1. æ£€æŸ¥æœåŠ¡å¯ç”¨æ€§..."

    local failed_checks=0
    local total_checks=10

    for i in {1..10}; do
        local response_code=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost")
        if [[ "$response_code" != "200" ]]; then
            ((failed_checks++))
        fi
        sleep 2
    done

    local availability=$(( (total_checks - failed_checks) * 100 / total_checks ))

    if [[ $availability -ge $AVAILABILITY_THRESHOLD ]]; then
        echo "âœ… æœåŠ¡å¯ç”¨æ€§æ­£å¸¸: $availability%"
        return 1
    else
        echo "âŒ æœåŠ¡å¯ç”¨æ€§ä¸è¶³: $availability% (é˜ˆå€¼: $AVAILABILITY_THRESHOLD%)"
        return 0
    fi
}

# 2. é”™è¯¯ç‡æ£€æŸ¥
check_error_rate() {
    echo "2. æ£€æŸ¥é”™è¯¯ç‡..."

**è‡ªåŠ¨å›æ»šæ‰§è¡Œè„šæœ¬**:
```bash
#!/bin/bash
# è‡ªåŠ¨å›æ»šæ‰§è¡Œè„šæœ¬

echo "=== è‡ªåŠ¨å›æ»šæ‰§è¡Œ ==="

# é…ç½®å˜é‡
BACKUP_DIR="/backup/rollback"
PREVIOUS_TAG="v1.2.0"  # æ ¹æ®å®é™…æƒ…å†µè®¾ç½®
ROLLBACK_LOG="/var/log/rollback.log"

# è®°å½•æ—¥å¿—å‡½æ•°
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$ROLLBACK_LOG"
}

# 1. åœæ­¢æœåŠ¡
stop_services() {
    log "1. åœæ­¢æœåŠ¡..."

    local services=("nginx" "php8.2-fpm")
    for service in "${services[@]}"; do
        if systemctl is-active --quiet "$service"; then
            if systemctl stop "$service"; then
                log "âœ… $service åœæ­¢æˆåŠŸ"
            else
                log "âŒ $service åœæ­¢å¤±è´¥"
                return 1
            fi
        else
            log "âš ï¸  $service æœªè¿è¡Œ"
        fi
    done

    sleep 3
    log "âœ… æ‰€æœ‰æœåŠ¡å·²åœæ­¢"
}

# 2. ä»£ç å›æ»š
rollback_code() {
    log "2. æ‰§è¡Œä»£ç å›æ»š..."

    # å¤‡ä»½å½“å‰ç‰ˆæœ¬
    local current_commit=$(git rev-parse HEAD)
    mkdir -p "$BACKUP_DIR"
    cp -r . "$BACKUP_DIR/current_backup_$current_commit"
    log "å½“å‰ç‰ˆæœ¬å·²å¤‡ä»½åˆ°: $BACKUP_DIR/current_backup_$current_commit"

    # åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
    if git checkout "$PREVIOUS_TAG"; then
        log "âœ… ä»£ç å›æ»šæˆåŠŸ: $PREVIOUS_TAG"
    else
        log "âŒ ä»£ç å›æ»šå¤±è´¥: $PREVIOUS_TAG"
        return 1
    fi

    # æ¢å¤é…ç½®æ–‡ä»¶
    if [[ -d "$BACKUP_DIR/current_backup_$current_commit" ]]; then
        cp "$BACKUP_DIR/current_backup_$current_commit/.env" .
        cp "$BACKUP_DIR/current_backup_$current_commit/config/packages/security.yaml" config/packages/
        log "âœ… é…ç½®æ–‡ä»¶å·²æ¢å¤"
    fi
}

# 3. æ•°æ®åº“å›æ»š
rollback_database() {
    log "3. æ‰§è¡Œæ•°æ®åº“å›æ»š..."

    # å¤‡ä»½å½“å‰æ•°æ®åº“
    local backup_file="$BACKUP_DIR/db_backup_$(date +%Y%m%d_%H%M%S).sql"
    if mysqldump --single-transaction --routines --triggers > "$backup_file"; then
        log "âœ… æ•°æ®åº“å¤‡ä»½æˆåŠŸ: $backup_file"
    else
        log "âŒ æ•°æ®åº“å¤‡ä»½å¤±è´¥"
        return 1
    fi

    # å›æ»šæ•°æ®åº“è¿ç§»
    if php bin/console doctrine:migrations:rollback --env=prod --no-interaction; then
        log "âœ… æ•°æ®åº“è¿ç§»å›æ»šæˆåŠŸ"
    else
        log "âŒ æ•°æ®åº“è¿ç§»å›æ»šå¤±è´¥"
        return 1
    fi
}

# 4. ä¾èµ–æ¢å¤
restore_dependencies() {
    log "4. æ¢å¤ä¾èµ–åŒ…..."

    # æ¸…ç†æ—§çš„vendorç›®å½•
    if [[ -d "vendor" ]]; then
        rm -rf vendor
        log "æ—§vendorç›®å½•å·²æ¸…ç†"
    fi

    # å®‰è£…ä¾èµ–
    if composer install --no-dev --optimize-autoloader --no-interaction; then
        log "âœ… ä¾èµ–åŒ…å®‰è£…æˆåŠŸ"
    else
        log "âŒ ä¾èµ–åŒ…å®‰è£…å¤±è´¥"
        return 1
    fi
}

# 5. ç¼“å­˜æ¸…ç†
clear_cache() {
    log "5. æ¸…ç†å’Œé‡å»ºç¼“å­˜..."

    # æ¸…ç†æ‰€æœ‰ç¼“å­˜
    if php bin/console cache:clear --env=prod --no-warmup; then
        log "âœ… ç¼“å­˜æ¸…ç†æˆåŠŸ"
    else
        log "âŒ ç¼“å­˜æ¸…ç†å¤±è´¥"
        return 1
    fi

    # é¢„çƒ­ç¼“å­˜
    if php bin/console cache:warmup --env=prod; then
        log "âœ… ç¼“å­˜é¢„çƒ­æˆåŠŸ"
    else
        log "âš ï¸  ç¼“å­˜é¢„çƒ­å¤±è´¥"
    fi
}

# 6. å¯åŠ¨æœåŠ¡
start_services() {
    log "6. å¯åŠ¨æœåŠ¡..."

    local services=("php8.2-fpm" "nginx")
    for service in "${services[@]}"; do
        if systemctl start "$service"; then
            sleep 2
            if systemctl is-active --quiet "$service"; then
                log "âœ… $service å¯åŠ¨æˆåŠŸ"
            else
                log "âŒ $service å¯åŠ¨å¤±è´¥"
                return 1
            fi
        else
            log "âŒ $service å¯åŠ¨å‘½ä»¤å¤±è´¥"
            return 1
        fi
    done

    log "âœ… æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨"
}

# 7. åŠŸèƒ½éªŒè¯
verify_rollback() {
    log "7. éªŒè¯å›æ»šç»“æœ..."

    sleep 5  # ç­‰å¾…æœåŠ¡å®Œå…¨å¯åŠ¨

    # æ£€æŸ¥é¦–é¡µ
    local homepage_status=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost")
    if [[ "$homepage_status" == "200" ]]; then
        log "âœ… é¦–é¡µè®¿é—®æ­£å¸¸"
    else
        log "âŒ é¦–é¡µè®¿é—®å¼‚å¸¸ (HTTP $homepage_status)"
        return 1
    fi

    # æ£€æŸ¥API
    local api_status=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost/api/health")
    if [[ "$api_status" == "200" ]]; then
        log "âœ… APIæ¥å£æ­£å¸¸"
    else
        log "âŒ APIæ¥å£å¼‚å¸¸ (HTTP $api_status)"
        return 1
    fi

    # æ£€æŸ¥æ•°æ®åº“è¿æ¥
    if php bin/console doctrine:database:create --if-not-exists --env=prod &>/dev/null; then
        log "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
    else
        log "âŒ æ•°æ®åº“è¿æ¥å¼‚å¸¸"
        return 1
    fi

    log "âœ… å›æ»šéªŒè¯é€šè¿‡"
}

# ä¸»æ‰§è¡Œå‡½æ•°
main() {
    log "å¼€å§‹æ‰§è¡Œè‡ªåŠ¨å›æ»š..."

    # æ£€æŸ¥æ˜¯å¦ä¸ºrootç”¨æˆ·
    if [[ $EUID -ne 0 ]]; then
        log "âŒ éœ€è¦rootæƒé™æ‰§è¡Œæ­¤è„šæœ¬"
        exit 1
    fi

    # æ‰§è¡Œå›æ»šæ­¥éª¤
    stop_services || { log "âŒ åœæ­¢æœåŠ¡å¤±è´¥ï¼Œå›æ»šä¸­æ­¢"; exit 1; }
    rollback_code || { log "âŒ ä»£ç å›æ»šå¤±è´¥"; exit 1; }
    rollback_database || { log "âŒ æ•°æ®åº“å›æ»šå¤±è´¥"; exit 1; }
    restore_dependencies || { log "âŒ ä¾èµ–æ¢å¤å¤±è´¥"; exit 1; }
    clear_cache || { log "âŒ ç¼“å­˜æ¸…ç†å¤±è´¥"; exit 1; }
    start_services || { log "âŒ æœåŠ¡å¯åŠ¨å¤±è´¥"; exit 1; }

    # éªŒè¯å›æ»šç»“æœ
    if verify_rollback; then
        log "ğŸ‰ è‡ªåŠ¨å›æ»šæ‰§è¡ŒæˆåŠŸï¼"
        log "ç³»ç»Ÿå·²æ¢å¤åˆ°ç‰ˆæœ¬: $PREVIOUS_TAG"
        exit 0
    else
        log "âŒ å›æ»šéªŒè¯å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥"
        exit 1
    fi
}

# æ‰§è¡Œå›æ»š
main "$@"
````

### 10.5 å®šæœŸç»´æŠ¤æ£€æŸ¥

#### 10.5.1 ç³»ç»Ÿæ›´æ–°æ£€æŸ¥

| æ£€æŸ¥é¡¹ç›®     | æ£€æŸ¥æ ‡å‡†                 | æ£€æŸ¥æ–¹æ³•                 | è´Ÿè´£äºº       | å®ŒæˆçŠ¶æ€ | å¤‡æ³¨         |
| ------------ | ------------------------ | ------------------------ | ------------ | -------- | ------------ |
| æ“ä½œç³»ç»Ÿæ›´æ–° | æ— å®‰å…¨è¡¥ä¸å¾…å®‰è£…         | apt list --upgradable    | ç³»ç»Ÿç®¡ç†å‘˜   | â˜        | æ¯æœˆæ£€æŸ¥ä¸€æ¬¡ |
| PHP ç‰ˆæœ¬æ›´æ–° | ç‰ˆæœ¬æ”¯æŒæœŸå†…ï¼Œæ— é‡å¤§æ¼æ´ | php -v + å®˜æ–¹å…¬å‘Š        | å¼€å‘å·¥ç¨‹å¸ˆ   | â˜        | å­£åº¦æ£€æŸ¥     |
| Symfony æ›´æ–° | ç‰ˆæœ¬æ”¯æŒæœŸå†…             | composer show symfony/\* | å¼€å‘å·¥ç¨‹å¸ˆ   | â˜        | å­£åº¦æ£€æŸ¥     |
| ä¾èµ–åŒ…æ›´æ–°   | æ— å·²çŸ¥å®‰å…¨æ¼æ´           | composer audit           | å¼€å‘å·¥ç¨‹å¸ˆ   | â˜        | æ¯æœˆæ£€æŸ¥     |
| æ•°æ®åº“æ›´æ–°   | ç‰ˆæœ¬æ”¯æŒæœŸå†…             | mysql --version          | æ•°æ®åº“ç®¡ç†å‘˜ | â˜        | åŠå¹´æ£€æŸ¥     |
| Nginx æ›´æ–°   | ç‰ˆæœ¬æ”¯æŒæœŸå†…             | nginx -v                 | è¿ç»´å·¥ç¨‹å¸ˆ   | â˜        | å­£åº¦æ£€æŸ¥     |

**ç³»ç»Ÿæ›´æ–°æ£€æŸ¥è„šæœ¬**:

```bash
#!/bin/bash
# ç³»ç»Ÿæ›´æ–°æ£€æŸ¥è„šæœ¬

echo "=== ç³»ç»Ÿæ›´æ–°æ£€æŸ¥ ==="

# 1. æ“ä½œç³»ç»Ÿæ›´æ–°æ£€æŸ¥
check_os_updates() {
    echo "1. æ£€æŸ¥æ“ä½œç³»ç»Ÿæ›´æ–°..."

    # æ›´æ–°åŒ…åˆ—è¡¨
    apt update &>/dev/null

    # æ£€æŸ¥å¯æ›´æ–°åŒ…æ•°é‡
    local update_count=$(apt list --upgradable 2>/dev/null | grep -v "WARNING" | wc -l)
    echo "å¯æ›´æ–°åŒ…æ•°é‡: $update_count"

    # æ£€æŸ¥å®‰å…¨æ›´æ–°
    local security_updates=$(apt list --upgradable 2>/dev/null | grep -i "security" | wc -l)
    if [[ $security_updates -gt 0 ]]; then
        echo "âš ï¸  å‘ç° $security_updates ä¸ªå®‰å…¨æ›´æ–°"

        # åˆ—å‡ºå®‰å…¨æ›´æ–°
        echo "å®‰å…¨æ›´æ–°åˆ—è¡¨:"
        apt list --upgradable 2>/dev/null | grep -i "security" | head -5
    else
        echo "âœ… æ— å¾…å®‰è£…çš„å®‰å…¨æ›´æ–°"
    fi

    # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬
    local current_kernel=$(uname -r)
    local latest_kernel=$(apt list linux-image* 2>/dev/null | grep -E "linux-image-[0-9]" | sort -V | tail -1 | cut -d' ' -f2 | cut -d'-' -f1-3)
    echo "å½“å‰å†…æ ¸ç‰ˆæœ¬: $current_kernel"
    echo "æœ€æ–°å†…æ ¸ç‰ˆæœ¬: $latest_kernel"
}

# 2. PHPå’ŒSymfonyæ›´æ–°æ£€æŸ¥
check_php_symfony_updates() {
    echo "2. æ£€æŸ¥PHPå’ŒSymfonyæ›´æ–°..."

    # æ£€æŸ¥PHPç‰ˆæœ¬
    local php_version=$(php -v | head -1 | cut -d' ' -f2)
    echo "å½“å‰PHPç‰ˆæœ¬: $php_version"

    # æ£€æŸ¥PHP EOLçŠ¶æ€
    local php_major=$(echo "$php_version" | cut -d'.' -f1-2)
    case $php_major in
        "8.2")
            echo "âœ… PHP 8.2 æ”¯æŒåˆ°2024å¹´11æœˆ"
            ;;
        "8.3")
            echo "âœ… PHP 8.3 æ”¯æŒåˆ°2026å¹´11æœˆ"
            ;;
        "8.1")
            echo "âš ï¸  PHP 8.1 å·²äº2024å¹´11æœˆåœæ­¢æ”¯æŒ"
            ;;
        *)
            echo "âŒ æœªçŸ¥PHPç‰ˆæœ¬çŠ¶æ€"
            ;;
    esac

    # æ£€æŸ¥Symfonyç‰ˆæœ¬
    if [[ -f "composer.json" ]]; then
        local symfony_version=$(composer show symfony/symfony --no-dev 2>/dev/null | grep "versions" | cut -d' ' -f2)
        echo "å½“å‰Symfonyç‰ˆæœ¬: $symfony_version"

        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
        local latest_symfony=$(composer show symfony/symfony --no-dev --latest 2>/dev/null | grep "latest" | cut -d' ' -f2)
        if [[ "$symfony_version" != "$latest_symfony" ]]; then
            echo "âš ï¸  æœ‰æ–°Symfonyç‰ˆæœ¬å¯ç”¨: $latest_symfony"
        else
            echo "âœ… Symfonyç‰ˆæœ¬ä¸ºæœ€æ–°"
        fi
    fi
}

# 3. ä¾èµ–åŒ…å®‰å…¨æ£€æŸ¥
check_dependency_security() {
    echo "3. æ£€æŸ¥ä¾èµ–åŒ…å®‰å…¨æ€§..."

    if [[ -f "composer.json" ]]; then
        # è¿è¡Œå®‰å…¨å®¡è®¡
        echo "æ‰§è¡ŒComposerå®‰å…¨å®¡è®¡..."
        if composer audit; then
            echo "âœ… æ— å·²çŸ¥å®‰å…¨æ¼æ´"
        else
            echo "âŒ å‘ç°å®‰å…¨æ¼æ´ï¼Œè¯·æ›´æ–°ä¾èµ–åŒ…"
        fi

        # æ£€æŸ¥è¿‡æ—¶ä¾èµ–
        echo "æ£€æŸ¥è¿‡æ—¶ä¾èµ–åŒ…..."
        local outdated_count=$(composer outdated --no-dev 2>/dev/null | grep -E "^[a-z]" | wc -l)
        if [[ $outdated_count -gt 0 ]]; then
            echo "âš ï¸  å‘ç° $outdated_count ä¸ªè¿‡æ—¶ä¾èµ–åŒ…"
            composer outdated --no-dev | head -10
        else
            echo "âœ… æ— è¿‡æ—¶ä¾èµ–åŒ…"
        fi
    fi
}

# 4. æ•°æ®åº“æ›´æ–°æ£€æŸ¥
check_database_updates() {
    echo "4. æ£€æŸ¥æ•°æ®åº“æ›´æ–°..."

    # æ£€æŸ¥MySQLç‰ˆæœ¬
    local mysql_version=$(mysql --version 2>/dev/null | cut -d' ' -f3 | cut -d',' -f1)
    echo "å½“å‰MySQLç‰ˆæœ¬: $mysql_version"

    # æ£€æŸ¥æ•°æ®åº“å¤§å°
    local db_size=$(mysql -e "SELECT ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'DB Size in MB' FROM information_schema.tables WHERE table_schema = DATABASE();" 2>/dev/null | tail -1)
    echo "æ•°æ®åº“å¤§å°: ${db_size}MB"

    # æ£€æŸ¥è¡¨ç¢ç‰‡åŒ–
    local fragmented_tables=$(mysql -e "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = DATABASE() AND ROUND(data_free/1024/1024) > 100;" 2>/dev/null | tail -1)
    if [[ $fragmented_tables -gt 0 ]]; then
        echo "âš ï¸  å‘ç° $fragmented_tables ä¸ªç¢ç‰‡åŒ–ä¸¥é‡çš„è¡¨"
    else
        echo "âœ… æ•°æ®åº“è¡¨ç¢ç‰‡åŒ–ç¨‹åº¦æ­£å¸¸"
    fi
}

# 5. Nginxæ›´æ–°æ£€æŸ¥
check_nginx_updates() {
    echo "5. æ£€æŸ¥Nginxæ›´æ–°..."

    local nginx_version=$(nginx -v 2>&1 | cut -d'/' -f2)
    echo "å½“å‰Nginxç‰ˆæœ¬: $nginx_version"

    # æ£€æŸ¥Nginxé…ç½®
    if nginx -t &>/dev/null; then
        echo "âœ… Nginxé…ç½®è¯­æ³•æ­£ç¡®"
    else
        echo "âŒ Nginxé…ç½®å­˜åœ¨é”™è¯¯"
        nginx -t
    fi

    # æ£€æŸ¥SSLè¯ä¹¦
    local ssl_cert="/etc/nginx/ssl/cert.pem"
    if [[ -f "$ssl_cert" ]]; then
        local cert_expiry=$(openssl x509 -in "$ssl_cert" -noout -enddate | cut -d'=' -f2)
        local expiry_timestamp=$(date -d "$cert_expiry" +%s)
        local current_timestamp=$(date +%s)
        local days_until_expiry=$(( (expiry_timestamp - current_timestamp) / 86400 ))

        if [[ $days_until_expiry -lt 30 ]]; then
            echo "âš ï¸  SSLè¯ä¹¦å°†åœ¨ $days_until_expiry å¤©åè¿‡æœŸ"
        else
            echo "âœ… SSLè¯ä¹¦æœ‰æ•ˆ ($days_until_expiry å¤©åè¿‡æœŸ)"
        fi
    fi
}

# 6. ç³»ç»Ÿèµ„æºæ£€æŸ¥
check_system_resources() {
    echo "6. æ£€æŸ¥ç³»ç»Ÿèµ„æº..."

    # æ£€æŸ¥ç£ç›˜ä½¿ç”¨
    local disk_usage=$(df / | tail -1 | awk '{print $5}' | tr -d '%')
    echo "ç£ç›˜ä½¿ç”¨ç‡: $disk_usage%"
    if [[ $disk_usage -gt 80 ]]; then
        echo "âš ï¸  ç£ç›˜ä½¿ç”¨ç‡è¿‡é«˜"
    fi

    # æ£€æŸ¥å†…å­˜ä½¿ç”¨
    local mem_usage=$(free | grep Mem | awk '{printf "%.1f", $3/$2 * 100.0}')
    echo "å†…å­˜ä½¿ç”¨ç‡: $mem_usage%"

    # æ£€æŸ¥ç³»ç»Ÿè´Ÿè½½
    local load_avg=$(uptime | awk -F'load average:' '{print $2}' | awk '{print $1}' | tr -d ',')
    echo "ç³»ç»Ÿè´Ÿè½½: $load_avg"

    # æ£€æŸ¥è¿è¡Œæ—¶é—´
    local uptime_days=$(uptime | awk -F'up ' '{print $2}' | cut -d',' -f1 | tr -d ' ')
    echo "ç³»ç»Ÿè¿è¡Œæ—¶é—´: $uptime_days"
}

# æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
main() {
    echo "ç³»ç»Ÿæ›´æ–°æ£€æŸ¥æŠ¥å‘Š - $(date '+%Y-%m-%d %H:%M:%S')"
    echo "======================================"

    check_os_updates
    echo ""

    check_php_symfony_updates
    echo ""

    check_dependency_security
    echo ""

    check_database_updates
    echo ""

    check_nginx_updates
    echo ""

    check_system_resources
    echo ""

    echo "======================================"
    echo "ç³»ç»Ÿæ›´æ–°æ£€æŸ¥å®Œæˆ"
}

main "$@"
```

#### 10.5.2 æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥

| æ£€æŸ¥é¡¹ç›®   | ä¼˜åŒ–æ ‡å‡†       | æ£€æŸ¥æ–¹æ³•     | è´Ÿè´£äºº       | å®ŒæˆçŠ¶æ€ | å¤‡æ³¨     |
| ---------- | -------------- | ------------ | ------------ | -------- | -------- |
| æ•°æ®åº“ä¼˜åŒ– | æŸ¥è¯¢æ—¶é—´<100ms | æ…¢æŸ¥è¯¢æ—¥å¿—   | æ•°æ®åº“ç®¡ç†å‘˜ | â˜        | æ¯å‘¨åˆ†æ |
| ç¼“å­˜å‘½ä¸­ç‡ | >80%           | Redis ç›‘æ§   | æ€§èƒ½å·¥ç¨‹å¸ˆ   | â˜        | æ¯æ—¥æ£€æŸ¥ |
| ä»£ç ä¼˜åŒ–   | æ— æ€§èƒ½ç“¶é¢ˆ     | æ€§èƒ½åˆ†æå·¥å…· | å¼€å‘å·¥ç¨‹å¸ˆ   | â˜        | æ¯æœˆæ£€æŸ¥ |
| å›¾ç‰‡ä¼˜åŒ–   | å‹ç¼©ç‡>30%     | å›¾ç‰‡å‹ç¼©å·¥å…· | å‰ç«¯å·¥ç¨‹å¸ˆ   | â˜        | æ¯æœˆæ£€æŸ¥ |
| CDN é…ç½®   | ç¼“å­˜ç­–ç•¥åˆç†   | CDN æ§åˆ¶å°   | è¿ç»´å·¥ç¨‹å¸ˆ   | â˜        | å­£åº¦æ£€æŸ¥ |
| è´Ÿè½½å‡è¡¡   | è´Ÿè½½åˆ†å¸ƒå‡åŒ€   | ç›‘æ§å¹³å°     | è¿ç»´å·¥ç¨‹å¸ˆ   | â˜        | æ¯æ—¥æ£€æŸ¥ |

    # æ£€æŸ¥Nginxé”™è¯¯æ—¥å¿—
    local nginx_errors=$(tail -100 /var/log/nginx/error.log | grep -i "error" | wc -l)
    local nginx_total=$(tail -1000 /var/log/nginx/access.log | wc -l)

    if [[ $nginx_total -gt 0 ]]; then
        local nginx_error_rate=$(( nginx_errors * 100 / nginx_total ))
        echo "Nginxé”™è¯¯ç‡: $nginx_error_rate%"

        if [[ $nginx_error_rate -gt $ERROR_RATE_THRESHOLD ]]; then
            echo "âŒ Nginxé”™è¯¯ç‡è¿‡é«˜"
            return 0
        fi
    fi

    # æ£€æŸ¥åº”ç”¨é”™è¯¯æ—¥å¿—
    local app_errors=$(tail -100 var/log/prod.log | grep -i "error\|critical" | wc -l)
    local app_total=$(tail -1000 var/log/prod.log | wc -l)

    if [[ $app_total -gt 0 ]]; then
        local app_error_rate=$(( app_errors * 100 / app_total ))
        echo "åº”ç”¨é”™è¯¯ç‡: $app_error_rate%"

        if [[ $app_error_rate -gt $ERROR_RATE_THRESHOLD ]]; then
            echo "âŒ åº”ç”¨é”™è¯¯ç‡è¿‡é«˜"
            return 0
        fi
    fi

    echo "âœ… é”™è¯¯ç‡æ­£å¸¸"
    return 1

}

# 3. å“åº”æ—¶é—´æ£€æŸ¥

check_response_time() {
echo "3. æ£€æŸ¥å“åº”æ—¶é—´..."

    local response_times=()
    for i in {1..10}; do
        local response_time=$(curl -s -o /dev/null -w "%{time_total}" "http://localhost")
        response_times+=("$response_time")
        sleep 1
    done

    local avg_time=$(printf '%s\n' "${response_times[@]}" | awk '{sum+=$1} END {print sum/NR}')
    local max_time=$(printf '%s\n' "${response_times[@]}" | sort -nr | head -1)

    echo "å¹³å‡å“åº”æ—¶é—´: ${avg_time}s"
    echo "æœ€å¤§å“åº”æ—¶é—´: ${max_time}s"

    if (( $(echo "$avg_time > $RESPONSE_TIME_THRESHOLD" | bc -l) )); then
        echo "âŒ å¹³å‡å“åº”æ—¶é—´è¿‡é•¿"
        return 0
    else
        echo "âœ… å“åº”æ—¶é—´æ­£å¸¸"
        return 1
    fi

}

# 4. æ•°æ®å®Œæ•´æ€§æ£€æŸ¥

check_data_integrity() {
echo "4. æ£€æŸ¥æ•°æ®å®Œæ•´æ€§..."

    # æ£€æŸ¥æ•°æ®åº“è¿æ¥
    if ! mysql -e "SELECT 1;" &>/dev/null; then
        echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
        return 0
    fi

    # æ£€æŸ¥å…³é”®è¡¨
    local critical_tables=("users" "sys_news_articles")
    for table in "${critical_tables[@]}"; do
        local table_check=$(mysql -e "DESCRIBE $table;" 2>/dev/null | wc -l)
        if [[ $table_check -lt 2 ]]; then
            echo "âŒ å…³é”®è¡¨å¼‚å¸¸: $table"
            return 0
        fi
    done

    # æ£€æŸ¥æ•°æ®ä¸€è‡´æ€§
    local consistency_check=$(mysql -e "
        SELECT COUNT(*) FROM sys_news_articles
        WHERE created_at > NOW() INTERVAL 1 DAY AND category_id IS NULL;
    " 2>/dev/null | tail -1)

    if [[ $consistency_check -gt 10 ]]; then
        echo "âŒ æ•°æ®ä¸€è‡´æ€§é—®é¢˜è¾ƒå¤š"
        return 0
    fi

    echo "âœ… æ•°æ®å®Œæ•´æ€§æ­£å¸¸"
    return 1

}

# 5. å®‰å…¨é—®é¢˜æ£€æŸ¥

check_security_issues() {
echo "5. æ£€æŸ¥å®‰å…¨é—®é¢˜..."

    # æ£€æŸ¥å¼‚å¸¸ç™»å½•
    local suspicious_logins=$(tail -1000 /var/log/auth.log | grep -i "failed\|invalid" | wc -l)
    if [[ $suspicious_logins -gt 50 ]]; then
        echo "âŒ å‘ç°å¤§é‡å¼‚å¸¸ç™»å½•å°è¯•"
        return 0
    fi

    # æ£€æŸ¥æ–‡ä»¶æƒé™
    local sensitive_files=(".env" "config/packages/security.yaml")
    for file in "${sensitive_files[@]}"; do
        if [[ -f "$file" ]]; then
            local file_perms=$(stat -c "%a" "$file")
            if [[ "$file_perms" != "600" ]] && [[ "$file_perms" != "640" ]]; then
                echo "âŒ æ•æ„Ÿæ–‡ä»¶æƒé™å¼‚å¸¸: $file ($file_perms)"
                return 0
            fi
        fi
    done

    # æ£€æŸ¥å¼€æ”¾ç«¯å£
    local suspicious_ports=$(netstat -tuln | grep -E ":22|:80|:443" | wc -l)
    if [[ $suspicious_ports -lt 3 ]]; then
        echo "âš ï¸  å¿…è¦ç«¯å£å¯èƒ½æœªå¼€æ”¾"
    fi

    echo "âœ… å®‰å…¨æ£€æŸ¥æ­£å¸¸"
    return 1

}

# 6. ç”¨æˆ·åé¦ˆæ£€æŸ¥

check_user_feedback() {
echo "6. æ£€æŸ¥ç”¨æˆ·åé¦ˆ..."

    # æ¨¡æ‹Ÿç”¨æˆ·æŠ•è¯‰ç»Ÿè®¡ï¼ˆå®é™…åº”ä»åé¦ˆç³»ç»Ÿè·å–ï¼‰
    local complaint_count=0

    # æ£€æŸ¥æœ€è¿‘çš„é”™è¯¯æ—¥å¿—ä½œä¸ºç”¨æˆ·æŠ•è¯‰çš„ä»£ç†æŒ‡æ ‡
    local recent_errors=$(tail -100 var/log/prod.log | grep -i "error" | wc -l)
    complaint_count=$((complaint_count + recent_errors))

    # æ£€æŸ¥5xxå“åº”ä½œä¸ºç”¨æˆ·æŠ•è¯‰çš„ä»£ç†æŒ‡æ ‡
    local server_errors=$(tail -1000 /var/log/nginx/access.log | grep " 5[0-9][0-9] " | wc -l)
    complaint_count=$((complaint_count + server_errors))

    echo "æ¨¡æ‹Ÿç”¨æˆ·æŠ•è¯‰æ•°é‡: $complaint_count"

    if [[ $complaint_count -gt $USER_COMPLAINT_THRESHOLD ]]; then
        echo "âŒ ç”¨æˆ·åé¦ˆé—®é¢˜è¿‡å¤š"
        return 0
    else
        echo "âœ… ç”¨æˆ·åé¦ˆæ­£å¸¸"
        return 1
    fi

}

# ä¸»åˆ¤æ–­é€»è¾‘

main() {
local rollback_triggers=0

    check_service_availability && ((rollback_triggers++))
    check_error_rate && ((rollback_triggers++))
    check_response_time && ((rollback_triggers++))
    check_data_integrity && ((rollback_triggers++))
    check_security_issues && ((rollback_triggers++))
    check_user_feedback && ((rollback_triggers++))

    echo ""
    echo "å›æ»šè§¦å‘æ¡ä»¶æ•°é‡: $rollback_triggers"

    if [[ $rollback_triggers -ge 2 ]]; then
        echo "ğŸš¨ æ»¡è¶³å›æ»šæ¡ä»¶ï¼Œå»ºè®®ç«‹å³æ‰§è¡Œå›æ»šï¼"
        exit 1
    elif [[ $rollback_triggers -eq 1 ]]; then
        echo "âš ï¸  å‘ç°1ä¸ªå›æ»šæ¡ä»¶ï¼Œè¯·å¯†åˆ‡å…³æ³¨"
        exit 2
    else
        echo "âœ… æ— å›æ»šå¿…è¦ï¼Œç³»ç»Ÿè¿è¡Œæ­£å¸¸"
        exit 0
    fi

}

main "$@"

````

#### 10.4.2 å›æ»šæ­¥éª¤ç¡®è®¤

| æ­¥éª¤ | æ“ä½œå†…å®¹   | æ‰§è¡Œå‘½ä»¤                         | è´Ÿè´£äºº       | å®ŒæˆçŠ¶æ€ | éªŒè¯æ–¹æ³•         |
| ---- | ---------- | -------------------------------- | ------------ | -------- | ---------------- |
| 1    | åœæ­¢æœåŠ¡   | systemctl stop nginx php8.2-fpm  | è¿ç»´å·¥ç¨‹å¸ˆ   | â˜        | æ£€æŸ¥è¿›ç¨‹çŠ¶æ€     |
| 2    | ä»£ç å›æ»š   | git checkout previous_tag        | éƒ¨ç½²å·¥ç¨‹å¸ˆ   | â˜        | ç¡®è®¤ç‰ˆæœ¬å·       |
| 3    | æ•°æ®åº“å›æ»š | doctrine:migrations:rollback     | æ•°æ®åº“ç®¡ç†å‘˜ | â˜        | éªŒè¯æ•°æ®çŠ¶æ€     |
| 4    | ä¾èµ–æ¢å¤   | composer install --no-dev        | éƒ¨ç½²å·¥ç¨‹å¸ˆ   | â˜        | æ£€æŸ¥ vendor ç›®å½• |
| 5    | ç¼“å­˜æ¸…ç†   | cache:clear --env=prod           | éƒ¨ç½²å·¥ç¨‹å¸ˆ   | â˜        | æ£€æŸ¥ç¼“å­˜ç›®å½•     |
| 6    | æœåŠ¡å¯åŠ¨   | systemctl start nginx php8.2-fpm | è¿ç»´å·¥ç¨‹å¸ˆ   | â˜        | æ£€æŸ¥æœåŠ¡çŠ¶æ€     |
| 7    | åŠŸèƒ½éªŒè¯   | è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬                   | æµ‹è¯•å·¥ç¨‹å¸ˆ   | â˜        | æ£€æŸ¥æµ‹è¯•ç»“æœ     |

```bash
#!/bin/bash
# åŠŸèƒ½ç¡®è®¤æ£€æŸ¥è„šæœ¬

echo "=== åŠŸèƒ½ç¡®è®¤æ£€æŸ¥ ==="

BASE_URL="http://localhost"
API_BASE_URL="http://localhost/api"

# 1. é¦–é¡µè®¿é—®æ£€æŸ¥
check_homepage() {
    echo "1. æ£€æŸ¥é¦–é¡µè®¿é—®..."

    local response_code=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL")
    local response_time=$(curl -s -o /dev/null -w "%{time_total}" "$BASE_URL")

    if [[ "$response_code" == "200" ]]; then
        echo "âœ… é¦–é¡µè®¿é—®æ­£å¸¸ (HTTP $response_code, ${response_time}s)"
    else
        echo "âŒ é¦–é¡µè®¿é—®å¼‚å¸¸ (HTTP $response_code)"
        return 1
    fi

    # æ£€æŸ¥é™æ€èµ„æº
    local static_resources=("/css/app.css" "/js/app.js" "/favicon.ico")
    for resource in "${static_resources[@]}"; do
        local resource_code=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL$resource")
        if [[ "$resource_code" == "200" ]]; then
            echo "âœ… é™æ€èµ„æºæ­£å¸¸: $resource"
        else
            echo "âš ï¸  é™æ€èµ„æºå¼‚å¸¸: $resource (HTTP $resource_code)"
        fi
    done
}

# 2. APIæ¥å£æ£€æŸ¥
check_api_endpoints() {
    echo "2. æ£€æŸ¥APIæ¥å£..."

    # å¥åº·æ£€æŸ¥æ¥å£
    local health_response=$(curl -s "$API_BASE_URL/health")
    if echo "$health_response" | jq -e '.status' &>/dev/null; then
        echo "âœ… å¥åº·æ£€æŸ¥æ¥å£æ­£å¸¸"
    else
        echo "âŒ å¥åº·æ£€æŸ¥æ¥å£å¼‚å¸¸"
        return 1
    fi

    # æ–‡ç« åˆ—è¡¨æ¥å£
    local articles_response=$(curl -s "$API_BASE_URL/articles")
    if echo "$articles_response" | jq -e '.data' &>/dev/null; then
        echo "âœ… æ–‡ç« åˆ—è¡¨æ¥å£æ­£å¸¸"
    else
        echo "âš ï¸  æ–‡ç« åˆ—è¡¨æ¥å£å¼‚å¸¸"
    fi

    # æ£€æŸ¥APIå“åº”æ—¶é—´
    local api_time=$(curl -s -o /dev/null -w "%{time_total}" "$API_BASE_URL/health")
    if (( $(echo "$api_time < 1.0" | bc -l) )); then
        echo "âœ… APIå“åº”æ—¶é—´æ­£å¸¸: ${api_time}s"
    else
        echo "âš ï¸  APIå“åº”æ—¶é—´è¾ƒé•¿: ${api_time}s"
    fi
}

# 3. JWTè®¤è¯æ£€æŸ¥
check_jwt_auth() {
    echo "3. æ£€æŸ¥JWTè®¤è¯..."

    # æµ‹è¯•ç™»å½•æ¥å£
    local login_response=$(curl -s -X POST \
        -H "Content-Type: application/json" \
        -d '{"username":"test@example.com","password":"testpassword"}' \
        "$API_BASE_URL/login")

    if echo "$login_response" | jq -e '.token' &>/dev/null; then
        local token=$(echo "$login_response" | jq -r '.token')
        echo "âœ… JWT Tokenç”ŸæˆæˆåŠŸ"

        # æµ‹è¯•TokenéªŒè¯
        local protected_response=$(curl -s -H "Authorization: Bearer $token" "$API_BASE_URL/user/profile")
        if echo "$protected_response" | jq -e '.id' &>/dev/null; then
            echo "âœ… JWT TokenéªŒè¯æˆåŠŸ"
        else
            echo "âŒ JWT TokenéªŒè¯å¤±è´¥"
            return 1
        fi
    else
        echo "âŒ JWT Tokenç”Ÿæˆå¤±è´¥"
        return 1
    fi
}

# 4. æ•°æ®åº“æ“ä½œæ£€æŸ¥
check_database_operations() {
    echo "4. æ£€æŸ¥æ•°æ®åº“æ“ä½œ..."

    # æµ‹è¯•æ•°æ®åº“è¿æ¥
    if php bin/console doctrine:database:create --if-not-exists --env=prod &>/dev/null; then
        echo "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
    else
        echo "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
        return 1
    fi

    # æµ‹è¯•æŸ¥è¯¢æ“ä½œ
    local query_result=$(mysql -e "SELECT COUNT(*) as count FROM information_schema.tables WHERE table_schema = DATABASE();" 2>/dev/null | tail -1)
    if [[ -n "$query_result" ]] && [[ "$query_result" -gt 0 ]]; then
        echo "âœ… æ•°æ®åº“æŸ¥è¯¢æ­£å¸¸ (è¡¨æ•°é‡: $query_result)"
    else
        echo "âš ï¸  æ•°æ®åº“æŸ¥è¯¢å¼‚å¸¸"
    fi
}

# 5. ç¼“å­˜åŠŸèƒ½æ£€æŸ¥
check_cache_functionality() {
    echo "5. æ£€æŸ¥ç¼“å­˜åŠŸèƒ½..."

    # æ£€æŸ¥Redisè¿æ¥
    if command -v redis-cli &> /dev/null; then
        if redis-cli ping &>/dev/null; then
            echo "âœ… Redisç¼“å­˜è¿æ¥æ­£å¸¸"

            # æµ‹è¯•ç¼“å­˜è¯»å†™
            local test_key="test_key_$(date +%s)"
            redis-cli set "$test_key" "test_value" &>/dev/null
            local cached_value=$(redis-cli get "$test_key" 2>/dev/null)

            if [[ "$cached_value" == "test_value" ]]; then
                echo "âœ… ç¼“å­˜è¯»å†™åŠŸèƒ½æ­£å¸¸"
                redis-cli del "$test_key" &>/dev/null
            else
                echo "âŒ ç¼“å­˜è¯»å†™åŠŸèƒ½å¼‚å¸¸"
            fi
        else
            echo "âŒ Redisç¼“å­˜è¿æ¥å¤±è´¥"
        fi
    else
        echo "âš ï¸  Redisæœªå®‰è£…"
    fi

    # æ£€æŸ¥Symfonyç¼“å­˜
    if php bin/console cache:pool:stats cache.app --env=prod &>/dev/null; then
        echo "âœ… Symfonyç¼“å­˜ç³»ç»Ÿæ­£å¸¸"
    else
        echo "âš ï¸  Symfonyç¼“å­˜ç³»ç»Ÿå¼‚å¸¸"
    fi
}

# 6. æ—¥å¿—è®°å½•æ£€æŸ¥
check_logging() {
    echo "6. æ£€æŸ¥æ—¥å¿—è®°å½•..."

    local log_files=("var/log/prod.log" "/var/log/nginx/access.log" "/var/log/nginx/error.log")

    for log_file in "${log_files[@]}"; do
        if [[ -f "$log_file" ]]; then
            local file_size=$(stat -c%s "$log_file")
            if [[ $file_size -gt 0 ]]; then
                echo "âœ… æ—¥å¿—æ–‡ä»¶æ­£å¸¸: $log_file (${file_size} bytes)"

                # æ£€æŸ¥æœ€è¿‘é”™è¯¯
                local recent_errors=$(tail -10 "$log_file" | grep -i "error\|critical" | wc -l)
                if [[ $recent_errors -eq 0 ]]; then
                    echo "âœ… æœ€è¿‘æ— é”™è¯¯è®°å½•"
                else
                    echo "âš ï¸  æœ€è¿‘æœ‰ $recent_errors ä¸ªé”™è¯¯"
                fi
            else
                echo "âš ï¸  æ—¥å¿—æ–‡ä»¶ä¸ºç©º: $log_file"
            fi
        else
            echo "âŒ æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $log_file"
        fi
    done
}

# æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
main() {
    local failed=0

    check_homepage || failed=1
    check_api_endpoints || failed=1
    check_jwt_auth || failed=1
    check_database_operations
    check_cache_functionality
    check_logging

    echo ""
    if [[ $failed -eq 0 ]]; then
        echo "ğŸ‰ åŠŸèƒ½ç¡®è®¤æ£€æŸ¥é€šè¿‡ï¼"
        exit 0
    else
        echo "âŒ éƒ¨åˆ†åŠŸèƒ½æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åé‡è¯•"
        exit 1
    fi
}

main "$@"
````

    # è¿è¡Œå•å…ƒæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
    if ./vendor/bin/phpunit --coverage-text --coverage-html=coverage/; then
        echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"

        # æ£€æŸ¥è¦†ç›–ç‡
        coverage=$(grep "Lines:" coverage/index.html | sed 's/.*Lines: *\([0-9.]*\)%.*/\1/')
        if (( $(echo "$coverage >= 80" | bc -l) )); then
            echo "âœ… ä»£ç è¦†ç›–ç‡è¾¾æ ‡: ${coverage}%"
        else
            echo "âš ï¸  ä»£ç è¦†ç›–ç‡ä¸è¶³: ${coverage}%"
        fi
        return 0
    else
        echo "âŒ å•å…ƒæµ‹è¯•å¤±è´¥"
        return 1
    fi

}

# 3. å®‰å…¨æ‰«æ

security_scan() {
echo "3. æ‰§è¡Œå®‰å…¨æ‰«æ..."

    # æ£€æŸ¥ä¾èµ–æ¼æ´
    if composer audit; then
        echo "âœ… ä¾èµ–å®‰å…¨æ£€æŸ¥é€šè¿‡"
    else
        echo "âš ï¸  å‘ç°ä¾èµ–å®‰å…¨æ¼æ´"
    fi

    # æ£€æŸ¥ä»£ç å®‰å…¨é—®é¢˜
    if ./vendor/bin/phpstan analyse src --level=1 --configuration=phpstan-security.neon; then
        echo "âœ… ä»£ç å®‰å…¨æ£€æŸ¥é€šè¿‡"
    else
        echo "âŒ ä»£ç å®‰å…¨æ£€æŸ¥å¤±è´¥"
        return 1
    fi

}

# 4. æ€§èƒ½åŸºå‡†æµ‹è¯•

performance_test() {
echo "4. æ‰§è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."

    # å¯åŠ¨æµ‹è¯•æœåŠ¡å™¨
    php -S localhost:8000 -t public/ &
    local server_pid=$!
    sleep 2

    # æµ‹è¯•APIå“åº”æ—¶é—´
    local response_time=$(curl -o /dev/null -s -w '%{time_total}' http://localhost:8000/api/health)

    if (( $(echo "$response_time < 2.0" | bc -l) )); then
        echo "âœ… APIå“åº”æ—¶é—´æ­£å¸¸: ${response_time}s"
    else
        echo "âš ï¸  APIå“åº”æ—¶é—´è¿‡é•¿: ${response_time}s"
    fi

    # åœæ­¢æµ‹è¯•æœåŠ¡å™¨
    kill $server_pid

}

# æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥

main() {
local failed=0

    static_analysis || failed=1
    unit_tests || failed=1
    security_scan || failed=1
    performance_test

    if [[ $failed -eq 0 ]]; then
        echo ""
        echo "ğŸ‰ æ‰€æœ‰ä»£ç è´¨é‡æ£€æŸ¥é€šè¿‡ï¼"
        exit 0
    else
        echo ""
        echo "âŒ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åé‡è¯•"
        exit 1
    fi

}

main "$@"

````

#### 10.1.2 ç¯å¢ƒå‡†å¤‡æ£€æŸ¥

| æ£€æŸ¥é¡¹ç›®   | æ£€æŸ¥æ ‡å‡†                          | æ£€æŸ¥æ–¹æ³•          | è´Ÿè´£äºº       | å®ŒæˆçŠ¶æ€ | å¤‡æ³¨           |
| ---------- | --------------------------------- | ----------------- | ------------ | -------- | -------------- |
| æœåŠ¡å™¨èµ„æº | CPU < 70%, å†…å­˜ < 80%, ç£ç›˜ < 85% | ç³»ç»Ÿç›‘æ§è„šæœ¬æ£€æŸ¥  | è¿ç»´å·¥ç¨‹å¸ˆ   | â˜        | æ£€æŸ¥èµ„æºä½™é‡   |
| æ•°æ®åº“è¿æ¥ | è¿æ¥æˆåŠŸç‡ 100%                   | æ•°æ®åº“è¿æ¥æµ‹è¯•    | æ•°æ®åº“ç®¡ç†å‘˜ | â˜        | æµ‹è¯•ä¸»ä»è¿æ¥   |
| SSL è¯ä¹¦   | æœ‰æ•ˆæœŸ > 30 å¤©                    | openssl x509 æ£€æŸ¥ | å®‰å…¨å·¥ç¨‹å¸ˆ   | â˜        | æ£€æŸ¥è¯ä¹¦é“¾     |
| ç›‘æ§ç³»ç»Ÿ   | æ‰€æœ‰ç›‘æ§é¡¹æ­£å¸¸                    | æ£€æŸ¥ç›‘æ§é¢æ¿      | è¿ç»´å·¥ç¨‹å¸ˆ   | â˜        | ç¡®è®¤å‘Šè­¦é€šé“   |
| å¤‡ä»½çŠ¶æ€   | æœ€æ–°å¤‡ä»½ < 24 å°æ—¶                | æ£€æŸ¥å¤‡ä»½æ—¥å¿—      | å¤‡ä»½ç®¡ç†å‘˜   | â˜        | éªŒè¯å¤‡ä»½å®Œæ•´æ€§ |
| ç½‘ç»œè¿é€šæ€§ | å¤–ç½‘è®¿é—®æ­£å¸¸                      | ping + curl æµ‹è¯•  | ç½‘ç»œå·¥ç¨‹å¸ˆ   | â˜        | æµ‹è¯• DNS è§£æ  |

**ç¯å¢ƒæ£€æŸ¥è‡ªåŠ¨åŒ–è„šæœ¬**:

```bash
#!/bin/bash
# ç”Ÿäº§ç¯å¢ƒå‡†å¤‡æ£€æŸ¥è„šæœ¬

echo "=== ç”Ÿäº§ç¯å¢ƒå‡†å¤‡æ£€æŸ¥ ==="

# 1. æœåŠ¡å™¨èµ„æºæ£€æŸ¥
check_system_resources() {
    echo "1. æ£€æŸ¥æœåŠ¡å™¨èµ„æº..."

    # CPUä½¿ç”¨ç‡
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | awk '{print $2}' | cut -d'%' -f1)
    if (( $(echo "$cpu_usage < 70" | bc -l) )); then
        echo "âœ… CPUä½¿ç”¨ç‡æ­£å¸¸: ${cpu_usage}%"
    else
        echo "âš ï¸  CPUä½¿ç”¨ç‡è¾ƒé«˜: ${cpu_usage}%"
    fi

    # å†…å­˜ä½¿ç”¨ç‡
    local memory_usage=$(free | awk '/Mem:/ {printf "%.1f", $3/$2 * 100.0}')
    if (( $(echo "$memory_usage < 80" | bc -l) )); then
        echo "âœ… å†…å­˜ä½¿ç”¨ç‡æ­£å¸¸: ${memory_usage}%"
    else
        echo "âš ï¸  å†…å­˜ä½¿ç”¨ç‡è¾ƒé«˜: ${memory_usage}%"
    fi

    # ç£ç›˜ä½¿ç”¨ç‡
    local disk_usage=$(df / | awk 'NR==2 {print $5}' | cut -d'%' -f1)
    if [[ $disk_usage -lt 85 ]]; then
        echo "âœ… ç£ç›˜ä½¿ç”¨ç‡æ­£å¸¸: ${disk_usage}%"
    else
        echo "âš ï¸  ç£ç›˜ä½¿ç”¨ç‡è¾ƒé«˜: ${disk_usage}%"
    fi
}

# 2. æ•°æ®åº“è¿æ¥æ£€æŸ¥
check_database_connection() {
    echo "2. æ£€æŸ¥æ•°æ®åº“è¿æ¥..."

    # ä¸»æ•°æ®åº“è¿æ¥
    if mysql -e "SELECT 1;" &>/dev/null; then
        echo "âœ… ä¸»æ•°æ®åº“è¿æ¥æ­£å¸¸"
    else
        echo "âŒ ä¸»æ•°æ®åº“è¿æ¥å¤±è´¥"
        return 1
    fi

    # æ£€æŸ¥ä»æ•°æ®åº“ï¼ˆå¦‚æœæœ‰ï¼‰
    if mysql -h slave-db -e "SELECT 1;" &>/dev/null; then
        echo "âœ… ä»æ•°æ®åº“è¿æ¥æ­£å¸¸"
    else
        echo "âš ï¸  ä»æ•°æ®åº“è¿æ¥å¤±è´¥æˆ–ä¸å­˜åœ¨"
    fi

    # æ£€æŸ¥æ•°æ®åº“è¿æ¥æ•°
    local connections=$(mysql -e "SHOW STATUS LIKE 'Threads_connected';" | tail -1 | awk '{print $2}')
    local max_connections=$(mysql -e "SHOW VARIABLES LIKE 'max_connections';" | tail -1 | awk '{print $2}')
    local usage=$((connections * 100 / max_connections))

    if [[ $usage -lt 80 ]]; then
        echo "âœ… æ•°æ®åº“è¿æ¥æ•°æ­£å¸¸: $connections/$max_connections (${usage}%)"
    else
        echo "âš ï¸  æ•°æ®åº“è¿æ¥æ•°è¾ƒé«˜: $connections/$max_connections (${usage}%)"
    fi
}

# 3. SSLè¯ä¹¦æ£€æŸ¥
check_ssl_certificates() {
    echo "3. æ£€æŸ¥SSLè¯ä¹¦..."

    local domains=("your-domain.com" "api.your-domain.com")

    for domain in "${domains[@]}"; do
        if [[ -f "/etc/letsencrypt/live/$domain/fullchain.pem" ]]; then
            local expiry_date=$(openssl x509 -in "/etc/letsencrypt/live/$domain/fullchain.pem" -noout -enddate | cut -d= -f2)
            local expiry_timestamp=$(date -d "$expiry_date" +%s)
            local current_timestamp=$(date +%s)
            local days_until_expiry=$(( (expiry_timestamp - current_timestamp) / 86400 ))

            if [[ $days_until_expiry -gt 30 ]]; then
                echo "âœ… $domain SSLè¯ä¹¦æœ‰æ•ˆ: å‰©ä½™ $days_until_expiry å¤©"
            else
                echo "âš ï¸  $domain SSLè¯ä¹¦å³å°†è¿‡æœŸ: å‰©ä½™ $days_until_expiry å¤©"
            fi
        else
            echo "âŒ $domain SSLè¯ä¹¦æ–‡ä»¶ä¸å­˜åœ¨"
        fi
    done
}

# 4. ç›‘æ§ç³»ç»Ÿæ£€æŸ¥
check_monitoring() {
    echo "4. æ£€æŸ¥ç›‘æ§ç³»ç»Ÿ..."

    # æ£€æŸ¥ç›‘æ§æœåŠ¡çŠ¶æ€
    if systemctl is-active --quiet prometheus; then
        echo "âœ… Prometheusç›‘æ§æœåŠ¡æ­£å¸¸"
    else
        echo "âŒ Prometheusç›‘æ§æœåŠ¡å¼‚å¸¸"
    fi

    if systemctl is-active --quiet grafana; then
        echo "âœ… Grafanaç›‘æ§é¢æ¿æ­£å¸¸"
    else
        echo "âŒ Grafanaç›‘æ§é¢æ¿å¼‚å¸¸"
    fi

    # æ£€æŸ¥å‘Šè­¦è§„åˆ™
    if curl -s http://localhost:9093/api/v1/alerts | grep -q "firing"; then
        echo "âš ï¸  å­˜åœ¨æ´»è·ƒå‘Šè­¦"
    else
        echo "âœ… æ— æ´»è·ƒå‘Šè­¦"
    fi
}

# 5. å¤‡ä»½çŠ¶æ€æ£€æŸ¥
check_backup_status() {
    echo "5. æ£€æŸ¥å¤‡ä»½çŠ¶æ€..."

    local backup_dir="/backup"
    local latest_backup=$(find "$backup_dir" -name "*.sql.gz" -type f -printf '%T@ %p\n' | sort -n | tail -1 | cut -d' ' -f2-)

    if [[ -n "$latest_backup" ]]; then
        local backup_age=$(( ($(date +%s) - $(stat -c %Y "$latest_backup")) / 86400 ))

        if [[ $backup_age -lt 1 ]]; then
            echo "âœ… æœ€æ–°å¤‡ä»½åŠæ—¶: ${backup_age}å¤©å‰"
        else
            echo "âš ï¸  æœ€æ–°å¤‡ä»½è¾ƒæ—§: ${backup_age}å¤©å‰"
        fi

        # éªŒè¯å¤‡ä»½å®Œæ•´æ€§
        if gzip -t "$latest_backup" 2>/dev/null; then
            echo "âœ… å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§éªŒè¯é€šè¿‡"
        else
            echo "âŒ å¤‡ä»½æ–‡ä»¶æŸå"
        fi
    else
        echo "âŒ æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
    fi
}

# 6. ç½‘ç»œè¿é€šæ€§æ£€æŸ¥
check_network_connectivity() {
    echo "6. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§..."

    # DNSè§£ææµ‹è¯•
    if nslookup google.com &>/dev/null; then
        echo "âœ… DNSè§£ææ­£å¸¸"
    else
        echo "âŒ DNSè§£æå¤±è´¥"
    fi

    # å¤–ç½‘è¿é€šæ€§æµ‹è¯•
    if ping -c 3 8.8.8.8 &>/dev/null; then
        echo "âœ… å¤–ç½‘è¿é€šæ­£å¸¸"
    else
        echo "âš ï¸  å¤–ç½‘è¿é€šå¼‚å¸¸"
    fi

    # HTTPè®¿é—®æµ‹è¯•
    local http_status=$(curl -s -o /dev/null -w "%{http_code}" http://httpbin.org/ip)
    if [[ "$http_status" == "200" ]]; then
        echo "âœ… HTTPè®¿é—®æ­£å¸¸"
    else
        echo "âš ï¸  HTTPè®¿é—®å¼‚å¸¸ (HTTP $http_status)"
    fi
}

# æ‰§è¡Œæ‰€æœ‰æ£€æŸ¥
main() {
    local failed=0

    check_system_resources
    check_database_connection || failed=1
    check_ssl_certificates
    check_monitoring
    check_backup_status
    check_network_connectivity

    echo ""
    if [[ $failed -eq 0 ]]; then
        echo "ğŸ‰ ç¯å¢ƒå‡†å¤‡æ£€æŸ¥é€šè¿‡ï¼"
        exit 0
    else
        echo "âŒ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤åé‡è¯•"
        exit 1
    fi
}

main "$@"
````

#### 10.1.3 é…ç½®æ–‡ä»¶æ£€æŸ¥

-   [ ] ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®
-   [ ] æ•°æ®åº“è¿æ¥é…ç½®æ­£ç¡®
-   [ ] JWT å¯†é’¥é…ç½®æ­£ç¡®
-   [ ] CORS é…ç½®æ­£ç¡®
-   [ ] ç¼“å­˜é…ç½®æ­£ç¡®
-   [ ] æ—¥å¿—é…ç½®æ­£ç¡®

### 10.2 å‘å¸ƒè¿‡ç¨‹æ£€æŸ¥æ¸…å•

#### 10.2.1 éƒ¨ç½²æ‰§è¡Œæ£€æŸ¥

-   [ ] ä»£ç æ‹‰å–æˆåŠŸ
-   [ ] ä¾èµ–å®‰è£…æˆåŠŸ
-   [ ] ç¼“å­˜æ¸…é™¤æˆåŠŸ
-   [ ] æ•°æ®åº“è¿ç§»æˆåŠŸ
-   [ ] æƒé™è®¾ç½®æ­£ç¡®
-   [ ] æœåŠ¡é‡å¯æˆåŠŸ

#### 10.2.2 åŠŸèƒ½éªŒè¯æ£€æŸ¥

-   [ ] é¦–é¡µè®¿é—®æ­£å¸¸
-   [ ] API æ¥å£å“åº”æ­£å¸¸
-   [ ] JWT è®¤è¯æ­£å¸¸
-   [ ] æ•°æ®åº“æŸ¥è¯¢æ­£å¸¸
-   [ ] ç¼“å­˜åŠŸèƒ½æ­£å¸¸
-   [ ] æ—¥å¿—è®°å½•æ­£å¸¸

### 10.3 å‘å¸ƒåæ£€æŸ¥æ¸…å•

#### 10.3.1 ç›‘æ§æ£€æŸ¥

-   [ ] åº”ç”¨æ€§èƒ½æ­£å¸¸
-   [ ] é”™è¯¯ç‡æ­£å¸¸
-   [ ] èµ„æºä½¿ç”¨æ­£å¸¸
-   [ ] æ•°æ®åº“æ€§èƒ½æ­£å¸¸
-   [ ] ç½‘ç»œè¿æ¥æ­£å¸¸
-   [ ] å®‰å…¨æŒ‡æ ‡æ­£å¸¸

#### 10.3.2 ä¸šåŠ¡æ£€æŸ¥

-   [ ] æ ¸å¿ƒä¸šåŠ¡åŠŸèƒ½æ­£å¸¸
-   [ ] ç”¨æˆ·ä½“éªŒæ­£å¸¸
-   [ ] æ•°æ®ç»Ÿè®¡æ­£å¸¸
-   [ ] ç¬¬ä¸‰æ–¹é›†æˆæ­£å¸¸
-   [ ] æ”¯ä»˜åŠŸèƒ½æ­£å¸¸ï¼ˆå¦‚é€‚ç”¨ï¼‰
-   [ ] é€šçŸ¥åŠŸèƒ½æ­£å¸¸

### 10.4 ç´§æ€¥å›æ»šæ£€æŸ¥æ¸…å•

#### 10.4.1 å›æ»šå‡†å¤‡æ£€æŸ¥

-   [ ] å¤‡ä»½æ–‡ä»¶å¯ç”¨
-   [ ] å›æ»šè„šæœ¬å‡†å¤‡
-   [ ] å›¢é˜Ÿé€šçŸ¥åˆ°ä½
-   [ ] ç”¨æˆ·é€šçŸ¥å‡†å¤‡
-   [ ] é£é™©è¯„ä¼°å®Œæˆ
-   [ ] å›æ»šçª—å£ç¡®è®¤

#### 10.4.2 å›æ»šæ‰§è¡Œæ£€æŸ¥

-   [ ] æœåŠ¡åœæ­¢æˆåŠŸ
-   [ ] ä»£ç æ¢å¤æˆåŠŸ
-   [ ] é…ç½®æ¢å¤æˆåŠŸ
-   [ ] æ•°æ®åº“æ¢å¤æˆåŠŸ
-   [ ] ç¼“å­˜æ¸…é™¤æˆåŠŸ
-   [ ] æœåŠ¡å¯åŠ¨æˆåŠŸ

### 10.5 å®šæœŸç»´æŠ¤æ£€æŸ¥æ¸…å•

#### 10.5.1 æ—¥å¸¸ç»´æŠ¤æ£€æŸ¥

-   [ ] æ—¥å¿—æ¸…ç†å®Œæˆ
-   [ ] å¤‡ä»½æ‰§è¡ŒæˆåŠŸ
-   [ ] ç³»ç»Ÿæ›´æ–°æ£€æŸ¥
-   [ ] å®‰å…¨æ‰«ææ‰§è¡Œ
-   [ ] æ€§èƒ½ç›‘æ§æ­£å¸¸
-   [ ] å‘Šè­¦æµ‹è¯•æ­£å¸¸

#### 10.5.2 å‘¨æœŸæ€§ç»´æŠ¤æ£€æŸ¥

-   [ ] æ•°æ®åº“ä¼˜åŒ–å®Œæˆ
-   [ ] ç´¢å¼•é‡å»ºå®Œæˆ
-   [ ] ç»Ÿè®¡ä¿¡æ¯æ›´æ–°
-   [ ] ç¼“å­˜æ¸…ç†å®Œæˆ
-   [ ] è¯ä¹¦æœ‰æ•ˆæœŸæ£€æŸ¥
-   [ ] ä¾èµ–åŒ…æ›´æ–°æ£€æŸ¥

---

## é™„å½•

### A. ç›¸å…³æ–‡æ¡£é“¾æ¥

-   [é¡¹ç›®æŠ€æœ¯æ–‡æ¡£](./é¡¹ç›®æ–‡æ¡£.md)
-   [API æ¥å£æ–‡æ¡£](./public/API_Documentation_Public.md)
-   [æ•°æ®åº“è®¾è®¡æ–‡æ¡£](./create_tables.sql)
-   [å®‰å…¨é…ç½®æŒ‡å—](./config/packages/security.yaml)

### B. ç´§æ€¥è”ç³»æ–¹å¼

-   æŠ€æœ¯è´Ÿè´£äºº: [è”ç³»æ–¹å¼]
-   è¿ç»´è´Ÿè´£äºº: [è”ç³»æ–¹å¼]
-   æ•°æ®åº“ç®¡ç†å‘˜: [è”ç³»æ–¹å¼]
-   å®‰å…¨è´Ÿè´£äºº: [è”ç³»æ–¹å¼]

### C. ç‰ˆæœ¬å†å²

| ç‰ˆæœ¬   | æ—¥æœŸ       | ä¿®æ”¹å†…å®¹     | ä¿®æ”¹äºº     |
| ------ | ---------- | ------------ | ---------- |
| v1.0.0 | 2025-11-27 | åˆå§‹ç‰ˆæœ¬åˆ›å»º | æ–‡æ¡£åˆ›å»ºè€… |

### D. å˜æ›´è®°å½•

-   2025-11-27: åˆ›å»ºç”Ÿäº§ç¯å¢ƒå‘å¸ƒæ–‡æ¡£æ¡†æ¶
-   å¾…è¡¥å……: å…·ä½“æŠ€æœ¯ç»†èŠ‚å¡«å……
-   å¾…è¡¥å……: å®é™…éƒ¨ç½²ç»éªŒè¡¥å……

---

**æ–‡æ¡£çŠ¶æ€**: è‰ç¨¿  
**ä¸‹æ¬¡å®¡æŸ¥æ—¥æœŸ**: [å¾…å¡«å†™]  
**æ–‡æ¡£æ‰€æœ‰è€…**: è¿ç»´å›¢é˜Ÿ

---

## ç¬¬ 11 ç« ï¼šé™„å½•

### 11.1 ç‰ˆæœ¬ä¿¡æ¯ä¸æ›´æ–°æ—¥å¿—

#### æ–‡æ¡£ç‰ˆæœ¬ä¿¡æ¯

-   **æ–‡æ¡£ç‰ˆæœ¬**: v2.1.0
-   **æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 27 æ—¥
-   **é€‚ç”¨ç³»ç»Ÿç‰ˆæœ¬**: Symfony 7.3 + PHP 8.2+
-   **ç»´æŠ¤äººå‘˜**: è¿ç»´å›¢é˜Ÿ

#### æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬   | æ›´æ–°æ—¥æœŸ   | æ›´æ–°å†…å®¹                                            | æ›´æ–°äºº   |
| ------ | ---------- | --------------------------------------------------- | -------- |
| v2.1.0 | 2025-11-27 | å®Œå–„ç¬¬ 8 ç« æ•…éšœæ’é™¤å’Œç¬¬ 10 ç« æ£€æŸ¥æ¸…å•ï¼Œæ·»åŠ è¯¦ç»†è„šæœ¬ | è¿ç»´å›¢é˜Ÿ |
| v2.0.0 | 2025-11-20 | é‡æ„æ–‡æ¡£ç»“æ„ï¼Œæ·»åŠ ä¼ä¸šçº§æ•…éšœæ’é™¤æŒ‡å—                | è¿ç»´å›¢é˜Ÿ |
| v1.5.0 | 2025-11-15 | æ·»åŠ  JWT è®¤è¯å’ŒåŒæ•°æ®åº“æ¶æ„éƒ¨ç½²æŒ‡å—                 | å¼€å‘å›¢é˜Ÿ |
| v1.2.0 | 2025-11-10 | å®Œå–„ç›‘æ§é…ç½®å’Œå‘Šè­¦æœºåˆ¶                              | è¿ç»´å›¢é˜Ÿ |
| v1.0.0 | 2025-11-01 | åˆå§‹ç‰ˆæœ¬ï¼ŒåŸºç¡€éƒ¨ç½²æµç¨‹                              | å¼€å‘å›¢é˜Ÿ |

### 11.2 å¿«é€Ÿå‚è€ƒ

#### å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

```bash
# Symfonyå‘½ä»¤
php bin/console cache:clear --env=prod              # æ¸…ç†ç”Ÿäº§ç¼“å­˜
php bin/console doctrine:migrations:migrate          # æ‰§è¡Œæ•°æ®åº“è¿ç§»
php bin/console jwt:generate-keypair                 # ç”ŸæˆJWTå¯†é’¥å¯¹
php bin/console debug:router                         # æŸ¥çœ‹è·¯ç”±åˆ—è¡¨
php bin/console debug:container                      # æŸ¥çœ‹æœåŠ¡å®¹å™¨

# æ•°æ®åº“æ“ä½œ
mysql -u root -p                                    # ç™»å½•MySQL
mysqldump -u root -p database_name > backup.sql     # æ•°æ®åº“å¤‡ä»½
mysql -u root -p database_name < backup.sql         # æ•°æ®åº“æ¢å¤

# æœåŠ¡ç®¡ç†
systemctl status nginx                              # æ£€æŸ¥NginxçŠ¶æ€
systemctl restart php8.2-fpm                       # é‡å¯PHP-FPM
systemctl reload nginx                              # é‡è½½Nginxé…ç½®
journalctl -u nginx -f                              # æŸ¥çœ‹Nginxæ—¥å¿—

# æ€§èƒ½ç›‘æ§
top                                                  # æŸ¥çœ‹ç³»ç»Ÿè¿›ç¨‹
htop                                                 # å¢å¼ºç‰ˆè¿›ç¨‹ç›‘æ§
iotop                                                # ç£ç›˜I/Oç›‘æ§
netstat -tuln                                       # æŸ¥çœ‹ç½‘ç»œè¿æ¥
```

#### é…ç½®æ–‡ä»¶è·¯å¾„

| é…ç½®ç±»å‹ | æ–‡ä»¶è·¯å¾„                                        | ç”¨é€”           |
| -------- | ----------------------------------------------- | -------------- |
| ç¯å¢ƒå˜é‡ | `.env`                                          | åº”ç”¨ç¯å¢ƒé…ç½®   |
| æ•°æ®åº“   | `config/packages/doctrine.yaml`                 | æ•°æ®åº“è¿æ¥é…ç½® |
| å®‰å…¨     | `config/packages/security.yaml`                 | å®‰å…¨è®¤è¯é…ç½®   |
| JWT      | `config/packages/lexik_jwt_authentication.yaml` | JWT è®¤è¯é…ç½®   |
| CORS     | `config/packages/nelmio_cors.yaml`              | è·¨åŸŸé…ç½®       |
| ç¼“å­˜     | `config/packages/cache.yaml`                    | ç¼“å­˜é…ç½®       |
| Nginx    | `/etc/nginx/sites-available/your-site`          | Web æœåŠ¡å™¨é…ç½® |
| PHP-FPM  | `/etc/php/8.2/fpm/pool.d/www.conf`              | PHP è¿›ç¨‹é…ç½®   |
| MySQL    | `/etc/mysql/mysql.conf.d/mysqld.cnf`            | æ•°æ®åº“é…ç½®     |

#### ç«¯å£å’ŒæœåŠ¡

| æœåŠ¡  | ç«¯å£ | åè®® | ç”¨é€”          |
| ----- | ---- | ---- | ------------- |
| HTTP  | 80   | TCP  | Web æœåŠ¡      |
| HTTPS | 443  | TCP  | å®‰å…¨ Web æœåŠ¡ |
| MySQL | 3306 | TCP  | æ•°æ®åº“æœåŠ¡    |
| Redis | 6379 | TCP  | ç¼“å­˜æœåŠ¡      |
| SSH   | 22   | TCP  | è¿œç¨‹ç®¡ç†      |

### 11.3 æ•…éšœæ’é™¤å¿«é€Ÿç´¢å¼•

#### æŒ‰é”™è¯¯ç±»å‹å¿«é€Ÿå®šä½

**HTTP é”™è¯¯ä»£ç **

-   **403 Forbidden**: æ£€æŸ¥æ–‡ä»¶æƒé™å’Œ Nginx é…ç½®
-   **404 Not Found**: æ£€æŸ¥è·¯ç”±é…ç½®å’Œ URL é‡å†™
-   **500 Internal Server Error**: æ£€æŸ¥ PHP é”™è¯¯æ—¥å¿—
-   **502 Bad Gateway**: æ£€æŸ¥ PHP-FPM çŠ¶æ€
-   **503 Service Unavailable**: æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ

**æ•°æ®åº“é”™è¯¯**

-   **Connection refused**: æ£€æŸ¥ MySQL æœåŠ¡çŠ¶æ€
-   **Access denied**: æ£€æŸ¥æ•°æ®åº“ç”¨æˆ·æƒé™
-   **Table doesn't exist**: æ‰§è¡Œæ•°æ®åº“è¿ç§»
-   **Too many connections**: è°ƒæ•´ max_connections å‚æ•°

**æ€§èƒ½é—®é¢˜**

-   **å“åº”æ…¢**: æ£€æŸ¥æ…¢æŸ¥è¯¢æ—¥å¿—å’Œç¼“å­˜é…ç½®
-   **å†…å­˜ä¸è¶³**: æ£€æŸ¥ PHP memory_limit å’Œç³»ç»Ÿå†…å­˜
-   **CPU ä½¿ç”¨ç‡é«˜**: æ£€æŸ¥è¿›ç¨‹çŠ¶æ€å’Œä»£ç æ€§èƒ½

### 11.4 åº”æ€¥å“åº”æµç¨‹

#### ç´§æ€¥è”ç³»äºº

| è§’è‰²         | å§“å | ç”µè¯          | é‚®ç®±                 | èŒè´£       |
| ------------ | ---- | ------------- | -------------------- | ---------- |
| è¿ç»´è´Ÿè´£äºº   | å¼ ä¸‰ | 138-xxxx-xxxx | ops@company.com      | ç³»ç»Ÿè¿ç»´   |
| å¼€å‘è´Ÿè´£äºº   | æå›› | 139-xxxx-xxxx | dev@company.com      | åº”ç”¨å¼€å‘   |
| æ•°æ®åº“ç®¡ç†å‘˜ | ç‹äº” | 137-xxxx-xxxx | dba@company.com      | æ•°æ®åº“ç®¡ç† |
| å®‰å…¨è´Ÿè´£äºº   | èµµå…­ | 136-xxxx-xxxx | security@company.com | å®‰å…¨ç®¡ç†   |
| äº§å“è´Ÿè´£äºº   | é’±ä¸ƒ | 135-xxxx-xxxx | product@company.com  | äº§å“å†³ç­–   |

#### åº”æ€¥å“åº”æ­¥éª¤

1. **æ•…éšœå‘ç°** (0-5 åˆ†é’Ÿ)

    - ç›‘æ§å‘Šè­¦æˆ–ç”¨æˆ·åé¦ˆ
    - ç¡®è®¤æ•…éšœå½±å“èŒƒå›´
    - å¯åŠ¨åº”æ€¥å“åº”

2. **åˆæ­¥è¯Šæ–­** (5-15 åˆ†é’Ÿ)

    - æ£€æŸ¥æœåŠ¡çŠ¶æ€
    - æŸ¥çœ‹é”™è¯¯æ—¥å¿—
    - ç¡®å®šæ•…éšœç±»å‹

3. **ç´§æ€¥å¤„ç†** (15-30 åˆ†é’Ÿ)

    - æ‰§è¡Œä¸´æ—¶ä¿®å¤
    - å¿…è¦æ—¶æ‰§è¡Œå›æ»š
    - æ¢å¤æ ¸å¿ƒæœåŠ¡

4. **æ ¹å› åˆ†æ** (30 åˆ†é’Ÿ-2 å°æ—¶)

    - æ·±å…¥åˆ†æé—®é¢˜
    - åˆ¶å®šè§£å†³æ–¹æ¡ˆ
    - å®æ–½æ°¸ä¹…ä¿®å¤

5. **äº‹åæ€»ç»“** (2 å°æ—¶-1 å¤©)
    - ç¼–å†™æ•…éšœæŠ¥å‘Š
    - æ›´æ–°è¿ç»´æ–‡æ¡£
    - åˆ¶å®šé¢„é˜²æªæ–½

### 11.5 è„šæœ¬é›†åˆç´¢å¼•

#### è¯Šæ–­è„šæœ¬

-   [`scripts/system_diagnosis.sh`](scripts/system_diagnosis.sh) - ç³»ç»Ÿç»¼åˆè¯Šæ–­
-   [`scripts/health_monitor.sh`](scripts/health_monitor.sh) - å¥åº·ç›‘æ§å®ˆæŠ¤è¿›ç¨‹
-   [`scripts/troubleshooting_helper.sh`](scripts/troubleshooting_helper.sh) - äº¤äº’å¼æ•…éšœæ’é™¤åŠ©æ‰‹

#### éƒ¨ç½²è„šæœ¬

-   [`scripts/deploy.sh`](scripts/deploy.sh) - è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬
-   [`scripts/rollback.sh`](scripts/rollback.sh) - è‡ªåŠ¨å›æ»šè„šæœ¬
-   [`scripts/backup.sh`](scripts/backup.sh) - æ•°æ®å¤‡ä»½è„šæœ¬

#### æ£€æŸ¥è„šæœ¬

-   [`scripts/pre_release_check.sh`](scripts/pre_release_check.sh) - å‘å¸ƒå‰æ£€æŸ¥
-   [`scripts/post_release_check.sh`](scripts/post_release_check.sh) - å‘å¸ƒåæ£€æŸ¥
-   [`scripts/security_audit.sh`](scripts/security_audit.sh) - å®‰å…¨å®¡è®¡è„šæœ¬

#### ç»´æŠ¤è„šæœ¬

-   [`scripts/system_update.sh`](scripts/system_update.sh) - ç³»ç»Ÿæ›´æ–°è„šæœ¬
-   [`scripts/performance_tuning.sh`](scripts/performance_tuning.sh) - æ€§èƒ½ä¼˜åŒ–è„šæœ¬
-   [`scripts/log_analysis.sh`](scripts/log_analysis.sh) - æ—¥å¿—åˆ†æè„šæœ¬

### 11.6 ç›‘æ§æŒ‡æ ‡å‚è€ƒ

#### ç³»ç»ŸæŒ‡æ ‡é˜ˆå€¼

| æŒ‡æ ‡       | æ­£å¸¸èŒƒå›´ | è­¦å‘Šé˜ˆå€¼ | ä¸¥é‡é˜ˆå€¼ | æ£€æŸ¥é¢‘ç‡ |
| ---------- | -------- | -------- | -------- | -------- |
| CPU ä½¿ç”¨ç‡ | < 70%    | 70-85%   | > 85%    | 1 åˆ†é’Ÿ   |
| å†…å­˜ä½¿ç”¨ç‡ | < 80%    | 80-90%   | > 90%    | 1 åˆ†é’Ÿ   |
| ç£ç›˜ä½¿ç”¨ç‡ | < 70%    | 70-85%   | > 85%    | 5 åˆ†é’Ÿ   |
| ç³»ç»Ÿè´Ÿè½½   | < 2.0    | 2.0-4.0  | > 4.0    | 1 åˆ†é’Ÿ   |
| ç½‘ç»œå»¶è¿Ÿ   | < 50ms   | 50-100ms | > 100ms  | 1 åˆ†é’Ÿ   |

#### åº”ç”¨æŒ‡æ ‡é˜ˆå€¼

| æŒ‡æ ‡         | æ­£å¸¸èŒƒå›´ | è­¦å‘Šé˜ˆå€¼  | ä¸¥é‡é˜ˆå€¼ | æ£€æŸ¥é¢‘ç‡ |
| ------------ | -------- | --------- | -------- | -------- |
| å“åº”æ—¶é—´     | < 200ms  | 200-500ms | > 500ms  | 1 åˆ†é’Ÿ   |
| é”™è¯¯ç‡       | < 1%     | 1-5%      | > 5%     | 1 åˆ†é’Ÿ   |
| å¹¶å‘è¿æ¥æ•°   | < 1000   | 1000-1500 | > 1500   | 1 åˆ†é’Ÿ   |
| æ•°æ®åº“è¿æ¥æ•° | < 50     | 50-80     | > 80     | 1 åˆ†é’Ÿ   |
| ç¼“å­˜å‘½ä¸­ç‡   | > 90%    | 80-90%    | < 80%    | 5 åˆ†é’Ÿ   |

### 11.7 å®‰å…¨æ£€æŸ¥æ¸…å•

#### æ—¥å¸¸å®‰å…¨æ£€æŸ¥

-   [ ] æ£€æŸ¥ç³»ç»Ÿç”¨æˆ·å’Œæƒé™
-   [ ] å®¡æŸ¥ç™»å½•æ—¥å¿—å’Œå¼‚å¸¸è®¿é—®
-   [ ] éªŒè¯ SSL è¯ä¹¦æœ‰æ•ˆæœŸ
-   [ ] æ£€æŸ¥é˜²ç«å¢™è§„åˆ™
-   [ ] æ‰«æç³»ç»Ÿæ¼æ´
-   [ ] å¤‡ä»½å®‰å…¨é…ç½®
-   [ ] ç›‘æ§æ–‡ä»¶å®Œæ•´æ€§
-   [ ] æ£€æŸ¥è¿›ç¨‹å’Œç«¯å£

#### æœˆåº¦å®‰å…¨å®¡è®¡

-   [ ] æ›´æ–°ç³»ç»Ÿè¡¥ä¸
-   [ ] å®¡æŸ¥è®¿é—®æ§åˆ¶ç­–ç•¥
-   [ ] æ£€æŸ¥æ•°æ®åº“æƒé™
-   [ ] éªŒè¯å¤‡ä»½åŠ å¯†
-   [ ] æµ‹è¯•åº”æ€¥å“åº”æµç¨‹
-   [ ] æ›´æ–°å®‰å…¨æ–‡æ¡£
-   [ ] åŸ¹è®­å®‰å…¨æ„è¯†
-   [ ] è¯„ä¼°å®‰å…¨é£é™©

### 11.8 æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### æ•°æ®åº“ä¼˜åŒ–

```sql
-- åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢
CREATE INDEX idx_article_created_at ON sys_news_articles(created_at);
CREATE INDEX idx_user_email ON users(email);

-- åˆ†æè¡¨ç»Ÿè®¡ä¿¡æ¯
ANALYZE TABLE sys_news_articles;

-- ä¼˜åŒ–è¡¨ç»“æ„
OPTIMIZE TABLE sys_news_articles;
```

#### PHP é…ç½®ä¼˜åŒ–

```ini
# php.ini
memory_limit = 256M
max_execution_time = 30
max_input_vars = 3000
opcache.enable = 1
opcache.memory_consumption = 128
```

#### Nginx é…ç½®ä¼˜åŒ–

```nginx
# å¯ç”¨gzipå‹ç¼©
gzip on;
gzip_types text/plain text/css application/json application/javascript;

# è®¾ç½®ç¼“å­˜å¤´
location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

---

## æ–‡æ¡£ç»“æŸ

**æœ¬æ–‡æ¡£æœ€åæ›´æ–°æ—¶é—´**: 2025 å¹´ 11 æœˆ 27 æ—¥  
**æ–‡æ¡£ç»´æŠ¤**: è¿ç»´å›¢é˜Ÿ  
**è”ç³»æ–¹å¼**: ops@company.com

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»ç›¸å…³è´£ä»»äººæˆ–æäº¤ Issue åˆ°é¡¹ç›®ä»“åº“ã€‚

**æ³¨æ„**: æœ¬æ–‡æ¡£å†…å®¹ä¼šéšç€ç³»ç»Ÿç‰ˆæœ¬æ›´æ–°è€ŒæŒç»­æ›´æ–°ï¼Œè¯·ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ã€‚

---

## æ–‡æ¡£ä½¿ç”¨æŒ‡å—

### å¦‚ä½•ä½¿ç”¨æœ¬æ–‡æ¡£

æœ¬æ–‡æ¡£æ˜¯ä¸º Symfony 7.3 + PHP 8.2+ RESTful API é¡¹ç›®è®¾è®¡çš„å®Œæ•´ç”Ÿäº§ç¯å¢ƒå‘å¸ƒå’Œè¿ç»´æŒ‡å—ã€‚å»ºè®®æŒ‰ä»¥ä¸‹æ–¹å¼ä½¿ç”¨ï¼š

#### 1. é¦–æ¬¡éƒ¨ç½²

-   é˜…è¯»ç¬¬ 1-7 ç« äº†è§£ç³»ç»Ÿæ¶æ„å’Œé…ç½®è¦æ±‚
-   æŒ‰ç…§ç¬¬ 2-5 ç« è¿›è¡Œç¯å¢ƒæ­å»ºå’Œé…ç½®
-   ä½¿ç”¨ç¬¬ 9 ç« è¿›è¡Œå¤‡ä»½éªŒè¯
-   æ‰§è¡Œç¬¬ 10 ç« æ£€æŸ¥æ¸…å•ç¡®ä¿éƒ¨ç½²æˆåŠŸ

#### 2. æ—¥å¸¸è¿ç»´

-   å®šæœŸè¿è¡Œç¬¬ 8 ç« æ•…éšœæ’é™¤è„šæœ¬
-   ä½¿ç”¨ç¬¬ 10 ç« æ£€æŸ¥æ¸…å•è¿›è¡Œä¾‹è¡Œæ£€æŸ¥
-   å…³æ³¨ç¬¬ 7 ç« ç›‘æ§æŒ‡æ ‡
-   å‚è€ƒç¬¬ 11 ç« å¿«é€Ÿå‚è€ƒ

#### 3. æ•…éšœå¤„ç†

-   ä½¿ç”¨ç¬¬ 8 ç« æ•…éšœæ’é™¤æŒ‡å—
-   è¿è¡Œ scripts ç›®å½•ä¸‹çš„è¯Šæ–­è„šæœ¬
-   å‚è€ƒé™„å½•ä¸­çš„åº”æ€¥å“åº”æµç¨‹
-   è”ç³»ç›¸å…³è´£ä»»äºº

#### 4. ç‰ˆæœ¬æ›´æ–°

-   æ‰§è¡Œå‘å¸ƒå‰æ£€æŸ¥æ¸…å•
-   æŒ‰ç…§ç¬¬ 3-4 ç« è¿›è¡Œä»£ç éƒ¨ç½²
-   è¿è¡Œå‘å¸ƒåæ£€æŸ¥éªŒè¯
-   å‡†å¤‡å›æ»šæ–¹æ¡ˆ

### è„šæœ¬ä½¿ç”¨å¿«é€Ÿå‚è€ƒ

| åœºæ™¯     | è„šæœ¬å‘½ä»¤                                 | è¯´æ˜           |
| -------- | ---------------------------------------- | -------------- |
| ç³»ç»Ÿè¯Šæ–­ | `sudo ./scripts/system_diagnosis.sh`     | å…¨é¢ç³»ç»Ÿæ£€æŸ¥   |
| å¯åŠ¨ç›‘æ§ | `sudo ./scripts/health_monitor.sh start` | å¯åŠ¨å¥åº·ç›‘æ§   |
| æ•…éšœæ’é™¤ | `./scripts/troubleshooting_helper.sh`    | äº¤äº’å¼é—®é¢˜è¯Šæ–­ |
| åœæ­¢ç›‘æ§ | `sudo ./scripts/health_monitor.sh stop`  | åœæ­¢å¥åº·ç›‘æ§   |

### æœ€ä½³å®è·µå»ºè®®

1. **å®šæœŸç»´æŠ¤**

    - æ¯å‘¨æ‰§è¡Œç³»ç»Ÿè¯Šæ–­
    - æ¯æœˆæ£€æŸ¥å®‰å…¨æ›´æ–°
    - æ¯å­£åº¦è¿›è¡Œæ€§èƒ½ä¼˜åŒ–

2. **ç›‘æ§å‘Šè­¦**

    - è®¾ç½®åˆç†çš„ç›‘æ§é˜ˆå€¼
    - é…ç½®å¤šæ¸ é“å‘Šè­¦é€šçŸ¥
    - å®šæœŸæµ‹è¯•å‘Šè­¦æœºåˆ¶

3. **å¤‡ä»½ç­–ç•¥**

    - æ¯æ—¥è‡ªåŠ¨å¤‡ä»½æ•°æ®åº“
    - æ¯å‘¨å¤‡ä»½é…ç½®æ–‡ä»¶
    - å®šæœŸéªŒè¯å¤‡ä»½æœ‰æ•ˆæ€§

4. **å®‰å…¨é˜²æŠ¤**
    - å®šæœŸæ›´æ–°ç³»ç»Ÿè¡¥ä¸
    - ç›‘æ§å¼‚å¸¸è®¿é—®è¡Œä¸º
    - å®šæœŸè¿›è¡Œå®‰å…¨å®¡è®¡

### ç‰ˆæœ¬å…¼å®¹æ€§

| ç»„ä»¶    | æ”¯æŒç‰ˆæœ¬ | æ¨èç‰ˆæœ¬ | EOL æ—¶é—´ |
| ------- | -------- | -------- | -------- |
| PHP     | 8.2+     | 8.3      | 2026-11  |
| Symfony | 7.0+     | 7.3      | 2027-05  |
| MySQL   | 8.0+     | 8.0      | 2030-04  |
| Nginx   | 1.20+    | 1.24     | æŒç»­æ”¯æŒ |
| Redis   | 6.0+     | 7.0      | æŒç»­æ”¯æŒ |

### æ€§èƒ½åŸºå‡†

| æŒ‡æ ‡           | ç›®æ ‡å€¼  | è­¦å‘Šé˜ˆå€¼  | ä¸¥é‡é˜ˆå€¼ |
| -------------- | ------- | --------- | -------- |
| é¡µé¢å“åº”æ—¶é—´   | < 200ms | 200-500ms | > 500ms  |
| API å“åº”æ—¶é—´   | < 100ms | 100-300ms | > 300ms  |
| æ•°æ®åº“æŸ¥è¯¢æ—¶é—´ | < 50ms  | 50-100ms  | > 100ms  |
| CPU ä½¿ç”¨ç‡     | < 70%   | 70-85%    | > 85%    |
| å†…å­˜ä½¿ç”¨ç‡     | < 80%   | 80-90%    | > 90%    |
| ç£ç›˜ä½¿ç”¨ç‡     | < 70%   | 70-85%    | > 85%    |

### å¸¸è§é—®é¢˜ FAQ

**Q: å¦‚ä½•å¿«é€Ÿæ£€æŸ¥ç³»ç»ŸçŠ¶æ€ï¼Ÿ**
A: è¿è¡Œ `sudo ./scripts/system_diagnosis.sh` è¿›è¡Œå…¨é¢æ£€æŸ¥ï¼Œæˆ–ä½¿ç”¨ `./scripts/troubleshooting_helper.sh` é€‰æ‹©ç»¼åˆæ£€æŸ¥ã€‚

**Q: åº”ç”¨å“åº”æ…¢æ€ä¹ˆåŠï¼Ÿ**
A: ä½¿ç”¨æ•…éšœæ’é™¤åŠ©æ‰‹çš„æ€§èƒ½é—®é¢˜æ’æŸ¥åŠŸèƒ½ï¼Œæ£€æŸ¥ CPUã€å†…å­˜ã€æ•°æ®åº“æŸ¥è¯¢å’Œç¼“å­˜çŠ¶æ€ã€‚

**Q: å¦‚ä½•è®¾ç½®è‡ªåŠ¨ç›‘æ§ï¼Ÿ**
A: ä½¿ç”¨ `sudo ./scripts/health_monitor.sh start` å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼Œé…ç½®é‚®ä»¶å’Œ Slack å‘Šè­¦ã€‚

**Q: æ•°æ®åº“è¿æ¥å¤±è´¥å¦‚ä½•å¤„ç†ï¼Ÿ**
A: æ£€æŸ¥ MySQL æœåŠ¡çŠ¶æ€ã€è¿æ¥é…ç½®ã€ç”¨æˆ·æƒé™ï¼Œå‚è€ƒç¬¬ 8 ç« æ•°æ®åº“è¿æ¥é—®é¢˜æ’æŸ¥ã€‚

**Q: å¦‚ä½•å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬ï¼Ÿ**
A: ä½¿ç”¨ç¬¬ 10 ç« ç´§æ€¥å›æ»šæ£€æŸ¥æ¸…å•ï¼Œæ‰§è¡Œè‡ªåŠ¨å›æ»šè„šæœ¬æˆ–æ‰‹åŠ¨å›æ»šæ­¥éª¤ã€‚

---

## è‡´è°¢

æœ¬æ–‡æ¡£çš„ç¼–å†™å’Œç»´æŠ¤ç¦»ä¸å¼€ä»¥ä¸‹å›¢é˜Ÿçš„åŠªåŠ›ï¼š

-   **å¼€å‘å›¢é˜Ÿ**: æä¾›æŠ€æœ¯æ¶æ„æ”¯æŒå’Œä»£ç å®ç°
-   **è¿ç»´å›¢é˜Ÿ**: è´¡èµ è¿ç»´ç»éªŒå’Œæœ€ä½³å®è·µ
-   **å®‰å…¨å›¢é˜Ÿ**: æä¾›å®‰å…¨è§„èŒƒå’Œé˜²æŠ¤å»ºè®®
-   **æµ‹è¯•å›¢é˜Ÿ**: éªŒè¯æ–‡æ¡£å‡†ç¡®æ€§å’Œå¯æ“ä½œæ€§

ç‰¹åˆ«æ„Ÿè°¢æ‰€æœ‰ä¸ºæœ¬æ–‡æ¡£æä¾›åé¦ˆå’Œå»ºè®®çš„åŒäº‹ä»¬ã€‚

---

## å…è´£å£°æ˜

æœ¬æ–‡æ¡£ä»…ä¾›å‚è€ƒï¼Œå®é™…éƒ¨ç½²å’Œè¿ç»´è¯·æ ¹æ®å…·ä½“ç¯å¢ƒå’Œéœ€æ±‚è¿›è¡Œè°ƒæ•´ã€‚ä½¿ç”¨æœ¬æ–‡æ¡£ä¸­çš„è„šæœ¬å’Œé…ç½®å‰ï¼Œè¯·åœ¨æµ‹è¯•ç¯å¢ƒä¸­å……åˆ†éªŒè¯ã€‚å¯¹äºå› ä½¿ç”¨æœ¬æ–‡æ¡£é€ æˆçš„ä»»ä½•æŸå¤±ï¼Œä½œè€…å’Œå›¢é˜Ÿä¸æ‰¿æ‹…è´£ä»»ã€‚

---

## ç‰ˆæƒä¿¡æ¯

æœ¬æ–‡æ¡£ç‰ˆæƒå½’å…¬å¸æ‰€æœ‰ï¼Œä»…ä¾›å†…éƒ¨ä½¿ç”¨ã€‚æœªç»æˆæƒï¼Œä¸å¾—å¤–ä¼ æˆ–ç”¨äºå•†ä¸šç”¨é€”ã€‚

**æ–‡æ¡£ç‰ˆæœ¬**: v2.1.0  
**æœ€åæ›´æ–°**: 2025 å¹´ 11 æœˆ 27 æ—¥  
**ä¸‹æ¬¡æ›´æ–°**: æ ¹æ®ç³»ç»Ÿç‰ˆæœ¬å˜åŒ–é€‚æ—¶æ›´æ–°

---

_æœ¬æ–‡æ¡£æŒç»­æ›´æ–°ä¸­ï¼Œå¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»è¿ç»´å›¢é˜Ÿã€‚_
